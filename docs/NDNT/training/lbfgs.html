<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.4.0"/>
    <title>NDNT.training.lbfgs API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../training.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;NDNT.training</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#is_legal">is_legal</a>
            </li>
            <li>
                    <a class="function" href="#polyinterp">polyinterp</a>
            </li>
            <li>
                    <a class="class" href="#LBFGS">LBFGS</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LBFGS.__init__">LBFGS</a>
                        </li>
                        <li>
                                <a class="function" href="#LBFGS.line_search">line_search</a>
                        </li>
                        <li>
                                <a class="function" href="#LBFGS.two_loop_recursion">two_loop_recursion</a>
                        </li>
                        <li>
                                <a class="function" href="#LBFGS.curvature_update">curvature_update</a>
                        </li>
                        <li>
                                <a class="function" href="#LBFGS.step">step</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#FullBatchLBFGS">FullBatchLBFGS</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FullBatchLBFGS.__init__">FullBatchLBFGS</a>
                        </li>
                        <li>
                                <a class="function" href="#FullBatchLBFGS.step">step</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../NDNT.html">NDNT</a><wbr>.<a href="./../training.html">training</a><wbr>.lbfgs    </h1>

                
                        <input id="mod-lbfgs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-lbfgs-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">Optimizer</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="k">def</span> <span class="nf">is_legal</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="sd">    Checks that tensor is not NaN or Inf.</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">    Args:</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="sd">        v (tensor): tensor to be checked</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a>    <span class="n">legal</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>    <span class="k">return</span> <span class="n">legal</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="k">def</span> <span class="nf">polyinterp</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">x_min_bound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_max_bound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">    Gives the minimizer and minimum of the interpolating polynomial over given points</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="sd">    based on function and derivative information. Defaults to bisection if no critical</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="sd">    points are valid.</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="sd">    Based on polyinterp.m Matlab function in minFunc by Mark Schmidt with some slight</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="sd">    modifications.</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="sd">    Implemented by: Hao-Jun Michael Shi and Dheevatsa Mudigere</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="sd">    Last edited 12/6/18.</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">    Args:</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">        points (nparray): two-dimensional array with each point of form [x f g]</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="sd">        x_min_bound (float): minimum value that brackets minimum (default: minimum of points)</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd">        x_max_bound (float): maximum value that brackets minimum (default: maximum of points)</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">        plot (bool): plot interpolating polynomial</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd">    Returns:</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">        x_sol (float): minimizer of interpolating polynomial</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">        F_min (float): minimum of interpolating polynomial</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">    Note:</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">        Set f or g to np.nan if they are unknown</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>    <span class="n">no_points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>    <span class="n">x_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>    <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>    <span class="c1"># compute bounds of interpolation area</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>    <span class="k">if</span> <span class="n">x_min_bound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>        <span class="n">x_min_bound</span> <span class="o">=</span> <span class="n">x_min</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>    <span class="k">if</span> <span class="n">x_max_bound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>        <span class="n">x_max_bound</span> <span class="o">=</span> <span class="n">x_max</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>    <span class="c1"># explicit formula for quadratic interpolation</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>    <span class="k">if</span> <span class="n">no_points</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>        <span class="c1"># Solution to quadratic interpolation is given by:</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>        <span class="c1"># a = -(f1 - f2 - g1(x1 - x2))/(x1 - x2)^2</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>        <span class="c1"># x_min = x1 - g1/(2a)</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>        <span class="c1"># if x1 = 0, then is given by:</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>        <span class="c1"># x_min = - (g1*x2^2)/(2(f2 - f1 - g1*x2))</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>        <span class="k">if</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="o">-</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>        <span class="n">x_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">x_min_bound</span><span class="p">,</span> <span class="n">x_sol</span><span class="p">),</span> <span class="n">x_max_bound</span><span class="p">)</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>    <span class="c1"># explicit formula for cubic interpolation</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>    <span class="k">elif</span> <span class="n">no_points</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="c1"># Solution to cubic interpolation is given by:</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="c1"># d1 = g1 + g2 - 3((f1 - f2)/(x1 - x2))</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="c1"># d2 = sqrt(d1^2 - g1*g2)</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="c1"># x_min = x2 - (x2 - x1)*((g2 + d2 - d1)/(g2 - g1 + 2*d2))</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="n">d1</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">((</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="n">d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">d2</span><span class="p">):</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">((</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">-</span> <span class="n">d1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d2</span><span class="p">))</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">x_min_bound</span><span class="p">,</span> <span class="n">x_sol</span><span class="p">),</span> <span class="n">x_max_bound</span><span class="p">)</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_max_bound</span> <span class="o">+</span> <span class="n">x_min_bound</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>    <span class="c1"># solve linear system</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="c1"># define linear constraints</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="c1"># add linear constraints on function values</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_points</span><span class="p">):</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>                <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>                    <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="n">j</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="c1"># add linear constraints on gradient values</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_points</span><span class="p">):</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]):</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>                <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>                    <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">order</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="n">order</span> <span class="o">-</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>        <span class="c1"># check if system is solvable</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>        <span class="k">if</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">!=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_min_bound</span> <span class="o">+</span> <span class="n">x_max_bound</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>            <span class="n">f_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>            <span class="c1"># solve linear system for interpolating polynomial</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>            <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>            <span class="c1"># compute critical points</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>            <span class="n">dcoeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>                <span class="n">dcoeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">order</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>            <span class="n">crit_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_min_bound</span><span class="p">,</span> <span class="n">x_max_bound</span><span class="p">])</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>            <span class="n">crit_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crit_pts</span><span class="p">,</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">dcoeff</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>                <span class="n">roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roots</span><span class="p">(</span><span class="n">dcoeff</span><span class="p">)</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>                <span class="n">crit_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crit_pts</span><span class="p">,</span> <span class="n">roots</span><span class="p">)</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>            <span class="c1"># test critical points</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>            <span class="n">f_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_min_bound</span> <span class="o">+</span> <span class="n">x_max_bound</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># defaults to bisection</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>            <span class="k">for</span> <span class="n">crit_pt</span> <span class="ow">in</span> <span class="n">crit_pts</span><span class="p">:</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">crit_pt</span><span class="p">)</span> <span class="ow">and</span> <span class="n">crit_pt</span> <span class="o">&gt;=</span> <span class="n">x_min_bound</span> <span class="ow">and</span> <span class="n">crit_pt</span> <span class="o">&lt;=</span> <span class="n">x_max_bound</span><span class="p">:</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>                    <span class="n">F_cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">crit_pt</span><span class="p">)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">F_cp</span><span class="p">)</span> <span class="ow">and</span> <span class="n">F_cp</span> <span class="o">&lt;</span> <span class="n">f_min</span><span class="p">:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>                        <span class="n">x_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">crit_pt</span><span class="p">)</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>                        <span class="n">f_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">F_cp</span><span class="p">)</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>            <span class="k">if</span><span class="p">(</span><span class="n">plot</span><span class="p">):</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_min_bound</span><span class="p">,</span> <span class="n">x_max_bound</span><span class="p">,</span> <span class="p">(</span><span class="n">x_max_bound</span> <span class="o">-</span> <span class="n">x_min_bound</span><span class="p">)</span><span class="o">/</span><span class="mi">10000</span><span class="p">)</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_sol</span><span class="p">,</span> <span class="n">f_min</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>    <span class="k">return</span> <span class="n">x_sol</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="k">class</span> <span class="nc">LBFGS</span><span class="p">(</span><span class="n">Optimizer</span><span class="p">):</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">    Implements the L-BFGS algorithm. Compatible with multi-batch and full-overlap</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">    L-BFGS implementations and (stochastic) Powell damping. Partly based on the </span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">    original L-BFGS implementation in PyTorch, Mark Schmidt&#39;s minFunc MATLAB code, </span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="sd">    and Michael Overton&#39;s weak Wolfe line search MATLAB code.</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">    Implemented by: Hao-Jun Michael Shi and Dheevatsa Mudigere</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a><span class="sd">    Last edited 10/20/20.</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">    Warnings:</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">      . Does not support per-parameter options and parameter groups.</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">      . All parameters have to be on a single device.</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="sd">    Args:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a><span class="sd">        lr (float): steplength or learning rate (default: 1)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="sd">        history_size (int): update history size (default: 10)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a><span class="sd">        line_search (str): designates line search to use (default: &#39;Wolfe&#39;)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="sd">            Options:</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="sd">                &#39;None&#39;: uses steplength designated in algorithm</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="sd">                &#39;Armijo&#39;: uses Armijo backtracking line search</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">                &#39;Wolfe&#39;: uses Armijo-Wolfe bracketing line search</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">        dtype: data type (default: torch.float)</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">        debug (bool): debugging mode</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a><span class="sd">    References:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a><span class="sd">    [1] Berahas, Albert S., Jorge Nocedal, and Martin Takc. &quot;A Multi-Batch L-BFGS </span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="sd">        Method for Machine Learning.&quot; Advances in Neural Information Processing </span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a><span class="sd">        Systems. 2016.</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">    [2] Bollapragada, Raghu, et al. &quot;A Progressive Batching L-BFGS Method for Machine </span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="sd">        Learning.&quot; International Conference on Machine Learning. 2018.</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">    [3] Lewis, Adrian S., and Michael L. Overton. &quot;Nonsmooth Optimization via Quasi-Newton</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">        Methods.&quot; Mathematical Programming 141.1-2 (2013): 135-163.</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">    [4] Liu, Dong C., and Jorge Nocedal. &quot;On the Limited Memory BFGS Method for </span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="sd">        Large Scale Optimization.&quot; Mathematical Programming 45.1-3 (1989): 503-528.</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="sd">    [5] Nocedal, Jorge. &quot;Updating Quasi-Newton Matrices With Limited Storage.&quot; </span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">        Mathematics of Computation 35.151 (1980): 773-782.</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">    [6] Nocedal, Jorge, and Stephen J. Wright. &quot;Numerical Optimization.&quot; Springer New York,</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a><span class="sd">        2006.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a><span class="sd">    [7] Schmidt, Mark. &quot;minFunc: Unconstrained Differentiable Multivariate Optimization </span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="sd">        in Matlab.&quot; Software available at http://www.cs.ubc.ca/~schmidtm/Software/minFunc.html </span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a><span class="sd">        (2005).</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="sd">    [8] Schraudolph, Nicol N., Jin Yu, and Simon Gnter. &quot;A Stochastic Quasi-Newton </span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">        Method for Online Convex Optimization.&quot; Artificial Intelligence and Statistics. </span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">        2007.</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">    [9] Wang, Xiao, et al. &quot;Stochastic Quasi-Newton Methods for Nonconvex Stochastic </span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">        Optimization.&quot; SIAM Journal on Optimization 27.2 (2017): 927-956.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">line_search</span><span class="o">=</span><span class="s1">&#39;Wolfe&#39;</span><span class="p">,</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>                 <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>        <span class="c1"># ensure inputs are valid</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">lr</span><span class="p">:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid learning rate: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">history_size</span><span class="p">:</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid history size: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">history_size</span><span class="p">))</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>        <span class="k">if</span> <span class="n">line_search</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Armijo&#39;</span><span class="p">,</span> <span class="s1">&#39;Wolfe&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]:</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid line search: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_search</span><span class="p">))</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>        <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="n">history_size</span><span class="p">,</span> <span class="n">line_search</span><span class="o">=</span><span class="n">line_search</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">LBFGS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;L-BFGS doesn&#39;t support per-parameter options &quot;</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>                             <span class="s2">&quot;(parameter groups)&quot;</span><span class="p">)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_numel_cache</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;n_iter&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;curv_skips&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;fail_skips&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;H_diag&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;old_dirs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;old_stps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>    <span class="k">def</span> <span class="nf">_numel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numel_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_numel_cache</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">total</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">total</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numel_cache</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>    <span class="k">def</span> <span class="nf">_gather_flat_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        <span class="n">views</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>                <span class="n">view</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">is_sparse</span><span class="p">:</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>                <span class="n">view</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dense</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>                <span class="n">view</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>            <span class="n">views</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>    <span class="k">def</span> <span class="nf">_add_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">update</span><span class="p">):</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>            <span class="n">numel</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>            <span class="c1"># view as to avoid deprecated pointwise semantics</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>            <span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">step_size</span><span class="p">,</span> <span class="n">update</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">numel</span><span class="p">]</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>            <span class="n">offset</span> <span class="o">+=</span> <span class="n">numel</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="k">assert</span> <span class="n">offset</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numel</span><span class="p">()</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>    <span class="k">def</span> <span class="nf">_copy_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="n">current_params</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>            <span class="n">current_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>        <span class="k">return</span> <span class="n">current_params</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>    <span class="k">def</span> <span class="nf">_load_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_params</span><span class="p">):</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>            <span class="n">param</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">current_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>    <span class="k">def</span> <span class="nf">line_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line_search</span><span class="p">):</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">        Switches line search option.</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">        </span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="sd">        Args:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">            line_search (str): designates line search to use</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">                Options:</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">                    &#39;None&#39;: uses steplength designated in algorithm</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">                    &#39;Armijo&#39;: uses Armijo backtracking line search</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">                    &#39;Wolfe&#39;: uses Armijo-Wolfe bracketing line search</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">        </span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>        
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        <span class="n">group</span><span class="p">[</span><span class="s1">&#39;line_search&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_search</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>        
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>        <span class="k">return</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>    <span class="k">def</span> <span class="nf">two_loop_recursion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">        Performs two-loop recursion on given vector to obtain Hv.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a><span class="sd">        Args:</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="sd">            vec (tensor): 1-D tensor to apply two-loop recursion to</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="sd">        Output:</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">            r (tensor): matrix-vector product Hv</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>        <span class="n">history_size</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;history_size&#39;</span><span class="p">]</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>        <span class="n">old_dirs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_dirs&#39;</span><span class="p">)</span>    <span class="c1"># change in gradients</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>        <span class="n">old_stps</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_stps&#39;</span><span class="p">)</span>    <span class="c1"># change in iterates</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>        <span class="n">H_diag</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;H_diag&#39;</span><span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>        <span class="c1"># compute the product of the inverse Hessian approximation and the gradient</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>        <span class="n">num_old</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_dirs</span><span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>        <span class="k">if</span> <span class="s1">&#39;rho&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">history_size</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">history_size</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>        <span class="n">rho</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_old</span><span class="p">):</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>            <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">old_stps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">old_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>        <span class="n">q</span> <span class="o">=</span> <span class="n">vec</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_old</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>            <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>            <span class="n">q</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">old_stps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>        <span class="c1"># multiply by initial Hessian </span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>        <span class="c1"># r/d is the final direction</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">H_diag</span><span class="p">)</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_old</span><span class="p">):</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>            <span class="n">beta</span> <span class="o">=</span> <span class="n">old_stps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>            <span class="n">r</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta</span><span class="p">,</span> <span class="n">old_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>        <span class="k">return</span> <span class="n">r</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>    <span class="k">def</span> <span class="nf">curvature_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flat_grad</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a><span class="sd">        Performs curvature update.</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a><span class="sd">        Args:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="sd">            flat_grad (tensor): 1-D tensor of flattened gradient for computing </span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a><span class="sd">                gradient difference with previously stored gradient</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="sd">            eps (float): constant for curvature pair rejection or damping (default: 1e-2)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a><span class="sd">            damping (bool): flag for using Powell damping (default: False)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>        <span class="c1"># load parameters</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>        <span class="k">if</span><span class="p">(</span><span class="n">eps</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>            <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid eps; must be positive.&#39;</span><span class="p">))</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>        <span class="n">history_size</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;history_size&#39;</span><span class="p">]</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>        <span class="n">debug</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="c1"># variables cached in state (for tracing)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>        <span class="n">fail</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>        
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>        <span class="c1"># check if line search failed</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">fail</span><span class="p">:</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>            
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>            <span class="n">old_dirs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_dirs&#39;</span><span class="p">)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>            <span class="n">old_stps</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_stps&#39;</span><span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>            <span class="n">H_diag</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;H_diag&#39;</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>            <span class="n">prev_flat_grad</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prev_flat_grad&#39;</span><span class="p">)</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>            <span class="n">Bs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Bs&#39;</span><span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>    
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>            <span class="c1"># compute y&#39;s</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">flat_grad</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">prev_flat_grad</span><span class="p">)</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>            <span class="n">sBs</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Bs</span><span class="p">)</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>            <span class="n">ys</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># y*s</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>            <span class="c1"># update L-BFGS matrix</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>            <span class="k">if</span> <span class="n">ys</span> <span class="o">&gt;</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">sBs</span> <span class="ow">or</span> <span class="n">damping</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>    
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>                <span class="c1"># perform Powell damping</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>                <span class="k">if</span> <span class="n">damping</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">ys</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="o">*</span><span class="n">sBs</span><span class="p">:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Applying Powell damping...&#39;</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>                    <span class="n">theta</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">sBs</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sBs</span> <span class="o">-</span> <span class="n">ys</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>                    <span class="n">y</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">Bs</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>    
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>                <span class="c1"># updating memory</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_dirs</span><span class="p">)</span> <span class="o">==</span> <span class="n">history_size</span><span class="p">:</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>                    <span class="c1"># shift history by one (limited-memory)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>                    <span class="n">old_dirs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>                    <span class="n">old_stps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>    
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                <span class="c1"># store new direction/step</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>                <span class="n">old_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>                <span class="n">old_stps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>    
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>                <span class="c1"># update scale of initial Hessian approximation</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>                <span class="n">H_diag</span> <span class="o">=</span> <span class="n">ys</span> <span class="o">/</span> <span class="n">y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># (y*y)</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>                
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;old_dirs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_dirs</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;old_stps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_stps</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;H_diag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">H_diag</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>                <span class="c1"># save skip</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;curv_skips&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Curvature pair skipped due to failed criterion&#39;</span><span class="p">)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>            <span class="c1"># save skip</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;fail_skips&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Line search failed; curvature pair update skipped&#39;</span><span class="p">)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>        <span class="k">return</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>    <span class="k">def</span> <span class="nf">_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_k</span><span class="p">,</span> <span class="n">g_Ok</span><span class="p">,</span> <span class="n">g_Sk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">        Performs a single optimization step.</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">        </span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">        Args:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">            p_k (tensor): 1-D tensor specifying search direction</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="sd">            g_Ok (tensor): 1-D tensor of flattened gradient over overlap O_k used</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a><span class="sd">                            for gradient differencing in curvature pair update</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">            g_Sk (tensor): 1-D tensor of flattened gradient over full sample S_k</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="sd">                            used for curvature pair damping or rejection criterion,</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">                            if None, will use g_Ok (default: None)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="sd">            options (dict): contains options for performing line search (default: None)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="sd">        Options for Armijo backtracking line search:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">            &#39;closure&#39; (callable): reevaluates model and returns function value</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="sd">            &#39;current_loss&#39; (tensor): objective value at current iterate (default: F(x_k))</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a><span class="sd">            &#39;gtd&#39; (tensor): inner product g_Ok&#39;d in line search (default: g_Ok&#39;d)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a><span class="sd">            &#39;eta&#39; (tensor): factor for decreasing steplength &gt; 0 (default: 2)</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a><span class="sd">            &#39;c1&#39; (tensor): sufficient decrease constant in (0, 1) (default: 1e-4)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a><span class="sd">            &#39;max_ls&#39; (int): maximum number of line search steps permitted (default: 10)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a><span class="sd">            &#39;interpolate&#39; (bool): flag for using interpolation (default: True)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a><span class="sd">            &#39;inplace&#39; (bool): flag for inplace operations (default: True)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a><span class="sd">            &#39;ls_debug&#39; (bool): debugging mode for line search</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a><span class="sd">        Options for Wolfe line search:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="sd">            &#39;closure&#39; (callable): reevaluates model and returns function value</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="sd">            &#39;current_loss&#39; (tensor): objective value at current iterate (default: F(x_k))</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="sd">            &#39;gtd&#39; (tensor): inner product g_Ok&#39;d in line search (default: g_Ok&#39;d)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a><span class="sd">            &#39;eta&#39; (float): factor for extrapolation (default: 2)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a><span class="sd">            &#39;c1&#39; (float): sufficient decrease constant in (0, 1) (default: 1e-4)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a><span class="sd">            &#39;c2&#39; (float): curvature condition constant in (0, 1) (default: 0.9)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="sd">            &#39;max_ls&#39; (int): maximum number of line search steps permitted (default: 10)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a><span class="sd">            &#39;interpolate&#39; (bool): flag for using interpolation (default: True)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a><span class="sd">            &#39;inplace&#39; (bool): flag for inplace operations (default: True)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a><span class="sd">            &#39;ls_debug&#39; (bool): debugging mode for line search</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a><span class="sd">        Outputs (depends on line search):</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a><span class="sd">          . No line search:</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a><span class="sd">                t (float): steplength</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="sd">          . Armijo backtracking line search:</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a><span class="sd">                F_new (tensor): loss function at new iterate</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a><span class="sd">                t (tensor): final steplength</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="sd">                ls_step (int): number of backtracks</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="sd">                closure_eval (int): number of closure evaluations</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="sd">                desc_dir (bool): descent direction flag</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a><span class="sd">                    True: p_k is descent direction with respect to the line search</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="sd">                    function</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="sd">                    False: p_k is not a descent direction with respect to the line</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="sd">                    search function</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="sd">                fail (bool): failure flag</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">                    True: line search reached maximum number of iterations, failed</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">                    False: line search succeeded</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a><span class="sd">          . Wolfe line search:</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">                F_new (tensor): loss function at new iterate</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">                g_new (tensor): gradient at new iterate</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a><span class="sd">                t (float): final steplength</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="sd">                ls_step (int): number of backtracks</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="sd">                closure_eval (int): number of closure evaluations</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">                grad_eval (int): number of gradient evaluations</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a><span class="sd">                desc_dir (bool): descent direction flag</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">                    True: p_k is descent direction with respect to the line search</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="sd">                    function</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">                    False: p_k is not a descent direction with respect to the line</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">                    search function</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">                fail (bool): failure flag</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">                    True: line search reached maximum number of iterations, failed</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">                    False: line search succeeded</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">                    </span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="sd">        Notes:</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="sd">          . If encountering line search failure in the deterministic setting, one</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="sd">            should try increasing the maximum number of line search steps max_ls.</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>            <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>        <span class="c1"># load parameter options</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>        <span class="n">lr</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>        <span class="n">line_search</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;line_search&#39;</span><span class="p">]</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="n">debug</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>        <span class="c1"># variables cached in state (for tracing)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>        <span class="n">prev_flat_grad</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prev_flat_grad&#39;</span><span class="p">)</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        <span class="n">Bs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Bs&#39;</span><span class="p">)</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>        <span class="c1"># keep track of nb of iterations</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>        <span class="c1"># set search direction</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">p_k</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>        <span class="c1"># modify previous gradient</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>        <span class="k">if</span> <span class="n">prev_flat_grad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>            <span class="n">prev_flat_grad</span> <span class="o">=</span> <span class="n">g_Ok</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>            <span class="n">prev_flat_grad</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">g_Ok</span><span class="p">)</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>        <span class="c1"># set initial step size</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">lr</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="c1"># closure evaluation counter</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="n">closure_eval</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>        <span class="k">if</span> <span class="n">g_Sk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>            <span class="n">g_Sk</span> <span class="o">=</span> <span class="n">g_Ok</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>        <span class="c1"># perform Armijo backtracking line search</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>        <span class="k">if</span> <span class="n">line_search</span> <span class="o">==</span> <span class="s1">&#39;Armijo&#39;</span><span class="p">:</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>            <span class="c1"># load options</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>            <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>                <span class="k">if</span> <span class="s1">&#39;closure&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;closure option not specified.&#39;</span><span class="p">))</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>                    <span class="n">closure</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;closure&#39;</span><span class="p">]</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>                <span class="k">if</span> <span class="s1">&#39;gtd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>                    <span class="n">gtd</span> <span class="o">=</span> <span class="n">g_Sk</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                    <span class="n">gtd</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;gtd&#39;</span><span class="p">]</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>                <span class="k">if</span> <span class="s1">&#39;current_loss&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>                    <span class="n">F_k</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>                    <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>                    <span class="n">F_k</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;current_loss&#39;</span><span class="p">]</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>                <span class="k">if</span> <span class="s1">&#39;eta&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>                    <span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid eta; must be positive.&#39;</span><span class="p">))</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>                    <span class="n">eta</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>                <span class="k">if</span> <span class="s1">&#39;c1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>                    <span class="n">c1</span> <span class="o">=</span> <span class="mf">1e-4</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid c1; must be strictly between 0 and 1.&#39;</span><span class="p">))</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>                    <span class="n">c1</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>                <span class="k">if</span> <span class="s1">&#39;max_ls&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>                    <span class="n">max_ls</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_ls&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid max_ls; must be positive.&#39;</span><span class="p">))</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>                    <span class="n">max_ls</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_ls&#39;</span><span class="p">]</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>                <span class="k">if</span> <span class="s1">&#39;interpolate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>                    <span class="n">interpolate</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>                    <span class="n">interpolate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;interpolate&#39;</span><span class="p">]</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>                <span class="k">if</span> <span class="s1">&#39;inplace&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>                    <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>                    <span class="n">inplace</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;inplace&#39;</span><span class="p">]</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>                    
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>                <span class="k">if</span> <span class="s1">&#39;ls_debug&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>                    <span class="n">ls_debug</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>                    <span class="n">ls_debug</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;ls_debug&#39;</span><span class="p">]</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>                <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Options are not specified; need closure evaluating function.&#39;</span><span class="p">))</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>            <span class="c1"># initialize values</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>            <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>                <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>                    <span class="n">F_prev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>                    <span class="n">F_prev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>            <span class="n">ls_step</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>            <span class="n">t_prev</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># old steplength</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>            <span class="n">fail</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># failure flag</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>            <span class="c1"># begin print for debug mode</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>            <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==================================== Begin Armijo line search ===================================&#39;</span><span class="p">)</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F(x): </span><span class="si">%.8e</span><span class="s1">  g*d: </span><span class="si">%.8e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">F_k</span><span class="p">,</span> <span class="n">gtd</span><span class="p">))</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>            <span class="c1"># check if search direction is descent direction</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>            <span class="k">if</span> <span class="n">gtd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>                <span class="n">desc_dir</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not a descent direction!&#39;</span><span class="p">)</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>                <span class="n">desc_dir</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>            <span class="c1"># store values if not in-place</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>                <span class="n">current_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_params</span><span class="p">()</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>            <span class="c1"># update and evaluate at new point</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>            <span class="n">F_new</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>            <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>            <span class="c1"># print info if debugging</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>            <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LS Step: </span><span class="si">%d</span><span class="s1">  t: </span><span class="si">%.8e</span><span class="s1">  F(x+td): </span><span class="si">%.8e</span><span class="s1">  F-c1*t*g*d: </span><span class="si">%.8e</span><span class="s1">  F(x): </span><span class="si">%.8e</span><span class="s1">&#39;</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>                      <span class="o">%</span> <span class="p">(</span><span class="n">ls_step</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">F_new</span><span class="p">,</span> <span class="n">F_k</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">gtd</span><span class="p">,</span> <span class="n">F_k</span><span class="p">))</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>            <span class="c1"># check Armijo condition</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>            <span class="k">while</span> <span class="n">F_new</span> <span class="o">&gt;</span> <span class="n">F_k</span> <span class="o">+</span> <span class="n">c1</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">gtd</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_legal</span><span class="p">(</span><span class="n">F_new</span><span class="p">):</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>                <span class="c1"># check if maximum number of iterations reached</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>                <span class="k">if</span> <span class="n">ls_step</span> <span class="o">&gt;=</span> <span class="n">max_ls</span><span class="p">:</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>                    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_load_params</span><span class="p">(</span><span class="n">current_params</span><span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>                    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>                    <span class="n">F_new</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>                    <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>                    <span class="n">fail</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>                    <span class="k">break</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>                    <span class="c1"># store current steplength</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                    <span class="n">t_new</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>                    <span class="c1"># compute new steplength</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                    <span class="c1"># if first step or not interpolating, then multiply by factor</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>                    <span class="k">if</span> <span class="n">ls_step</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">interpolate</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_legal</span><span class="p">(</span><span class="n">F_new</span><span class="p">):</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">/</span><span class="n">eta</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>                    <span class="c1"># if second step, use function value at new point along with </span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>                    <span class="c1"># gradient and function at current iterate</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>                    <span class="k">elif</span> <span class="n">ls_step</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_legal</span><span class="p">(</span><span class="n">F_prev</span><span class="p">):</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="n">polyinterp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="n">F_k</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">gtd</span><span class="o">.</span><span class="n">item</span><span class="p">()],</span> <span class="p">[</span><span class="n">t_new</span><span class="p">,</span> <span class="n">F_new</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]))</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                    <span class="c1"># otherwise, use function values at new point, previous point,</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>                    <span class="c1"># and gradient and function at current iterate</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="n">polyinterp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="n">F_k</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">gtd</span><span class="o">.</span><span class="n">item</span><span class="p">()],</span> <span class="p">[</span><span class="n">t_new</span><span class="p">,</span> <span class="n">F_new</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> 
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>                                                <span class="p">[</span><span class="n">t_prev</span><span class="p">,</span> <span class="n">F_prev</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]))</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>                    <span class="c1"># if values are too extreme, adjust t</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>                    <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>                        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">t_new</span><span class="p">:</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>                            <span class="n">t</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">t_new</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>                        <span class="k">elif</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">t_new</span><span class="p">:</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>                            <span class="n">t</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">t_new</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>                        <span class="c1"># store old point</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>                        <span class="n">F_prev</span> <span class="o">=</span> <span class="n">F_new</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>                        <span class="n">t_prev</span> <span class="o">=</span> <span class="n">t_new</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>                    <span class="c1"># update iterate and reevaluate</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>                    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_new</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_load_params</span><span class="p">(</span><span class="n">current_params</span><span class="p">)</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>                    <span class="n">F_new</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>                    <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                    <span class="n">ls_step</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># iterate</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>                    
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>                    <span class="c1"># print info if debugging</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>                    <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LS Step: </span><span class="si">%d</span><span class="s1">  t: </span><span class="si">%.8e</span><span class="s1">  F(x+td):   </span><span class="si">%.8e</span><span class="s1">  F-c1*t*g*d: </span><span class="si">%.8e</span><span class="s1">  F(x): </span><span class="si">%.8e</span><span class="s1">&#39;</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>                              <span class="o">%</span> <span class="p">(</span><span class="n">ls_step</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">F_new</span><span class="p">,</span> <span class="n">F_k</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">gtd</span><span class="p">,</span> <span class="n">F_k</span><span class="p">))</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>            <span class="c1"># store Bs</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>            <span class="k">if</span> <span class="n">Bs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>                <span class="n">Bs</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_Sk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">))</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>                <span class="n">Bs</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">g_Sk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">))</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>                
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>            <span class="c1"># print final steplength</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>            <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final Steplength:&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;===================================== End Armijo line search ====================================&#39;</span><span class="p">)</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;prev_flat_grad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_flat_grad</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Bs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bs</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;fail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fail</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>            <span class="k">return</span> <span class="n">F_new</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ls_step</span><span class="p">,</span> <span class="n">closure_eval</span><span class="p">,</span> <span class="n">desc_dir</span><span class="p">,</span> <span class="n">fail</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="c1"># perform weak Wolfe line search</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="k">elif</span> <span class="n">line_search</span> <span class="o">==</span> <span class="s1">&#39;Wolfe&#39;</span><span class="p">:</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>            <span class="c1"># load options</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>            <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>                <span class="k">if</span> <span class="s1">&#39;closure&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;closure option not specified.&#39;</span><span class="p">))</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>                    <span class="n">closure</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;closure&#39;</span><span class="p">]</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>                <span class="k">if</span> <span class="s1">&#39;current_loss&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>                    <span class="n">F_k</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>                    <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>                    <span class="n">F_k</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;current_loss&#39;</span><span class="p">]</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>                <span class="k">if</span> <span class="s1">&#39;gtd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>                    <span class="n">gtd</span> <span class="o">=</span> <span class="n">g_Sk</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>                    <span class="n">gtd</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;gtd&#39;</span><span class="p">]</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>                <span class="k">if</span> <span class="s1">&#39;eta&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                    <span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid eta; must be greater than 1.&#39;</span><span class="p">))</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>                    <span class="n">eta</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>                <span class="k">if</span> <span class="s1">&#39;c1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>                    <span class="n">c1</span> <span class="o">=</span> <span class="mf">1e-4</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid c1; must be strictly between 0 and 1.&#39;</span><span class="p">))</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>                    <span class="n">c1</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>                <span class="k">if</span> <span class="s1">&#39;c2&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>                    <span class="n">c2</span> <span class="o">=</span> <span class="mf">0.9</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid c2; must be strictly between 0 and 1.&#39;</span><span class="p">))</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">c1</span><span class="p">:</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid c2; must be strictly larger than c1.&#39;</span><span class="p">))</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>                    <span class="n">c2</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>                <span class="k">if</span> <span class="s1">&#39;max_ls&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>                    <span class="n">max_ls</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_ls&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid max_ls; must be positive.&#39;</span><span class="p">))</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>                    <span class="n">max_ls</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_ls&#39;</span><span class="p">]</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>                <span class="k">if</span> <span class="s1">&#39;interpolate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>                    <span class="n">interpolate</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>                    <span class="n">interpolate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;interpolate&#39;</span><span class="p">]</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>                <span class="k">if</span> <span class="s1">&#39;inplace&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>                    <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>                    <span class="n">inplace</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;inplace&#39;</span><span class="p">]</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>                    
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>                <span class="k">if</span> <span class="s1">&#39;ls_debug&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>                    <span class="n">ls_debug</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>                    <span class="n">ls_debug</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;ls_debug&#39;</span><span class="p">]</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>                <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Options are not specified; need closure evaluating function.&#39;</span><span class="p">))</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>            <span class="c1"># initialize counters</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="n">ls_step</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="n">grad_eval</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># tracks gradient evaluations</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="n">t_prev</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># old steplength</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>            <span class="c1"># initialize bracketing variables and flag</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>            <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>            <span class="n">beta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">)</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>            <span class="n">fail</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>            <span class="c1"># initialize values for line search</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="k">if</span><span class="p">(</span><span class="n">interpolate</span><span class="p">):</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>                <span class="n">F_a</span> <span class="o">=</span> <span class="n">F_k</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                <span class="n">g_a</span> <span class="o">=</span> <span class="n">gtd</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>                <span class="k">if</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()):</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>                    <span class="n">F_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>                    <span class="n">g_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>                    <span class="n">F_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>                    <span class="n">g_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>            <span class="c1"># begin print for debug mode</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>            <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==================================== Begin Wolfe line search ====================================&#39;</span><span class="p">)</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F(x): </span><span class="si">%.8e</span><span class="s1">  g*d: </span><span class="si">%.8e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">F_k</span><span class="p">,</span> <span class="n">gtd</span><span class="p">))</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>            <span class="c1"># check if search direction is descent direction</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>            <span class="k">if</span> <span class="n">gtd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>                <span class="n">desc_dir</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not a descent direction!&#39;</span><span class="p">)</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>                <span class="n">desc_dir</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>            <span class="c1"># store values if not in-place</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>                <span class="n">current_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_params</span><span class="p">()</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>            <span class="c1"># update and evaluate at new point</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>            <span class="n">F_new</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>            <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>            <span class="c1"># main loop</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>                <span class="c1"># check if maximum number of line search steps have been reached</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>                <span class="k">if</span> <span class="n">ls_step</span> <span class="o">&gt;=</span> <span class="n">max_ls</span><span class="p">:</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>                    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_load_params</span><span class="p">(</span><span class="n">current_params</span><span class="p">)</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>                    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>                    <span class="n">F_new</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>                    <span class="n">F_new</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>                    <span class="n">g_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_flat_grad</span><span class="p">()</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>                    <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>                    <span class="n">grad_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>                    <span class="n">fail</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>                    <span class="k">break</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>                <span class="c1"># print info if debugging</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>                <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LS Step: </span><span class="si">%d</span><span class="s1">  t: </span><span class="si">%.8e</span><span class="s1">  alpha: </span><span class="si">%.8e</span><span class="s1">  beta: </span><span class="si">%.8e</span><span class="s1">&#39;</span> 
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>                          <span class="o">%</span> <span class="p">(</span><span class="n">ls_step</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">))</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Armijo:  F(x+td): </span><span class="si">%.8e</span><span class="s1">  F-c1*t*g*d: </span><span class="si">%.8e</span><span class="s1">  F(x): </span><span class="si">%.8e</span><span class="s1">&#39;</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>                          <span class="o">%</span> <span class="p">(</span><span class="n">F_new</span><span class="p">,</span> <span class="n">F_k</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">gtd</span><span class="p">,</span> <span class="n">F_k</span><span class="p">))</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>                <span class="c1"># check Armijo condition</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                <span class="k">if</span> <span class="n">F_new</span> <span class="o">&gt;</span> <span class="n">F_k</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">gtd</span><span class="p">:</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>                    <span class="c1"># set upper bound</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>                    <span class="n">beta</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>                    <span class="n">t_prev</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>                    <span class="c1"># update interpolation quantities</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>                    <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>                        <span class="n">F_b</span> <span class="o">=</span> <span class="n">F_new</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>                        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>                            <span class="n">g_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>                            <span class="n">g_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>                    <span class="c1"># compute gradient</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>                    <span class="n">F_new</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>                    <span class="n">g_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_flat_grad</span><span class="p">()</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>                    <span class="n">grad_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>                    <span class="n">gtd_new</span> <span class="o">=</span> <span class="n">g_new</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>                    
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>                    <span class="c1"># print info if debugging</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>                    <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wolfe: g(x+td)*d: </span><span class="si">%.8e</span><span class="s1">  c2*g*d: </span><span class="si">%.8e</span><span class="s1">  gtd: </span><span class="si">%.8e</span><span class="s1">&#39;</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>                              <span class="o">%</span> <span class="p">(</span><span class="n">gtd_new</span><span class="p">,</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">gtd</span><span class="p">,</span> <span class="n">gtd</span><span class="p">))</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>                    <span class="c1"># check curvature condition</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>                    <span class="k">if</span> <span class="n">gtd_new</span> <span class="o">&lt;</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">gtd</span><span class="p">:</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>                        <span class="c1"># set lower bound</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>                        <span class="n">alpha</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>                        <span class="n">t_prev</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>                        <span class="c1"># update interpolation quantities</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>                        <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>                            <span class="n">F_a</span> <span class="o">=</span> <span class="n">F_new</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>                            <span class="n">g_a</span> <span class="o">=</span> <span class="n">gtd_new</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>                        <span class="k">break</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>                <span class="c1"># compute new steplength</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>                <span class="c1"># if first step or not interpolating, then bisect or multiply by factor</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">interpolate</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_legal</span><span class="p">(</span><span class="n">F_b</span><span class="p">):</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>                    <span class="k">if</span> <span class="n">beta</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">):</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="n">eta</span><span class="o">*</span><span class="n">t</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>                <span class="c1"># otherwise interpolate between a and b</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>                    <span class="n">t</span> <span class="o">=</span> <span class="n">polyinterp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">alpha</span><span class="p">,</span> <span class="n">F_a</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">g_a</span><span class="o">.</span><span class="n">item</span><span class="p">()],</span> <span class="p">[</span><span class="n">beta</span><span class="p">,</span> <span class="n">F_b</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">g_b</span><span class="o">.</span><span class="n">item</span><span class="p">()]]))</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>                    <span class="c1"># if values are too extreme, adjust t</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>                    <span class="k">if</span> <span class="n">beta</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">):</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>                        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">t_prev</span><span class="p">:</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>                            <span class="n">t</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">t_prev</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                        <span class="k">elif</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">t_prev</span><span class="p">:</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>                            <span class="n">t</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">t_prev</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>                        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">):</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>                            <span class="n">t</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>                        <span class="k">elif</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">:</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>                            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>                    <span class="c1"># if we obtain nonsensical value from interpolation</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>                    <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>                <span class="c1"># update parameters</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>                <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_prev</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_load_params</span><span class="p">(</span><span class="n">current_params</span><span class="p">)</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>                <span class="c1"># evaluate closure</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>                <span class="n">F_new</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>                <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>                <span class="n">ls_step</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>            <span class="c1"># store Bs</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>            <span class="k">if</span> <span class="n">Bs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>                <span class="n">Bs</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_Sk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">))</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>                <span class="n">Bs</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">g_Sk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">))</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>                
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>            <span class="c1"># print final steplength</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>            <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final Steplength:&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;===================================== End Wolfe line search =====================================&#39;</span><span class="p">)</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;prev_flat_grad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_flat_grad</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Bs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bs</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;fail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fail</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>            <span class="k">return</span> <span class="n">F_new</span><span class="p">,</span> <span class="n">g_new</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ls_step</span><span class="p">,</span> <span class="n">closure_eval</span><span class="p">,</span> <span class="n">grad_eval</span><span class="p">,</span> <span class="n">desc_dir</span><span class="p">,</span> <span class="n">fail</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>            <span class="c1"># perform update</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>            <span class="c1"># store Bs</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>            <span class="k">if</span> <span class="n">Bs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>                <span class="n">Bs</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_Sk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">))</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>                <span class="n">Bs</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">g_Sk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">))</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;prev_flat_grad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_flat_grad</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Bs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bs</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;fail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>            <span class="k">return</span> <span class="n">t</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_k</span><span class="p">,</span> <span class="n">g_Ok</span><span class="p">,</span> <span class="n">g_Sk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{}):</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">(</span><span class="n">p_k</span><span class="p">,</span> <span class="n">g_Ok</span><span class="p">,</span> <span class="n">g_Sk</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="k">class</span> <span class="nc">FullBatchLBFGS</span><span class="p">(</span><span class="n">LBFGS</span><span class="p">):</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="sd">    Implements full-batch or deterministic L-BFGS algorithm. Compatible with</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">    Powell damping. Can be used when evaluating a deterministic function and</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="sd">    gradient. Wraps the LBFGS optimizer. Performs the two-loop recursion,</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="sd">    updating, and curvature updating in a single step.</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="sd">    Implemented by: Hao-Jun Michael Shi and Dheevatsa Mudigere</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a><span class="sd">    Last edited 11/15/18.</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a><span class="sd">    Warnings:</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="sd">      . Does not support per-parameter options and parameter groups.</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">      . All parameters have to be on a single device.</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">      </span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">    Args:</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">        lr (float): steplength or learning rate (default: 1)</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">        history_size (int): update history size (default: 10)</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="sd">        line_search (str): designates line search to use (default: &#39;Wolfe&#39;)</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">            Options:</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a><span class="sd">                &#39;None&#39;: uses steplength designated in algorithm</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a><span class="sd">                &#39;Armijo&#39;: uses Armijo backtracking line search</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="sd">                &#39;Wolfe&#39;: uses Armijo-Wolfe bracketing line search</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a><span class="sd">        dtype: data type (default: torch.float)</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a><span class="sd">        debug (bool): debugging mode</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">line_search</span><span class="o">=</span><span class="s1">&#39;Wolfe&#39;</span><span class="p">,</span> 
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>                 <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">FullBatchLBFGS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">history_size</span><span class="p">,</span> <span class="n">line_search</span><span class="p">,</span> 
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>             <span class="n">dtype</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="sd">        Performs a single optimization step.</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a><span class="sd">        Args:</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="sd">            options (dict): contains options for performing line search (default: None)</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="sd">            </span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a><span class="sd">        General Options:</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a><span class="sd">            &#39;eps&#39; (float): constant for curvature pair rejection or damping (default: 1e-2)</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a><span class="sd">            &#39;damping&#39; (bool): flag for using Powell damping (default: False)</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="sd">        Options for Armijo backtracking line search:</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a><span class="sd">            &#39;closure&#39; (callable): reevaluates model and returns function value</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="sd">            &#39;current_loss&#39; (tensor): objective value at current iterate (default: F(x_k))</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="sd">            &#39;gtd&#39; (tensor): inner product g_Ok&#39;d in line search (default: g_Ok&#39;d)</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a><span class="sd">            &#39;eta&#39; (tensor): factor for decreasing steplength &gt; 0 (default: 2)</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a><span class="sd">            &#39;c1&#39; (tensor): sufficient decrease constant in (0, 1) (default: 1e-4)</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a><span class="sd">            &#39;max_ls&#39; (int): maximum number of line search steps permitted (default: 10)</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a><span class="sd">            &#39;interpolate&#39; (bool): flag for using interpolation (default: True)</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a><span class="sd">            &#39;inplace&#39; (bool): flag for inplace operations (default: True)</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="sd">            &#39;ls_debug&#39; (bool): debugging mode for line search</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a><span class="sd">        Options for Wolfe line search:</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a><span class="sd">            &#39;closure&#39; (callable): reevaluates model and returns function value</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="sd">            &#39;current_loss&#39; (tensor): objective value at current iterate (default: F(x_k))</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a><span class="sd">            &#39;gtd&#39; (tensor): inner product g_Ok&#39;d in line search (default: g_Ok&#39;d)</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a><span class="sd">            &#39;eta&#39; (float): factor for extrapolation (default: 2)</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="sd">            &#39;c1&#39; (float): sufficient decrease constant in (0, 1) (default: 1e-4)</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">            &#39;c2&#39; (float): curvature condition constant in (0, 1) (default: 0.9)</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a><span class="sd">            &#39;max_ls&#39; (int): maximum number of line search steps permitted (default: 10)</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a><span class="sd">            &#39;interpolate&#39; (bool): flag for using interpolation (default: True)</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a><span class="sd">            &#39;inplace&#39; (bool): flag for inplace operations (default: True)</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a><span class="sd">            &#39;ls_debug&#39; (bool): debugging mode for line search</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a><span class="sd">        Outputs (depends on line search):</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a><span class="sd">          . No line search:</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="sd">                t (float): steplength</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="sd">          . Armijo backtracking line search:</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">                F_new (tensor): loss function at new iterate</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">                t (tensor): final steplength</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">                ls_step (int): number of backtracks</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">                closure_eval (int): number of closure evaluations</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">                desc_dir (bool): descent direction flag</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">                    True: p_k is descent direction with respect to the line search</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a><span class="sd">                    function</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="sd">                    False: p_k is not a descent direction with respect to the line</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">                    search function</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">                fail (bool): failure flag</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">                    True: line search reached maximum number of iterations, failed</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a><span class="sd">                    False: line search succeeded</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">          . Wolfe line search:</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">                F_new (tensor): loss function at new iterate</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="sd">                g_new (tensor): gradient at new iterate</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="sd">                t (float): final steplength</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">                ls_step (int): number of backtracks</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a><span class="sd">                closure_eval (int): number of closure evaluations</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a><span class="sd">                grad_eval (int): number of gradient evaluations</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a><span class="sd">                desc_dir (bool): descent direction flag</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a><span class="sd">                    True: p_k is descent direction with respect to the line search</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a><span class="sd">                    function</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a><span class="sd">                    False: p_k is not a descent direction with respect to the line</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a><span class="sd">                    search function</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">                fail (bool): failure flag</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a><span class="sd">                    True: line search reached maximum number of iterations, failed</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a><span class="sd">                    False: line search succeeded</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a><span class="sd">                    </span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a><span class="sd">        Notes:</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a><span class="sd">          . If encountering line search failure in the deterministic setting, one</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a><span class="sd">            should try increasing the maximum number of line search steps max_ls.</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>        
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="c1"># load options for damping and eps</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>        <span class="k">if</span> <span class="s1">&#39;damping&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>            <span class="n">damping</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>            <span class="n">damping</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;damping&#39;</span><span class="p">]</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>            
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="k">if</span> <span class="s1">&#39;eps&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>            <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-2</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>            <span class="n">eps</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;eps&#39;</span><span class="p">]</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>        
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>        <span class="c1"># gather gradient</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>        <span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_flat_grad</span><span class="p">()</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>        
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>        <span class="c1"># update curvature if after 1st iteration</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">curvature_update</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">damping</span><span class="p">)</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>        <span class="c1"># compute search direction</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_loop_recursion</span><span class="p">(</span><span class="o">-</span><span class="n">grad</span><span class="p">)</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="c1"># take step</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="is_legal">
                            <input id="is_legal-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_legal</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">v</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="is_legal-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#is_legal"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="is_legal-10"><a href="#is_legal-10"><span class="linenos">10</span></a><span class="k">def</span> <span class="nf">is_legal</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
</span><span id="is_legal-11"><a href="#is_legal-11"><span class="linenos">11</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="is_legal-12"><a href="#is_legal-12"><span class="linenos">12</span></a><span class="sd">    Checks that tensor is not NaN or Inf.</span>
</span><span id="is_legal-13"><a href="#is_legal-13"><span class="linenos">13</span></a>
</span><span id="is_legal-14"><a href="#is_legal-14"><span class="linenos">14</span></a><span class="sd">    Args:</span>
</span><span id="is_legal-15"><a href="#is_legal-15"><span class="linenos">15</span></a><span class="sd">        v (tensor): tensor to be checked</span>
</span><span id="is_legal-16"><a href="#is_legal-16"><span class="linenos">16</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="is_legal-17"><a href="#is_legal-17"><span class="linenos">17</span></a>    <span class="n">legal</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span id="is_legal-18"><a href="#is_legal-18"><span class="linenos">18</span></a>
</span><span id="is_legal-19"><a href="#is_legal-19"><span class="linenos">19</span></a>    <span class="k">return</span> <span class="n">legal</span>
</span></pre></div>


            <div class="docstring"><p>Checks that tensor is not NaN or Inf.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>v (tensor):</strong>  tensor to be checked</li>
</ul>
</div>


                </section>
                <section id="polyinterp">
                            <input id="polyinterp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">polyinterp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">points</span>, </span><span class="param"><span class="n">x_min_bound</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">x_max_bound</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">plot</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="polyinterp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#polyinterp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="polyinterp-22"><a href="#polyinterp-22"><span class="linenos"> 22</span></a><span class="k">def</span> <span class="nf">polyinterp</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">x_min_bound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_max_bound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="polyinterp-23"><a href="#polyinterp-23"><span class="linenos"> 23</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="polyinterp-24"><a href="#polyinterp-24"><span class="linenos"> 24</span></a><span class="sd">    Gives the minimizer and minimum of the interpolating polynomial over given points</span>
</span><span id="polyinterp-25"><a href="#polyinterp-25"><span class="linenos"> 25</span></a><span class="sd">    based on function and derivative information. Defaults to bisection if no critical</span>
</span><span id="polyinterp-26"><a href="#polyinterp-26"><span class="linenos"> 26</span></a><span class="sd">    points are valid.</span>
</span><span id="polyinterp-27"><a href="#polyinterp-27"><span class="linenos"> 27</span></a><span class="sd">    Based on polyinterp.m Matlab function in minFunc by Mark Schmidt with some slight</span>
</span><span id="polyinterp-28"><a href="#polyinterp-28"><span class="linenos"> 28</span></a><span class="sd">    modifications.</span>
</span><span id="polyinterp-29"><a href="#polyinterp-29"><span class="linenos"> 29</span></a><span class="sd">    Implemented by: Hao-Jun Michael Shi and Dheevatsa Mudigere</span>
</span><span id="polyinterp-30"><a href="#polyinterp-30"><span class="linenos"> 30</span></a><span class="sd">    Last edited 12/6/18.</span>
</span><span id="polyinterp-31"><a href="#polyinterp-31"><span class="linenos"> 31</span></a>
</span><span id="polyinterp-32"><a href="#polyinterp-32"><span class="linenos"> 32</span></a><span class="sd">    Args:</span>
</span><span id="polyinterp-33"><a href="#polyinterp-33"><span class="linenos"> 33</span></a><span class="sd">        points (nparray): two-dimensional array with each point of form [x f g]</span>
</span><span id="polyinterp-34"><a href="#polyinterp-34"><span class="linenos"> 34</span></a><span class="sd">        x_min_bound (float): minimum value that brackets minimum (default: minimum of points)</span>
</span><span id="polyinterp-35"><a href="#polyinterp-35"><span class="linenos"> 35</span></a><span class="sd">        x_max_bound (float): maximum value that brackets minimum (default: maximum of points)</span>
</span><span id="polyinterp-36"><a href="#polyinterp-36"><span class="linenos"> 36</span></a><span class="sd">        plot (bool): plot interpolating polynomial</span>
</span><span id="polyinterp-37"><a href="#polyinterp-37"><span class="linenos"> 37</span></a>
</span><span id="polyinterp-38"><a href="#polyinterp-38"><span class="linenos"> 38</span></a><span class="sd">    Returns:</span>
</span><span id="polyinterp-39"><a href="#polyinterp-39"><span class="linenos"> 39</span></a><span class="sd">        x_sol (float): minimizer of interpolating polynomial</span>
</span><span id="polyinterp-40"><a href="#polyinterp-40"><span class="linenos"> 40</span></a><span class="sd">        F_min (float): minimum of interpolating polynomial</span>
</span><span id="polyinterp-41"><a href="#polyinterp-41"><span class="linenos"> 41</span></a>
</span><span id="polyinterp-42"><a href="#polyinterp-42"><span class="linenos"> 42</span></a><span class="sd">    Note:</span>
</span><span id="polyinterp-43"><a href="#polyinterp-43"><span class="linenos"> 43</span></a><span class="sd">        Set f or g to np.nan if they are unknown</span>
</span><span id="polyinterp-44"><a href="#polyinterp-44"><span class="linenos"> 44</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="polyinterp-45"><a href="#polyinterp-45"><span class="linenos"> 45</span></a>    <span class="n">no_points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="polyinterp-46"><a href="#polyinterp-46"><span class="linenos"> 46</span></a>    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="polyinterp-47"><a href="#polyinterp-47"><span class="linenos"> 47</span></a>
</span><span id="polyinterp-48"><a href="#polyinterp-48"><span class="linenos"> 48</span></a>    <span class="n">x_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="polyinterp-49"><a href="#polyinterp-49"><span class="linenos"> 49</span></a>    <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="polyinterp-50"><a href="#polyinterp-50"><span class="linenos"> 50</span></a>
</span><span id="polyinterp-51"><a href="#polyinterp-51"><span class="linenos"> 51</span></a>    <span class="c1"># compute bounds of interpolation area</span>
</span><span id="polyinterp-52"><a href="#polyinterp-52"><span class="linenos"> 52</span></a>    <span class="k">if</span> <span class="n">x_min_bound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="polyinterp-53"><a href="#polyinterp-53"><span class="linenos"> 53</span></a>        <span class="n">x_min_bound</span> <span class="o">=</span> <span class="n">x_min</span>
</span><span id="polyinterp-54"><a href="#polyinterp-54"><span class="linenos"> 54</span></a>    <span class="k">if</span> <span class="n">x_max_bound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="polyinterp-55"><a href="#polyinterp-55"><span class="linenos"> 55</span></a>        <span class="n">x_max_bound</span> <span class="o">=</span> <span class="n">x_max</span>
</span><span id="polyinterp-56"><a href="#polyinterp-56"><span class="linenos"> 56</span></a>
</span><span id="polyinterp-57"><a href="#polyinterp-57"><span class="linenos"> 57</span></a>    <span class="c1"># explicit formula for quadratic interpolation</span>
</span><span id="polyinterp-58"><a href="#polyinterp-58"><span class="linenos"> 58</span></a>    <span class="k">if</span> <span class="n">no_points</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="polyinterp-59"><a href="#polyinterp-59"><span class="linenos"> 59</span></a>        <span class="c1"># Solution to quadratic interpolation is given by:</span>
</span><span id="polyinterp-60"><a href="#polyinterp-60"><span class="linenos"> 60</span></a>        <span class="c1"># a = -(f1 - f2 - g1(x1 - x2))/(x1 - x2)^2</span>
</span><span id="polyinterp-61"><a href="#polyinterp-61"><span class="linenos"> 61</span></a>        <span class="c1"># x_min = x1 - g1/(2a)</span>
</span><span id="polyinterp-62"><a href="#polyinterp-62"><span class="linenos"> 62</span></a>        <span class="c1"># if x1 = 0, then is given by:</span>
</span><span id="polyinterp-63"><a href="#polyinterp-63"><span class="linenos"> 63</span></a>        <span class="c1"># x_min = - (g1*x2^2)/(2(f2 - f1 - g1*x2))</span>
</span><span id="polyinterp-64"><a href="#polyinterp-64"><span class="linenos"> 64</span></a>
</span><span id="polyinterp-65"><a href="#polyinterp-65"><span class="linenos"> 65</span></a>        <span class="k">if</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="polyinterp-66"><a href="#polyinterp-66"><span class="linenos"> 66</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="o">-</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
</span><span id="polyinterp-67"><a href="#polyinterp-67"><span class="linenos"> 67</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="polyinterp-68"><a href="#polyinterp-68"><span class="linenos"> 68</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
</span><span id="polyinterp-69"><a href="#polyinterp-69"><span class="linenos"> 69</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
</span><span id="polyinterp-70"><a href="#polyinterp-70"><span class="linenos"> 70</span></a>
</span><span id="polyinterp-71"><a href="#polyinterp-71"><span class="linenos"> 71</span></a>        <span class="n">x_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">x_min_bound</span><span class="p">,</span> <span class="n">x_sol</span><span class="p">),</span> <span class="n">x_max_bound</span><span class="p">)</span>
</span><span id="polyinterp-72"><a href="#polyinterp-72"><span class="linenos"> 72</span></a>
</span><span id="polyinterp-73"><a href="#polyinterp-73"><span class="linenos"> 73</span></a>    <span class="c1"># explicit formula for cubic interpolation</span>
</span><span id="polyinterp-74"><a href="#polyinterp-74"><span class="linenos"> 74</span></a>    <span class="k">elif</span> <span class="n">no_points</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="polyinterp-75"><a href="#polyinterp-75"><span class="linenos"> 75</span></a>        <span class="c1"># Solution to cubic interpolation is given by:</span>
</span><span id="polyinterp-76"><a href="#polyinterp-76"><span class="linenos"> 76</span></a>        <span class="c1"># d1 = g1 + g2 - 3((f1 - f2)/(x1 - x2))</span>
</span><span id="polyinterp-77"><a href="#polyinterp-77"><span class="linenos"> 77</span></a>        <span class="c1"># d2 = sqrt(d1^2 - g1*g2)</span>
</span><span id="polyinterp-78"><a href="#polyinterp-78"><span class="linenos"> 78</span></a>        <span class="c1"># x_min = x2 - (x2 - x1)*((g2 + d2 - d1)/(g2 - g1 + 2*d2))</span>
</span><span id="polyinterp-79"><a href="#polyinterp-79"><span class="linenos"> 79</span></a>        <span class="n">d1</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">((</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
</span><span id="polyinterp-80"><a href="#polyinterp-80"><span class="linenos"> 80</span></a>        <span class="n">d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="polyinterp-81"><a href="#polyinterp-81"><span class="linenos"> 81</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">d2</span><span class="p">):</span>
</span><span id="polyinterp-82"><a href="#polyinterp-82"><span class="linenos"> 82</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">((</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">-</span> <span class="n">d1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d2</span><span class="p">))</span>
</span><span id="polyinterp-83"><a href="#polyinterp-83"><span class="linenos"> 83</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">x_min_bound</span><span class="p">,</span> <span class="n">x_sol</span><span class="p">),</span> <span class="n">x_max_bound</span><span class="p">)</span>
</span><span id="polyinterp-84"><a href="#polyinterp-84"><span class="linenos"> 84</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="polyinterp-85"><a href="#polyinterp-85"><span class="linenos"> 85</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_max_bound</span> <span class="o">+</span> <span class="n">x_min_bound</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="polyinterp-86"><a href="#polyinterp-86"><span class="linenos"> 86</span></a>
</span><span id="polyinterp-87"><a href="#polyinterp-87"><span class="linenos"> 87</span></a>    <span class="c1"># solve linear system</span>
</span><span id="polyinterp-88"><a href="#polyinterp-88"><span class="linenos"> 88</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="polyinterp-89"><a href="#polyinterp-89"><span class="linenos"> 89</span></a>        <span class="c1"># define linear constraints</span>
</span><span id="polyinterp-90"><a href="#polyinterp-90"><span class="linenos"> 90</span></a>        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="polyinterp-91"><a href="#polyinterp-91"><span class="linenos"> 91</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="polyinterp-92"><a href="#polyinterp-92"><span class="linenos"> 92</span></a>
</span><span id="polyinterp-93"><a href="#polyinterp-93"><span class="linenos"> 93</span></a>        <span class="c1"># add linear constraints on function values</span>
</span><span id="polyinterp-94"><a href="#polyinterp-94"><span class="linenos"> 94</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_points</span><span class="p">):</span>
</span><span id="polyinterp-95"><a href="#polyinterp-95"><span class="linenos"> 95</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
</span><span id="polyinterp-96"><a href="#polyinterp-96"><span class="linenos"> 96</span></a>                <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="polyinterp-97"><a href="#polyinterp-97"><span class="linenos"> 97</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="polyinterp-98"><a href="#polyinterp-98"><span class="linenos"> 98</span></a>                    <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="n">j</span>
</span><span id="polyinterp-99"><a href="#polyinterp-99"><span class="linenos"> 99</span></a>                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="polyinterp-100"><a href="#polyinterp-100"><span class="linenos">100</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="polyinterp-101"><a href="#polyinterp-101"><span class="linenos">101</span></a>
</span><span id="polyinterp-102"><a href="#polyinterp-102"><span class="linenos">102</span></a>        <span class="c1"># add linear constraints on gradient values</span>
</span><span id="polyinterp-103"><a href="#polyinterp-103"><span class="linenos">103</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_points</span><span class="p">):</span>
</span><span id="polyinterp-104"><a href="#polyinterp-104"><span class="linenos">104</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]):</span>
</span><span id="polyinterp-105"><a href="#polyinterp-105"><span class="linenos">105</span></a>                <span class="n">constraint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="polyinterp-106"><a href="#polyinterp-106"><span class="linenos">106</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
</span><span id="polyinterp-107"><a href="#polyinterp-107"><span class="linenos">107</span></a>                    <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">order</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="n">order</span> <span class="o">-</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="polyinterp-108"><a href="#polyinterp-108"><span class="linenos">108</span></a>                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="polyinterp-109"><a href="#polyinterp-109"><span class="linenos">109</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="polyinterp-110"><a href="#polyinterp-110"><span class="linenos">110</span></a>
</span><span id="polyinterp-111"><a href="#polyinterp-111"><span class="linenos">111</span></a>        <span class="c1"># check if system is solvable</span>
</span><span id="polyinterp-112"><a href="#polyinterp-112"><span class="linenos">112</span></a>        <span class="k">if</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">!=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="polyinterp-113"><a href="#polyinterp-113"><span class="linenos">113</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_min_bound</span> <span class="o">+</span> <span class="n">x_max_bound</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="polyinterp-114"><a href="#polyinterp-114"><span class="linenos">114</span></a>            <span class="n">f_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
</span><span id="polyinterp-115"><a href="#polyinterp-115"><span class="linenos">115</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="polyinterp-116"><a href="#polyinterp-116"><span class="linenos">116</span></a>            <span class="c1"># solve linear system for interpolating polynomial</span>
</span><span id="polyinterp-117"><a href="#polyinterp-117"><span class="linenos">117</span></a>            <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span id="polyinterp-118"><a href="#polyinterp-118"><span class="linenos">118</span></a>
</span><span id="polyinterp-119"><a href="#polyinterp-119"><span class="linenos">119</span></a>            <span class="c1"># compute critical points</span>
</span><span id="polyinterp-120"><a href="#polyinterp-120"><span class="linenos">120</span></a>            <span class="n">dcoeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</span><span id="polyinterp-121"><a href="#polyinterp-121"><span class="linenos">121</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="polyinterp-122"><a href="#polyinterp-122"><span class="linenos">122</span></a>                <span class="n">dcoeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">order</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
</span><span id="polyinterp-123"><a href="#polyinterp-123"><span class="linenos">123</span></a>
</span><span id="polyinterp-124"><a href="#polyinterp-124"><span class="linenos">124</span></a>            <span class="n">crit_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_min_bound</span><span class="p">,</span> <span class="n">x_max_bound</span><span class="p">])</span>
</span><span id="polyinterp-125"><a href="#polyinterp-125"><span class="linenos">125</span></a>            <span class="n">crit_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crit_pts</span><span class="p">,</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="polyinterp-126"><a href="#polyinterp-126"><span class="linenos">126</span></a>
</span><span id="polyinterp-127"><a href="#polyinterp-127"><span class="linenos">127</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">dcoeff</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="polyinterp-128"><a href="#polyinterp-128"><span class="linenos">128</span></a>                <span class="n">roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roots</span><span class="p">(</span><span class="n">dcoeff</span><span class="p">)</span>
</span><span id="polyinterp-129"><a href="#polyinterp-129"><span class="linenos">129</span></a>                <span class="n">crit_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crit_pts</span><span class="p">,</span> <span class="n">roots</span><span class="p">)</span>
</span><span id="polyinterp-130"><a href="#polyinterp-130"><span class="linenos">130</span></a>
</span><span id="polyinterp-131"><a href="#polyinterp-131"><span class="linenos">131</span></a>            <span class="c1"># test critical points</span>
</span><span id="polyinterp-132"><a href="#polyinterp-132"><span class="linenos">132</span></a>            <span class="n">f_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
</span><span id="polyinterp-133"><a href="#polyinterp-133"><span class="linenos">133</span></a>            <span class="n">x_sol</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_min_bound</span> <span class="o">+</span> <span class="n">x_max_bound</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># defaults to bisection</span>
</span><span id="polyinterp-134"><a href="#polyinterp-134"><span class="linenos">134</span></a>            <span class="k">for</span> <span class="n">crit_pt</span> <span class="ow">in</span> <span class="n">crit_pts</span><span class="p">:</span>
</span><span id="polyinterp-135"><a href="#polyinterp-135"><span class="linenos">135</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">crit_pt</span><span class="p">)</span> <span class="ow">and</span> <span class="n">crit_pt</span> <span class="o">&gt;=</span> <span class="n">x_min_bound</span> <span class="ow">and</span> <span class="n">crit_pt</span> <span class="o">&lt;=</span> <span class="n">x_max_bound</span><span class="p">:</span>
</span><span id="polyinterp-136"><a href="#polyinterp-136"><span class="linenos">136</span></a>                    <span class="n">F_cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">crit_pt</span><span class="p">)</span>
</span><span id="polyinterp-137"><a href="#polyinterp-137"><span class="linenos">137</span></a>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">F_cp</span><span class="p">)</span> <span class="ow">and</span> <span class="n">F_cp</span> <span class="o">&lt;</span> <span class="n">f_min</span><span class="p">:</span>
</span><span id="polyinterp-138"><a href="#polyinterp-138"><span class="linenos">138</span></a>                        <span class="n">x_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">crit_pt</span><span class="p">)</span>
</span><span id="polyinterp-139"><a href="#polyinterp-139"><span class="linenos">139</span></a>                        <span class="n">f_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">F_cp</span><span class="p">)</span>
</span><span id="polyinterp-140"><a href="#polyinterp-140"><span class="linenos">140</span></a>
</span><span id="polyinterp-141"><a href="#polyinterp-141"><span class="linenos">141</span></a>            <span class="k">if</span><span class="p">(</span><span class="n">plot</span><span class="p">):</span>
</span><span id="polyinterp-142"><a href="#polyinterp-142"><span class="linenos">142</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
</span><span id="polyinterp-143"><a href="#polyinterp-143"><span class="linenos">143</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_min_bound</span><span class="p">,</span> <span class="n">x_max_bound</span><span class="p">,</span> <span class="p">(</span><span class="n">x_max_bound</span> <span class="o">-</span> <span class="n">x_min_bound</span><span class="p">)</span><span class="o">/</span><span class="mi">10000</span><span class="p">)</span>
</span><span id="polyinterp-144"><a href="#polyinterp-144"><span class="linenos">144</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="polyinterp-145"><a href="#polyinterp-145"><span class="linenos">145</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="polyinterp-146"><a href="#polyinterp-146"><span class="linenos">146</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_sol</span><span class="p">,</span> <span class="n">f_min</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
</span><span id="polyinterp-147"><a href="#polyinterp-147"><span class="linenos">147</span></a>
</span><span id="polyinterp-148"><a href="#polyinterp-148"><span class="linenos">148</span></a>    <span class="k">return</span> <span class="n">x_sol</span>
</span></pre></div>


            <div class="docstring"><p>Gives the minimizer and minimum of the interpolating polynomial over given points
based on function and derivative information. Defaults to bisection if no critical
points are valid.
Based on polyinterp.m Matlab function in minFunc by Mark Schmidt with some slight
modifications.
Implemented by: Hao-Jun Michael Shi and Dheevatsa Mudigere
Last edited 12/6/18.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>points (nparray):</strong>  two-dimensional array with each point of form [x f g]</li>
<li><strong>x_min_bound (float):</strong>  minimum value that brackets minimum (default: minimum of points)</li>
<li><strong>x_max_bound (float):</strong>  maximum value that brackets minimum (default: maximum of points)</li>
<li><strong>plot (bool):</strong>  plot interpolating polynomial</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>x_sol (float): minimizer of interpolating polynomial
  F_min (float): minimum of interpolating polynomial</p>
</blockquote>

<h6 id="note">Note:</h6>

<blockquote>
  <p>Set f or g to np.nan if they are unknown</p>
</blockquote>
</div>


                </section>
                <section id="LBFGS">
                            <input id="LBFGS-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LBFGS</span><wbr>(<span class="base">torch.optim.optimizer.Optimizer</span>):

                <label class="view-source-button" for="LBFGS-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LBFGS"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LBFGS-151"><a href="#LBFGS-151"><span class="linenos">151</span></a><span class="k">class</span> <span class="nc">LBFGS</span><span class="p">(</span><span class="n">Optimizer</span><span class="p">):</span>
</span><span id="LBFGS-152"><a href="#LBFGS-152"><span class="linenos">152</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LBFGS-153"><a href="#LBFGS-153"><span class="linenos">153</span></a><span class="sd">    Implements the L-BFGS algorithm. Compatible with multi-batch and full-overlap</span>
</span><span id="LBFGS-154"><a href="#LBFGS-154"><span class="linenos">154</span></a><span class="sd">    L-BFGS implementations and (stochastic) Powell damping. Partly based on the </span>
</span><span id="LBFGS-155"><a href="#LBFGS-155"><span class="linenos">155</span></a><span class="sd">    original L-BFGS implementation in PyTorch, Mark Schmidt&#39;s minFunc MATLAB code, </span>
</span><span id="LBFGS-156"><a href="#LBFGS-156"><span class="linenos">156</span></a><span class="sd">    and Michael Overton&#39;s weak Wolfe line search MATLAB code.</span>
</span><span id="LBFGS-157"><a href="#LBFGS-157"><span class="linenos">157</span></a><span class="sd">    Implemented by: Hao-Jun Michael Shi and Dheevatsa Mudigere</span>
</span><span id="LBFGS-158"><a href="#LBFGS-158"><span class="linenos">158</span></a><span class="sd">    Last edited 10/20/20.</span>
</span><span id="LBFGS-159"><a href="#LBFGS-159"><span class="linenos">159</span></a>
</span><span id="LBFGS-160"><a href="#LBFGS-160"><span class="linenos">160</span></a><span class="sd">    Warnings:</span>
</span><span id="LBFGS-161"><a href="#LBFGS-161"><span class="linenos">161</span></a><span class="sd">      . Does not support per-parameter options and parameter groups.</span>
</span><span id="LBFGS-162"><a href="#LBFGS-162"><span class="linenos">162</span></a><span class="sd">      . All parameters have to be on a single device.</span>
</span><span id="LBFGS-163"><a href="#LBFGS-163"><span class="linenos">163</span></a>
</span><span id="LBFGS-164"><a href="#LBFGS-164"><span class="linenos">164</span></a><span class="sd">    Args:</span>
</span><span id="LBFGS-165"><a href="#LBFGS-165"><span class="linenos">165</span></a><span class="sd">        lr (float): steplength or learning rate (default: 1)</span>
</span><span id="LBFGS-166"><a href="#LBFGS-166"><span class="linenos">166</span></a><span class="sd">        history_size (int): update history size (default: 10)</span>
</span><span id="LBFGS-167"><a href="#LBFGS-167"><span class="linenos">167</span></a><span class="sd">        line_search (str): designates line search to use (default: &#39;Wolfe&#39;)</span>
</span><span id="LBFGS-168"><a href="#LBFGS-168"><span class="linenos">168</span></a><span class="sd">            Options:</span>
</span><span id="LBFGS-169"><a href="#LBFGS-169"><span class="linenos">169</span></a><span class="sd">                &#39;None&#39;: uses steplength designated in algorithm</span>
</span><span id="LBFGS-170"><a href="#LBFGS-170"><span class="linenos">170</span></a><span class="sd">                &#39;Armijo&#39;: uses Armijo backtracking line search</span>
</span><span id="LBFGS-171"><a href="#LBFGS-171"><span class="linenos">171</span></a><span class="sd">                &#39;Wolfe&#39;: uses Armijo-Wolfe bracketing line search</span>
</span><span id="LBFGS-172"><a href="#LBFGS-172"><span class="linenos">172</span></a><span class="sd">        dtype: data type (default: torch.float)</span>
</span><span id="LBFGS-173"><a href="#LBFGS-173"><span class="linenos">173</span></a><span class="sd">        debug (bool): debugging mode</span>
</span><span id="LBFGS-174"><a href="#LBFGS-174"><span class="linenos">174</span></a>
</span><span id="LBFGS-175"><a href="#LBFGS-175"><span class="linenos">175</span></a><span class="sd">    References:</span>
</span><span id="LBFGS-176"><a href="#LBFGS-176"><span class="linenos">176</span></a><span class="sd">    [1] Berahas, Albert S., Jorge Nocedal, and Martin Takc. &quot;A Multi-Batch L-BFGS </span>
</span><span id="LBFGS-177"><a href="#LBFGS-177"><span class="linenos">177</span></a><span class="sd">        Method for Machine Learning.&quot; Advances in Neural Information Processing </span>
</span><span id="LBFGS-178"><a href="#LBFGS-178"><span class="linenos">178</span></a><span class="sd">        Systems. 2016.</span>
</span><span id="LBFGS-179"><a href="#LBFGS-179"><span class="linenos">179</span></a><span class="sd">    [2] Bollapragada, Raghu, et al. &quot;A Progressive Batching L-BFGS Method for Machine </span>
</span><span id="LBFGS-180"><a href="#LBFGS-180"><span class="linenos">180</span></a><span class="sd">        Learning.&quot; International Conference on Machine Learning. 2018.</span>
</span><span id="LBFGS-181"><a href="#LBFGS-181"><span class="linenos">181</span></a><span class="sd">    [3] Lewis, Adrian S., and Michael L. Overton. &quot;Nonsmooth Optimization via Quasi-Newton</span>
</span><span id="LBFGS-182"><a href="#LBFGS-182"><span class="linenos">182</span></a><span class="sd">        Methods.&quot; Mathematical Programming 141.1-2 (2013): 135-163.</span>
</span><span id="LBFGS-183"><a href="#LBFGS-183"><span class="linenos">183</span></a><span class="sd">    [4] Liu, Dong C., and Jorge Nocedal. &quot;On the Limited Memory BFGS Method for </span>
</span><span id="LBFGS-184"><a href="#LBFGS-184"><span class="linenos">184</span></a><span class="sd">        Large Scale Optimization.&quot; Mathematical Programming 45.1-3 (1989): 503-528.</span>
</span><span id="LBFGS-185"><a href="#LBFGS-185"><span class="linenos">185</span></a><span class="sd">    [5] Nocedal, Jorge. &quot;Updating Quasi-Newton Matrices With Limited Storage.&quot; </span>
</span><span id="LBFGS-186"><a href="#LBFGS-186"><span class="linenos">186</span></a><span class="sd">        Mathematics of Computation 35.151 (1980): 773-782.</span>
</span><span id="LBFGS-187"><a href="#LBFGS-187"><span class="linenos">187</span></a><span class="sd">    [6] Nocedal, Jorge, and Stephen J. Wright. &quot;Numerical Optimization.&quot; Springer New York,</span>
</span><span id="LBFGS-188"><a href="#LBFGS-188"><span class="linenos">188</span></a><span class="sd">        2006.</span>
</span><span id="LBFGS-189"><a href="#LBFGS-189"><span class="linenos">189</span></a><span class="sd">    [7] Schmidt, Mark. &quot;minFunc: Unconstrained Differentiable Multivariate Optimization </span>
</span><span id="LBFGS-190"><a href="#LBFGS-190"><span class="linenos">190</span></a><span class="sd">        in Matlab.&quot; Software available at http://www.cs.ubc.ca/~schmidtm/Software/minFunc.html </span>
</span><span id="LBFGS-191"><a href="#LBFGS-191"><span class="linenos">191</span></a><span class="sd">        (2005).</span>
</span><span id="LBFGS-192"><a href="#LBFGS-192"><span class="linenos">192</span></a><span class="sd">    [8] Schraudolph, Nicol N., Jin Yu, and Simon Gnter. &quot;A Stochastic Quasi-Newton </span>
</span><span id="LBFGS-193"><a href="#LBFGS-193"><span class="linenos">193</span></a><span class="sd">        Method for Online Convex Optimization.&quot; Artificial Intelligence and Statistics. </span>
</span><span id="LBFGS-194"><a href="#LBFGS-194"><span class="linenos">194</span></a><span class="sd">        2007.</span>
</span><span id="LBFGS-195"><a href="#LBFGS-195"><span class="linenos">195</span></a><span class="sd">    [9] Wang, Xiao, et al. &quot;Stochastic Quasi-Newton Methods for Nonconvex Stochastic </span>
</span><span id="LBFGS-196"><a href="#LBFGS-196"><span class="linenos">196</span></a><span class="sd">        Optimization.&quot; SIAM Journal on Optimization 27.2 (2017): 927-956.</span>
</span><span id="LBFGS-197"><a href="#LBFGS-197"><span class="linenos">197</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="LBFGS-198"><a href="#LBFGS-198"><span class="linenos">198</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">line_search</span><span class="o">=</span><span class="s1">&#39;Wolfe&#39;</span><span class="p">,</span>
</span><span id="LBFGS-199"><a href="#LBFGS-199"><span class="linenos">199</span></a>                 <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="LBFGS-200"><a href="#LBFGS-200"><span class="linenos">200</span></a>
</span><span id="LBFGS-201"><a href="#LBFGS-201"><span class="linenos">201</span></a>        <span class="c1"># ensure inputs are valid</span>
</span><span id="LBFGS-202"><a href="#LBFGS-202"><span class="linenos">202</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">lr</span><span class="p">:</span>
</span><span id="LBFGS-203"><a href="#LBFGS-203"><span class="linenos">203</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid learning rate: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>
</span><span id="LBFGS-204"><a href="#LBFGS-204"><span class="linenos">204</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">history_size</span><span class="p">:</span>
</span><span id="LBFGS-205"><a href="#LBFGS-205"><span class="linenos">205</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid history size: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">history_size</span><span class="p">))</span>
</span><span id="LBFGS-206"><a href="#LBFGS-206"><span class="linenos">206</span></a>        <span class="k">if</span> <span class="n">line_search</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Armijo&#39;</span><span class="p">,</span> <span class="s1">&#39;Wolfe&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]:</span>
</span><span id="LBFGS-207"><a href="#LBFGS-207"><span class="linenos">207</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid line search: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_search</span><span class="p">))</span>
</span><span id="LBFGS-208"><a href="#LBFGS-208"><span class="linenos">208</span></a>
</span><span id="LBFGS-209"><a href="#LBFGS-209"><span class="linenos">209</span></a>        <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="n">history_size</span><span class="p">,</span> <span class="n">line_search</span><span class="o">=</span><span class="n">line_search</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
</span><span id="LBFGS-210"><a href="#LBFGS-210"><span class="linenos">210</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">LBFGS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>
</span><span id="LBFGS-211"><a href="#LBFGS-211"><span class="linenos">211</span></a>
</span><span id="LBFGS-212"><a href="#LBFGS-212"><span class="linenos">212</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LBFGS-213"><a href="#LBFGS-213"><span class="linenos">213</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;L-BFGS doesn&#39;t support per-parameter options &quot;</span>
</span><span id="LBFGS-214"><a href="#LBFGS-214"><span class="linenos">214</span></a>                             <span class="s2">&quot;(parameter groups)&quot;</span><span class="p">)</span>
</span><span id="LBFGS-215"><a href="#LBFGS-215"><span class="linenos">215</span></a>
</span><span id="LBFGS-216"><a href="#LBFGS-216"><span class="linenos">216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
</span><span id="LBFGS-217"><a href="#LBFGS-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_numel_cache</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LBFGS-218"><a href="#LBFGS-218"><span class="linenos">218</span></a>
</span><span id="LBFGS-219"><a href="#LBFGS-219"><span class="linenos">219</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="LBFGS-220"><a href="#LBFGS-220"><span class="linenos">220</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;n_iter&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LBFGS-221"><a href="#LBFGS-221"><span class="linenos">221</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;curv_skips&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LBFGS-222"><a href="#LBFGS-222"><span class="linenos">222</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;fail_skips&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LBFGS-223"><a href="#LBFGS-223"><span class="linenos">223</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;H_diag&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LBFGS-224"><a href="#LBFGS-224"><span class="linenos">224</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="LBFGS-225"><a href="#LBFGS-225"><span class="linenos">225</span></a>
</span><span id="LBFGS-226"><a href="#LBFGS-226"><span class="linenos">226</span></a>        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;old_dirs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LBFGS-227"><a href="#LBFGS-227"><span class="linenos">227</span></a>        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;old_stps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LBFGS-228"><a href="#LBFGS-228"><span class="linenos">228</span></a>
</span><span id="LBFGS-229"><a href="#LBFGS-229"><span class="linenos">229</span></a>    <span class="k">def</span> <span class="nf">_numel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LBFGS-230"><a href="#LBFGS-230"><span class="linenos">230</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numel_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LBFGS-231"><a href="#LBFGS-231"><span class="linenos">231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_numel_cache</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">total</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">total</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LBFGS-232"><a href="#LBFGS-232"><span class="linenos">232</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numel_cache</span>
</span><span id="LBFGS-233"><a href="#LBFGS-233"><span class="linenos">233</span></a>
</span><span id="LBFGS-234"><a href="#LBFGS-234"><span class="linenos">234</span></a>    <span class="k">def</span> <span class="nf">_gather_flat_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LBFGS-235"><a href="#LBFGS-235"><span class="linenos">235</span></a>        <span class="n">views</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LBFGS-236"><a href="#LBFGS-236"><span class="linenos">236</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
</span><span id="LBFGS-237"><a href="#LBFGS-237"><span class="linenos">237</span></a>            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LBFGS-238"><a href="#LBFGS-238"><span class="linenos">238</span></a>                <span class="n">view</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
</span><span id="LBFGS-239"><a href="#LBFGS-239"><span class="linenos">239</span></a>            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">is_sparse</span><span class="p">:</span>
</span><span id="LBFGS-240"><a href="#LBFGS-240"><span class="linenos">240</span></a>                <span class="n">view</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dense</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LBFGS-241"><a href="#LBFGS-241"><span class="linenos">241</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-242"><a href="#LBFGS-242"><span class="linenos">242</span></a>                <span class="n">view</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LBFGS-243"><a href="#LBFGS-243"><span class="linenos">243</span></a>            <span class="n">views</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="LBFGS-244"><a href="#LBFGS-244"><span class="linenos">244</span></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LBFGS-245"><a href="#LBFGS-245"><span class="linenos">245</span></a>
</span><span id="LBFGS-246"><a href="#LBFGS-246"><span class="linenos">246</span></a>    <span class="k">def</span> <span class="nf">_add_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">update</span><span class="p">):</span>
</span><span id="LBFGS-247"><a href="#LBFGS-247"><span class="linenos">247</span></a>        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LBFGS-248"><a href="#LBFGS-248"><span class="linenos">248</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
</span><span id="LBFGS-249"><a href="#LBFGS-249"><span class="linenos">249</span></a>            <span class="n">numel</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
</span><span id="LBFGS-250"><a href="#LBFGS-250"><span class="linenos">250</span></a>            <span class="c1"># view as to avoid deprecated pointwise semantics</span>
</span><span id="LBFGS-251"><a href="#LBFGS-251"><span class="linenos">251</span></a>            <span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">step_size</span><span class="p">,</span> <span class="n">update</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">numel</span><span class="p">]</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</span><span id="LBFGS-252"><a href="#LBFGS-252"><span class="linenos">252</span></a>            <span class="n">offset</span> <span class="o">+=</span> <span class="n">numel</span>
</span><span id="LBFGS-253"><a href="#LBFGS-253"><span class="linenos">253</span></a>        <span class="k">assert</span> <span class="n">offset</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numel</span><span class="p">()</span>
</span><span id="LBFGS-254"><a href="#LBFGS-254"><span class="linenos">254</span></a>
</span><span id="LBFGS-255"><a href="#LBFGS-255"><span class="linenos">255</span></a>    <span class="k">def</span> <span class="nf">_copy_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LBFGS-256"><a href="#LBFGS-256"><span class="linenos">256</span></a>        <span class="n">current_params</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LBFGS-257"><a href="#LBFGS-257"><span class="linenos">257</span></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
</span><span id="LBFGS-258"><a href="#LBFGS-258"><span class="linenos">258</span></a>            <span class="n">current_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</span><span id="LBFGS-259"><a href="#LBFGS-259"><span class="linenos">259</span></a>        <span class="k">return</span> <span class="n">current_params</span>
</span><span id="LBFGS-260"><a href="#LBFGS-260"><span class="linenos">260</span></a>
</span><span id="LBFGS-261"><a href="#LBFGS-261"><span class="linenos">261</span></a>    <span class="k">def</span> <span class="nf">_load_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_params</span><span class="p">):</span>
</span><span id="LBFGS-262"><a href="#LBFGS-262"><span class="linenos">262</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LBFGS-263"><a href="#LBFGS-263"><span class="linenos">263</span></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">:</span>
</span><span id="LBFGS-264"><a href="#LBFGS-264"><span class="linenos">264</span></a>            <span class="n">param</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">current_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="LBFGS-265"><a href="#LBFGS-265"><span class="linenos">265</span></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-266"><a href="#LBFGS-266"><span class="linenos">266</span></a>
</span><span id="LBFGS-267"><a href="#LBFGS-267"><span class="linenos">267</span></a>    <span class="k">def</span> <span class="nf">line_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line_search</span><span class="p">):</span>
</span><span id="LBFGS-268"><a href="#LBFGS-268"><span class="linenos">268</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LBFGS-269"><a href="#LBFGS-269"><span class="linenos">269</span></a><span class="sd">        Switches line search option.</span>
</span><span id="LBFGS-270"><a href="#LBFGS-270"><span class="linenos">270</span></a><span class="sd">        </span>
</span><span id="LBFGS-271"><a href="#LBFGS-271"><span class="linenos">271</span></a><span class="sd">        Args:</span>
</span><span id="LBFGS-272"><a href="#LBFGS-272"><span class="linenos">272</span></a><span class="sd">            line_search (str): designates line search to use</span>
</span><span id="LBFGS-273"><a href="#LBFGS-273"><span class="linenos">273</span></a><span class="sd">                Options:</span>
</span><span id="LBFGS-274"><a href="#LBFGS-274"><span class="linenos">274</span></a><span class="sd">                    &#39;None&#39;: uses steplength designated in algorithm</span>
</span><span id="LBFGS-275"><a href="#LBFGS-275"><span class="linenos">275</span></a><span class="sd">                    &#39;Armijo&#39;: uses Armijo backtracking line search</span>
</span><span id="LBFGS-276"><a href="#LBFGS-276"><span class="linenos">276</span></a><span class="sd">                    &#39;Wolfe&#39;: uses Armijo-Wolfe bracketing line search</span>
</span><span id="LBFGS-277"><a href="#LBFGS-277"><span class="linenos">277</span></a><span class="sd">        </span>
</span><span id="LBFGS-278"><a href="#LBFGS-278"><span class="linenos">278</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LBFGS-279"><a href="#LBFGS-279"><span class="linenos">279</span></a>        
</span><span id="LBFGS-280"><a href="#LBFGS-280"><span class="linenos">280</span></a>        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LBFGS-281"><a href="#LBFGS-281"><span class="linenos">281</span></a>        <span class="n">group</span><span class="p">[</span><span class="s1">&#39;line_search&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_search</span>
</span><span id="LBFGS-282"><a href="#LBFGS-282"><span class="linenos">282</span></a>        
</span><span id="LBFGS-283"><a href="#LBFGS-283"><span class="linenos">283</span></a>        <span class="k">return</span>
</span><span id="LBFGS-284"><a href="#LBFGS-284"><span class="linenos">284</span></a>
</span><span id="LBFGS-285"><a href="#LBFGS-285"><span class="linenos">285</span></a>    <span class="k">def</span> <span class="nf">two_loop_recursion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
</span><span id="LBFGS-286"><a href="#LBFGS-286"><span class="linenos">286</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LBFGS-287"><a href="#LBFGS-287"><span class="linenos">287</span></a><span class="sd">        Performs two-loop recursion on given vector to obtain Hv.</span>
</span><span id="LBFGS-288"><a href="#LBFGS-288"><span class="linenos">288</span></a>
</span><span id="LBFGS-289"><a href="#LBFGS-289"><span class="linenos">289</span></a><span class="sd">        Args:</span>
</span><span id="LBFGS-290"><a href="#LBFGS-290"><span class="linenos">290</span></a><span class="sd">            vec (tensor): 1-D tensor to apply two-loop recursion to</span>
</span><span id="LBFGS-291"><a href="#LBFGS-291"><span class="linenos">291</span></a>
</span><span id="LBFGS-292"><a href="#LBFGS-292"><span class="linenos">292</span></a><span class="sd">        Output:</span>
</span><span id="LBFGS-293"><a href="#LBFGS-293"><span class="linenos">293</span></a><span class="sd">            r (tensor): matrix-vector product Hv</span>
</span><span id="LBFGS-294"><a href="#LBFGS-294"><span class="linenos">294</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LBFGS-295"><a href="#LBFGS-295"><span class="linenos">295</span></a>
</span><span id="LBFGS-296"><a href="#LBFGS-296"><span class="linenos">296</span></a>        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LBFGS-297"><a href="#LBFGS-297"><span class="linenos">297</span></a>        <span class="n">history_size</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;history_size&#39;</span><span class="p">]</span>
</span><span id="LBFGS-298"><a href="#LBFGS-298"><span class="linenos">298</span></a>
</span><span id="LBFGS-299"><a href="#LBFGS-299"><span class="linenos">299</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="LBFGS-300"><a href="#LBFGS-300"><span class="linenos">300</span></a>        <span class="n">old_dirs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_dirs&#39;</span><span class="p">)</span>    <span class="c1"># change in gradients</span>
</span><span id="LBFGS-301"><a href="#LBFGS-301"><span class="linenos">301</span></a>        <span class="n">old_stps</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_stps&#39;</span><span class="p">)</span>    <span class="c1"># change in iterates</span>
</span><span id="LBFGS-302"><a href="#LBFGS-302"><span class="linenos">302</span></a>        <span class="n">H_diag</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;H_diag&#39;</span><span class="p">)</span>
</span><span id="LBFGS-303"><a href="#LBFGS-303"><span class="linenos">303</span></a>
</span><span id="LBFGS-304"><a href="#LBFGS-304"><span class="linenos">304</span></a>        <span class="c1"># compute the product of the inverse Hessian approximation and the gradient</span>
</span><span id="LBFGS-305"><a href="#LBFGS-305"><span class="linenos">305</span></a>        <span class="n">num_old</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_dirs</span><span class="p">)</span>
</span><span id="LBFGS-306"><a href="#LBFGS-306"><span class="linenos">306</span></a>
</span><span id="LBFGS-307"><a href="#LBFGS-307"><span class="linenos">307</span></a>        <span class="k">if</span> <span class="s1">&#39;rho&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="LBFGS-308"><a href="#LBFGS-308"><span class="linenos">308</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">history_size</span>
</span><span id="LBFGS-309"><a href="#LBFGS-309"><span class="linenos">309</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">history_size</span>
</span><span id="LBFGS-310"><a href="#LBFGS-310"><span class="linenos">310</span></a>        <span class="n">rho</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span>
</span><span id="LBFGS-311"><a href="#LBFGS-311"><span class="linenos">311</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
</span><span id="LBFGS-312"><a href="#LBFGS-312"><span class="linenos">312</span></a>
</span><span id="LBFGS-313"><a href="#LBFGS-313"><span class="linenos">313</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_old</span><span class="p">):</span>
</span><span id="LBFGS-314"><a href="#LBFGS-314"><span class="linenos">314</span></a>            <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">old_stps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">old_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="LBFGS-315"><a href="#LBFGS-315"><span class="linenos">315</span></a>
</span><span id="LBFGS-316"><a href="#LBFGS-316"><span class="linenos">316</span></a>        <span class="n">q</span> <span class="o">=</span> <span class="n">vec</span>
</span><span id="LBFGS-317"><a href="#LBFGS-317"><span class="linenos">317</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_old</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="LBFGS-318"><a href="#LBFGS-318"><span class="linenos">318</span></a>            <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="LBFGS-319"><a href="#LBFGS-319"><span class="linenos">319</span></a>            <span class="n">q</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">old_stps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="LBFGS-320"><a href="#LBFGS-320"><span class="linenos">320</span></a>
</span><span id="LBFGS-321"><a href="#LBFGS-321"><span class="linenos">321</span></a>        <span class="c1"># multiply by initial Hessian </span>
</span><span id="LBFGS-322"><a href="#LBFGS-322"><span class="linenos">322</span></a>        <span class="c1"># r/d is the final direction</span>
</span><span id="LBFGS-323"><a href="#LBFGS-323"><span class="linenos">323</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">H_diag</span><span class="p">)</span>
</span><span id="LBFGS-324"><a href="#LBFGS-324"><span class="linenos">324</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_old</span><span class="p">):</span>
</span><span id="LBFGS-325"><a href="#LBFGS-325"><span class="linenos">325</span></a>            <span class="n">beta</span> <span class="o">=</span> <span class="n">old_stps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="LBFGS-326"><a href="#LBFGS-326"><span class="linenos">326</span></a>            <span class="n">r</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta</span><span class="p">,</span> <span class="n">old_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="LBFGS-327"><a href="#LBFGS-327"><span class="linenos">327</span></a>
</span><span id="LBFGS-328"><a href="#LBFGS-328"><span class="linenos">328</span></a>        <span class="k">return</span> <span class="n">r</span>
</span><span id="LBFGS-329"><a href="#LBFGS-329"><span class="linenos">329</span></a>
</span><span id="LBFGS-330"><a href="#LBFGS-330"><span class="linenos">330</span></a>    <span class="k">def</span> <span class="nf">curvature_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flat_grad</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="LBFGS-331"><a href="#LBFGS-331"><span class="linenos">331</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LBFGS-332"><a href="#LBFGS-332"><span class="linenos">332</span></a><span class="sd">        Performs curvature update.</span>
</span><span id="LBFGS-333"><a href="#LBFGS-333"><span class="linenos">333</span></a>
</span><span id="LBFGS-334"><a href="#LBFGS-334"><span class="linenos">334</span></a><span class="sd">        Args:</span>
</span><span id="LBFGS-335"><a href="#LBFGS-335"><span class="linenos">335</span></a><span class="sd">            flat_grad (tensor): 1-D tensor of flattened gradient for computing </span>
</span><span id="LBFGS-336"><a href="#LBFGS-336"><span class="linenos">336</span></a><span class="sd">                gradient difference with previously stored gradient</span>
</span><span id="LBFGS-337"><a href="#LBFGS-337"><span class="linenos">337</span></a><span class="sd">            eps (float): constant for curvature pair rejection or damping (default: 1e-2)</span>
</span><span id="LBFGS-338"><a href="#LBFGS-338"><span class="linenos">338</span></a><span class="sd">            damping (bool): flag for using Powell damping (default: False)</span>
</span><span id="LBFGS-339"><a href="#LBFGS-339"><span class="linenos">339</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LBFGS-340"><a href="#LBFGS-340"><span class="linenos">340</span></a>
</span><span id="LBFGS-341"><a href="#LBFGS-341"><span class="linenos">341</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="LBFGS-342"><a href="#LBFGS-342"><span class="linenos">342</span></a>
</span><span id="LBFGS-343"><a href="#LBFGS-343"><span class="linenos">343</span></a>        <span class="c1"># load parameters</span>
</span><span id="LBFGS-344"><a href="#LBFGS-344"><span class="linenos">344</span></a>        <span class="k">if</span><span class="p">(</span><span class="n">eps</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="LBFGS-345"><a href="#LBFGS-345"><span class="linenos">345</span></a>            <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid eps; must be positive.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-346"><a href="#LBFGS-346"><span class="linenos">346</span></a>
</span><span id="LBFGS-347"><a href="#LBFGS-347"><span class="linenos">347</span></a>        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LBFGS-348"><a href="#LBFGS-348"><span class="linenos">348</span></a>        <span class="n">history_size</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;history_size&#39;</span><span class="p">]</span>
</span><span id="LBFGS-349"><a href="#LBFGS-349"><span class="linenos">349</span></a>        <span class="n">debug</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span>
</span><span id="LBFGS-350"><a href="#LBFGS-350"><span class="linenos">350</span></a>
</span><span id="LBFGS-351"><a href="#LBFGS-351"><span class="linenos">351</span></a>        <span class="c1"># variables cached in state (for tracing)</span>
</span><span id="LBFGS-352"><a href="#LBFGS-352"><span class="linenos">352</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="LBFGS-353"><a href="#LBFGS-353"><span class="linenos">353</span></a>        <span class="n">fail</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">)</span>
</span><span id="LBFGS-354"><a href="#LBFGS-354"><span class="linenos">354</span></a>        
</span><span id="LBFGS-355"><a href="#LBFGS-355"><span class="linenos">355</span></a>        <span class="c1"># check if line search failed</span>
</span><span id="LBFGS-356"><a href="#LBFGS-356"><span class="linenos">356</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">fail</span><span class="p">:</span>
</span><span id="LBFGS-357"><a href="#LBFGS-357"><span class="linenos">357</span></a>            
</span><span id="LBFGS-358"><a href="#LBFGS-358"><span class="linenos">358</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
</span><span id="LBFGS-359"><a href="#LBFGS-359"><span class="linenos">359</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
</span><span id="LBFGS-360"><a href="#LBFGS-360"><span class="linenos">360</span></a>            <span class="n">old_dirs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_dirs&#39;</span><span class="p">)</span>
</span><span id="LBFGS-361"><a href="#LBFGS-361"><span class="linenos">361</span></a>            <span class="n">old_stps</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_stps&#39;</span><span class="p">)</span>
</span><span id="LBFGS-362"><a href="#LBFGS-362"><span class="linenos">362</span></a>            <span class="n">H_diag</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;H_diag&#39;</span><span class="p">)</span>
</span><span id="LBFGS-363"><a href="#LBFGS-363"><span class="linenos">363</span></a>            <span class="n">prev_flat_grad</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prev_flat_grad&#39;</span><span class="p">)</span>
</span><span id="LBFGS-364"><a href="#LBFGS-364"><span class="linenos">364</span></a>            <span class="n">Bs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Bs&#39;</span><span class="p">)</span>
</span><span id="LBFGS-365"><a href="#LBFGS-365"><span class="linenos">365</span></a>    
</span><span id="LBFGS-366"><a href="#LBFGS-366"><span class="linenos">366</span></a>            <span class="c1"># compute y&#39;s</span>
</span><span id="LBFGS-367"><a href="#LBFGS-367"><span class="linenos">367</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">flat_grad</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">prev_flat_grad</span><span class="p">)</span>
</span><span id="LBFGS-368"><a href="#LBFGS-368"><span class="linenos">368</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span id="LBFGS-369"><a href="#LBFGS-369"><span class="linenos">369</span></a>            <span class="n">sBs</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Bs</span><span class="p">)</span>
</span><span id="LBFGS-370"><a href="#LBFGS-370"><span class="linenos">370</span></a>            <span class="n">ys</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># y*s</span>
</span><span id="LBFGS-371"><a href="#LBFGS-371"><span class="linenos">371</span></a>
</span><span id="LBFGS-372"><a href="#LBFGS-372"><span class="linenos">372</span></a>            <span class="c1"># update L-BFGS matrix</span>
</span><span id="LBFGS-373"><a href="#LBFGS-373"><span class="linenos">373</span></a>            <span class="k">if</span> <span class="n">ys</span> <span class="o">&gt;</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">sBs</span> <span class="ow">or</span> <span class="n">damping</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="LBFGS-374"><a href="#LBFGS-374"><span class="linenos">374</span></a>    
</span><span id="LBFGS-375"><a href="#LBFGS-375"><span class="linenos">375</span></a>                <span class="c1"># perform Powell damping</span>
</span><span id="LBFGS-376"><a href="#LBFGS-376"><span class="linenos">376</span></a>                <span class="k">if</span> <span class="n">damping</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">ys</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="o">*</span><span class="n">sBs</span><span class="p">:</span>
</span><span id="LBFGS-377"><a href="#LBFGS-377"><span class="linenos">377</span></a>                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="LBFGS-378"><a href="#LBFGS-378"><span class="linenos">378</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Applying Powell damping...&#39;</span><span class="p">)</span>
</span><span id="LBFGS-379"><a href="#LBFGS-379"><span class="linenos">379</span></a>                    <span class="n">theta</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">sBs</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sBs</span> <span class="o">-</span> <span class="n">ys</span><span class="p">)</span>
</span><span id="LBFGS-380"><a href="#LBFGS-380"><span class="linenos">380</span></a>                    <span class="n">y</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">Bs</span>
</span><span id="LBFGS-381"><a href="#LBFGS-381"><span class="linenos">381</span></a>    
</span><span id="LBFGS-382"><a href="#LBFGS-382"><span class="linenos">382</span></a>                <span class="c1"># updating memory</span>
</span><span id="LBFGS-383"><a href="#LBFGS-383"><span class="linenos">383</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_dirs</span><span class="p">)</span> <span class="o">==</span> <span class="n">history_size</span><span class="p">:</span>
</span><span id="LBFGS-384"><a href="#LBFGS-384"><span class="linenos">384</span></a>                    <span class="c1"># shift history by one (limited-memory)</span>
</span><span id="LBFGS-385"><a href="#LBFGS-385"><span class="linenos">385</span></a>                    <span class="n">old_dirs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="LBFGS-386"><a href="#LBFGS-386"><span class="linenos">386</span></a>                    <span class="n">old_stps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="LBFGS-387"><a href="#LBFGS-387"><span class="linenos">387</span></a>    
</span><span id="LBFGS-388"><a href="#LBFGS-388"><span class="linenos">388</span></a>                <span class="c1"># store new direction/step</span>
</span><span id="LBFGS-389"><a href="#LBFGS-389"><span class="linenos">389</span></a>                <span class="n">old_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="LBFGS-390"><a href="#LBFGS-390"><span class="linenos">390</span></a>                <span class="n">old_stps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="LBFGS-391"><a href="#LBFGS-391"><span class="linenos">391</span></a>    
</span><span id="LBFGS-392"><a href="#LBFGS-392"><span class="linenos">392</span></a>                <span class="c1"># update scale of initial Hessian approximation</span>
</span><span id="LBFGS-393"><a href="#LBFGS-393"><span class="linenos">393</span></a>                <span class="n">H_diag</span> <span class="o">=</span> <span class="n">ys</span> <span class="o">/</span> <span class="n">y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># (y*y)</span>
</span><span id="LBFGS-394"><a href="#LBFGS-394"><span class="linenos">394</span></a>                
</span><span id="LBFGS-395"><a href="#LBFGS-395"><span class="linenos">395</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;old_dirs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_dirs</span>
</span><span id="LBFGS-396"><a href="#LBFGS-396"><span class="linenos">396</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;old_stps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_stps</span>
</span><span id="LBFGS-397"><a href="#LBFGS-397"><span class="linenos">397</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;H_diag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">H_diag</span>
</span><span id="LBFGS-398"><a href="#LBFGS-398"><span class="linenos">398</span></a>
</span><span id="LBFGS-399"><a href="#LBFGS-399"><span class="linenos">399</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-400"><a href="#LBFGS-400"><span class="linenos">400</span></a>                <span class="c1"># save skip</span>
</span><span id="LBFGS-401"><a href="#LBFGS-401"><span class="linenos">401</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;curv_skips&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-402"><a href="#LBFGS-402"><span class="linenos">402</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="LBFGS-403"><a href="#LBFGS-403"><span class="linenos">403</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Curvature pair skipped due to failed criterion&#39;</span><span class="p">)</span>
</span><span id="LBFGS-404"><a href="#LBFGS-404"><span class="linenos">404</span></a>
</span><span id="LBFGS-405"><a href="#LBFGS-405"><span class="linenos">405</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-406"><a href="#LBFGS-406"><span class="linenos">406</span></a>            <span class="c1"># save skip</span>
</span><span id="LBFGS-407"><a href="#LBFGS-407"><span class="linenos">407</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;fail_skips&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-408"><a href="#LBFGS-408"><span class="linenos">408</span></a>            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="LBFGS-409"><a href="#LBFGS-409"><span class="linenos">409</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Line search failed; curvature pair update skipped&#39;</span><span class="p">)</span>
</span><span id="LBFGS-410"><a href="#LBFGS-410"><span class="linenos">410</span></a>
</span><span id="LBFGS-411"><a href="#LBFGS-411"><span class="linenos">411</span></a>        <span class="k">return</span>
</span><span id="LBFGS-412"><a href="#LBFGS-412"><span class="linenos">412</span></a>
</span><span id="LBFGS-413"><a href="#LBFGS-413"><span class="linenos">413</span></a>    <span class="k">def</span> <span class="nf">_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_k</span><span class="p">,</span> <span class="n">g_Ok</span><span class="p">,</span> <span class="n">g_Sk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="LBFGS-414"><a href="#LBFGS-414"><span class="linenos">414</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LBFGS-415"><a href="#LBFGS-415"><span class="linenos">415</span></a><span class="sd">        Performs a single optimization step.</span>
</span><span id="LBFGS-416"><a href="#LBFGS-416"><span class="linenos">416</span></a><span class="sd">        </span>
</span><span id="LBFGS-417"><a href="#LBFGS-417"><span class="linenos">417</span></a><span class="sd">        Args:</span>
</span><span id="LBFGS-418"><a href="#LBFGS-418"><span class="linenos">418</span></a><span class="sd">            p_k (tensor): 1-D tensor specifying search direction</span>
</span><span id="LBFGS-419"><a href="#LBFGS-419"><span class="linenos">419</span></a><span class="sd">            g_Ok (tensor): 1-D tensor of flattened gradient over overlap O_k used</span>
</span><span id="LBFGS-420"><a href="#LBFGS-420"><span class="linenos">420</span></a><span class="sd">                            for gradient differencing in curvature pair update</span>
</span><span id="LBFGS-421"><a href="#LBFGS-421"><span class="linenos">421</span></a><span class="sd">            g_Sk (tensor): 1-D tensor of flattened gradient over full sample S_k</span>
</span><span id="LBFGS-422"><a href="#LBFGS-422"><span class="linenos">422</span></a><span class="sd">                            used for curvature pair damping or rejection criterion,</span>
</span><span id="LBFGS-423"><a href="#LBFGS-423"><span class="linenos">423</span></a><span class="sd">                            if None, will use g_Ok (default: None)</span>
</span><span id="LBFGS-424"><a href="#LBFGS-424"><span class="linenos">424</span></a><span class="sd">            options (dict): contains options for performing line search (default: None)</span>
</span><span id="LBFGS-425"><a href="#LBFGS-425"><span class="linenos">425</span></a>
</span><span id="LBFGS-426"><a href="#LBFGS-426"><span class="linenos">426</span></a><span class="sd">        Options for Armijo backtracking line search:</span>
</span><span id="LBFGS-427"><a href="#LBFGS-427"><span class="linenos">427</span></a><span class="sd">            &#39;closure&#39; (callable): reevaluates model and returns function value</span>
</span><span id="LBFGS-428"><a href="#LBFGS-428"><span class="linenos">428</span></a><span class="sd">            &#39;current_loss&#39; (tensor): objective value at current iterate (default: F(x_k))</span>
</span><span id="LBFGS-429"><a href="#LBFGS-429"><span class="linenos">429</span></a><span class="sd">            &#39;gtd&#39; (tensor): inner product g_Ok&#39;d in line search (default: g_Ok&#39;d)</span>
</span><span id="LBFGS-430"><a href="#LBFGS-430"><span class="linenos">430</span></a><span class="sd">            &#39;eta&#39; (tensor): factor for decreasing steplength &gt; 0 (default: 2)</span>
</span><span id="LBFGS-431"><a href="#LBFGS-431"><span class="linenos">431</span></a><span class="sd">            &#39;c1&#39; (tensor): sufficient decrease constant in (0, 1) (default: 1e-4)</span>
</span><span id="LBFGS-432"><a href="#LBFGS-432"><span class="linenos">432</span></a><span class="sd">            &#39;max_ls&#39; (int): maximum number of line search steps permitted (default: 10)</span>
</span><span id="LBFGS-433"><a href="#LBFGS-433"><span class="linenos">433</span></a><span class="sd">            &#39;interpolate&#39; (bool): flag for using interpolation (default: True)</span>
</span><span id="LBFGS-434"><a href="#LBFGS-434"><span class="linenos">434</span></a><span class="sd">            &#39;inplace&#39; (bool): flag for inplace operations (default: True)</span>
</span><span id="LBFGS-435"><a href="#LBFGS-435"><span class="linenos">435</span></a><span class="sd">            &#39;ls_debug&#39; (bool): debugging mode for line search</span>
</span><span id="LBFGS-436"><a href="#LBFGS-436"><span class="linenos">436</span></a>
</span><span id="LBFGS-437"><a href="#LBFGS-437"><span class="linenos">437</span></a><span class="sd">        Options for Wolfe line search:</span>
</span><span id="LBFGS-438"><a href="#LBFGS-438"><span class="linenos">438</span></a><span class="sd">            &#39;closure&#39; (callable): reevaluates model and returns function value</span>
</span><span id="LBFGS-439"><a href="#LBFGS-439"><span class="linenos">439</span></a><span class="sd">            &#39;current_loss&#39; (tensor): objective value at current iterate (default: F(x_k))</span>
</span><span id="LBFGS-440"><a href="#LBFGS-440"><span class="linenos">440</span></a><span class="sd">            &#39;gtd&#39; (tensor): inner product g_Ok&#39;d in line search (default: g_Ok&#39;d)</span>
</span><span id="LBFGS-441"><a href="#LBFGS-441"><span class="linenos">441</span></a><span class="sd">            &#39;eta&#39; (float): factor for extrapolation (default: 2)</span>
</span><span id="LBFGS-442"><a href="#LBFGS-442"><span class="linenos">442</span></a><span class="sd">            &#39;c1&#39; (float): sufficient decrease constant in (0, 1) (default: 1e-4)</span>
</span><span id="LBFGS-443"><a href="#LBFGS-443"><span class="linenos">443</span></a><span class="sd">            &#39;c2&#39; (float): curvature condition constant in (0, 1) (default: 0.9)</span>
</span><span id="LBFGS-444"><a href="#LBFGS-444"><span class="linenos">444</span></a><span class="sd">            &#39;max_ls&#39; (int): maximum number of line search steps permitted (default: 10)</span>
</span><span id="LBFGS-445"><a href="#LBFGS-445"><span class="linenos">445</span></a><span class="sd">            &#39;interpolate&#39; (bool): flag for using interpolation (default: True)</span>
</span><span id="LBFGS-446"><a href="#LBFGS-446"><span class="linenos">446</span></a><span class="sd">            &#39;inplace&#39; (bool): flag for inplace operations (default: True)</span>
</span><span id="LBFGS-447"><a href="#LBFGS-447"><span class="linenos">447</span></a><span class="sd">            &#39;ls_debug&#39; (bool): debugging mode for line search</span>
</span><span id="LBFGS-448"><a href="#LBFGS-448"><span class="linenos">448</span></a>
</span><span id="LBFGS-449"><a href="#LBFGS-449"><span class="linenos">449</span></a><span class="sd">        Outputs (depends on line search):</span>
</span><span id="LBFGS-450"><a href="#LBFGS-450"><span class="linenos">450</span></a><span class="sd">          . No line search:</span>
</span><span id="LBFGS-451"><a href="#LBFGS-451"><span class="linenos">451</span></a><span class="sd">                t (float): steplength</span>
</span><span id="LBFGS-452"><a href="#LBFGS-452"><span class="linenos">452</span></a><span class="sd">          . Armijo backtracking line search:</span>
</span><span id="LBFGS-453"><a href="#LBFGS-453"><span class="linenos">453</span></a><span class="sd">                F_new (tensor): loss function at new iterate</span>
</span><span id="LBFGS-454"><a href="#LBFGS-454"><span class="linenos">454</span></a><span class="sd">                t (tensor): final steplength</span>
</span><span id="LBFGS-455"><a href="#LBFGS-455"><span class="linenos">455</span></a><span class="sd">                ls_step (int): number of backtracks</span>
</span><span id="LBFGS-456"><a href="#LBFGS-456"><span class="linenos">456</span></a><span class="sd">                closure_eval (int): number of closure evaluations</span>
</span><span id="LBFGS-457"><a href="#LBFGS-457"><span class="linenos">457</span></a><span class="sd">                desc_dir (bool): descent direction flag</span>
</span><span id="LBFGS-458"><a href="#LBFGS-458"><span class="linenos">458</span></a><span class="sd">                    True: p_k is descent direction with respect to the line search</span>
</span><span id="LBFGS-459"><a href="#LBFGS-459"><span class="linenos">459</span></a><span class="sd">                    function</span>
</span><span id="LBFGS-460"><a href="#LBFGS-460"><span class="linenos">460</span></a><span class="sd">                    False: p_k is not a descent direction with respect to the line</span>
</span><span id="LBFGS-461"><a href="#LBFGS-461"><span class="linenos">461</span></a><span class="sd">                    search function</span>
</span><span id="LBFGS-462"><a href="#LBFGS-462"><span class="linenos">462</span></a><span class="sd">                fail (bool): failure flag</span>
</span><span id="LBFGS-463"><a href="#LBFGS-463"><span class="linenos">463</span></a><span class="sd">                    True: line search reached maximum number of iterations, failed</span>
</span><span id="LBFGS-464"><a href="#LBFGS-464"><span class="linenos">464</span></a><span class="sd">                    False: line search succeeded</span>
</span><span id="LBFGS-465"><a href="#LBFGS-465"><span class="linenos">465</span></a><span class="sd">          . Wolfe line search:</span>
</span><span id="LBFGS-466"><a href="#LBFGS-466"><span class="linenos">466</span></a><span class="sd">                F_new (tensor): loss function at new iterate</span>
</span><span id="LBFGS-467"><a href="#LBFGS-467"><span class="linenos">467</span></a><span class="sd">                g_new (tensor): gradient at new iterate</span>
</span><span id="LBFGS-468"><a href="#LBFGS-468"><span class="linenos">468</span></a><span class="sd">                t (float): final steplength</span>
</span><span id="LBFGS-469"><a href="#LBFGS-469"><span class="linenos">469</span></a><span class="sd">                ls_step (int): number of backtracks</span>
</span><span id="LBFGS-470"><a href="#LBFGS-470"><span class="linenos">470</span></a><span class="sd">                closure_eval (int): number of closure evaluations</span>
</span><span id="LBFGS-471"><a href="#LBFGS-471"><span class="linenos">471</span></a><span class="sd">                grad_eval (int): number of gradient evaluations</span>
</span><span id="LBFGS-472"><a href="#LBFGS-472"><span class="linenos">472</span></a><span class="sd">                desc_dir (bool): descent direction flag</span>
</span><span id="LBFGS-473"><a href="#LBFGS-473"><span class="linenos">473</span></a><span class="sd">                    True: p_k is descent direction with respect to the line search</span>
</span><span id="LBFGS-474"><a href="#LBFGS-474"><span class="linenos">474</span></a><span class="sd">                    function</span>
</span><span id="LBFGS-475"><a href="#LBFGS-475"><span class="linenos">475</span></a><span class="sd">                    False: p_k is not a descent direction with respect to the line</span>
</span><span id="LBFGS-476"><a href="#LBFGS-476"><span class="linenos">476</span></a><span class="sd">                    search function</span>
</span><span id="LBFGS-477"><a href="#LBFGS-477"><span class="linenos">477</span></a><span class="sd">                fail (bool): failure flag</span>
</span><span id="LBFGS-478"><a href="#LBFGS-478"><span class="linenos">478</span></a><span class="sd">                    True: line search reached maximum number of iterations, failed</span>
</span><span id="LBFGS-479"><a href="#LBFGS-479"><span class="linenos">479</span></a><span class="sd">                    False: line search succeeded</span>
</span><span id="LBFGS-480"><a href="#LBFGS-480"><span class="linenos">480</span></a><span class="sd">                    </span>
</span><span id="LBFGS-481"><a href="#LBFGS-481"><span class="linenos">481</span></a><span class="sd">        Notes:</span>
</span><span id="LBFGS-482"><a href="#LBFGS-482"><span class="linenos">482</span></a><span class="sd">          . If encountering line search failure in the deterministic setting, one</span>
</span><span id="LBFGS-483"><a href="#LBFGS-483"><span class="linenos">483</span></a><span class="sd">            should try increasing the maximum number of line search steps max_ls.</span>
</span><span id="LBFGS-484"><a href="#LBFGS-484"><span class="linenos">484</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LBFGS-485"><a href="#LBFGS-485"><span class="linenos">485</span></a>
</span><span id="LBFGS-486"><a href="#LBFGS-486"><span class="linenos">486</span></a>        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LBFGS-487"><a href="#LBFGS-487"><span class="linenos">487</span></a>            <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LBFGS-488"><a href="#LBFGS-488"><span class="linenos">488</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="LBFGS-489"><a href="#LBFGS-489"><span class="linenos">489</span></a>
</span><span id="LBFGS-490"><a href="#LBFGS-490"><span class="linenos">490</span></a>        <span class="c1"># load parameter options</span>
</span><span id="LBFGS-491"><a href="#LBFGS-491"><span class="linenos">491</span></a>        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LBFGS-492"><a href="#LBFGS-492"><span class="linenos">492</span></a>        <span class="n">lr</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span>
</span><span id="LBFGS-493"><a href="#LBFGS-493"><span class="linenos">493</span></a>        <span class="n">line_search</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;line_search&#39;</span><span class="p">]</span>
</span><span id="LBFGS-494"><a href="#LBFGS-494"><span class="linenos">494</span></a>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span>
</span><span id="LBFGS-495"><a href="#LBFGS-495"><span class="linenos">495</span></a>        <span class="n">debug</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span>
</span><span id="LBFGS-496"><a href="#LBFGS-496"><span class="linenos">496</span></a>
</span><span id="LBFGS-497"><a href="#LBFGS-497"><span class="linenos">497</span></a>        <span class="c1"># variables cached in state (for tracing)</span>
</span><span id="LBFGS-498"><a href="#LBFGS-498"><span class="linenos">498</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="LBFGS-499"><a href="#LBFGS-499"><span class="linenos">499</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
</span><span id="LBFGS-500"><a href="#LBFGS-500"><span class="linenos">500</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
</span><span id="LBFGS-501"><a href="#LBFGS-501"><span class="linenos">501</span></a>        <span class="n">prev_flat_grad</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prev_flat_grad&#39;</span><span class="p">)</span>
</span><span id="LBFGS-502"><a href="#LBFGS-502"><span class="linenos">502</span></a>        <span class="n">Bs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Bs&#39;</span><span class="p">)</span>
</span><span id="LBFGS-503"><a href="#LBFGS-503"><span class="linenos">503</span></a>
</span><span id="LBFGS-504"><a href="#LBFGS-504"><span class="linenos">504</span></a>        <span class="c1"># keep track of nb of iterations</span>
</span><span id="LBFGS-505"><a href="#LBFGS-505"><span class="linenos">505</span></a>        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-506"><a href="#LBFGS-506"><span class="linenos">506</span></a>
</span><span id="LBFGS-507"><a href="#LBFGS-507"><span class="linenos">507</span></a>        <span class="c1"># set search direction</span>
</span><span id="LBFGS-508"><a href="#LBFGS-508"><span class="linenos">508</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">p_k</span>
</span><span id="LBFGS-509"><a href="#LBFGS-509"><span class="linenos">509</span></a>
</span><span id="LBFGS-510"><a href="#LBFGS-510"><span class="linenos">510</span></a>        <span class="c1"># modify previous gradient</span>
</span><span id="LBFGS-511"><a href="#LBFGS-511"><span class="linenos">511</span></a>        <span class="k">if</span> <span class="n">prev_flat_grad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LBFGS-512"><a href="#LBFGS-512"><span class="linenos">512</span></a>            <span class="n">prev_flat_grad</span> <span class="o">=</span> <span class="n">g_Ok</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="LBFGS-513"><a href="#LBFGS-513"><span class="linenos">513</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-514"><a href="#LBFGS-514"><span class="linenos">514</span></a>            <span class="n">prev_flat_grad</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">g_Ok</span><span class="p">)</span>
</span><span id="LBFGS-515"><a href="#LBFGS-515"><span class="linenos">515</span></a>
</span><span id="LBFGS-516"><a href="#LBFGS-516"><span class="linenos">516</span></a>        <span class="c1"># set initial step size</span>
</span><span id="LBFGS-517"><a href="#LBFGS-517"><span class="linenos">517</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">lr</span>
</span><span id="LBFGS-518"><a href="#LBFGS-518"><span class="linenos">518</span></a>
</span><span id="LBFGS-519"><a href="#LBFGS-519"><span class="linenos">519</span></a>        <span class="c1"># closure evaluation counter</span>
</span><span id="LBFGS-520"><a href="#LBFGS-520"><span class="linenos">520</span></a>        <span class="n">closure_eval</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LBFGS-521"><a href="#LBFGS-521"><span class="linenos">521</span></a>
</span><span id="LBFGS-522"><a href="#LBFGS-522"><span class="linenos">522</span></a>        <span class="k">if</span> <span class="n">g_Sk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LBFGS-523"><a href="#LBFGS-523"><span class="linenos">523</span></a>            <span class="n">g_Sk</span> <span class="o">=</span> <span class="n">g_Ok</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="LBFGS-524"><a href="#LBFGS-524"><span class="linenos">524</span></a>
</span><span id="LBFGS-525"><a href="#LBFGS-525"><span class="linenos">525</span></a>        <span class="c1"># perform Armijo backtracking line search</span>
</span><span id="LBFGS-526"><a href="#LBFGS-526"><span class="linenos">526</span></a>        <span class="k">if</span> <span class="n">line_search</span> <span class="o">==</span> <span class="s1">&#39;Armijo&#39;</span><span class="p">:</span>
</span><span id="LBFGS-527"><a href="#LBFGS-527"><span class="linenos">527</span></a>
</span><span id="LBFGS-528"><a href="#LBFGS-528"><span class="linenos">528</span></a>            <span class="c1"># load options</span>
</span><span id="LBFGS-529"><a href="#LBFGS-529"><span class="linenos">529</span></a>            <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
</span><span id="LBFGS-530"><a href="#LBFGS-530"><span class="linenos">530</span></a>                <span class="k">if</span> <span class="s1">&#39;closure&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-531"><a href="#LBFGS-531"><span class="linenos">531</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;closure option not specified.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-532"><a href="#LBFGS-532"><span class="linenos">532</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-533"><a href="#LBFGS-533"><span class="linenos">533</span></a>                    <span class="n">closure</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;closure&#39;</span><span class="p">]</span>
</span><span id="LBFGS-534"><a href="#LBFGS-534"><span class="linenos">534</span></a>
</span><span id="LBFGS-535"><a href="#LBFGS-535"><span class="linenos">535</span></a>                <span class="k">if</span> <span class="s1">&#39;gtd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-536"><a href="#LBFGS-536"><span class="linenos">536</span></a>                    <span class="n">gtd</span> <span class="o">=</span> <span class="n">g_Sk</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span><span id="LBFGS-537"><a href="#LBFGS-537"><span class="linenos">537</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-538"><a href="#LBFGS-538"><span class="linenos">538</span></a>                    <span class="n">gtd</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;gtd&#39;</span><span class="p">]</span>
</span><span id="LBFGS-539"><a href="#LBFGS-539"><span class="linenos">539</span></a>
</span><span id="LBFGS-540"><a href="#LBFGS-540"><span class="linenos">540</span></a>                <span class="k">if</span> <span class="s1">&#39;current_loss&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-541"><a href="#LBFGS-541"><span class="linenos">541</span></a>                    <span class="n">F_k</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="LBFGS-542"><a href="#LBFGS-542"><span class="linenos">542</span></a>                    <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-543"><a href="#LBFGS-543"><span class="linenos">543</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-544"><a href="#LBFGS-544"><span class="linenos">544</span></a>                    <span class="n">F_k</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;current_loss&#39;</span><span class="p">]</span>
</span><span id="LBFGS-545"><a href="#LBFGS-545"><span class="linenos">545</span></a>
</span><span id="LBFGS-546"><a href="#LBFGS-546"><span class="linenos">546</span></a>                <span class="k">if</span> <span class="s1">&#39;eta&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-547"><a href="#LBFGS-547"><span class="linenos">547</span></a>                    <span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="LBFGS-548"><a href="#LBFGS-548"><span class="linenos">548</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LBFGS-549"><a href="#LBFGS-549"><span class="linenos">549</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid eta; must be positive.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-550"><a href="#LBFGS-550"><span class="linenos">550</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-551"><a href="#LBFGS-551"><span class="linenos">551</span></a>                    <span class="n">eta</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span>
</span><span id="LBFGS-552"><a href="#LBFGS-552"><span class="linenos">552</span></a>
</span><span id="LBFGS-553"><a href="#LBFGS-553"><span class="linenos">553</span></a>                <span class="k">if</span> <span class="s1">&#39;c1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-554"><a href="#LBFGS-554"><span class="linenos">554</span></a>                    <span class="n">c1</span> <span class="o">=</span> <span class="mf">1e-4</span>
</span><span id="LBFGS-555"><a href="#LBFGS-555"><span class="linenos">555</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LBFGS-556"><a href="#LBFGS-556"><span class="linenos">556</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid c1; must be strictly between 0 and 1.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-557"><a href="#LBFGS-557"><span class="linenos">557</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-558"><a href="#LBFGS-558"><span class="linenos">558</span></a>                    <span class="n">c1</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span>
</span><span id="LBFGS-559"><a href="#LBFGS-559"><span class="linenos">559</span></a>
</span><span id="LBFGS-560"><a href="#LBFGS-560"><span class="linenos">560</span></a>                <span class="k">if</span> <span class="s1">&#39;max_ls&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-561"><a href="#LBFGS-561"><span class="linenos">561</span></a>                    <span class="n">max_ls</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="LBFGS-562"><a href="#LBFGS-562"><span class="linenos">562</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_ls&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LBFGS-563"><a href="#LBFGS-563"><span class="linenos">563</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid max_ls; must be positive.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-564"><a href="#LBFGS-564"><span class="linenos">564</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-565"><a href="#LBFGS-565"><span class="linenos">565</span></a>                    <span class="n">max_ls</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_ls&#39;</span><span class="p">]</span>
</span><span id="LBFGS-566"><a href="#LBFGS-566"><span class="linenos">566</span></a>
</span><span id="LBFGS-567"><a href="#LBFGS-567"><span class="linenos">567</span></a>                <span class="k">if</span> <span class="s1">&#39;interpolate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-568"><a href="#LBFGS-568"><span class="linenos">568</span></a>                    <span class="n">interpolate</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LBFGS-569"><a href="#LBFGS-569"><span class="linenos">569</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-570"><a href="#LBFGS-570"><span class="linenos">570</span></a>                    <span class="n">interpolate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;interpolate&#39;</span><span class="p">]</span>
</span><span id="LBFGS-571"><a href="#LBFGS-571"><span class="linenos">571</span></a>
</span><span id="LBFGS-572"><a href="#LBFGS-572"><span class="linenos">572</span></a>                <span class="k">if</span> <span class="s1">&#39;inplace&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-573"><a href="#LBFGS-573"><span class="linenos">573</span></a>                    <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LBFGS-574"><a href="#LBFGS-574"><span class="linenos">574</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-575"><a href="#LBFGS-575"><span class="linenos">575</span></a>                    <span class="n">inplace</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;inplace&#39;</span><span class="p">]</span>
</span><span id="LBFGS-576"><a href="#LBFGS-576"><span class="linenos">576</span></a>                    
</span><span id="LBFGS-577"><a href="#LBFGS-577"><span class="linenos">577</span></a>                <span class="k">if</span> <span class="s1">&#39;ls_debug&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-578"><a href="#LBFGS-578"><span class="linenos">578</span></a>                    <span class="n">ls_debug</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LBFGS-579"><a href="#LBFGS-579"><span class="linenos">579</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-580"><a href="#LBFGS-580"><span class="linenos">580</span></a>                    <span class="n">ls_debug</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;ls_debug&#39;</span><span class="p">]</span>
</span><span id="LBFGS-581"><a href="#LBFGS-581"><span class="linenos">581</span></a>
</span><span id="LBFGS-582"><a href="#LBFGS-582"><span class="linenos">582</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-583"><a href="#LBFGS-583"><span class="linenos">583</span></a>                <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Options are not specified; need closure evaluating function.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-584"><a href="#LBFGS-584"><span class="linenos">584</span></a>
</span><span id="LBFGS-585"><a href="#LBFGS-585"><span class="linenos">585</span></a>            <span class="c1"># initialize values</span>
</span><span id="LBFGS-586"><a href="#LBFGS-586"><span class="linenos">586</span></a>            <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
</span><span id="LBFGS-587"><a href="#LBFGS-587"><span class="linenos">587</span></a>                <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
</span><span id="LBFGS-588"><a href="#LBFGS-588"><span class="linenos">588</span></a>                    <span class="n">F_prev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span><span id="LBFGS-589"><a href="#LBFGS-589"><span class="linenos">589</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-590"><a href="#LBFGS-590"><span class="linenos">590</span></a>                    <span class="n">F_prev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="LBFGS-591"><a href="#LBFGS-591"><span class="linenos">591</span></a>
</span><span id="LBFGS-592"><a href="#LBFGS-592"><span class="linenos">592</span></a>            <span class="n">ls_step</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LBFGS-593"><a href="#LBFGS-593"><span class="linenos">593</span></a>            <span class="n">t_prev</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># old steplength</span>
</span><span id="LBFGS-594"><a href="#LBFGS-594"><span class="linenos">594</span></a>            <span class="n">fail</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># failure flag</span>
</span><span id="LBFGS-595"><a href="#LBFGS-595"><span class="linenos">595</span></a>
</span><span id="LBFGS-596"><a href="#LBFGS-596"><span class="linenos">596</span></a>            <span class="c1"># begin print for debug mode</span>
</span><span id="LBFGS-597"><a href="#LBFGS-597"><span class="linenos">597</span></a>            <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="LBFGS-598"><a href="#LBFGS-598"><span class="linenos">598</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==================================== Begin Armijo line search ===================================&#39;</span><span class="p">)</span>
</span><span id="LBFGS-599"><a href="#LBFGS-599"><span class="linenos">599</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F(x): </span><span class="si">%.8e</span><span class="s1">  g*d: </span><span class="si">%.8e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">F_k</span><span class="p">,</span> <span class="n">gtd</span><span class="p">))</span>
</span><span id="LBFGS-600"><a href="#LBFGS-600"><span class="linenos">600</span></a>
</span><span id="LBFGS-601"><a href="#LBFGS-601"><span class="linenos">601</span></a>            <span class="c1"># check if search direction is descent direction</span>
</span><span id="LBFGS-602"><a href="#LBFGS-602"><span class="linenos">602</span></a>            <span class="k">if</span> <span class="n">gtd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LBFGS-603"><a href="#LBFGS-603"><span class="linenos">603</span></a>                <span class="n">desc_dir</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LBFGS-604"><a href="#LBFGS-604"><span class="linenos">604</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="LBFGS-605"><a href="#LBFGS-605"><span class="linenos">605</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not a descent direction!&#39;</span><span class="p">)</span>
</span><span id="LBFGS-606"><a href="#LBFGS-606"><span class="linenos">606</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-607"><a href="#LBFGS-607"><span class="linenos">607</span></a>                <span class="n">desc_dir</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LBFGS-608"><a href="#LBFGS-608"><span class="linenos">608</span></a>
</span><span id="LBFGS-609"><a href="#LBFGS-609"><span class="linenos">609</span></a>            <span class="c1"># store values if not in-place</span>
</span><span id="LBFGS-610"><a href="#LBFGS-610"><span class="linenos">610</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="LBFGS-611"><a href="#LBFGS-611"><span class="linenos">611</span></a>                <span class="n">current_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_params</span><span class="p">()</span>
</span><span id="LBFGS-612"><a href="#LBFGS-612"><span class="linenos">612</span></a>
</span><span id="LBFGS-613"><a href="#LBFGS-613"><span class="linenos">613</span></a>            <span class="c1"># update and evaluate at new point</span>
</span><span id="LBFGS-614"><a href="#LBFGS-614"><span class="linenos">614</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="LBFGS-615"><a href="#LBFGS-615"><span class="linenos">615</span></a>            <span class="n">F_new</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="LBFGS-616"><a href="#LBFGS-616"><span class="linenos">616</span></a>            <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-617"><a href="#LBFGS-617"><span class="linenos">617</span></a>
</span><span id="LBFGS-618"><a href="#LBFGS-618"><span class="linenos">618</span></a>            <span class="c1"># print info if debugging</span>
</span><span id="LBFGS-619"><a href="#LBFGS-619"><span class="linenos">619</span></a>            <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="LBFGS-620"><a href="#LBFGS-620"><span class="linenos">620</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LS Step: </span><span class="si">%d</span><span class="s1">  t: </span><span class="si">%.8e</span><span class="s1">  F(x+td): </span><span class="si">%.8e</span><span class="s1">  F-c1*t*g*d: </span><span class="si">%.8e</span><span class="s1">  F(x): </span><span class="si">%.8e</span><span class="s1">&#39;</span>
</span><span id="LBFGS-621"><a href="#LBFGS-621"><span class="linenos">621</span></a>                      <span class="o">%</span> <span class="p">(</span><span class="n">ls_step</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">F_new</span><span class="p">,</span> <span class="n">F_k</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">gtd</span><span class="p">,</span> <span class="n">F_k</span><span class="p">))</span>
</span><span id="LBFGS-622"><a href="#LBFGS-622"><span class="linenos">622</span></a>
</span><span id="LBFGS-623"><a href="#LBFGS-623"><span class="linenos">623</span></a>            <span class="c1"># check Armijo condition</span>
</span><span id="LBFGS-624"><a href="#LBFGS-624"><span class="linenos">624</span></a>            <span class="k">while</span> <span class="n">F_new</span> <span class="o">&gt;</span> <span class="n">F_k</span> <span class="o">+</span> <span class="n">c1</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">gtd</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_legal</span><span class="p">(</span><span class="n">F_new</span><span class="p">):</span>
</span><span id="LBFGS-625"><a href="#LBFGS-625"><span class="linenos">625</span></a>
</span><span id="LBFGS-626"><a href="#LBFGS-626"><span class="linenos">626</span></a>                <span class="c1"># check if maximum number of iterations reached</span>
</span><span id="LBFGS-627"><a href="#LBFGS-627"><span class="linenos">627</span></a>                <span class="k">if</span> <span class="n">ls_step</span> <span class="o">&gt;=</span> <span class="n">max_ls</span><span class="p">:</span>
</span><span id="LBFGS-628"><a href="#LBFGS-628"><span class="linenos">628</span></a>                    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="LBFGS-629"><a href="#LBFGS-629"><span class="linenos">629</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="LBFGS-630"><a href="#LBFGS-630"><span class="linenos">630</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-631"><a href="#LBFGS-631"><span class="linenos">631</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_load_params</span><span class="p">(</span><span class="n">current_params</span><span class="p">)</span>
</span><span id="LBFGS-632"><a href="#LBFGS-632"><span class="linenos">632</span></a>
</span><span id="LBFGS-633"><a href="#LBFGS-633"><span class="linenos">633</span></a>                    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LBFGS-634"><a href="#LBFGS-634"><span class="linenos">634</span></a>                    <span class="n">F_new</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="LBFGS-635"><a href="#LBFGS-635"><span class="linenos">635</span></a>                    <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-636"><a href="#LBFGS-636"><span class="linenos">636</span></a>                    <span class="n">fail</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LBFGS-637"><a href="#LBFGS-637"><span class="linenos">637</span></a>                    <span class="k">break</span>
</span><span id="LBFGS-638"><a href="#LBFGS-638"><span class="linenos">638</span></a>
</span><span id="LBFGS-639"><a href="#LBFGS-639"><span class="linenos">639</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-640"><a href="#LBFGS-640"><span class="linenos">640</span></a>                    <span class="c1"># store current steplength</span>
</span><span id="LBFGS-641"><a href="#LBFGS-641"><span class="linenos">641</span></a>                    <span class="n">t_new</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="LBFGS-642"><a href="#LBFGS-642"><span class="linenos">642</span></a>
</span><span id="LBFGS-643"><a href="#LBFGS-643"><span class="linenos">643</span></a>                    <span class="c1"># compute new steplength</span>
</span><span id="LBFGS-644"><a href="#LBFGS-644"><span class="linenos">644</span></a>
</span><span id="LBFGS-645"><a href="#LBFGS-645"><span class="linenos">645</span></a>                    <span class="c1"># if first step or not interpolating, then multiply by factor</span>
</span><span id="LBFGS-646"><a href="#LBFGS-646"><span class="linenos">646</span></a>                    <span class="k">if</span> <span class="n">ls_step</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">interpolate</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_legal</span><span class="p">(</span><span class="n">F_new</span><span class="p">):</span>
</span><span id="LBFGS-647"><a href="#LBFGS-647"><span class="linenos">647</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">/</span><span class="n">eta</span>
</span><span id="LBFGS-648"><a href="#LBFGS-648"><span class="linenos">648</span></a>
</span><span id="LBFGS-649"><a href="#LBFGS-649"><span class="linenos">649</span></a>                    <span class="c1"># if second step, use function value at new point along with </span>
</span><span id="LBFGS-650"><a href="#LBFGS-650"><span class="linenos">650</span></a>                    <span class="c1"># gradient and function at current iterate</span>
</span><span id="LBFGS-651"><a href="#LBFGS-651"><span class="linenos">651</span></a>                    <span class="k">elif</span> <span class="n">ls_step</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_legal</span><span class="p">(</span><span class="n">F_prev</span><span class="p">):</span>
</span><span id="LBFGS-652"><a href="#LBFGS-652"><span class="linenos">652</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="n">polyinterp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="n">F_k</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">gtd</span><span class="o">.</span><span class="n">item</span><span class="p">()],</span> <span class="p">[</span><span class="n">t_new</span><span class="p">,</span> <span class="n">F_new</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]))</span>
</span><span id="LBFGS-653"><a href="#LBFGS-653"><span class="linenos">653</span></a>
</span><span id="LBFGS-654"><a href="#LBFGS-654"><span class="linenos">654</span></a>                    <span class="c1"># otherwise, use function values at new point, previous point,</span>
</span><span id="LBFGS-655"><a href="#LBFGS-655"><span class="linenos">655</span></a>                    <span class="c1"># and gradient and function at current iterate</span>
</span><span id="LBFGS-656"><a href="#LBFGS-656"><span class="linenos">656</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-657"><a href="#LBFGS-657"><span class="linenos">657</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="n">polyinterp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="n">F_k</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">gtd</span><span class="o">.</span><span class="n">item</span><span class="p">()],</span> <span class="p">[</span><span class="n">t_new</span><span class="p">,</span> <span class="n">F_new</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> 
</span><span id="LBFGS-658"><a href="#LBFGS-658"><span class="linenos">658</span></a>                                                <span class="p">[</span><span class="n">t_prev</span><span class="p">,</span> <span class="n">F_prev</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]))</span>
</span><span id="LBFGS-659"><a href="#LBFGS-659"><span class="linenos">659</span></a>
</span><span id="LBFGS-660"><a href="#LBFGS-660"><span class="linenos">660</span></a>                    <span class="c1"># if values are too extreme, adjust t</span>
</span><span id="LBFGS-661"><a href="#LBFGS-661"><span class="linenos">661</span></a>                    <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
</span><span id="LBFGS-662"><a href="#LBFGS-662"><span class="linenos">662</span></a>                        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">t_new</span><span class="p">:</span>
</span><span id="LBFGS-663"><a href="#LBFGS-663"><span class="linenos">663</span></a>                            <span class="n">t</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">t_new</span>
</span><span id="LBFGS-664"><a href="#LBFGS-664"><span class="linenos">664</span></a>                        <span class="k">elif</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">t_new</span><span class="p">:</span>
</span><span id="LBFGS-665"><a href="#LBFGS-665"><span class="linenos">665</span></a>                            <span class="n">t</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">t_new</span>
</span><span id="LBFGS-666"><a href="#LBFGS-666"><span class="linenos">666</span></a>
</span><span id="LBFGS-667"><a href="#LBFGS-667"><span class="linenos">667</span></a>                        <span class="c1"># store old point</span>
</span><span id="LBFGS-668"><a href="#LBFGS-668"><span class="linenos">668</span></a>                        <span class="n">F_prev</span> <span class="o">=</span> <span class="n">F_new</span>
</span><span id="LBFGS-669"><a href="#LBFGS-669"><span class="linenos">669</span></a>                        <span class="n">t_prev</span> <span class="o">=</span> <span class="n">t_new</span>
</span><span id="LBFGS-670"><a href="#LBFGS-670"><span class="linenos">670</span></a>
</span><span id="LBFGS-671"><a href="#LBFGS-671"><span class="linenos">671</span></a>                    <span class="c1"># update iterate and reevaluate</span>
</span><span id="LBFGS-672"><a href="#LBFGS-672"><span class="linenos">672</span></a>                    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="LBFGS-673"><a href="#LBFGS-673"><span class="linenos">673</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_new</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="LBFGS-674"><a href="#LBFGS-674"><span class="linenos">674</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-675"><a href="#LBFGS-675"><span class="linenos">675</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_load_params</span><span class="p">(</span><span class="n">current_params</span><span class="p">)</span>
</span><span id="LBFGS-676"><a href="#LBFGS-676"><span class="linenos">676</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="LBFGS-677"><a href="#LBFGS-677"><span class="linenos">677</span></a>
</span><span id="LBFGS-678"><a href="#LBFGS-678"><span class="linenos">678</span></a>                    <span class="n">F_new</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="LBFGS-679"><a href="#LBFGS-679"><span class="linenos">679</span></a>                    <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-680"><a href="#LBFGS-680"><span class="linenos">680</span></a>                    <span class="n">ls_step</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># iterate</span>
</span><span id="LBFGS-681"><a href="#LBFGS-681"><span class="linenos">681</span></a>                    
</span><span id="LBFGS-682"><a href="#LBFGS-682"><span class="linenos">682</span></a>                    <span class="c1"># print info if debugging</span>
</span><span id="LBFGS-683"><a href="#LBFGS-683"><span class="linenos">683</span></a>                    <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="LBFGS-684"><a href="#LBFGS-684"><span class="linenos">684</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LS Step: </span><span class="si">%d</span><span class="s1">  t: </span><span class="si">%.8e</span><span class="s1">  F(x+td):   </span><span class="si">%.8e</span><span class="s1">  F-c1*t*g*d: </span><span class="si">%.8e</span><span class="s1">  F(x): </span><span class="si">%.8e</span><span class="s1">&#39;</span>
</span><span id="LBFGS-685"><a href="#LBFGS-685"><span class="linenos">685</span></a>                              <span class="o">%</span> <span class="p">(</span><span class="n">ls_step</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">F_new</span><span class="p">,</span> <span class="n">F_k</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">gtd</span><span class="p">,</span> <span class="n">F_k</span><span class="p">))</span>
</span><span id="LBFGS-686"><a href="#LBFGS-686"><span class="linenos">686</span></a>
</span><span id="LBFGS-687"><a href="#LBFGS-687"><span class="linenos">687</span></a>            <span class="c1"># store Bs</span>
</span><span id="LBFGS-688"><a href="#LBFGS-688"><span class="linenos">688</span></a>            <span class="k">if</span> <span class="n">Bs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LBFGS-689"><a href="#LBFGS-689"><span class="linenos">689</span></a>                <span class="n">Bs</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_Sk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">))</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="LBFGS-690"><a href="#LBFGS-690"><span class="linenos">690</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-691"><a href="#LBFGS-691"><span class="linenos">691</span></a>                <span class="n">Bs</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">g_Sk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">))</span>
</span><span id="LBFGS-692"><a href="#LBFGS-692"><span class="linenos">692</span></a>                
</span><span id="LBFGS-693"><a href="#LBFGS-693"><span class="linenos">693</span></a>            <span class="c1"># print final steplength</span>
</span><span id="LBFGS-694"><a href="#LBFGS-694"><span class="linenos">694</span></a>            <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="LBFGS-695"><a href="#LBFGS-695"><span class="linenos">695</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final Steplength:&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="LBFGS-696"><a href="#LBFGS-696"><span class="linenos">696</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;===================================== End Armijo line search ====================================&#39;</span><span class="p">)</span>
</span><span id="LBFGS-697"><a href="#LBFGS-697"><span class="linenos">697</span></a>
</span><span id="LBFGS-698"><a href="#LBFGS-698"><span class="linenos">698</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="LBFGS-699"><a href="#LBFGS-699"><span class="linenos">699</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;prev_flat_grad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_flat_grad</span>
</span><span id="LBFGS-700"><a href="#LBFGS-700"><span class="linenos">700</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="LBFGS-701"><a href="#LBFGS-701"><span class="linenos">701</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Bs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bs</span>
</span><span id="LBFGS-702"><a href="#LBFGS-702"><span class="linenos">702</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;fail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fail</span>
</span><span id="LBFGS-703"><a href="#LBFGS-703"><span class="linenos">703</span></a>
</span><span id="LBFGS-704"><a href="#LBFGS-704"><span class="linenos">704</span></a>            <span class="k">return</span> <span class="n">F_new</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ls_step</span><span class="p">,</span> <span class="n">closure_eval</span><span class="p">,</span> <span class="n">desc_dir</span><span class="p">,</span> <span class="n">fail</span>
</span><span id="LBFGS-705"><a href="#LBFGS-705"><span class="linenos">705</span></a>
</span><span id="LBFGS-706"><a href="#LBFGS-706"><span class="linenos">706</span></a>        <span class="c1"># perform weak Wolfe line search</span>
</span><span id="LBFGS-707"><a href="#LBFGS-707"><span class="linenos">707</span></a>        <span class="k">elif</span> <span class="n">line_search</span> <span class="o">==</span> <span class="s1">&#39;Wolfe&#39;</span><span class="p">:</span>
</span><span id="LBFGS-708"><a href="#LBFGS-708"><span class="linenos">708</span></a>
</span><span id="LBFGS-709"><a href="#LBFGS-709"><span class="linenos">709</span></a>            <span class="c1"># load options</span>
</span><span id="LBFGS-710"><a href="#LBFGS-710"><span class="linenos">710</span></a>            <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
</span><span id="LBFGS-711"><a href="#LBFGS-711"><span class="linenos">711</span></a>                <span class="k">if</span> <span class="s1">&#39;closure&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-712"><a href="#LBFGS-712"><span class="linenos">712</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;closure option not specified.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-713"><a href="#LBFGS-713"><span class="linenos">713</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-714"><a href="#LBFGS-714"><span class="linenos">714</span></a>                    <span class="n">closure</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;closure&#39;</span><span class="p">]</span>
</span><span id="LBFGS-715"><a href="#LBFGS-715"><span class="linenos">715</span></a>
</span><span id="LBFGS-716"><a href="#LBFGS-716"><span class="linenos">716</span></a>                <span class="k">if</span> <span class="s1">&#39;current_loss&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-717"><a href="#LBFGS-717"><span class="linenos">717</span></a>                    <span class="n">F_k</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="LBFGS-718"><a href="#LBFGS-718"><span class="linenos">718</span></a>                    <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-719"><a href="#LBFGS-719"><span class="linenos">719</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-720"><a href="#LBFGS-720"><span class="linenos">720</span></a>                    <span class="n">F_k</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;current_loss&#39;</span><span class="p">]</span>
</span><span id="LBFGS-721"><a href="#LBFGS-721"><span class="linenos">721</span></a>
</span><span id="LBFGS-722"><a href="#LBFGS-722"><span class="linenos">722</span></a>                <span class="k">if</span> <span class="s1">&#39;gtd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-723"><a href="#LBFGS-723"><span class="linenos">723</span></a>                    <span class="n">gtd</span> <span class="o">=</span> <span class="n">g_Sk</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span><span id="LBFGS-724"><a href="#LBFGS-724"><span class="linenos">724</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-725"><a href="#LBFGS-725"><span class="linenos">725</span></a>                    <span class="n">gtd</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;gtd&#39;</span><span class="p">]</span>
</span><span id="LBFGS-726"><a href="#LBFGS-726"><span class="linenos">726</span></a>
</span><span id="LBFGS-727"><a href="#LBFGS-727"><span class="linenos">727</span></a>                <span class="k">if</span> <span class="s1">&#39;eta&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-728"><a href="#LBFGS-728"><span class="linenos">728</span></a>                    <span class="n">eta</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="LBFGS-729"><a href="#LBFGS-729"><span class="linenos">729</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LBFGS-730"><a href="#LBFGS-730"><span class="linenos">730</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid eta; must be greater than 1.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-731"><a href="#LBFGS-731"><span class="linenos">731</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-732"><a href="#LBFGS-732"><span class="linenos">732</span></a>                    <span class="n">eta</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span>
</span><span id="LBFGS-733"><a href="#LBFGS-733"><span class="linenos">733</span></a>
</span><span id="LBFGS-734"><a href="#LBFGS-734"><span class="linenos">734</span></a>                <span class="k">if</span> <span class="s1">&#39;c1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-735"><a href="#LBFGS-735"><span class="linenos">735</span></a>                    <span class="n">c1</span> <span class="o">=</span> <span class="mf">1e-4</span>
</span><span id="LBFGS-736"><a href="#LBFGS-736"><span class="linenos">736</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LBFGS-737"><a href="#LBFGS-737"><span class="linenos">737</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid c1; must be strictly between 0 and 1.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-738"><a href="#LBFGS-738"><span class="linenos">738</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-739"><a href="#LBFGS-739"><span class="linenos">739</span></a>                    <span class="n">c1</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span>
</span><span id="LBFGS-740"><a href="#LBFGS-740"><span class="linenos">740</span></a>
</span><span id="LBFGS-741"><a href="#LBFGS-741"><span class="linenos">741</span></a>                <span class="k">if</span> <span class="s1">&#39;c2&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-742"><a href="#LBFGS-742"><span class="linenos">742</span></a>                    <span class="n">c2</span> <span class="o">=</span> <span class="mf">0.9</span>
</span><span id="LBFGS-743"><a href="#LBFGS-743"><span class="linenos">743</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LBFGS-744"><a href="#LBFGS-744"><span class="linenos">744</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid c2; must be strictly between 0 and 1.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-745"><a href="#LBFGS-745"><span class="linenos">745</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">c1</span><span class="p">:</span>
</span><span id="LBFGS-746"><a href="#LBFGS-746"><span class="linenos">746</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid c2; must be strictly larger than c1.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-747"><a href="#LBFGS-747"><span class="linenos">747</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-748"><a href="#LBFGS-748"><span class="linenos">748</span></a>                    <span class="n">c2</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span>
</span><span id="LBFGS-749"><a href="#LBFGS-749"><span class="linenos">749</span></a>
</span><span id="LBFGS-750"><a href="#LBFGS-750"><span class="linenos">750</span></a>                <span class="k">if</span> <span class="s1">&#39;max_ls&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-751"><a href="#LBFGS-751"><span class="linenos">751</span></a>                    <span class="n">max_ls</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="LBFGS-752"><a href="#LBFGS-752"><span class="linenos">752</span></a>                <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_ls&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LBFGS-753"><a href="#LBFGS-753"><span class="linenos">753</span></a>                    <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid max_ls; must be positive.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-754"><a href="#LBFGS-754"><span class="linenos">754</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-755"><a href="#LBFGS-755"><span class="linenos">755</span></a>                    <span class="n">max_ls</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_ls&#39;</span><span class="p">]</span>
</span><span id="LBFGS-756"><a href="#LBFGS-756"><span class="linenos">756</span></a>
</span><span id="LBFGS-757"><a href="#LBFGS-757"><span class="linenos">757</span></a>                <span class="k">if</span> <span class="s1">&#39;interpolate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-758"><a href="#LBFGS-758"><span class="linenos">758</span></a>                    <span class="n">interpolate</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LBFGS-759"><a href="#LBFGS-759"><span class="linenos">759</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-760"><a href="#LBFGS-760"><span class="linenos">760</span></a>                    <span class="n">interpolate</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;interpolate&#39;</span><span class="p">]</span>
</span><span id="LBFGS-761"><a href="#LBFGS-761"><span class="linenos">761</span></a>
</span><span id="LBFGS-762"><a href="#LBFGS-762"><span class="linenos">762</span></a>                <span class="k">if</span> <span class="s1">&#39;inplace&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-763"><a href="#LBFGS-763"><span class="linenos">763</span></a>                    <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LBFGS-764"><a href="#LBFGS-764"><span class="linenos">764</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-765"><a href="#LBFGS-765"><span class="linenos">765</span></a>                    <span class="n">inplace</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;inplace&#39;</span><span class="p">]</span>
</span><span id="LBFGS-766"><a href="#LBFGS-766"><span class="linenos">766</span></a>                    
</span><span id="LBFGS-767"><a href="#LBFGS-767"><span class="linenos">767</span></a>                <span class="k">if</span> <span class="s1">&#39;ls_debug&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LBFGS-768"><a href="#LBFGS-768"><span class="linenos">768</span></a>                    <span class="n">ls_debug</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LBFGS-769"><a href="#LBFGS-769"><span class="linenos">769</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-770"><a href="#LBFGS-770"><span class="linenos">770</span></a>                    <span class="n">ls_debug</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;ls_debug&#39;</span><span class="p">]</span>
</span><span id="LBFGS-771"><a href="#LBFGS-771"><span class="linenos">771</span></a>
</span><span id="LBFGS-772"><a href="#LBFGS-772"><span class="linenos">772</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-773"><a href="#LBFGS-773"><span class="linenos">773</span></a>                <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Options are not specified; need closure evaluating function.&#39;</span><span class="p">))</span>
</span><span id="LBFGS-774"><a href="#LBFGS-774"><span class="linenos">774</span></a>
</span><span id="LBFGS-775"><a href="#LBFGS-775"><span class="linenos">775</span></a>            <span class="c1"># initialize counters</span>
</span><span id="LBFGS-776"><a href="#LBFGS-776"><span class="linenos">776</span></a>            <span class="n">ls_step</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LBFGS-777"><a href="#LBFGS-777"><span class="linenos">777</span></a>            <span class="n">grad_eval</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># tracks gradient evaluations</span>
</span><span id="LBFGS-778"><a href="#LBFGS-778"><span class="linenos">778</span></a>            <span class="n">t_prev</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># old steplength</span>
</span><span id="LBFGS-779"><a href="#LBFGS-779"><span class="linenos">779</span></a>
</span><span id="LBFGS-780"><a href="#LBFGS-780"><span class="linenos">780</span></a>            <span class="c1"># initialize bracketing variables and flag</span>
</span><span id="LBFGS-781"><a href="#LBFGS-781"><span class="linenos">781</span></a>            <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LBFGS-782"><a href="#LBFGS-782"><span class="linenos">782</span></a>            <span class="n">beta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">)</span>
</span><span id="LBFGS-783"><a href="#LBFGS-783"><span class="linenos">783</span></a>            <span class="n">fail</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LBFGS-784"><a href="#LBFGS-784"><span class="linenos">784</span></a>
</span><span id="LBFGS-785"><a href="#LBFGS-785"><span class="linenos">785</span></a>            <span class="c1"># initialize values for line search</span>
</span><span id="LBFGS-786"><a href="#LBFGS-786"><span class="linenos">786</span></a>            <span class="k">if</span><span class="p">(</span><span class="n">interpolate</span><span class="p">):</span>
</span><span id="LBFGS-787"><a href="#LBFGS-787"><span class="linenos">787</span></a>                <span class="n">F_a</span> <span class="o">=</span> <span class="n">F_k</span>
</span><span id="LBFGS-788"><a href="#LBFGS-788"><span class="linenos">788</span></a>                <span class="n">g_a</span> <span class="o">=</span> <span class="n">gtd</span>
</span><span id="LBFGS-789"><a href="#LBFGS-789"><span class="linenos">789</span></a>
</span><span id="LBFGS-790"><a href="#LBFGS-790"><span class="linenos">790</span></a>                <span class="k">if</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()):</span>
</span><span id="LBFGS-791"><a href="#LBFGS-791"><span class="linenos">791</span></a>                    <span class="n">F_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span><span id="LBFGS-792"><a href="#LBFGS-792"><span class="linenos">792</span></a>                    <span class="n">g_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span><span id="LBFGS-793"><a href="#LBFGS-793"><span class="linenos">793</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-794"><a href="#LBFGS-794"><span class="linenos">794</span></a>                    <span class="n">F_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="LBFGS-795"><a href="#LBFGS-795"><span class="linenos">795</span></a>                    <span class="n">g_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="LBFGS-796"><a href="#LBFGS-796"><span class="linenos">796</span></a>
</span><span id="LBFGS-797"><a href="#LBFGS-797"><span class="linenos">797</span></a>            <span class="c1"># begin print for debug mode</span>
</span><span id="LBFGS-798"><a href="#LBFGS-798"><span class="linenos">798</span></a>            <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="LBFGS-799"><a href="#LBFGS-799"><span class="linenos">799</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==================================== Begin Wolfe line search ====================================&#39;</span><span class="p">)</span>
</span><span id="LBFGS-800"><a href="#LBFGS-800"><span class="linenos">800</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F(x): </span><span class="si">%.8e</span><span class="s1">  g*d: </span><span class="si">%.8e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">F_k</span><span class="p">,</span> <span class="n">gtd</span><span class="p">))</span>
</span><span id="LBFGS-801"><a href="#LBFGS-801"><span class="linenos">801</span></a>
</span><span id="LBFGS-802"><a href="#LBFGS-802"><span class="linenos">802</span></a>            <span class="c1"># check if search direction is descent direction</span>
</span><span id="LBFGS-803"><a href="#LBFGS-803"><span class="linenos">803</span></a>            <span class="k">if</span> <span class="n">gtd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LBFGS-804"><a href="#LBFGS-804"><span class="linenos">804</span></a>                <span class="n">desc_dir</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LBFGS-805"><a href="#LBFGS-805"><span class="linenos">805</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="LBFGS-806"><a href="#LBFGS-806"><span class="linenos">806</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not a descent direction!&#39;</span><span class="p">)</span>
</span><span id="LBFGS-807"><a href="#LBFGS-807"><span class="linenos">807</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-808"><a href="#LBFGS-808"><span class="linenos">808</span></a>                <span class="n">desc_dir</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LBFGS-809"><a href="#LBFGS-809"><span class="linenos">809</span></a>
</span><span id="LBFGS-810"><a href="#LBFGS-810"><span class="linenos">810</span></a>            <span class="c1"># store values if not in-place</span>
</span><span id="LBFGS-811"><a href="#LBFGS-811"><span class="linenos">811</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="LBFGS-812"><a href="#LBFGS-812"><span class="linenos">812</span></a>                <span class="n">current_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_params</span><span class="p">()</span>
</span><span id="LBFGS-813"><a href="#LBFGS-813"><span class="linenos">813</span></a>
</span><span id="LBFGS-814"><a href="#LBFGS-814"><span class="linenos">814</span></a>            <span class="c1"># update and evaluate at new point</span>
</span><span id="LBFGS-815"><a href="#LBFGS-815"><span class="linenos">815</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="LBFGS-816"><a href="#LBFGS-816"><span class="linenos">816</span></a>            <span class="n">F_new</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="LBFGS-817"><a href="#LBFGS-817"><span class="linenos">817</span></a>            <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-818"><a href="#LBFGS-818"><span class="linenos">818</span></a>
</span><span id="LBFGS-819"><a href="#LBFGS-819"><span class="linenos">819</span></a>            <span class="c1"># main loop</span>
</span><span id="LBFGS-820"><a href="#LBFGS-820"><span class="linenos">820</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="LBFGS-821"><a href="#LBFGS-821"><span class="linenos">821</span></a>
</span><span id="LBFGS-822"><a href="#LBFGS-822"><span class="linenos">822</span></a>                <span class="c1"># check if maximum number of line search steps have been reached</span>
</span><span id="LBFGS-823"><a href="#LBFGS-823"><span class="linenos">823</span></a>                <span class="k">if</span> <span class="n">ls_step</span> <span class="o">&gt;=</span> <span class="n">max_ls</span><span class="p">:</span>
</span><span id="LBFGS-824"><a href="#LBFGS-824"><span class="linenos">824</span></a>                    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="LBFGS-825"><a href="#LBFGS-825"><span class="linenos">825</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="LBFGS-826"><a href="#LBFGS-826"><span class="linenos">826</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-827"><a href="#LBFGS-827"><span class="linenos">827</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_load_params</span><span class="p">(</span><span class="n">current_params</span><span class="p">)</span>
</span><span id="LBFGS-828"><a href="#LBFGS-828"><span class="linenos">828</span></a>
</span><span id="LBFGS-829"><a href="#LBFGS-829"><span class="linenos">829</span></a>                    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LBFGS-830"><a href="#LBFGS-830"><span class="linenos">830</span></a>                    <span class="n">F_new</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="LBFGS-831"><a href="#LBFGS-831"><span class="linenos">831</span></a>                    <span class="n">F_new</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="LBFGS-832"><a href="#LBFGS-832"><span class="linenos">832</span></a>                    <span class="n">g_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_flat_grad</span><span class="p">()</span>
</span><span id="LBFGS-833"><a href="#LBFGS-833"><span class="linenos">833</span></a>                    <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-834"><a href="#LBFGS-834"><span class="linenos">834</span></a>                    <span class="n">grad_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-835"><a href="#LBFGS-835"><span class="linenos">835</span></a>                    <span class="n">fail</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LBFGS-836"><a href="#LBFGS-836"><span class="linenos">836</span></a>                    <span class="k">break</span>
</span><span id="LBFGS-837"><a href="#LBFGS-837"><span class="linenos">837</span></a>
</span><span id="LBFGS-838"><a href="#LBFGS-838"><span class="linenos">838</span></a>                <span class="c1"># print info if debugging</span>
</span><span id="LBFGS-839"><a href="#LBFGS-839"><span class="linenos">839</span></a>                <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="LBFGS-840"><a href="#LBFGS-840"><span class="linenos">840</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LS Step: </span><span class="si">%d</span><span class="s1">  t: </span><span class="si">%.8e</span><span class="s1">  alpha: </span><span class="si">%.8e</span><span class="s1">  beta: </span><span class="si">%.8e</span><span class="s1">&#39;</span> 
</span><span id="LBFGS-841"><a href="#LBFGS-841"><span class="linenos">841</span></a>                          <span class="o">%</span> <span class="p">(</span><span class="n">ls_step</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">))</span>
</span><span id="LBFGS-842"><a href="#LBFGS-842"><span class="linenos">842</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Armijo:  F(x+td): </span><span class="si">%.8e</span><span class="s1">  F-c1*t*g*d: </span><span class="si">%.8e</span><span class="s1">  F(x): </span><span class="si">%.8e</span><span class="s1">&#39;</span>
</span><span id="LBFGS-843"><a href="#LBFGS-843"><span class="linenos">843</span></a>                          <span class="o">%</span> <span class="p">(</span><span class="n">F_new</span><span class="p">,</span> <span class="n">F_k</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">gtd</span><span class="p">,</span> <span class="n">F_k</span><span class="p">))</span>
</span><span id="LBFGS-844"><a href="#LBFGS-844"><span class="linenos">844</span></a>
</span><span id="LBFGS-845"><a href="#LBFGS-845"><span class="linenos">845</span></a>                <span class="c1"># check Armijo condition</span>
</span><span id="LBFGS-846"><a href="#LBFGS-846"><span class="linenos">846</span></a>                <span class="k">if</span> <span class="n">F_new</span> <span class="o">&gt;</span> <span class="n">F_k</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">gtd</span><span class="p">:</span>
</span><span id="LBFGS-847"><a href="#LBFGS-847"><span class="linenos">847</span></a>
</span><span id="LBFGS-848"><a href="#LBFGS-848"><span class="linenos">848</span></a>                    <span class="c1"># set upper bound</span>
</span><span id="LBFGS-849"><a href="#LBFGS-849"><span class="linenos">849</span></a>                    <span class="n">beta</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="LBFGS-850"><a href="#LBFGS-850"><span class="linenos">850</span></a>                    <span class="n">t_prev</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="LBFGS-851"><a href="#LBFGS-851"><span class="linenos">851</span></a>
</span><span id="LBFGS-852"><a href="#LBFGS-852"><span class="linenos">852</span></a>                    <span class="c1"># update interpolation quantities</span>
</span><span id="LBFGS-853"><a href="#LBFGS-853"><span class="linenos">853</span></a>                    <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
</span><span id="LBFGS-854"><a href="#LBFGS-854"><span class="linenos">854</span></a>                        <span class="n">F_b</span> <span class="o">=</span> <span class="n">F_new</span>
</span><span id="LBFGS-855"><a href="#LBFGS-855"><span class="linenos">855</span></a>                        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
</span><span id="LBFGS-856"><a href="#LBFGS-856"><span class="linenos">856</span></a>                            <span class="n">g_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span><span id="LBFGS-857"><a href="#LBFGS-857"><span class="linenos">857</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-858"><a href="#LBFGS-858"><span class="linenos">858</span></a>                            <span class="n">g_b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="LBFGS-859"><a href="#LBFGS-859"><span class="linenos">859</span></a>
</span><span id="LBFGS-860"><a href="#LBFGS-860"><span class="linenos">860</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-861"><a href="#LBFGS-861"><span class="linenos">861</span></a>
</span><span id="LBFGS-862"><a href="#LBFGS-862"><span class="linenos">862</span></a>                    <span class="c1"># compute gradient</span>
</span><span id="LBFGS-863"><a href="#LBFGS-863"><span class="linenos">863</span></a>                    <span class="n">F_new</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="LBFGS-864"><a href="#LBFGS-864"><span class="linenos">864</span></a>                    <span class="n">g_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_flat_grad</span><span class="p">()</span>
</span><span id="LBFGS-865"><a href="#LBFGS-865"><span class="linenos">865</span></a>                    <span class="n">grad_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-866"><a href="#LBFGS-866"><span class="linenos">866</span></a>                    <span class="n">gtd_new</span> <span class="o">=</span> <span class="n">g_new</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span><span id="LBFGS-867"><a href="#LBFGS-867"><span class="linenos">867</span></a>                    
</span><span id="LBFGS-868"><a href="#LBFGS-868"><span class="linenos">868</span></a>                    <span class="c1"># print info if debugging</span>
</span><span id="LBFGS-869"><a href="#LBFGS-869"><span class="linenos">869</span></a>                    <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="LBFGS-870"><a href="#LBFGS-870"><span class="linenos">870</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wolfe: g(x+td)*d: </span><span class="si">%.8e</span><span class="s1">  c2*g*d: </span><span class="si">%.8e</span><span class="s1">  gtd: </span><span class="si">%.8e</span><span class="s1">&#39;</span>
</span><span id="LBFGS-871"><a href="#LBFGS-871"><span class="linenos">871</span></a>                              <span class="o">%</span> <span class="p">(</span><span class="n">gtd_new</span><span class="p">,</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">gtd</span><span class="p">,</span> <span class="n">gtd</span><span class="p">))</span>
</span><span id="LBFGS-872"><a href="#LBFGS-872"><span class="linenos">872</span></a>
</span><span id="LBFGS-873"><a href="#LBFGS-873"><span class="linenos">873</span></a>                    <span class="c1"># check curvature condition</span>
</span><span id="LBFGS-874"><a href="#LBFGS-874"><span class="linenos">874</span></a>                    <span class="k">if</span> <span class="n">gtd_new</span> <span class="o">&lt;</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">gtd</span><span class="p">:</span>
</span><span id="LBFGS-875"><a href="#LBFGS-875"><span class="linenos">875</span></a>
</span><span id="LBFGS-876"><a href="#LBFGS-876"><span class="linenos">876</span></a>                        <span class="c1"># set lower bound</span>
</span><span id="LBFGS-877"><a href="#LBFGS-877"><span class="linenos">877</span></a>                        <span class="n">alpha</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="LBFGS-878"><a href="#LBFGS-878"><span class="linenos">878</span></a>                        <span class="n">t_prev</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="LBFGS-879"><a href="#LBFGS-879"><span class="linenos">879</span></a>
</span><span id="LBFGS-880"><a href="#LBFGS-880"><span class="linenos">880</span></a>                        <span class="c1"># update interpolation quantities</span>
</span><span id="LBFGS-881"><a href="#LBFGS-881"><span class="linenos">881</span></a>                        <span class="k">if</span> <span class="n">interpolate</span><span class="p">:</span>
</span><span id="LBFGS-882"><a href="#LBFGS-882"><span class="linenos">882</span></a>                            <span class="n">F_a</span> <span class="o">=</span> <span class="n">F_new</span>
</span><span id="LBFGS-883"><a href="#LBFGS-883"><span class="linenos">883</span></a>                            <span class="n">g_a</span> <span class="o">=</span> <span class="n">gtd_new</span>
</span><span id="LBFGS-884"><a href="#LBFGS-884"><span class="linenos">884</span></a>
</span><span id="LBFGS-885"><a href="#LBFGS-885"><span class="linenos">885</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-886"><a href="#LBFGS-886"><span class="linenos">886</span></a>                        <span class="k">break</span>
</span><span id="LBFGS-887"><a href="#LBFGS-887"><span class="linenos">887</span></a>
</span><span id="LBFGS-888"><a href="#LBFGS-888"><span class="linenos">888</span></a>                <span class="c1"># compute new steplength</span>
</span><span id="LBFGS-889"><a href="#LBFGS-889"><span class="linenos">889</span></a>
</span><span id="LBFGS-890"><a href="#LBFGS-890"><span class="linenos">890</span></a>                <span class="c1"># if first step or not interpolating, then bisect or multiply by factor</span>
</span><span id="LBFGS-891"><a href="#LBFGS-891"><span class="linenos">891</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">interpolate</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_legal</span><span class="p">(</span><span class="n">F_b</span><span class="p">):</span>
</span><span id="LBFGS-892"><a href="#LBFGS-892"><span class="linenos">892</span></a>                    <span class="k">if</span> <span class="n">beta</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">):</span>
</span><span id="LBFGS-893"><a href="#LBFGS-893"><span class="linenos">893</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="n">eta</span><span class="o">*</span><span class="n">t</span>
</span><span id="LBFGS-894"><a href="#LBFGS-894"><span class="linenos">894</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-895"><a href="#LBFGS-895"><span class="linenos">895</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
</span><span id="LBFGS-896"><a href="#LBFGS-896"><span class="linenos">896</span></a>
</span><span id="LBFGS-897"><a href="#LBFGS-897"><span class="linenos">897</span></a>                <span class="c1"># otherwise interpolate between a and b</span>
</span><span id="LBFGS-898"><a href="#LBFGS-898"><span class="linenos">898</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-899"><a href="#LBFGS-899"><span class="linenos">899</span></a>                    <span class="n">t</span> <span class="o">=</span> <span class="n">polyinterp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">alpha</span><span class="p">,</span> <span class="n">F_a</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">g_a</span><span class="o">.</span><span class="n">item</span><span class="p">()],</span> <span class="p">[</span><span class="n">beta</span><span class="p">,</span> <span class="n">F_b</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">g_b</span><span class="o">.</span><span class="n">item</span><span class="p">()]]))</span>
</span><span id="LBFGS-900"><a href="#LBFGS-900"><span class="linenos">900</span></a>
</span><span id="LBFGS-901"><a href="#LBFGS-901"><span class="linenos">901</span></a>                    <span class="c1"># if values are too extreme, adjust t</span>
</span><span id="LBFGS-902"><a href="#LBFGS-902"><span class="linenos">902</span></a>                    <span class="k">if</span> <span class="n">beta</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">):</span>
</span><span id="LBFGS-903"><a href="#LBFGS-903"><span class="linenos">903</span></a>                        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">t_prev</span><span class="p">:</span>
</span><span id="LBFGS-904"><a href="#LBFGS-904"><span class="linenos">904</span></a>                            <span class="n">t</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">t_prev</span>
</span><span id="LBFGS-905"><a href="#LBFGS-905"><span class="linenos">905</span></a>                        <span class="k">elif</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">t_prev</span><span class="p">:</span>
</span><span id="LBFGS-906"><a href="#LBFGS-906"><span class="linenos">906</span></a>                            <span class="n">t</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">t_prev</span>
</span><span id="LBFGS-907"><a href="#LBFGS-907"><span class="linenos">907</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-908"><a href="#LBFGS-908"><span class="linenos">908</span></a>                        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">):</span>
</span><span id="LBFGS-909"><a href="#LBFGS-909"><span class="linenos">909</span></a>                            <span class="n">t</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
</span><span id="LBFGS-910"><a href="#LBFGS-910"><span class="linenos">910</span></a>                        <span class="k">elif</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">:</span>
</span><span id="LBFGS-911"><a href="#LBFGS-911"><span class="linenos">911</span></a>                            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
</span><span id="LBFGS-912"><a href="#LBFGS-912"><span class="linenos">912</span></a>
</span><span id="LBFGS-913"><a href="#LBFGS-913"><span class="linenos">913</span></a>                    <span class="c1"># if we obtain nonsensical value from interpolation</span>
</span><span id="LBFGS-914"><a href="#LBFGS-914"><span class="linenos">914</span></a>                    <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LBFGS-915"><a href="#LBFGS-915"><span class="linenos">915</span></a>                        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
</span><span id="LBFGS-916"><a href="#LBFGS-916"><span class="linenos">916</span></a>
</span><span id="LBFGS-917"><a href="#LBFGS-917"><span class="linenos">917</span></a>                <span class="c1"># update parameters</span>
</span><span id="LBFGS-918"><a href="#LBFGS-918"><span class="linenos">918</span></a>                <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
</span><span id="LBFGS-919"><a href="#LBFGS-919"><span class="linenos">919</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_prev</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="LBFGS-920"><a href="#LBFGS-920"><span class="linenos">920</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-921"><a href="#LBFGS-921"><span class="linenos">921</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_load_params</span><span class="p">(</span><span class="n">current_params</span><span class="p">)</span>
</span><span id="LBFGS-922"><a href="#LBFGS-922"><span class="linenos">922</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="LBFGS-923"><a href="#LBFGS-923"><span class="linenos">923</span></a>
</span><span id="LBFGS-924"><a href="#LBFGS-924"><span class="linenos">924</span></a>                <span class="c1"># evaluate closure</span>
</span><span id="LBFGS-925"><a href="#LBFGS-925"><span class="linenos">925</span></a>                <span class="n">F_new</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>
</span><span id="LBFGS-926"><a href="#LBFGS-926"><span class="linenos">926</span></a>                <span class="n">closure_eval</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-927"><a href="#LBFGS-927"><span class="linenos">927</span></a>                <span class="n">ls_step</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS-928"><a href="#LBFGS-928"><span class="linenos">928</span></a>
</span><span id="LBFGS-929"><a href="#LBFGS-929"><span class="linenos">929</span></a>            <span class="c1"># store Bs</span>
</span><span id="LBFGS-930"><a href="#LBFGS-930"><span class="linenos">930</span></a>            <span class="k">if</span> <span class="n">Bs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LBFGS-931"><a href="#LBFGS-931"><span class="linenos">931</span></a>                <span class="n">Bs</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_Sk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">))</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="LBFGS-932"><a href="#LBFGS-932"><span class="linenos">932</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-933"><a href="#LBFGS-933"><span class="linenos">933</span></a>                <span class="n">Bs</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">g_Sk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">))</span>
</span><span id="LBFGS-934"><a href="#LBFGS-934"><span class="linenos">934</span></a>                
</span><span id="LBFGS-935"><a href="#LBFGS-935"><span class="linenos">935</span></a>            <span class="c1"># print final steplength</span>
</span><span id="LBFGS-936"><a href="#LBFGS-936"><span class="linenos">936</span></a>            <span class="k">if</span> <span class="n">ls_debug</span><span class="p">:</span>
</span><span id="LBFGS-937"><a href="#LBFGS-937"><span class="linenos">937</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final Steplength:&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="LBFGS-938"><a href="#LBFGS-938"><span class="linenos">938</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;===================================== End Wolfe line search =====================================&#39;</span><span class="p">)</span>
</span><span id="LBFGS-939"><a href="#LBFGS-939"><span class="linenos">939</span></a>
</span><span id="LBFGS-940"><a href="#LBFGS-940"><span class="linenos">940</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="LBFGS-941"><a href="#LBFGS-941"><span class="linenos">941</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;prev_flat_grad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_flat_grad</span>
</span><span id="LBFGS-942"><a href="#LBFGS-942"><span class="linenos">942</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="LBFGS-943"><a href="#LBFGS-943"><span class="linenos">943</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Bs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bs</span>
</span><span id="LBFGS-944"><a href="#LBFGS-944"><span class="linenos">944</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;fail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fail</span>
</span><span id="LBFGS-945"><a href="#LBFGS-945"><span class="linenos">945</span></a>
</span><span id="LBFGS-946"><a href="#LBFGS-946"><span class="linenos">946</span></a>            <span class="k">return</span> <span class="n">F_new</span><span class="p">,</span> <span class="n">g_new</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ls_step</span><span class="p">,</span> <span class="n">closure_eval</span><span class="p">,</span> <span class="n">grad_eval</span><span class="p">,</span> <span class="n">desc_dir</span><span class="p">,</span> <span class="n">fail</span>
</span><span id="LBFGS-947"><a href="#LBFGS-947"><span class="linenos">947</span></a>
</span><span id="LBFGS-948"><a href="#LBFGS-948"><span class="linenos">948</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-949"><a href="#LBFGS-949"><span class="linenos">949</span></a>
</span><span id="LBFGS-950"><a href="#LBFGS-950"><span class="linenos">950</span></a>            <span class="c1"># perform update</span>
</span><span id="LBFGS-951"><a href="#LBFGS-951"><span class="linenos">951</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_add_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="LBFGS-952"><a href="#LBFGS-952"><span class="linenos">952</span></a>
</span><span id="LBFGS-953"><a href="#LBFGS-953"><span class="linenos">953</span></a>            <span class="c1"># store Bs</span>
</span><span id="LBFGS-954"><a href="#LBFGS-954"><span class="linenos">954</span></a>            <span class="k">if</span> <span class="n">Bs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LBFGS-955"><a href="#LBFGS-955"><span class="linenos">955</span></a>                <span class="n">Bs</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_Sk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">))</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="LBFGS-956"><a href="#LBFGS-956"><span class="linenos">956</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS-957"><a href="#LBFGS-957"><span class="linenos">957</span></a>                <span class="n">Bs</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">g_Sk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">))</span>
</span><span id="LBFGS-958"><a href="#LBFGS-958"><span class="linenos">958</span></a>
</span><span id="LBFGS-959"><a href="#LBFGS-959"><span class="linenos">959</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="LBFGS-960"><a href="#LBFGS-960"><span class="linenos">960</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;prev_flat_grad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_flat_grad</span>
</span><span id="LBFGS-961"><a href="#LBFGS-961"><span class="linenos">961</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
</span><span id="LBFGS-962"><a href="#LBFGS-962"><span class="linenos">962</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;Bs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Bs</span>
</span><span id="LBFGS-963"><a href="#LBFGS-963"><span class="linenos">963</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;fail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LBFGS-964"><a href="#LBFGS-964"><span class="linenos">964</span></a>
</span><span id="LBFGS-965"><a href="#LBFGS-965"><span class="linenos">965</span></a>            <span class="k">return</span> <span class="n">t</span>
</span><span id="LBFGS-966"><a href="#LBFGS-966"><span class="linenos">966</span></a>        
</span><span id="LBFGS-967"><a href="#LBFGS-967"><span class="linenos">967</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_k</span><span class="p">,</span> <span class="n">g_Ok</span><span class="p">,</span> <span class="n">g_Sk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{}):</span>
</span><span id="LBFGS-968"><a href="#LBFGS-968"><span class="linenos">968</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">(</span><span class="n">p_k</span><span class="p">,</span> <span class="n">g_Ok</span><span class="p">,</span> <span class="n">g_Sk</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Implements the L-BFGS algorithm. Compatible with multi-batch and full-overlap
L-BFGS implementations and (stochastic) Powell damping. Partly based on the 
original L-BFGS implementation in PyTorch, Mark Schmidt's minFunc MATLAB code, 
and Michael Overton's weak Wolfe line search MATLAB code.
Implemented by: Hao-Jun Michael Shi and Dheevatsa Mudigere
Last edited 10/20/20.</p>

<h6 id="warnings">Warnings:</h6>

<blockquote>
  <p>. Does not support per-parameter options and parameter groups.
  . All parameters have to be on a single device.</p>
</blockquote>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>lr (float):</strong>  steplength or learning rate (default: 1)</li>
<li><strong>history_size (int):</strong>  update history size (default: 10)</li>
<li><strong>line_search (str):</strong>  designates line search to use (default: 'Wolfe')
Options:
    'None': uses steplength designated in algorithm
    'Armijo': uses Armijo backtracking line search
    'Wolfe': uses Armijo-Wolfe bracketing line search</li>
<li><strong>dtype:</strong>  data type (default: torch.float)</li>
<li><strong>debug (bool):</strong>  debugging mode</li>
</ul>

<p>References:
[1] Berahas, Albert S., Jorge Nocedal, and Martin Takc. "A Multi-Batch L-BFGS 
    Method for Machine Learning." Advances in Neural Information Processing 
    Systems. 2016.
[2] Bollapragada, Raghu, et al. "A Progressive Batching L-BFGS Method for Machine 
    Learning." International Conference on Machine Learning. 2018.
[3] Lewis, Adrian S., and Michael L. Overton. "Nonsmooth Optimization via Quasi-Newton
    Methods." Mathematical Programming 141.1-2 (2013): 135-163.
[4] Liu, Dong C., and Jorge Nocedal. "On the Limited Memory BFGS Method for 
    Large Scale Optimization." Mathematical Programming 45.1-3 (1989): 503-528.
[5] Nocedal, Jorge. "Updating Quasi-Newton Matrices With Limited Storage." 
    Mathematics of Computation 35.151 (1980): 773-782.
[6] Nocedal, Jorge, and Stephen J. Wright. "Numerical Optimization." Springer New York,
    2006.
[7] Schmidt, Mark. "minFunc: Unconstrained Differentiable Multivariate Optimization 
    in Matlab." Software available at <a href="http://www.cs.ubc.ca/~schmidtm/Software/minFunc.html">http://www.cs.ubc.ca/~schmidtm/Software/minFunc.html</a> 
    (2005).
[8] Schraudolph, Nicol N., Jin Yu, and Simon Gnter. "A Stochastic Quasi-Newton 
    Method for Online Convex Optimization." Artificial Intelligence and Statistics. 
    2007.
[9] Wang, Xiao, et al. "Stochastic Quasi-Newton Methods for Nonconvex Stochastic 
    Optimization." SIAM Journal on Optimization 27.2 (2017): 927-956.</p>
</div>


                            <div id="LBFGS.__init__" class="classattr">
                                        <input id="LBFGS.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LBFGS</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">params</span>,</span><span class="param">	<span class="n">lr</span><span class="o">=</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">history_size</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">line_search</span><span class="o">=</span><span class="s1">&#39;Wolfe&#39;</span>,</span><span class="param">	<span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span>,</span><span class="param">	<span class="n">debug</span><span class="o">=</span><span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="LBFGS.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LBFGS.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LBFGS.__init__-198"><a href="#LBFGS.__init__-198"><span class="linenos">198</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">line_search</span><span class="o">=</span><span class="s1">&#39;Wolfe&#39;</span><span class="p">,</span>
</span><span id="LBFGS.__init__-199"><a href="#LBFGS.__init__-199"><span class="linenos">199</span></a>                 <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="LBFGS.__init__-200"><a href="#LBFGS.__init__-200"><span class="linenos">200</span></a>
</span><span id="LBFGS.__init__-201"><a href="#LBFGS.__init__-201"><span class="linenos">201</span></a>        <span class="c1"># ensure inputs are valid</span>
</span><span id="LBFGS.__init__-202"><a href="#LBFGS.__init__-202"><span class="linenos">202</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">lr</span><span class="p">:</span>
</span><span id="LBFGS.__init__-203"><a href="#LBFGS.__init__-203"><span class="linenos">203</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid learning rate: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>
</span><span id="LBFGS.__init__-204"><a href="#LBFGS.__init__-204"><span class="linenos">204</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">history_size</span><span class="p">:</span>
</span><span id="LBFGS.__init__-205"><a href="#LBFGS.__init__-205"><span class="linenos">205</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid history size: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">history_size</span><span class="p">))</span>
</span><span id="LBFGS.__init__-206"><a href="#LBFGS.__init__-206"><span class="linenos">206</span></a>        <span class="k">if</span> <span class="n">line_search</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Armijo&#39;</span><span class="p">,</span> <span class="s1">&#39;Wolfe&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]:</span>
</span><span id="LBFGS.__init__-207"><a href="#LBFGS.__init__-207"><span class="linenos">207</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid line search: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_search</span><span class="p">))</span>
</span><span id="LBFGS.__init__-208"><a href="#LBFGS.__init__-208"><span class="linenos">208</span></a>
</span><span id="LBFGS.__init__-209"><a href="#LBFGS.__init__-209"><span class="linenos">209</span></a>        <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="n">history_size</span><span class="p">,</span> <span class="n">line_search</span><span class="o">=</span><span class="n">line_search</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
</span><span id="LBFGS.__init__-210"><a href="#LBFGS.__init__-210"><span class="linenos">210</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">LBFGS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>
</span><span id="LBFGS.__init__-211"><a href="#LBFGS.__init__-211"><span class="linenos">211</span></a>
</span><span id="LBFGS.__init__-212"><a href="#LBFGS.__init__-212"><span class="linenos">212</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LBFGS.__init__-213"><a href="#LBFGS.__init__-213"><span class="linenos">213</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;L-BFGS doesn&#39;t support per-parameter options &quot;</span>
</span><span id="LBFGS.__init__-214"><a href="#LBFGS.__init__-214"><span class="linenos">214</span></a>                             <span class="s2">&quot;(parameter groups)&quot;</span><span class="p">)</span>
</span><span id="LBFGS.__init__-215"><a href="#LBFGS.__init__-215"><span class="linenos">215</span></a>
</span><span id="LBFGS.__init__-216"><a href="#LBFGS.__init__-216"><span class="linenos">216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
</span><span id="LBFGS.__init__-217"><a href="#LBFGS.__init__-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_numel_cache</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LBFGS.__init__-218"><a href="#LBFGS.__init__-218"><span class="linenos">218</span></a>
</span><span id="LBFGS.__init__-219"><a href="#LBFGS.__init__-219"><span class="linenos">219</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="LBFGS.__init__-220"><a href="#LBFGS.__init__-220"><span class="linenos">220</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;n_iter&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LBFGS.__init__-221"><a href="#LBFGS.__init__-221"><span class="linenos">221</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;curv_skips&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LBFGS.__init__-222"><a href="#LBFGS.__init__-222"><span class="linenos">222</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;fail_skips&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LBFGS.__init__-223"><a href="#LBFGS.__init__-223"><span class="linenos">223</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;H_diag&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LBFGS.__init__-224"><a href="#LBFGS.__init__-224"><span class="linenos">224</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="LBFGS.__init__-225"><a href="#LBFGS.__init__-225"><span class="linenos">225</span></a>
</span><span id="LBFGS.__init__-226"><a href="#LBFGS.__init__-226"><span class="linenos">226</span></a>        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;old_dirs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LBFGS.__init__-227"><a href="#LBFGS.__init__-227"><span class="linenos">227</span></a>        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;old_stps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></pre></div>


    

                            </div>
                            <div id="LBFGS.line_search" class="classattr">
                                        <input id="LBFGS.line_search-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">line_search</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">line_search</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LBFGS.line_search-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LBFGS.line_search"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LBFGS.line_search-267"><a href="#LBFGS.line_search-267"><span class="linenos">267</span></a>    <span class="k">def</span> <span class="nf">line_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line_search</span><span class="p">):</span>
</span><span id="LBFGS.line_search-268"><a href="#LBFGS.line_search-268"><span class="linenos">268</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LBFGS.line_search-269"><a href="#LBFGS.line_search-269"><span class="linenos">269</span></a><span class="sd">        Switches line search option.</span>
</span><span id="LBFGS.line_search-270"><a href="#LBFGS.line_search-270"><span class="linenos">270</span></a><span class="sd">        </span>
</span><span id="LBFGS.line_search-271"><a href="#LBFGS.line_search-271"><span class="linenos">271</span></a><span class="sd">        Args:</span>
</span><span id="LBFGS.line_search-272"><a href="#LBFGS.line_search-272"><span class="linenos">272</span></a><span class="sd">            line_search (str): designates line search to use</span>
</span><span id="LBFGS.line_search-273"><a href="#LBFGS.line_search-273"><span class="linenos">273</span></a><span class="sd">                Options:</span>
</span><span id="LBFGS.line_search-274"><a href="#LBFGS.line_search-274"><span class="linenos">274</span></a><span class="sd">                    &#39;None&#39;: uses steplength designated in algorithm</span>
</span><span id="LBFGS.line_search-275"><a href="#LBFGS.line_search-275"><span class="linenos">275</span></a><span class="sd">                    &#39;Armijo&#39;: uses Armijo backtracking line search</span>
</span><span id="LBFGS.line_search-276"><a href="#LBFGS.line_search-276"><span class="linenos">276</span></a><span class="sd">                    &#39;Wolfe&#39;: uses Armijo-Wolfe bracketing line search</span>
</span><span id="LBFGS.line_search-277"><a href="#LBFGS.line_search-277"><span class="linenos">277</span></a><span class="sd">        </span>
</span><span id="LBFGS.line_search-278"><a href="#LBFGS.line_search-278"><span class="linenos">278</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LBFGS.line_search-279"><a href="#LBFGS.line_search-279"><span class="linenos">279</span></a>        
</span><span id="LBFGS.line_search-280"><a href="#LBFGS.line_search-280"><span class="linenos">280</span></a>        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LBFGS.line_search-281"><a href="#LBFGS.line_search-281"><span class="linenos">281</span></a>        <span class="n">group</span><span class="p">[</span><span class="s1">&#39;line_search&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_search</span>
</span><span id="LBFGS.line_search-282"><a href="#LBFGS.line_search-282"><span class="linenos">282</span></a>        
</span><span id="LBFGS.line_search-283"><a href="#LBFGS.line_search-283"><span class="linenos">283</span></a>        <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>Switches line search option.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>line_search (str):</strong>  designates line search to use
Options:
    'None': uses steplength designated in algorithm
    'Armijo': uses Armijo backtracking line search
    'Wolfe': uses Armijo-Wolfe bracketing line search</li>
</ul>
</div>


                            </div>
                            <div id="LBFGS.two_loop_recursion" class="classattr">
                                        <input id="LBFGS.two_loop_recursion-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">two_loop_recursion</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">vec</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LBFGS.two_loop_recursion-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LBFGS.two_loop_recursion"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LBFGS.two_loop_recursion-285"><a href="#LBFGS.two_loop_recursion-285"><span class="linenos">285</span></a>    <span class="k">def</span> <span class="nf">two_loop_recursion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
</span><span id="LBFGS.two_loop_recursion-286"><a href="#LBFGS.two_loop_recursion-286"><span class="linenos">286</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LBFGS.two_loop_recursion-287"><a href="#LBFGS.two_loop_recursion-287"><span class="linenos">287</span></a><span class="sd">        Performs two-loop recursion on given vector to obtain Hv.</span>
</span><span id="LBFGS.two_loop_recursion-288"><a href="#LBFGS.two_loop_recursion-288"><span class="linenos">288</span></a>
</span><span id="LBFGS.two_loop_recursion-289"><a href="#LBFGS.two_loop_recursion-289"><span class="linenos">289</span></a><span class="sd">        Args:</span>
</span><span id="LBFGS.two_loop_recursion-290"><a href="#LBFGS.two_loop_recursion-290"><span class="linenos">290</span></a><span class="sd">            vec (tensor): 1-D tensor to apply two-loop recursion to</span>
</span><span id="LBFGS.two_loop_recursion-291"><a href="#LBFGS.two_loop_recursion-291"><span class="linenos">291</span></a>
</span><span id="LBFGS.two_loop_recursion-292"><a href="#LBFGS.two_loop_recursion-292"><span class="linenos">292</span></a><span class="sd">        Output:</span>
</span><span id="LBFGS.two_loop_recursion-293"><a href="#LBFGS.two_loop_recursion-293"><span class="linenos">293</span></a><span class="sd">            r (tensor): matrix-vector product Hv</span>
</span><span id="LBFGS.two_loop_recursion-294"><a href="#LBFGS.two_loop_recursion-294"><span class="linenos">294</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LBFGS.two_loop_recursion-295"><a href="#LBFGS.two_loop_recursion-295"><span class="linenos">295</span></a>
</span><span id="LBFGS.two_loop_recursion-296"><a href="#LBFGS.two_loop_recursion-296"><span class="linenos">296</span></a>        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LBFGS.two_loop_recursion-297"><a href="#LBFGS.two_loop_recursion-297"><span class="linenos">297</span></a>        <span class="n">history_size</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;history_size&#39;</span><span class="p">]</span>
</span><span id="LBFGS.two_loop_recursion-298"><a href="#LBFGS.two_loop_recursion-298"><span class="linenos">298</span></a>
</span><span id="LBFGS.two_loop_recursion-299"><a href="#LBFGS.two_loop_recursion-299"><span class="linenos">299</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="LBFGS.two_loop_recursion-300"><a href="#LBFGS.two_loop_recursion-300"><span class="linenos">300</span></a>        <span class="n">old_dirs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_dirs&#39;</span><span class="p">)</span>    <span class="c1"># change in gradients</span>
</span><span id="LBFGS.two_loop_recursion-301"><a href="#LBFGS.two_loop_recursion-301"><span class="linenos">301</span></a>        <span class="n">old_stps</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_stps&#39;</span><span class="p">)</span>    <span class="c1"># change in iterates</span>
</span><span id="LBFGS.two_loop_recursion-302"><a href="#LBFGS.two_loop_recursion-302"><span class="linenos">302</span></a>        <span class="n">H_diag</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;H_diag&#39;</span><span class="p">)</span>
</span><span id="LBFGS.two_loop_recursion-303"><a href="#LBFGS.two_loop_recursion-303"><span class="linenos">303</span></a>
</span><span id="LBFGS.two_loop_recursion-304"><a href="#LBFGS.two_loop_recursion-304"><span class="linenos">304</span></a>        <span class="c1"># compute the product of the inverse Hessian approximation and the gradient</span>
</span><span id="LBFGS.two_loop_recursion-305"><a href="#LBFGS.two_loop_recursion-305"><span class="linenos">305</span></a>        <span class="n">num_old</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_dirs</span><span class="p">)</span>
</span><span id="LBFGS.two_loop_recursion-306"><a href="#LBFGS.two_loop_recursion-306"><span class="linenos">306</span></a>
</span><span id="LBFGS.two_loop_recursion-307"><a href="#LBFGS.two_loop_recursion-307"><span class="linenos">307</span></a>        <span class="k">if</span> <span class="s1">&#39;rho&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span><span id="LBFGS.two_loop_recursion-308"><a href="#LBFGS.two_loop_recursion-308"><span class="linenos">308</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">history_size</span>
</span><span id="LBFGS.two_loop_recursion-309"><a href="#LBFGS.two_loop_recursion-309"><span class="linenos">309</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">history_size</span>
</span><span id="LBFGS.two_loop_recursion-310"><a href="#LBFGS.two_loop_recursion-310"><span class="linenos">310</span></a>        <span class="n">rho</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span>
</span><span id="LBFGS.two_loop_recursion-311"><a href="#LBFGS.two_loop_recursion-311"><span class="linenos">311</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
</span><span id="LBFGS.two_loop_recursion-312"><a href="#LBFGS.two_loop_recursion-312"><span class="linenos">312</span></a>
</span><span id="LBFGS.two_loop_recursion-313"><a href="#LBFGS.two_loop_recursion-313"><span class="linenos">313</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_old</span><span class="p">):</span>
</span><span id="LBFGS.two_loop_recursion-314"><a href="#LBFGS.two_loop_recursion-314"><span class="linenos">314</span></a>            <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">old_stps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">old_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="LBFGS.two_loop_recursion-315"><a href="#LBFGS.two_loop_recursion-315"><span class="linenos">315</span></a>
</span><span id="LBFGS.two_loop_recursion-316"><a href="#LBFGS.two_loop_recursion-316"><span class="linenos">316</span></a>        <span class="n">q</span> <span class="o">=</span> <span class="n">vec</span>
</span><span id="LBFGS.two_loop_recursion-317"><a href="#LBFGS.two_loop_recursion-317"><span class="linenos">317</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_old</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="LBFGS.two_loop_recursion-318"><a href="#LBFGS.two_loop_recursion-318"><span class="linenos">318</span></a>            <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="LBFGS.two_loop_recursion-319"><a href="#LBFGS.two_loop_recursion-319"><span class="linenos">319</span></a>            <span class="n">q</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">old_stps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="LBFGS.two_loop_recursion-320"><a href="#LBFGS.two_loop_recursion-320"><span class="linenos">320</span></a>
</span><span id="LBFGS.two_loop_recursion-321"><a href="#LBFGS.two_loop_recursion-321"><span class="linenos">321</span></a>        <span class="c1"># multiply by initial Hessian </span>
</span><span id="LBFGS.two_loop_recursion-322"><a href="#LBFGS.two_loop_recursion-322"><span class="linenos">322</span></a>        <span class="c1"># r/d is the final direction</span>
</span><span id="LBFGS.two_loop_recursion-323"><a href="#LBFGS.two_loop_recursion-323"><span class="linenos">323</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">H_diag</span><span class="p">)</span>
</span><span id="LBFGS.two_loop_recursion-324"><a href="#LBFGS.two_loop_recursion-324"><span class="linenos">324</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_old</span><span class="p">):</span>
</span><span id="LBFGS.two_loop_recursion-325"><a href="#LBFGS.two_loop_recursion-325"><span class="linenos">325</span></a>            <span class="n">beta</span> <span class="o">=</span> <span class="n">old_stps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="LBFGS.two_loop_recursion-326"><a href="#LBFGS.two_loop_recursion-326"><span class="linenos">326</span></a>            <span class="n">r</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta</span><span class="p">,</span> <span class="n">old_dirs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="LBFGS.two_loop_recursion-327"><a href="#LBFGS.two_loop_recursion-327"><span class="linenos">327</span></a>
</span><span id="LBFGS.two_loop_recursion-328"><a href="#LBFGS.two_loop_recursion-328"><span class="linenos">328</span></a>        <span class="k">return</span> <span class="n">r</span>
</span></pre></div>


            <div class="docstring"><p>Performs two-loop recursion on given vector to obtain Hv.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>vec (tensor):</strong>  1-D tensor to apply two-loop recursion to</li>
</ul>

<h6 id="output">Output:</h6>

<blockquote>
  <p>r (tensor): matrix-vector product Hv</p>
</blockquote>
</div>


                            </div>
                            <div id="LBFGS.curvature_update" class="classattr">
                                        <input id="LBFGS.curvature_update-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">curvature_update</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flat_grad</span>, </span><span class="param"><span class="n">eps</span><span class="o">=</span><span class="mf">0.01</span>, </span><span class="param"><span class="n">damping</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LBFGS.curvature_update-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LBFGS.curvature_update"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LBFGS.curvature_update-330"><a href="#LBFGS.curvature_update-330"><span class="linenos">330</span></a>    <span class="k">def</span> <span class="nf">curvature_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flat_grad</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="LBFGS.curvature_update-331"><a href="#LBFGS.curvature_update-331"><span class="linenos">331</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LBFGS.curvature_update-332"><a href="#LBFGS.curvature_update-332"><span class="linenos">332</span></a><span class="sd">        Performs curvature update.</span>
</span><span id="LBFGS.curvature_update-333"><a href="#LBFGS.curvature_update-333"><span class="linenos">333</span></a>
</span><span id="LBFGS.curvature_update-334"><a href="#LBFGS.curvature_update-334"><span class="linenos">334</span></a><span class="sd">        Args:</span>
</span><span id="LBFGS.curvature_update-335"><a href="#LBFGS.curvature_update-335"><span class="linenos">335</span></a><span class="sd">            flat_grad (tensor): 1-D tensor of flattened gradient for computing </span>
</span><span id="LBFGS.curvature_update-336"><a href="#LBFGS.curvature_update-336"><span class="linenos">336</span></a><span class="sd">                gradient difference with previously stored gradient</span>
</span><span id="LBFGS.curvature_update-337"><a href="#LBFGS.curvature_update-337"><span class="linenos">337</span></a><span class="sd">            eps (float): constant for curvature pair rejection or damping (default: 1e-2)</span>
</span><span id="LBFGS.curvature_update-338"><a href="#LBFGS.curvature_update-338"><span class="linenos">338</span></a><span class="sd">            damping (bool): flag for using Powell damping (default: False)</span>
</span><span id="LBFGS.curvature_update-339"><a href="#LBFGS.curvature_update-339"><span class="linenos">339</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LBFGS.curvature_update-340"><a href="#LBFGS.curvature_update-340"><span class="linenos">340</span></a>
</span><span id="LBFGS.curvature_update-341"><a href="#LBFGS.curvature_update-341"><span class="linenos">341</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="LBFGS.curvature_update-342"><a href="#LBFGS.curvature_update-342"><span class="linenos">342</span></a>
</span><span id="LBFGS.curvature_update-343"><a href="#LBFGS.curvature_update-343"><span class="linenos">343</span></a>        <span class="c1"># load parameters</span>
</span><span id="LBFGS.curvature_update-344"><a href="#LBFGS.curvature_update-344"><span class="linenos">344</span></a>        <span class="k">if</span><span class="p">(</span><span class="n">eps</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="LBFGS.curvature_update-345"><a href="#LBFGS.curvature_update-345"><span class="linenos">345</span></a>            <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid eps; must be positive.&#39;</span><span class="p">))</span>
</span><span id="LBFGS.curvature_update-346"><a href="#LBFGS.curvature_update-346"><span class="linenos">346</span></a>
</span><span id="LBFGS.curvature_update-347"><a href="#LBFGS.curvature_update-347"><span class="linenos">347</span></a>        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LBFGS.curvature_update-348"><a href="#LBFGS.curvature_update-348"><span class="linenos">348</span></a>        <span class="n">history_size</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;history_size&#39;</span><span class="p">]</span>
</span><span id="LBFGS.curvature_update-349"><a href="#LBFGS.curvature_update-349"><span class="linenos">349</span></a>        <span class="n">debug</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span>
</span><span id="LBFGS.curvature_update-350"><a href="#LBFGS.curvature_update-350"><span class="linenos">350</span></a>
</span><span id="LBFGS.curvature_update-351"><a href="#LBFGS.curvature_update-351"><span class="linenos">351</span></a>        <span class="c1"># variables cached in state (for tracing)</span>
</span><span id="LBFGS.curvature_update-352"><a href="#LBFGS.curvature_update-352"><span class="linenos">352</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="LBFGS.curvature_update-353"><a href="#LBFGS.curvature_update-353"><span class="linenos">353</span></a>        <span class="n">fail</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-354"><a href="#LBFGS.curvature_update-354"><span class="linenos">354</span></a>        
</span><span id="LBFGS.curvature_update-355"><a href="#LBFGS.curvature_update-355"><span class="linenos">355</span></a>        <span class="c1"># check if line search failed</span>
</span><span id="LBFGS.curvature_update-356"><a href="#LBFGS.curvature_update-356"><span class="linenos">356</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">fail</span><span class="p">:</span>
</span><span id="LBFGS.curvature_update-357"><a href="#LBFGS.curvature_update-357"><span class="linenos">357</span></a>            
</span><span id="LBFGS.curvature_update-358"><a href="#LBFGS.curvature_update-358"><span class="linenos">358</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-359"><a href="#LBFGS.curvature_update-359"><span class="linenos">359</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-360"><a href="#LBFGS.curvature_update-360"><span class="linenos">360</span></a>            <span class="n">old_dirs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_dirs&#39;</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-361"><a href="#LBFGS.curvature_update-361"><span class="linenos">361</span></a>            <span class="n">old_stps</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_stps&#39;</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-362"><a href="#LBFGS.curvature_update-362"><span class="linenos">362</span></a>            <span class="n">H_diag</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;H_diag&#39;</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-363"><a href="#LBFGS.curvature_update-363"><span class="linenos">363</span></a>            <span class="n">prev_flat_grad</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prev_flat_grad&#39;</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-364"><a href="#LBFGS.curvature_update-364"><span class="linenos">364</span></a>            <span class="n">Bs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Bs&#39;</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-365"><a href="#LBFGS.curvature_update-365"><span class="linenos">365</span></a>    
</span><span id="LBFGS.curvature_update-366"><a href="#LBFGS.curvature_update-366"><span class="linenos">366</span></a>            <span class="c1"># compute y&#39;s</span>
</span><span id="LBFGS.curvature_update-367"><a href="#LBFGS.curvature_update-367"><span class="linenos">367</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">flat_grad</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">prev_flat_grad</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-368"><a href="#LBFGS.curvature_update-368"><span class="linenos">368</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-369"><a href="#LBFGS.curvature_update-369"><span class="linenos">369</span></a>            <span class="n">sBs</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Bs</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-370"><a href="#LBFGS.curvature_update-370"><span class="linenos">370</span></a>            <span class="n">ys</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># y*s</span>
</span><span id="LBFGS.curvature_update-371"><a href="#LBFGS.curvature_update-371"><span class="linenos">371</span></a>
</span><span id="LBFGS.curvature_update-372"><a href="#LBFGS.curvature_update-372"><span class="linenos">372</span></a>            <span class="c1"># update L-BFGS matrix</span>
</span><span id="LBFGS.curvature_update-373"><a href="#LBFGS.curvature_update-373"><span class="linenos">373</span></a>            <span class="k">if</span> <span class="n">ys</span> <span class="o">&gt;</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">sBs</span> <span class="ow">or</span> <span class="n">damping</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="LBFGS.curvature_update-374"><a href="#LBFGS.curvature_update-374"><span class="linenos">374</span></a>    
</span><span id="LBFGS.curvature_update-375"><a href="#LBFGS.curvature_update-375"><span class="linenos">375</span></a>                <span class="c1"># perform Powell damping</span>
</span><span id="LBFGS.curvature_update-376"><a href="#LBFGS.curvature_update-376"><span class="linenos">376</span></a>                <span class="k">if</span> <span class="n">damping</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">ys</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="o">*</span><span class="n">sBs</span><span class="p">:</span>
</span><span id="LBFGS.curvature_update-377"><a href="#LBFGS.curvature_update-377"><span class="linenos">377</span></a>                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="LBFGS.curvature_update-378"><a href="#LBFGS.curvature_update-378"><span class="linenos">378</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Applying Powell damping...&#39;</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-379"><a href="#LBFGS.curvature_update-379"><span class="linenos">379</span></a>                    <span class="n">theta</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">sBs</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sBs</span> <span class="o">-</span> <span class="n">ys</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-380"><a href="#LBFGS.curvature_update-380"><span class="linenos">380</span></a>                    <span class="n">y</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">Bs</span>
</span><span id="LBFGS.curvature_update-381"><a href="#LBFGS.curvature_update-381"><span class="linenos">381</span></a>    
</span><span id="LBFGS.curvature_update-382"><a href="#LBFGS.curvature_update-382"><span class="linenos">382</span></a>                <span class="c1"># updating memory</span>
</span><span id="LBFGS.curvature_update-383"><a href="#LBFGS.curvature_update-383"><span class="linenos">383</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_dirs</span><span class="p">)</span> <span class="o">==</span> <span class="n">history_size</span><span class="p">:</span>
</span><span id="LBFGS.curvature_update-384"><a href="#LBFGS.curvature_update-384"><span class="linenos">384</span></a>                    <span class="c1"># shift history by one (limited-memory)</span>
</span><span id="LBFGS.curvature_update-385"><a href="#LBFGS.curvature_update-385"><span class="linenos">385</span></a>                    <span class="n">old_dirs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-386"><a href="#LBFGS.curvature_update-386"><span class="linenos">386</span></a>                    <span class="n">old_stps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-387"><a href="#LBFGS.curvature_update-387"><span class="linenos">387</span></a>    
</span><span id="LBFGS.curvature_update-388"><a href="#LBFGS.curvature_update-388"><span class="linenos">388</span></a>                <span class="c1"># store new direction/step</span>
</span><span id="LBFGS.curvature_update-389"><a href="#LBFGS.curvature_update-389"><span class="linenos">389</span></a>                <span class="n">old_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-390"><a href="#LBFGS.curvature_update-390"><span class="linenos">390</span></a>                <span class="n">old_stps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-391"><a href="#LBFGS.curvature_update-391"><span class="linenos">391</span></a>    
</span><span id="LBFGS.curvature_update-392"><a href="#LBFGS.curvature_update-392"><span class="linenos">392</span></a>                <span class="c1"># update scale of initial Hessian approximation</span>
</span><span id="LBFGS.curvature_update-393"><a href="#LBFGS.curvature_update-393"><span class="linenos">393</span></a>                <span class="n">H_diag</span> <span class="o">=</span> <span class="n">ys</span> <span class="o">/</span> <span class="n">y</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># (y*y)</span>
</span><span id="LBFGS.curvature_update-394"><a href="#LBFGS.curvature_update-394"><span class="linenos">394</span></a>                
</span><span id="LBFGS.curvature_update-395"><a href="#LBFGS.curvature_update-395"><span class="linenos">395</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;old_dirs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_dirs</span>
</span><span id="LBFGS.curvature_update-396"><a href="#LBFGS.curvature_update-396"><span class="linenos">396</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;old_stps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_stps</span>
</span><span id="LBFGS.curvature_update-397"><a href="#LBFGS.curvature_update-397"><span class="linenos">397</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;H_diag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">H_diag</span>
</span><span id="LBFGS.curvature_update-398"><a href="#LBFGS.curvature_update-398"><span class="linenos">398</span></a>
</span><span id="LBFGS.curvature_update-399"><a href="#LBFGS.curvature_update-399"><span class="linenos">399</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS.curvature_update-400"><a href="#LBFGS.curvature_update-400"><span class="linenos">400</span></a>                <span class="c1"># save skip</span>
</span><span id="LBFGS.curvature_update-401"><a href="#LBFGS.curvature_update-401"><span class="linenos">401</span></a>                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;curv_skips&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS.curvature_update-402"><a href="#LBFGS.curvature_update-402"><span class="linenos">402</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="LBFGS.curvature_update-403"><a href="#LBFGS.curvature_update-403"><span class="linenos">403</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Curvature pair skipped due to failed criterion&#39;</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-404"><a href="#LBFGS.curvature_update-404"><span class="linenos">404</span></a>
</span><span id="LBFGS.curvature_update-405"><a href="#LBFGS.curvature_update-405"><span class="linenos">405</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LBFGS.curvature_update-406"><a href="#LBFGS.curvature_update-406"><span class="linenos">406</span></a>            <span class="c1"># save skip</span>
</span><span id="LBFGS.curvature_update-407"><a href="#LBFGS.curvature_update-407"><span class="linenos">407</span></a>            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;fail_skips&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LBFGS.curvature_update-408"><a href="#LBFGS.curvature_update-408"><span class="linenos">408</span></a>            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="LBFGS.curvature_update-409"><a href="#LBFGS.curvature_update-409"><span class="linenos">409</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Line search failed; curvature pair update skipped&#39;</span><span class="p">)</span>
</span><span id="LBFGS.curvature_update-410"><a href="#LBFGS.curvature_update-410"><span class="linenos">410</span></a>
</span><span id="LBFGS.curvature_update-411"><a href="#LBFGS.curvature_update-411"><span class="linenos">411</span></a>        <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>Performs curvature update.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>flat_grad (tensor):</strong>  1-D tensor of flattened gradient for computing 
gradient difference with previously stored gradient</li>
<li><strong>eps (float):</strong>  constant for curvature pair rejection or damping (default: 1e-2)</li>
<li><strong>damping (bool):</strong>  flag for using Powell damping (default: False)</li>
</ul>
</div>


                            </div>
                            <div id="LBFGS.step" class="classattr">
                                        <input id="LBFGS.step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">p_k</span>, </span><span class="param"><span class="n">g_Ok</span>, </span><span class="param"><span class="n">g_Sk</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">options</span><span class="o">=</span><span class="p">{}</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LBFGS.step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LBFGS.step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LBFGS.step-967"><a href="#LBFGS.step-967"><span class="linenos">967</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_k</span><span class="p">,</span> <span class="n">g_Ok</span><span class="p">,</span> <span class="n">g_Sk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{}):</span>
</span><span id="LBFGS.step-968"><a href="#LBFGS.step-968"><span class="linenos">968</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">(</span><span class="n">p_k</span><span class="p">,</span> <span class="n">g_Ok</span><span class="p">,</span> <span class="n">g_Sk</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Performs a single optimization step (parameter update).</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>closure (Callable):</strong>  A closure that reevaluates the model and
returns the loss. Optional for most optimizers.</li>
</ul>

<div class="pdoc-alert pdoc-alert-note">

<p>Unless otherwise specified, this function should not modify the
<code>.grad</code> field of the parameters.</p>

</div>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.optim.optimizer.Optimizer</dt>
                                <dd id="LBFGS.defaults" class="variable">defaults</dd>
                <dd id="LBFGS.state" class="variable">state</dd>
                <dd id="LBFGS.param_groups" class="variable">param_groups</dd>
                <dd id="LBFGS.profile_hook_step" class="function">profile_hook_step</dd>
                <dd id="LBFGS.register_step_pre_hook" class="function">register_step_pre_hook</dd>
                <dd id="LBFGS.register_step_post_hook" class="function">register_step_post_hook</dd>
                <dd id="LBFGS.state_dict" class="function">state_dict</dd>
                <dd id="LBFGS.load_state_dict" class="function">load_state_dict</dd>
                <dd id="LBFGS.zero_grad" class="function">zero_grad</dd>
                <dd id="LBFGS.add_param_group" class="function">add_param_group</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="FullBatchLBFGS">
                            <input id="FullBatchLBFGS-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FullBatchLBFGS</span><wbr>(<span class="base"><a href="#LBFGS">LBFGS</a></span>):

                <label class="view-source-button" for="FullBatchLBFGS-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FullBatchLBFGS"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FullBatchLBFGS-971"><a href="#FullBatchLBFGS-971"><span class="linenos"> 971</span></a><span class="k">class</span> <span class="nc">FullBatchLBFGS</span><span class="p">(</span><span class="n">LBFGS</span><span class="p">):</span>
</span><span id="FullBatchLBFGS-972"><a href="#FullBatchLBFGS-972"><span class="linenos"> 972</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FullBatchLBFGS-973"><a href="#FullBatchLBFGS-973"><span class="linenos"> 973</span></a><span class="sd">    Implements full-batch or deterministic L-BFGS algorithm. Compatible with</span>
</span><span id="FullBatchLBFGS-974"><a href="#FullBatchLBFGS-974"><span class="linenos"> 974</span></a><span class="sd">    Powell damping. Can be used when evaluating a deterministic function and</span>
</span><span id="FullBatchLBFGS-975"><a href="#FullBatchLBFGS-975"><span class="linenos"> 975</span></a><span class="sd">    gradient. Wraps the LBFGS optimizer. Performs the two-loop recursion,</span>
</span><span id="FullBatchLBFGS-976"><a href="#FullBatchLBFGS-976"><span class="linenos"> 976</span></a><span class="sd">    updating, and curvature updating in a single step.</span>
</span><span id="FullBatchLBFGS-977"><a href="#FullBatchLBFGS-977"><span class="linenos"> 977</span></a><span class="sd">    Implemented by: Hao-Jun Michael Shi and Dheevatsa Mudigere</span>
</span><span id="FullBatchLBFGS-978"><a href="#FullBatchLBFGS-978"><span class="linenos"> 978</span></a><span class="sd">    Last edited 11/15/18.</span>
</span><span id="FullBatchLBFGS-979"><a href="#FullBatchLBFGS-979"><span class="linenos"> 979</span></a><span class="sd">    Warnings:</span>
</span><span id="FullBatchLBFGS-980"><a href="#FullBatchLBFGS-980"><span class="linenos"> 980</span></a><span class="sd">      . Does not support per-parameter options and parameter groups.</span>
</span><span id="FullBatchLBFGS-981"><a href="#FullBatchLBFGS-981"><span class="linenos"> 981</span></a><span class="sd">      . All parameters have to be on a single device.</span>
</span><span id="FullBatchLBFGS-982"><a href="#FullBatchLBFGS-982"><span class="linenos"> 982</span></a><span class="sd">      </span>
</span><span id="FullBatchLBFGS-983"><a href="#FullBatchLBFGS-983"><span class="linenos"> 983</span></a><span class="sd">    Args:</span>
</span><span id="FullBatchLBFGS-984"><a href="#FullBatchLBFGS-984"><span class="linenos"> 984</span></a><span class="sd">        lr (float): steplength or learning rate (default: 1)</span>
</span><span id="FullBatchLBFGS-985"><a href="#FullBatchLBFGS-985"><span class="linenos"> 985</span></a><span class="sd">        history_size (int): update history size (default: 10)</span>
</span><span id="FullBatchLBFGS-986"><a href="#FullBatchLBFGS-986"><span class="linenos"> 986</span></a><span class="sd">        line_search (str): designates line search to use (default: &#39;Wolfe&#39;)</span>
</span><span id="FullBatchLBFGS-987"><a href="#FullBatchLBFGS-987"><span class="linenos"> 987</span></a><span class="sd">            Options:</span>
</span><span id="FullBatchLBFGS-988"><a href="#FullBatchLBFGS-988"><span class="linenos"> 988</span></a><span class="sd">                &#39;None&#39;: uses steplength designated in algorithm</span>
</span><span id="FullBatchLBFGS-989"><a href="#FullBatchLBFGS-989"><span class="linenos"> 989</span></a><span class="sd">                &#39;Armijo&#39;: uses Armijo backtracking line search</span>
</span><span id="FullBatchLBFGS-990"><a href="#FullBatchLBFGS-990"><span class="linenos"> 990</span></a><span class="sd">                &#39;Wolfe&#39;: uses Armijo-Wolfe bracketing line search</span>
</span><span id="FullBatchLBFGS-991"><a href="#FullBatchLBFGS-991"><span class="linenos"> 991</span></a><span class="sd">        dtype: data type (default: torch.float)</span>
</span><span id="FullBatchLBFGS-992"><a href="#FullBatchLBFGS-992"><span class="linenos"> 992</span></a><span class="sd">        debug (bool): debugging mode</span>
</span><span id="FullBatchLBFGS-993"><a href="#FullBatchLBFGS-993"><span class="linenos"> 993</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FullBatchLBFGS-994"><a href="#FullBatchLBFGS-994"><span class="linenos"> 994</span></a>
</span><span id="FullBatchLBFGS-995"><a href="#FullBatchLBFGS-995"><span class="linenos"> 995</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">line_search</span><span class="o">=</span><span class="s1">&#39;Wolfe&#39;</span><span class="p">,</span> 
</span><span id="FullBatchLBFGS-996"><a href="#FullBatchLBFGS-996"><span class="linenos"> 996</span></a>                 <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="FullBatchLBFGS-997"><a href="#FullBatchLBFGS-997"><span class="linenos"> 997</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">FullBatchLBFGS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">history_size</span><span class="p">,</span> <span class="n">line_search</span><span class="p">,</span> 
</span><span id="FullBatchLBFGS-998"><a href="#FullBatchLBFGS-998"><span class="linenos"> 998</span></a>             <span class="n">dtype</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
</span><span id="FullBatchLBFGS-999"><a href="#FullBatchLBFGS-999"><span class="linenos"> 999</span></a>
</span><span id="FullBatchLBFGS-1000"><a href="#FullBatchLBFGS-1000"><span class="linenos">1000</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="FullBatchLBFGS-1001"><a href="#FullBatchLBFGS-1001"><span class="linenos">1001</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FullBatchLBFGS-1002"><a href="#FullBatchLBFGS-1002"><span class="linenos">1002</span></a><span class="sd">        Performs a single optimization step.</span>
</span><span id="FullBatchLBFGS-1003"><a href="#FullBatchLBFGS-1003"><span class="linenos">1003</span></a><span class="sd">        Args:</span>
</span><span id="FullBatchLBFGS-1004"><a href="#FullBatchLBFGS-1004"><span class="linenos">1004</span></a><span class="sd">            options (dict): contains options for performing line search (default: None)</span>
</span><span id="FullBatchLBFGS-1005"><a href="#FullBatchLBFGS-1005"><span class="linenos">1005</span></a><span class="sd">            </span>
</span><span id="FullBatchLBFGS-1006"><a href="#FullBatchLBFGS-1006"><span class="linenos">1006</span></a><span class="sd">        General Options:</span>
</span><span id="FullBatchLBFGS-1007"><a href="#FullBatchLBFGS-1007"><span class="linenos">1007</span></a><span class="sd">            &#39;eps&#39; (float): constant for curvature pair rejection or damping (default: 1e-2)</span>
</span><span id="FullBatchLBFGS-1008"><a href="#FullBatchLBFGS-1008"><span class="linenos">1008</span></a><span class="sd">            &#39;damping&#39; (bool): flag for using Powell damping (default: False)</span>
</span><span id="FullBatchLBFGS-1009"><a href="#FullBatchLBFGS-1009"><span class="linenos">1009</span></a>
</span><span id="FullBatchLBFGS-1010"><a href="#FullBatchLBFGS-1010"><span class="linenos">1010</span></a><span class="sd">        Options for Armijo backtracking line search:</span>
</span><span id="FullBatchLBFGS-1011"><a href="#FullBatchLBFGS-1011"><span class="linenos">1011</span></a><span class="sd">            &#39;closure&#39; (callable): reevaluates model and returns function value</span>
</span><span id="FullBatchLBFGS-1012"><a href="#FullBatchLBFGS-1012"><span class="linenos">1012</span></a><span class="sd">            &#39;current_loss&#39; (tensor): objective value at current iterate (default: F(x_k))</span>
</span><span id="FullBatchLBFGS-1013"><a href="#FullBatchLBFGS-1013"><span class="linenos">1013</span></a><span class="sd">            &#39;gtd&#39; (tensor): inner product g_Ok&#39;d in line search (default: g_Ok&#39;d)</span>
</span><span id="FullBatchLBFGS-1014"><a href="#FullBatchLBFGS-1014"><span class="linenos">1014</span></a><span class="sd">            &#39;eta&#39; (tensor): factor for decreasing steplength &gt; 0 (default: 2)</span>
</span><span id="FullBatchLBFGS-1015"><a href="#FullBatchLBFGS-1015"><span class="linenos">1015</span></a><span class="sd">            &#39;c1&#39; (tensor): sufficient decrease constant in (0, 1) (default: 1e-4)</span>
</span><span id="FullBatchLBFGS-1016"><a href="#FullBatchLBFGS-1016"><span class="linenos">1016</span></a><span class="sd">            &#39;max_ls&#39; (int): maximum number of line search steps permitted (default: 10)</span>
</span><span id="FullBatchLBFGS-1017"><a href="#FullBatchLBFGS-1017"><span class="linenos">1017</span></a><span class="sd">            &#39;interpolate&#39; (bool): flag for using interpolation (default: True)</span>
</span><span id="FullBatchLBFGS-1018"><a href="#FullBatchLBFGS-1018"><span class="linenos">1018</span></a><span class="sd">            &#39;inplace&#39; (bool): flag for inplace operations (default: True)</span>
</span><span id="FullBatchLBFGS-1019"><a href="#FullBatchLBFGS-1019"><span class="linenos">1019</span></a><span class="sd">            &#39;ls_debug&#39; (bool): debugging mode for line search</span>
</span><span id="FullBatchLBFGS-1020"><a href="#FullBatchLBFGS-1020"><span class="linenos">1020</span></a>
</span><span id="FullBatchLBFGS-1021"><a href="#FullBatchLBFGS-1021"><span class="linenos">1021</span></a><span class="sd">        Options for Wolfe line search:</span>
</span><span id="FullBatchLBFGS-1022"><a href="#FullBatchLBFGS-1022"><span class="linenos">1022</span></a><span class="sd">            &#39;closure&#39; (callable): reevaluates model and returns function value</span>
</span><span id="FullBatchLBFGS-1023"><a href="#FullBatchLBFGS-1023"><span class="linenos">1023</span></a><span class="sd">            &#39;current_loss&#39; (tensor): objective value at current iterate (default: F(x_k))</span>
</span><span id="FullBatchLBFGS-1024"><a href="#FullBatchLBFGS-1024"><span class="linenos">1024</span></a><span class="sd">            &#39;gtd&#39; (tensor): inner product g_Ok&#39;d in line search (default: g_Ok&#39;d)</span>
</span><span id="FullBatchLBFGS-1025"><a href="#FullBatchLBFGS-1025"><span class="linenos">1025</span></a><span class="sd">            &#39;eta&#39; (float): factor for extrapolation (default: 2)</span>
</span><span id="FullBatchLBFGS-1026"><a href="#FullBatchLBFGS-1026"><span class="linenos">1026</span></a><span class="sd">            &#39;c1&#39; (float): sufficient decrease constant in (0, 1) (default: 1e-4)</span>
</span><span id="FullBatchLBFGS-1027"><a href="#FullBatchLBFGS-1027"><span class="linenos">1027</span></a><span class="sd">            &#39;c2&#39; (float): curvature condition constant in (0, 1) (default: 0.9)</span>
</span><span id="FullBatchLBFGS-1028"><a href="#FullBatchLBFGS-1028"><span class="linenos">1028</span></a><span class="sd">            &#39;max_ls&#39; (int): maximum number of line search steps permitted (default: 10)</span>
</span><span id="FullBatchLBFGS-1029"><a href="#FullBatchLBFGS-1029"><span class="linenos">1029</span></a><span class="sd">            &#39;interpolate&#39; (bool): flag for using interpolation (default: True)</span>
</span><span id="FullBatchLBFGS-1030"><a href="#FullBatchLBFGS-1030"><span class="linenos">1030</span></a><span class="sd">            &#39;inplace&#39; (bool): flag for inplace operations (default: True)</span>
</span><span id="FullBatchLBFGS-1031"><a href="#FullBatchLBFGS-1031"><span class="linenos">1031</span></a><span class="sd">            &#39;ls_debug&#39; (bool): debugging mode for line search</span>
</span><span id="FullBatchLBFGS-1032"><a href="#FullBatchLBFGS-1032"><span class="linenos">1032</span></a>
</span><span id="FullBatchLBFGS-1033"><a href="#FullBatchLBFGS-1033"><span class="linenos">1033</span></a><span class="sd">        Outputs (depends on line search):</span>
</span><span id="FullBatchLBFGS-1034"><a href="#FullBatchLBFGS-1034"><span class="linenos">1034</span></a><span class="sd">          . No line search:</span>
</span><span id="FullBatchLBFGS-1035"><a href="#FullBatchLBFGS-1035"><span class="linenos">1035</span></a><span class="sd">                t (float): steplength</span>
</span><span id="FullBatchLBFGS-1036"><a href="#FullBatchLBFGS-1036"><span class="linenos">1036</span></a><span class="sd">          . Armijo backtracking line search:</span>
</span><span id="FullBatchLBFGS-1037"><a href="#FullBatchLBFGS-1037"><span class="linenos">1037</span></a><span class="sd">                F_new (tensor): loss function at new iterate</span>
</span><span id="FullBatchLBFGS-1038"><a href="#FullBatchLBFGS-1038"><span class="linenos">1038</span></a><span class="sd">                t (tensor): final steplength</span>
</span><span id="FullBatchLBFGS-1039"><a href="#FullBatchLBFGS-1039"><span class="linenos">1039</span></a><span class="sd">                ls_step (int): number of backtracks</span>
</span><span id="FullBatchLBFGS-1040"><a href="#FullBatchLBFGS-1040"><span class="linenos">1040</span></a><span class="sd">                closure_eval (int): number of closure evaluations</span>
</span><span id="FullBatchLBFGS-1041"><a href="#FullBatchLBFGS-1041"><span class="linenos">1041</span></a><span class="sd">                desc_dir (bool): descent direction flag</span>
</span><span id="FullBatchLBFGS-1042"><a href="#FullBatchLBFGS-1042"><span class="linenos">1042</span></a><span class="sd">                    True: p_k is descent direction with respect to the line search</span>
</span><span id="FullBatchLBFGS-1043"><a href="#FullBatchLBFGS-1043"><span class="linenos">1043</span></a><span class="sd">                    function</span>
</span><span id="FullBatchLBFGS-1044"><a href="#FullBatchLBFGS-1044"><span class="linenos">1044</span></a><span class="sd">                    False: p_k is not a descent direction with respect to the line</span>
</span><span id="FullBatchLBFGS-1045"><a href="#FullBatchLBFGS-1045"><span class="linenos">1045</span></a><span class="sd">                    search function</span>
</span><span id="FullBatchLBFGS-1046"><a href="#FullBatchLBFGS-1046"><span class="linenos">1046</span></a><span class="sd">                fail (bool): failure flag</span>
</span><span id="FullBatchLBFGS-1047"><a href="#FullBatchLBFGS-1047"><span class="linenos">1047</span></a><span class="sd">                    True: line search reached maximum number of iterations, failed</span>
</span><span id="FullBatchLBFGS-1048"><a href="#FullBatchLBFGS-1048"><span class="linenos">1048</span></a><span class="sd">                    False: line search succeeded</span>
</span><span id="FullBatchLBFGS-1049"><a href="#FullBatchLBFGS-1049"><span class="linenos">1049</span></a><span class="sd">          . Wolfe line search:</span>
</span><span id="FullBatchLBFGS-1050"><a href="#FullBatchLBFGS-1050"><span class="linenos">1050</span></a><span class="sd">                F_new (tensor): loss function at new iterate</span>
</span><span id="FullBatchLBFGS-1051"><a href="#FullBatchLBFGS-1051"><span class="linenos">1051</span></a><span class="sd">                g_new (tensor): gradient at new iterate</span>
</span><span id="FullBatchLBFGS-1052"><a href="#FullBatchLBFGS-1052"><span class="linenos">1052</span></a><span class="sd">                t (float): final steplength</span>
</span><span id="FullBatchLBFGS-1053"><a href="#FullBatchLBFGS-1053"><span class="linenos">1053</span></a><span class="sd">                ls_step (int): number of backtracks</span>
</span><span id="FullBatchLBFGS-1054"><a href="#FullBatchLBFGS-1054"><span class="linenos">1054</span></a><span class="sd">                closure_eval (int): number of closure evaluations</span>
</span><span id="FullBatchLBFGS-1055"><a href="#FullBatchLBFGS-1055"><span class="linenos">1055</span></a><span class="sd">                grad_eval (int): number of gradient evaluations</span>
</span><span id="FullBatchLBFGS-1056"><a href="#FullBatchLBFGS-1056"><span class="linenos">1056</span></a><span class="sd">                desc_dir (bool): descent direction flag</span>
</span><span id="FullBatchLBFGS-1057"><a href="#FullBatchLBFGS-1057"><span class="linenos">1057</span></a><span class="sd">                    True: p_k is descent direction with respect to the line search</span>
</span><span id="FullBatchLBFGS-1058"><a href="#FullBatchLBFGS-1058"><span class="linenos">1058</span></a><span class="sd">                    function</span>
</span><span id="FullBatchLBFGS-1059"><a href="#FullBatchLBFGS-1059"><span class="linenos">1059</span></a><span class="sd">                    False: p_k is not a descent direction with respect to the line</span>
</span><span id="FullBatchLBFGS-1060"><a href="#FullBatchLBFGS-1060"><span class="linenos">1060</span></a><span class="sd">                    search function</span>
</span><span id="FullBatchLBFGS-1061"><a href="#FullBatchLBFGS-1061"><span class="linenos">1061</span></a><span class="sd">                fail (bool): failure flag</span>
</span><span id="FullBatchLBFGS-1062"><a href="#FullBatchLBFGS-1062"><span class="linenos">1062</span></a><span class="sd">                    True: line search reached maximum number of iterations, failed</span>
</span><span id="FullBatchLBFGS-1063"><a href="#FullBatchLBFGS-1063"><span class="linenos">1063</span></a><span class="sd">                    False: line search succeeded</span>
</span><span id="FullBatchLBFGS-1064"><a href="#FullBatchLBFGS-1064"><span class="linenos">1064</span></a><span class="sd">                    </span>
</span><span id="FullBatchLBFGS-1065"><a href="#FullBatchLBFGS-1065"><span class="linenos">1065</span></a><span class="sd">        Notes:</span>
</span><span id="FullBatchLBFGS-1066"><a href="#FullBatchLBFGS-1066"><span class="linenos">1066</span></a><span class="sd">          . If encountering line search failure in the deterministic setting, one</span>
</span><span id="FullBatchLBFGS-1067"><a href="#FullBatchLBFGS-1067"><span class="linenos">1067</span></a><span class="sd">            should try increasing the maximum number of line search steps max_ls.</span>
</span><span id="FullBatchLBFGS-1068"><a href="#FullBatchLBFGS-1068"><span class="linenos">1068</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FullBatchLBFGS-1069"><a href="#FullBatchLBFGS-1069"><span class="linenos">1069</span></a>        
</span><span id="FullBatchLBFGS-1070"><a href="#FullBatchLBFGS-1070"><span class="linenos">1070</span></a>        <span class="c1"># load options for damping and eps</span>
</span><span id="FullBatchLBFGS-1071"><a href="#FullBatchLBFGS-1071"><span class="linenos">1071</span></a>        <span class="k">if</span> <span class="s1">&#39;damping&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="FullBatchLBFGS-1072"><a href="#FullBatchLBFGS-1072"><span class="linenos">1072</span></a>            <span class="n">damping</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FullBatchLBFGS-1073"><a href="#FullBatchLBFGS-1073"><span class="linenos">1073</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FullBatchLBFGS-1074"><a href="#FullBatchLBFGS-1074"><span class="linenos">1074</span></a>            <span class="n">damping</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;damping&#39;</span><span class="p">]</span>
</span><span id="FullBatchLBFGS-1075"><a href="#FullBatchLBFGS-1075"><span class="linenos">1075</span></a>            
</span><span id="FullBatchLBFGS-1076"><a href="#FullBatchLBFGS-1076"><span class="linenos">1076</span></a>        <span class="k">if</span> <span class="s1">&#39;eps&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="FullBatchLBFGS-1077"><a href="#FullBatchLBFGS-1077"><span class="linenos">1077</span></a>            <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-2</span>
</span><span id="FullBatchLBFGS-1078"><a href="#FullBatchLBFGS-1078"><span class="linenos">1078</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FullBatchLBFGS-1079"><a href="#FullBatchLBFGS-1079"><span class="linenos">1079</span></a>            <span class="n">eps</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;eps&#39;</span><span class="p">]</span>
</span><span id="FullBatchLBFGS-1080"><a href="#FullBatchLBFGS-1080"><span class="linenos">1080</span></a>        
</span><span id="FullBatchLBFGS-1081"><a href="#FullBatchLBFGS-1081"><span class="linenos">1081</span></a>        <span class="c1"># gather gradient</span>
</span><span id="FullBatchLBFGS-1082"><a href="#FullBatchLBFGS-1082"><span class="linenos">1082</span></a>        <span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_flat_grad</span><span class="p">()</span>
</span><span id="FullBatchLBFGS-1083"><a href="#FullBatchLBFGS-1083"><span class="linenos">1083</span></a>        
</span><span id="FullBatchLBFGS-1084"><a href="#FullBatchLBFGS-1084"><span class="linenos">1084</span></a>        <span class="c1"># update curvature if after 1st iteration</span>
</span><span id="FullBatchLBFGS-1085"><a href="#FullBatchLBFGS-1085"><span class="linenos">1085</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="FullBatchLBFGS-1086"><a href="#FullBatchLBFGS-1086"><span class="linenos">1086</span></a>        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="FullBatchLBFGS-1087"><a href="#FullBatchLBFGS-1087"><span class="linenos">1087</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">curvature_update</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">damping</span><span class="p">)</span>
</span><span id="FullBatchLBFGS-1088"><a href="#FullBatchLBFGS-1088"><span class="linenos">1088</span></a>
</span><span id="FullBatchLBFGS-1089"><a href="#FullBatchLBFGS-1089"><span class="linenos">1089</span></a>        <span class="c1"># compute search direction</span>
</span><span id="FullBatchLBFGS-1090"><a href="#FullBatchLBFGS-1090"><span class="linenos">1090</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_loop_recursion</span><span class="p">(</span><span class="o">-</span><span class="n">grad</span><span class="p">)</span>
</span><span id="FullBatchLBFGS-1091"><a href="#FullBatchLBFGS-1091"><span class="linenos">1091</span></a>
</span><span id="FullBatchLBFGS-1092"><a href="#FullBatchLBFGS-1092"><span class="linenos">1092</span></a>        <span class="c1"># take step</span>
</span><span id="FullBatchLBFGS-1093"><a href="#FullBatchLBFGS-1093"><span class="linenos">1093</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Implements full-batch or deterministic L-BFGS algorithm. Compatible with
Powell damping. Can be used when evaluating a deterministic function and
gradient. Wraps the LBFGS optimizer. Performs the two-loop recursion,
updating, and curvature updating in a single step.
Implemented by: Hao-Jun Michael Shi and Dheevatsa Mudigere
Last edited 11/15/18.</p>

<h6 id="warnings">Warnings:</h6>

<blockquote>
  <p>. Does not support per-parameter options and parameter groups.
  . All parameters have to be on a single device.</p>
</blockquote>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>lr (float):</strong>  steplength or learning rate (default: 1)</li>
<li><strong>history_size (int):</strong>  update history size (default: 10)</li>
<li><strong>line_search (str):</strong>  designates line search to use (default: 'Wolfe')
Options:
    'None': uses steplength designated in algorithm
    'Armijo': uses Armijo backtracking line search
    'Wolfe': uses Armijo-Wolfe bracketing line search</li>
<li><strong>dtype:</strong>  data type (default: torch.float)</li>
<li><strong>debug (bool):</strong>  debugging mode</li>
</ul>
</div>


                            <div id="FullBatchLBFGS.__init__" class="classattr">
                                        <input id="FullBatchLBFGS.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">FullBatchLBFGS</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">params</span>,</span><span class="param">	<span class="n">lr</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">history_size</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">line_search</span><span class="o">=</span><span class="s1">&#39;Wolfe&#39;</span>,</span><span class="param">	<span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span>,</span><span class="param">	<span class="n">debug</span><span class="o">=</span><span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="FullBatchLBFGS.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FullBatchLBFGS.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FullBatchLBFGS.__init__-995"><a href="#FullBatchLBFGS.__init__-995"><span class="linenos">995</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">line_search</span><span class="o">=</span><span class="s1">&#39;Wolfe&#39;</span><span class="p">,</span> 
</span><span id="FullBatchLBFGS.__init__-996"><a href="#FullBatchLBFGS.__init__-996"><span class="linenos">996</span></a>                 <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="FullBatchLBFGS.__init__-997"><a href="#FullBatchLBFGS.__init__-997"><span class="linenos">997</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">FullBatchLBFGS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">history_size</span><span class="p">,</span> <span class="n">line_search</span><span class="p">,</span> 
</span><span id="FullBatchLBFGS.__init__-998"><a href="#FullBatchLBFGS.__init__-998"><span class="linenos">998</span></a>             <span class="n">dtype</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="FullBatchLBFGS.step" class="classattr">
                                        <input id="FullBatchLBFGS.step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">options</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FullBatchLBFGS.step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FullBatchLBFGS.step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FullBatchLBFGS.step-1000"><a href="#FullBatchLBFGS.step-1000"><span class="linenos">1000</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="FullBatchLBFGS.step-1001"><a href="#FullBatchLBFGS.step-1001"><span class="linenos">1001</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FullBatchLBFGS.step-1002"><a href="#FullBatchLBFGS.step-1002"><span class="linenos">1002</span></a><span class="sd">        Performs a single optimization step.</span>
</span><span id="FullBatchLBFGS.step-1003"><a href="#FullBatchLBFGS.step-1003"><span class="linenos">1003</span></a><span class="sd">        Args:</span>
</span><span id="FullBatchLBFGS.step-1004"><a href="#FullBatchLBFGS.step-1004"><span class="linenos">1004</span></a><span class="sd">            options (dict): contains options for performing line search (default: None)</span>
</span><span id="FullBatchLBFGS.step-1005"><a href="#FullBatchLBFGS.step-1005"><span class="linenos">1005</span></a><span class="sd">            </span>
</span><span id="FullBatchLBFGS.step-1006"><a href="#FullBatchLBFGS.step-1006"><span class="linenos">1006</span></a><span class="sd">        General Options:</span>
</span><span id="FullBatchLBFGS.step-1007"><a href="#FullBatchLBFGS.step-1007"><span class="linenos">1007</span></a><span class="sd">            &#39;eps&#39; (float): constant for curvature pair rejection or damping (default: 1e-2)</span>
</span><span id="FullBatchLBFGS.step-1008"><a href="#FullBatchLBFGS.step-1008"><span class="linenos">1008</span></a><span class="sd">            &#39;damping&#39; (bool): flag for using Powell damping (default: False)</span>
</span><span id="FullBatchLBFGS.step-1009"><a href="#FullBatchLBFGS.step-1009"><span class="linenos">1009</span></a>
</span><span id="FullBatchLBFGS.step-1010"><a href="#FullBatchLBFGS.step-1010"><span class="linenos">1010</span></a><span class="sd">        Options for Armijo backtracking line search:</span>
</span><span id="FullBatchLBFGS.step-1011"><a href="#FullBatchLBFGS.step-1011"><span class="linenos">1011</span></a><span class="sd">            &#39;closure&#39; (callable): reevaluates model and returns function value</span>
</span><span id="FullBatchLBFGS.step-1012"><a href="#FullBatchLBFGS.step-1012"><span class="linenos">1012</span></a><span class="sd">            &#39;current_loss&#39; (tensor): objective value at current iterate (default: F(x_k))</span>
</span><span id="FullBatchLBFGS.step-1013"><a href="#FullBatchLBFGS.step-1013"><span class="linenos">1013</span></a><span class="sd">            &#39;gtd&#39; (tensor): inner product g_Ok&#39;d in line search (default: g_Ok&#39;d)</span>
</span><span id="FullBatchLBFGS.step-1014"><a href="#FullBatchLBFGS.step-1014"><span class="linenos">1014</span></a><span class="sd">            &#39;eta&#39; (tensor): factor for decreasing steplength &gt; 0 (default: 2)</span>
</span><span id="FullBatchLBFGS.step-1015"><a href="#FullBatchLBFGS.step-1015"><span class="linenos">1015</span></a><span class="sd">            &#39;c1&#39; (tensor): sufficient decrease constant in (0, 1) (default: 1e-4)</span>
</span><span id="FullBatchLBFGS.step-1016"><a href="#FullBatchLBFGS.step-1016"><span class="linenos">1016</span></a><span class="sd">            &#39;max_ls&#39; (int): maximum number of line search steps permitted (default: 10)</span>
</span><span id="FullBatchLBFGS.step-1017"><a href="#FullBatchLBFGS.step-1017"><span class="linenos">1017</span></a><span class="sd">            &#39;interpolate&#39; (bool): flag for using interpolation (default: True)</span>
</span><span id="FullBatchLBFGS.step-1018"><a href="#FullBatchLBFGS.step-1018"><span class="linenos">1018</span></a><span class="sd">            &#39;inplace&#39; (bool): flag for inplace operations (default: True)</span>
</span><span id="FullBatchLBFGS.step-1019"><a href="#FullBatchLBFGS.step-1019"><span class="linenos">1019</span></a><span class="sd">            &#39;ls_debug&#39; (bool): debugging mode for line search</span>
</span><span id="FullBatchLBFGS.step-1020"><a href="#FullBatchLBFGS.step-1020"><span class="linenos">1020</span></a>
</span><span id="FullBatchLBFGS.step-1021"><a href="#FullBatchLBFGS.step-1021"><span class="linenos">1021</span></a><span class="sd">        Options for Wolfe line search:</span>
</span><span id="FullBatchLBFGS.step-1022"><a href="#FullBatchLBFGS.step-1022"><span class="linenos">1022</span></a><span class="sd">            &#39;closure&#39; (callable): reevaluates model and returns function value</span>
</span><span id="FullBatchLBFGS.step-1023"><a href="#FullBatchLBFGS.step-1023"><span class="linenos">1023</span></a><span class="sd">            &#39;current_loss&#39; (tensor): objective value at current iterate (default: F(x_k))</span>
</span><span id="FullBatchLBFGS.step-1024"><a href="#FullBatchLBFGS.step-1024"><span class="linenos">1024</span></a><span class="sd">            &#39;gtd&#39; (tensor): inner product g_Ok&#39;d in line search (default: g_Ok&#39;d)</span>
</span><span id="FullBatchLBFGS.step-1025"><a href="#FullBatchLBFGS.step-1025"><span class="linenos">1025</span></a><span class="sd">            &#39;eta&#39; (float): factor for extrapolation (default: 2)</span>
</span><span id="FullBatchLBFGS.step-1026"><a href="#FullBatchLBFGS.step-1026"><span class="linenos">1026</span></a><span class="sd">            &#39;c1&#39; (float): sufficient decrease constant in (0, 1) (default: 1e-4)</span>
</span><span id="FullBatchLBFGS.step-1027"><a href="#FullBatchLBFGS.step-1027"><span class="linenos">1027</span></a><span class="sd">            &#39;c2&#39; (float): curvature condition constant in (0, 1) (default: 0.9)</span>
</span><span id="FullBatchLBFGS.step-1028"><a href="#FullBatchLBFGS.step-1028"><span class="linenos">1028</span></a><span class="sd">            &#39;max_ls&#39; (int): maximum number of line search steps permitted (default: 10)</span>
</span><span id="FullBatchLBFGS.step-1029"><a href="#FullBatchLBFGS.step-1029"><span class="linenos">1029</span></a><span class="sd">            &#39;interpolate&#39; (bool): flag for using interpolation (default: True)</span>
</span><span id="FullBatchLBFGS.step-1030"><a href="#FullBatchLBFGS.step-1030"><span class="linenos">1030</span></a><span class="sd">            &#39;inplace&#39; (bool): flag for inplace operations (default: True)</span>
</span><span id="FullBatchLBFGS.step-1031"><a href="#FullBatchLBFGS.step-1031"><span class="linenos">1031</span></a><span class="sd">            &#39;ls_debug&#39; (bool): debugging mode for line search</span>
</span><span id="FullBatchLBFGS.step-1032"><a href="#FullBatchLBFGS.step-1032"><span class="linenos">1032</span></a>
</span><span id="FullBatchLBFGS.step-1033"><a href="#FullBatchLBFGS.step-1033"><span class="linenos">1033</span></a><span class="sd">        Outputs (depends on line search):</span>
</span><span id="FullBatchLBFGS.step-1034"><a href="#FullBatchLBFGS.step-1034"><span class="linenos">1034</span></a><span class="sd">          . No line search:</span>
</span><span id="FullBatchLBFGS.step-1035"><a href="#FullBatchLBFGS.step-1035"><span class="linenos">1035</span></a><span class="sd">                t (float): steplength</span>
</span><span id="FullBatchLBFGS.step-1036"><a href="#FullBatchLBFGS.step-1036"><span class="linenos">1036</span></a><span class="sd">          . Armijo backtracking line search:</span>
</span><span id="FullBatchLBFGS.step-1037"><a href="#FullBatchLBFGS.step-1037"><span class="linenos">1037</span></a><span class="sd">                F_new (tensor): loss function at new iterate</span>
</span><span id="FullBatchLBFGS.step-1038"><a href="#FullBatchLBFGS.step-1038"><span class="linenos">1038</span></a><span class="sd">                t (tensor): final steplength</span>
</span><span id="FullBatchLBFGS.step-1039"><a href="#FullBatchLBFGS.step-1039"><span class="linenos">1039</span></a><span class="sd">                ls_step (int): number of backtracks</span>
</span><span id="FullBatchLBFGS.step-1040"><a href="#FullBatchLBFGS.step-1040"><span class="linenos">1040</span></a><span class="sd">                closure_eval (int): number of closure evaluations</span>
</span><span id="FullBatchLBFGS.step-1041"><a href="#FullBatchLBFGS.step-1041"><span class="linenos">1041</span></a><span class="sd">                desc_dir (bool): descent direction flag</span>
</span><span id="FullBatchLBFGS.step-1042"><a href="#FullBatchLBFGS.step-1042"><span class="linenos">1042</span></a><span class="sd">                    True: p_k is descent direction with respect to the line search</span>
</span><span id="FullBatchLBFGS.step-1043"><a href="#FullBatchLBFGS.step-1043"><span class="linenos">1043</span></a><span class="sd">                    function</span>
</span><span id="FullBatchLBFGS.step-1044"><a href="#FullBatchLBFGS.step-1044"><span class="linenos">1044</span></a><span class="sd">                    False: p_k is not a descent direction with respect to the line</span>
</span><span id="FullBatchLBFGS.step-1045"><a href="#FullBatchLBFGS.step-1045"><span class="linenos">1045</span></a><span class="sd">                    search function</span>
</span><span id="FullBatchLBFGS.step-1046"><a href="#FullBatchLBFGS.step-1046"><span class="linenos">1046</span></a><span class="sd">                fail (bool): failure flag</span>
</span><span id="FullBatchLBFGS.step-1047"><a href="#FullBatchLBFGS.step-1047"><span class="linenos">1047</span></a><span class="sd">                    True: line search reached maximum number of iterations, failed</span>
</span><span id="FullBatchLBFGS.step-1048"><a href="#FullBatchLBFGS.step-1048"><span class="linenos">1048</span></a><span class="sd">                    False: line search succeeded</span>
</span><span id="FullBatchLBFGS.step-1049"><a href="#FullBatchLBFGS.step-1049"><span class="linenos">1049</span></a><span class="sd">          . Wolfe line search:</span>
</span><span id="FullBatchLBFGS.step-1050"><a href="#FullBatchLBFGS.step-1050"><span class="linenos">1050</span></a><span class="sd">                F_new (tensor): loss function at new iterate</span>
</span><span id="FullBatchLBFGS.step-1051"><a href="#FullBatchLBFGS.step-1051"><span class="linenos">1051</span></a><span class="sd">                g_new (tensor): gradient at new iterate</span>
</span><span id="FullBatchLBFGS.step-1052"><a href="#FullBatchLBFGS.step-1052"><span class="linenos">1052</span></a><span class="sd">                t (float): final steplength</span>
</span><span id="FullBatchLBFGS.step-1053"><a href="#FullBatchLBFGS.step-1053"><span class="linenos">1053</span></a><span class="sd">                ls_step (int): number of backtracks</span>
</span><span id="FullBatchLBFGS.step-1054"><a href="#FullBatchLBFGS.step-1054"><span class="linenos">1054</span></a><span class="sd">                closure_eval (int): number of closure evaluations</span>
</span><span id="FullBatchLBFGS.step-1055"><a href="#FullBatchLBFGS.step-1055"><span class="linenos">1055</span></a><span class="sd">                grad_eval (int): number of gradient evaluations</span>
</span><span id="FullBatchLBFGS.step-1056"><a href="#FullBatchLBFGS.step-1056"><span class="linenos">1056</span></a><span class="sd">                desc_dir (bool): descent direction flag</span>
</span><span id="FullBatchLBFGS.step-1057"><a href="#FullBatchLBFGS.step-1057"><span class="linenos">1057</span></a><span class="sd">                    True: p_k is descent direction with respect to the line search</span>
</span><span id="FullBatchLBFGS.step-1058"><a href="#FullBatchLBFGS.step-1058"><span class="linenos">1058</span></a><span class="sd">                    function</span>
</span><span id="FullBatchLBFGS.step-1059"><a href="#FullBatchLBFGS.step-1059"><span class="linenos">1059</span></a><span class="sd">                    False: p_k is not a descent direction with respect to the line</span>
</span><span id="FullBatchLBFGS.step-1060"><a href="#FullBatchLBFGS.step-1060"><span class="linenos">1060</span></a><span class="sd">                    search function</span>
</span><span id="FullBatchLBFGS.step-1061"><a href="#FullBatchLBFGS.step-1061"><span class="linenos">1061</span></a><span class="sd">                fail (bool): failure flag</span>
</span><span id="FullBatchLBFGS.step-1062"><a href="#FullBatchLBFGS.step-1062"><span class="linenos">1062</span></a><span class="sd">                    True: line search reached maximum number of iterations, failed</span>
</span><span id="FullBatchLBFGS.step-1063"><a href="#FullBatchLBFGS.step-1063"><span class="linenos">1063</span></a><span class="sd">                    False: line search succeeded</span>
</span><span id="FullBatchLBFGS.step-1064"><a href="#FullBatchLBFGS.step-1064"><span class="linenos">1064</span></a><span class="sd">                    </span>
</span><span id="FullBatchLBFGS.step-1065"><a href="#FullBatchLBFGS.step-1065"><span class="linenos">1065</span></a><span class="sd">        Notes:</span>
</span><span id="FullBatchLBFGS.step-1066"><a href="#FullBatchLBFGS.step-1066"><span class="linenos">1066</span></a><span class="sd">          . If encountering line search failure in the deterministic setting, one</span>
</span><span id="FullBatchLBFGS.step-1067"><a href="#FullBatchLBFGS.step-1067"><span class="linenos">1067</span></a><span class="sd">            should try increasing the maximum number of line search steps max_ls.</span>
</span><span id="FullBatchLBFGS.step-1068"><a href="#FullBatchLBFGS.step-1068"><span class="linenos">1068</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FullBatchLBFGS.step-1069"><a href="#FullBatchLBFGS.step-1069"><span class="linenos">1069</span></a>        
</span><span id="FullBatchLBFGS.step-1070"><a href="#FullBatchLBFGS.step-1070"><span class="linenos">1070</span></a>        <span class="c1"># load options for damping and eps</span>
</span><span id="FullBatchLBFGS.step-1071"><a href="#FullBatchLBFGS.step-1071"><span class="linenos">1071</span></a>        <span class="k">if</span> <span class="s1">&#39;damping&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="FullBatchLBFGS.step-1072"><a href="#FullBatchLBFGS.step-1072"><span class="linenos">1072</span></a>            <span class="n">damping</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FullBatchLBFGS.step-1073"><a href="#FullBatchLBFGS.step-1073"><span class="linenos">1073</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FullBatchLBFGS.step-1074"><a href="#FullBatchLBFGS.step-1074"><span class="linenos">1074</span></a>            <span class="n">damping</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;damping&#39;</span><span class="p">]</span>
</span><span id="FullBatchLBFGS.step-1075"><a href="#FullBatchLBFGS.step-1075"><span class="linenos">1075</span></a>            
</span><span id="FullBatchLBFGS.step-1076"><a href="#FullBatchLBFGS.step-1076"><span class="linenos">1076</span></a>        <span class="k">if</span> <span class="s1">&#39;eps&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="FullBatchLBFGS.step-1077"><a href="#FullBatchLBFGS.step-1077"><span class="linenos">1077</span></a>            <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-2</span>
</span><span id="FullBatchLBFGS.step-1078"><a href="#FullBatchLBFGS.step-1078"><span class="linenos">1078</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FullBatchLBFGS.step-1079"><a href="#FullBatchLBFGS.step-1079"><span class="linenos">1079</span></a>            <span class="n">eps</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;eps&#39;</span><span class="p">]</span>
</span><span id="FullBatchLBFGS.step-1080"><a href="#FullBatchLBFGS.step-1080"><span class="linenos">1080</span></a>        
</span><span id="FullBatchLBFGS.step-1081"><a href="#FullBatchLBFGS.step-1081"><span class="linenos">1081</span></a>        <span class="c1"># gather gradient</span>
</span><span id="FullBatchLBFGS.step-1082"><a href="#FullBatchLBFGS.step-1082"><span class="linenos">1082</span></a>        <span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_flat_grad</span><span class="p">()</span>
</span><span id="FullBatchLBFGS.step-1083"><a href="#FullBatchLBFGS.step-1083"><span class="linenos">1083</span></a>        
</span><span id="FullBatchLBFGS.step-1084"><a href="#FullBatchLBFGS.step-1084"><span class="linenos">1084</span></a>        <span class="c1"># update curvature if after 1st iteration</span>
</span><span id="FullBatchLBFGS.step-1085"><a href="#FullBatchLBFGS.step-1085"><span class="linenos">1085</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;global_state&#39;</span><span class="p">]</span>
</span><span id="FullBatchLBFGS.step-1086"><a href="#FullBatchLBFGS.step-1086"><span class="linenos">1086</span></a>        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;n_iter&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="FullBatchLBFGS.step-1087"><a href="#FullBatchLBFGS.step-1087"><span class="linenos">1087</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">curvature_update</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">damping</span><span class="p">)</span>
</span><span id="FullBatchLBFGS.step-1088"><a href="#FullBatchLBFGS.step-1088"><span class="linenos">1088</span></a>
</span><span id="FullBatchLBFGS.step-1089"><a href="#FullBatchLBFGS.step-1089"><span class="linenos">1089</span></a>        <span class="c1"># compute search direction</span>
</span><span id="FullBatchLBFGS.step-1090"><a href="#FullBatchLBFGS.step-1090"><span class="linenos">1090</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_loop_recursion</span><span class="p">(</span><span class="o">-</span><span class="n">grad</span><span class="p">)</span>
</span><span id="FullBatchLBFGS.step-1091"><a href="#FullBatchLBFGS.step-1091"><span class="linenos">1091</span></a>
</span><span id="FullBatchLBFGS.step-1092"><a href="#FullBatchLBFGS.step-1092"><span class="linenos">1092</span></a>        <span class="c1"># take step</span>
</span><span id="FullBatchLBFGS.step-1093"><a href="#FullBatchLBFGS.step-1093"><span class="linenos">1093</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Performs a single optimization step.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>options (dict):</strong>  contains options for performing line search (default: None)</li>
</ul>

<h6 id="general-options">General Options:</h6>

<blockquote>
  <p>'eps' (float): constant for curvature pair rejection or damping (default: 1e-2)
  'damping' (bool): flag for using Powell damping (default: False)</p>
</blockquote>

<h6 id="options-for-armijo-backtracking-line-search">Options for Armijo backtracking line search:</h6>

<blockquote>
  <p>'closure' (callable): reevaluates model and returns function value
  'current_loss' (tensor): objective value at current iterate (default: F(x_k))
  'gtd' (tensor): inner product g_Ok'd in line search (default: g_Ok'd)
  'eta' (tensor): factor for decreasing steplength &gt; 0 (default: 2)
  'c1' (tensor): sufficient decrease constant in (0, 1) (default: 1e-4)
  'max_ls' (int): maximum number of line search steps permitted (default: 10)
  'interpolate' (bool): flag for using interpolation (default: True)
  'inplace' (bool): flag for inplace operations (default: True)
  'ls_debug' (bool): debugging mode for line search</p>
</blockquote>

<h6 id="options-for-wolfe-line-search">Options for Wolfe line search:</h6>

<blockquote>
  <p>'closure' (callable): reevaluates model and returns function value
  'current_loss' (tensor): objective value at current iterate (default: F(x_k))
  'gtd' (tensor): inner product g_Ok'd in line search (default: g_Ok'd)
  'eta' (float): factor for extrapolation (default: 2)
  'c1' (float): sufficient decrease constant in (0, 1) (default: 1e-4)
  'c2' (float): curvature condition constant in (0, 1) (default: 0.9)
  'max_ls' (int): maximum number of line search steps permitted (default: 10)
  'interpolate' (bool): flag for using interpolation (default: True)
  'inplace' (bool): flag for inplace operations (default: True)
  'ls_debug' (bool): debugging mode for line search</p>
</blockquote>

<p>Outputs (depends on line search):
  . No line search:
        t (float): steplength
  . Armijo backtracking line search:
        F_new (tensor): loss function at new iterate
        t (tensor): final steplength
        ls_step (int): number of backtracks
        closure_eval (int): number of closure evaluations
        desc_dir (bool): descent direction flag
            True: p_k is descent direction with respect to the line search
            function
            False: p_k is not a descent direction with respect to the line
            search function
        fail (bool): failure flag
            True: line search reached maximum number of iterations, failed
            False: line search succeeded
  . Wolfe line search:
        F_new (tensor): loss function at new iterate
        g_new (tensor): gradient at new iterate
        t (float): final steplength
        ls_step (int): number of backtracks
        closure_eval (int): number of closure evaluations
        grad_eval (int): number of gradient evaluations
        desc_dir (bool): descent direction flag
            True: p_k is descent direction with respect to the line search
            function
            False: p_k is not a descent direction with respect to the line
            search function
        fail (bool): failure flag
            True: line search reached maximum number of iterations, failed
            False: line search succeeded</p>

<h6 id="notes">Notes:</h6>

<blockquote>
  <p>. If encountering line search failure in the deterministic setting, one
    should try increasing the maximum number of line search steps max_ls.</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#LBFGS">LBFGS</a></dt>
                                <dd id="FullBatchLBFGS.line_search" class="function"><a href="#LBFGS.line_search">line_search</a></dd>
                <dd id="FullBatchLBFGS.two_loop_recursion" class="function"><a href="#LBFGS.two_loop_recursion">two_loop_recursion</a></dd>
                <dd id="FullBatchLBFGS.curvature_update" class="function"><a href="#LBFGS.curvature_update">curvature_update</a></dd>

            </div>
            <div><dt>torch.optim.optimizer.Optimizer</dt>
                                <dd id="FullBatchLBFGS.defaults" class="variable">defaults</dd>
                <dd id="FullBatchLBFGS.state" class="variable">state</dd>
                <dd id="FullBatchLBFGS.param_groups" class="variable">param_groups</dd>
                <dd id="FullBatchLBFGS.profile_hook_step" class="function">profile_hook_step</dd>
                <dd id="FullBatchLBFGS.register_step_pre_hook" class="function">register_step_pre_hook</dd>
                <dd id="FullBatchLBFGS.register_step_post_hook" class="function">register_step_post_hook</dd>
                <dd id="FullBatchLBFGS.state_dict" class="function">state_dict</dd>
                <dd id="FullBatchLBFGS.load_state_dict" class="function">load_state_dict</dd>
                <dd id="FullBatchLBFGS.zero_grad" class="function">zero_grad</dd>
                <dd id="FullBatchLBFGS.add_param_group" class="function">add_param_group</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>