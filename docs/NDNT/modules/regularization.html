<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.4.0"/>
    <title>NDNT.modules.regularization API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../modules.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;NDNT.modules</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Regularization">Regularization</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Regularization.__init__">Regularization</a>
                        </li>
                        <li>
                                <a class="variable" href="#Regularization.input_dims">input_dims</a>
                        </li>
                        <li>
                                <a class="variable" href="#Regularization.vals">vals</a>
                        </li>
                        <li>
                                <a class="variable" href="#Regularization.reg_modules">reg_modules</a>
                        </li>
                        <li>
                                <a class="variable" href="#Regularization.normalize">normalize</a>
                        </li>
                        <li>
                                <a class="variable" href="#Regularization.unit_reg">unit_reg</a>
                        </li>
                        <li>
                                <a class="variable" href="#Regularization.folded_lags">folded_lags</a>
                        </li>
                        <li>
                                <a class="variable" href="#Regularization.num_outputs">num_outputs</a>
                        </li>
                        <li>
                                <a class="variable" href="#Regularization.pos_constraint">pos_constraint</a>
                        </li>
                        <li>
                                <a class="variable" href="#Regularization.boundary_conditions">boundary_conditions</a>
                        </li>
                        <li>
                                <a class="variable" href="#Regularization.activity_regmodule">activity_regmodule</a>
                        </li>
                        <li>
                                <a class="function" href="#Regularization.set_reg_val">set_reg_val</a>
                        </li>
                        <li>
                                <a class="function" href="#Regularization.unit_reg_convert">unit_reg_convert</a>
                        </li>
                        <li>
                                <a class="function" href="#Regularization.build_reg_modules">build_reg_modules</a>
                        </li>
                        <li>
                                <a class="function" href="#Regularization.compute_reg_loss">compute_reg_loss</a>
                        </li>
                        <li>
                                <a class="function" href="#Regularization.compute_activity_regularization">compute_activity_regularization</a>
                        </li>
                        <li>
                                <a class="function" href="#Regularization.reg_copy">reg_copy</a>
                        </li>
                        <li>
                                <a class="function" href="#Regularization.get_reg_class">get_reg_class</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#RegModule">RegModule</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#RegModule.__init__">RegModule</a>
                        </li>
                        <li>
                                <a class="variable" href="#RegModule.reg_type">reg_type</a>
                        </li>
                        <li>
                                <a class="variable" href="#RegModule.unit_reg">unit_reg</a>
                        </li>
                        <li>
                                <a class="variable" href="#RegModule.input_dims">input_dims</a>
                        </li>
                        <li>
                                <a class="variable" href="#RegModule.num_dims">num_dims</a>
                        </li>
                        <li>
                                <a class="variable" href="#RegModule.folded_lags">folded_lags</a>
                        </li>
                        <li>
                                <a class="variable" href="#RegModule.pos_constraint">pos_constraint</a>
                        </li>
                        <li>
                                <a class="function" href="#RegModule.forward">forward</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LocalityReg">LocalityReg</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LocalityReg.__init__">LocalityReg</a>
                        </li>
                        <li>
                                <a class="function" href="#LocalityReg.compute_reg_penalty">compute_reg_penalty</a>
                        </li>
                        <li>
                                <a class="function" href="#LocalityReg.build_reg_mats">build_reg_mats</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DiagonalReg">DiagonalReg</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DiagonalReg.__init__">DiagonalReg</a>
                        </li>
                        <li>
                                <a class="variable" href="#DiagonalReg.input_dims">input_dims</a>
                        </li>
                        <li>
                                <a class="function" href="#DiagonalReg.compute_reg_penalty">compute_reg_penalty</a>
                        </li>
                        <li>
                                <a class="function" href="#DiagonalReg.build_reg_mats">build_reg_mats</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#InlineReg">InlineReg</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#InlineReg.__init__">InlineReg</a>
                        </li>
                        <li>
                                <a class="function" href="#InlineReg.compute_reg_penalty">compute_reg_penalty</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ConvReg">ConvReg</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ConvReg.__init__">ConvReg</a>
                        </li>
                        <li>
                                <a class="variable" href="#ConvReg.BC">BC</a>
                        </li>
                        <li>
                                <a class="function" href="#ConvReg.compute_reg_penalty">compute_reg_penalty</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Tikhanov">Tikhanov</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Tikhanov.__init__">Tikhanov</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tikhanov.input_dims">input_dims</a>
                        </li>
                        <li>
                                <a class="function" href="#Tikhanov.compute_reg_penalty">compute_reg_penalty</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#TikhanovC">TikhanovC</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TikhanovC.__init__">TikhanovC</a>
                        </li>
                        <li>
                                <a class="variable" href="#TikhanovC.input_dims">input_dims</a>
                        </li>
                        <li>
                                <a class="variable" href="#TikhanovC.collapse_dims">collapse_dims</a>
                        </li>
                        <li>
                                <a class="function" href="#TikhanovC.compute_reg_penalty">compute_reg_penalty</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ActivityReg">ActivityReg</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ActivityReg.__init__">ActivityReg</a>
                        </li>
                        <li>
                                <a class="variable" href="#ActivityReg.acitivity_penalty">acitivity_penalty</a>
                        </li>
                        <li>
                                <a class="function" href="#ActivityReg.compute_activity_penalty">compute_activity_penalty</a>
                        </li>
                        <li>
                                <a class="function" href="#ActivityReg.compute_reg_penalty">compute_reg_penalty</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../NDNT.html">NDNT</a><wbr>.<a href="./../modules.html">modules</a><wbr>.regularization    </h1>

                
                        <input id="mod-regularization-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-regularization-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="c1">### regularization.py: managing regularization</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="k">class</span> <span class="nc">Regularization</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">    Class for handling layer-wise regularization. </span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">    </span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">    This class stores all info for regularization, </span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">    and sets up regularization modules for training, </span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    and returns reg_penalty from layer when passed in weights.</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">    </span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">    Attributes:</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">        vals (dict): values for different types of regularization stored as</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">            floats</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">        vals_ph (dict): placeholders for different types of regularization to</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">            simplify the tf Graph when experimenting with different reg vals</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">        vals_var (dict): values for different types of regularization stored as</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">            (un-trainable) tf.Variables</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">        mats (dict): matrices for different types of regularization stored as</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">            tf constants</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">        penalties (dict): tf ops for evaluating different regularization </span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">            penalties</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">        input_dims (list): dimensions of layer input size; for constructing reg </span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">            matrices</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">        num_outputs (int): dimension of layer output size; for generating </span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">            target weights in norm2</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>                 <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Regularization class. This stores all info for regularization, and </span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">        sets up regularization modules for training, and returns reg_penalty from layer when passed in weights</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">        </span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">        Parameters:</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">        - input_dims (list of ints): dimension of input size (for building reg mats)</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">        - vals (dict, optional): key-value pairs specifying value for each type of regularization </span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">        - Note: to pass in boundary_condition information, use a dict in vals with the values corresponding to</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">            particular regularization, e,g., &#39;BCs&#39;:{&#39;d2t&#39;:1, &#39;d2x&#39;:0} (1=on, 0=off)</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">            </span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        Raises:</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">        - TypeError: If `input_dims` is not specified</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">        - TypeError: If `num_outputs` is not specified</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">        </span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">        Notes:</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">        - I&#39;m using my old regularization matrices, which is made for the following 3-dimensional </span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">        weights with dimensions ordered in [NX, NY, num_lags]. Currently, filter_dims is 4-d: </span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">        [num_filters, NX, NY, num_lags] so this will need to rearrage so num_filters gets folded into last </span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">        dimension so that it will work with d2t regularization, if reshape is necessary]</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">Regularization</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="c1"># check input</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="k">assert</span> <span class="n">filter_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must specify `input_dims`&quot;</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="n">filter_dims</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vals</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span> 
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">=</span> <span class="n">num_outputs</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="o">=</span><span class="n">pos_constraint</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">activity_regmodule</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="c1"># read user input</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>        <span class="k">if</span> <span class="n">vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>            <span class="k">for</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>                <span class="k">if</span> <span class="n">reg_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_reg_val</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">)</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>    <span class="c1"># END Regularization.__init__</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>    <span class="k">def</span> <span class="nf">set_reg_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set regularization value in self.vals dict </span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">        </span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">        Args:</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">            reg_type (str): see `_allowed_reg_types` for options</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">            reg_val (float): value of regularization parameter</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">            </span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">        Returns:</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">            bool: True if `reg_type` has not been previously set</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">            </span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">        Note: can also pass in a dictionary with boundary condition information addressed by reg_type</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">        Raises:</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">            ValueError: If `reg_type` is not a valid regularization type</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">            ValueError: If `reg_val` is less than 0.0            </span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="c1"># check inputs</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reg_class</span><span class="p">():</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>            <span class="k">if</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bc&#39;</span><span class="p">,</span> <span class="s1">&#39;bcs&#39;</span><span class="p">,</span> <span class="s1">&#39;BC&#39;</span><span class="p">,</span> <span class="s1">&#39;BCs&#39;</span><span class="p">]:</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s2">&quot;Regularization: boundary conditions must be a dictionary.&quot;</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">reg_val</span><span class="p">)</span>  <span class="c1"># set potential boundary conditions</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>                <span class="k">return</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regularization: </span><span class="si">%s</span><span class="s2"> not recognized as a valid regularization type&quot;</span> <span class="o">%</span> <span class="n">reg_type</span><span class="p">)</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>                <span class="c1"># skip this regularization type</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>                <span class="k">return</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="k">if</span> <span class="n">reg_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># then eliminate reg_type</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>            <span class="k">if</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">:</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># add or modify reg_val</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">reg_val</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`reg_val` must be greater than or equal to zero&#39;</span><span class="p">)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span><span class="p">:</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;UNITREG initialization problems&quot;</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_val</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">,</span> <span class="s2">&quot;UNITREG: unmatched size list of reg values&quot;</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">reg_val</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">*</span><span class="n">reg_val</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Normal reg val setting</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_val</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>    <span class="c1"># END Regularization.set_reg_val</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>    <span class="k">def</span> <span class="nf">unit_reg_convert</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">unit_reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Can convert reg object to turn on or off unit_reg (default turns it on&quot;&quot;&quot;</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="k">if</span> <span class="n">unit_reg</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span><span class="p">:</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UNITREG: No conversion necessary&quot;</span><span class="p">)</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>            <span class="k">return</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="k">if</span> <span class="n">unit_reg</span> <span class="ow">and</span> <span class="p">(</span><span class="n">num_outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;UNITREG: must set num_ouputs&quot;</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span> <span class="o">=</span> <span class="n">unit_reg</span> 
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="k">for</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">unit_reg</span><span class="p">:</span>  <span class="c1"># turn off unit reg -- convert from list to single number via mean</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>                <span class="n">new_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> 
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>                <span class="n">new_val</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>            
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_reg_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">new_val</span><span class="p">)</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>    <span class="c1"># END Regularization.unit_reg_convert</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>    <span class="k">def</span> <span class="nf">build_reg_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepares regularization modules in train based on current regularization values&quot;&quot;&quot;</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>  <span class="c1"># this clears old modules (better way?)</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>            
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="k">for</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>            <span class="c1"># check for boundary conditions</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>            <span class="n">BC</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># default padding for boundary conditions</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>                <span class="k">if</span> <span class="n">reg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span><span class="p">:</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>                    <span class="n">BC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>                    <span class="c1">#print(&#39;  Setting boundary conditions for&#39;, reg, &#39;=&#39;, BC)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>            <span class="n">reg_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reg_class</span><span class="p">(</span><span class="n">reg</span><span class="p">)(</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>                <span class="n">reg_type</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> 
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>                <span class="n">input_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">,</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>                <span class="n">folded_lags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">,</span> <span class="n">unit_reg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="n">BC</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_obj</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>            <span class="k">if</span> <span class="n">reg</span> <span class="o">==</span> <span class="s1">&#39;activity&#39;</span><span class="p">:</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">activity_regmodule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># hoping this acts as a pointer (otherwise use explicit indexing)</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>                <span class="c1"># note this currently will only handle one activity reg type at once, otherwise make list </span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>    <span class="c1"># END Regularization.build_reg_modules</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>    <span class="k">def</span> <span class="nf">compute_reg_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>        <span class="c1"># I don&#39;t think this flag is yet used anywhere -- weights are passed in normalized, if relevant</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span> 
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="n">weights</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="n">rloss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="k">for</span> <span class="n">regmod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span><span class="p">:</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            <span class="n">rloss</span> <span class="o">+=</span> <span class="n">regmod</span><span class="p">(</span> <span class="n">weights</span> <span class="p">)</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="k">return</span> <span class="n">rloss</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>    <span class="c1"># END Regularization.define_reg_loss</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>    <span class="k">def</span> <span class="nf">compute_activity_regularization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_output</span><span class="p">):</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="c1"># first put wrapper so wont throw bug with older model</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activity_regmodule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">activity_regmodule</span><span class="o">.</span><span class="n">compute_activity_penalty</span><span class="p">(</span><span class="n">layer_output</span><span class="p">)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>    <span class="k">def</span> <span class="nf">reg_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy regularization to new structure&quot;&quot;&quot;</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="n">reg_target</span> <span class="o">=</span> <span class="n">Regularization</span><span class="p">(</span><span class="n">input_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">)</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="n">reg_target</span><span class="o">.</span><span class="n">vals</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="k">return</span> <span class="n">reg_target</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>    <span class="k">def</span> <span class="nf">get_reg_class</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="n">reg_index</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;d2xt&#39;</span><span class="p">:</span> <span class="n">ConvReg</span><span class="p">,</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>                     <span class="s1">&#39;d2x&#39;</span><span class="p">:</span> <span class="n">ConvReg</span><span class="p">,</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>                     <span class="s1">&#39;d2t&#39;</span><span class="p">:</span> <span class="n">ConvReg</span><span class="p">,</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>                     <span class="s1">&#39;l1&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>                     <span class="s1">&#39;l2&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>                     <span class="s1">&#39;norm2&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span> <span class="c1"># weight regularization</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>                     <span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>                     <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>                     <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>                     <span class="s1">&#39;orth&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>                     <span class="s1">&#39;bi_t&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>                     <span class="s1">&#39;glocalx&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>                     <span class="s1">&#39;glocalt&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>                     <span class="s1">&#39;localx&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>                     <span class="s1">&#39;localt&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>                     <span class="s1">&#39;trd&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>                     <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>                     <span class="s1">&#39;glocal&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>                     <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>                     <span class="s1">&#39;max_filt&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>                     <span class="s1">&#39;max_space&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>                     <span class="s1">&#39;gmax_t&#39;</span><span class="p">:</span> <span class="n">TikhanovC</span><span class="p">,</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>                     <span class="s1">&#39;gmax_space&#39;</span><span class="p">:</span> <span class="n">TikhanovC</span><span class="p">,</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>                     <span class="s1">&#39;gmax_filter&#39;</span><span class="p">:</span> <span class="n">TikhanovC</span><span class="p">,</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>                     <span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="n">DiagonalReg</span><span class="p">,</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>                     <span class="s1">&#39;edge_t&#39;</span><span class="p">:</span> <span class="n">DiagonalReg</span><span class="p">,</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>                     <span class="s1">&#39;edge_t0&#39;</span><span class="p">:</span> <span class="n">DiagonalReg</span><span class="p">,</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>                     <span class="s1">&#39;edge_x&#39;</span><span class="p">:</span> <span class="n">DiagonalReg</span><span class="p">,</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>                     <span class="s1">&#39;activity&#39;</span><span class="p">:</span> <span class="n">ActivityReg</span><span class="p">}</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>        
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="n">ret</span> <span class="o">=</span> <span class="n">reg_index</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            <span class="n">ret</span> <span class="o">=</span> <span class="n">reg_index</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>    <span class="c1"># END Regularization.reg_copy</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="k">class</span> <span class="nc">RegModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span> 
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Base class for regularization modules &quot;&quot;&quot;</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>                 <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_dims</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">unit_reg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>                 <span class="n">pos_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Reg_module class&quot;&quot;&quot;</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Need reg_type.&#39;</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="k">assert</span> <span class="n">reg_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Need reg_val&#39;</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        <span class="k">assert</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Need input dims&#39;</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">=</span> <span class="n">reg_type</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span> <span class="o">=</span> <span class="n">unit_reg</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">reg_val</span><span class="p">))</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="n">input_dims</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">=</span> <span class="n">num_dims</span> <span class="c1"># this is the relevant number of dimensions for some filters -- will be set within functions</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span> <span class="o">=</span> <span class="n">pos_constraint</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reg_penalty</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">*</span> <span class="n">rpen</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>        <span class="k">return</span> <span class="n">rpen</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="k">class</span> <span class="nc">LocalityReg</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Regularization to penalize locality separably for each dimension&quot;&quot;&quot;</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>    
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_dims</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for LocalityReg class&quot;&quot;&quot;</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;localx&#39;</span><span class="p">,</span> <span class="s1">&#39;localt&#39;</span><span class="p">,</span> <span class="s1">&#39;glocalx&#39;</span><span class="p">,</span> <span class="s1">&#39;glocalt&#39;</span><span class="p">,</span> <span class="s1">&#39;trd&#39;</span><span class="p">]</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid Locality Reg type&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">build_reg_mats</span><span class="p">()</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="c1"># normalized weights mean w ~ 1/sqrt(N), so \sum w^2 = 1. but w^4 =&gt; 1/N^2 so multiply by N</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="c1">#self.multiplier = np.prod(input_dims)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute regularization penalty for locality&quot;&quot;&quot;</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#[C, NX, NY, num_lags, num_filters]</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="c1">#[C, NX, NY, num_lags, num_filters]</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocalx&#39;</span><span class="p">:</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>            
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>            <span class="c1"># glocal                </span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>            <span class="n">wx</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># sum over y and t (note this works for singular dim y too, i.e., 1d)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>            <span class="n">penx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xn,xw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">wx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localx_pen</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="n">penx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xn,xn-&gt;n&#39;</span><span class="p">,</span> <span class="n">penx</span><span class="p">,</span> <span class="n">wx</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>                <span class="n">rpen</span> <span class="o">=</span> <span class="n">penx</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                <span class="n">wy</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># sum over x and t</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">same_dims</span><span class="p">:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,yw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localx_pen</span><span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,yn-&gt;n&#39;</span><span class="p">,</span> <span class="n">peny</span><span class="p">,</span> <span class="n">wy</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                <span class="k">else</span><span class="p">:</span>    
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,yw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localy_pen</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,yn-&gt;n&#39;</span><span class="p">,</span> <span class="n">peny</span><span class="p">,</span> <span class="n">wy</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>                <span class="n">rpen</span> <span class="o">=</span> <span class="n">penx</span> <span class="o">+</span> <span class="n">peny</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocalt&#39;</span><span class="p">:</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="c1"># glocal on time</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>            <span class="c1">#w = weights.reshape(self.input_dims + [-1])**2</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>            <span class="n">wt</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tn,tw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">wt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localt_pen</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tn,tn-&gt;n&#39;</span><span class="p">,</span> <span class="n">rpen</span><span class="p">,</span> <span class="n">wt</span><span class="p">)</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;localx&#39;</span><span class="p">:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="c1"># glocal</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="c1">#w = weights.reshape(self.input_dims + [-1])**2 #[C, NX, NY, num_lags, num_filters]</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>            <span class="n">penx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,xw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localx_pen</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>            <span class="n">penx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">penx</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                <span class="n">rpen</span> <span class="o">=</span> <span class="n">penx</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">same_dims</span><span class="p">:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,yw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localx_pen</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">peny</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                <span class="k">else</span><span class="p">:</span>    
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,yw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localy_pen</span><span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">peny</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                <span class="n">rpen</span> <span class="o">=</span> <span class="n">penx</span> <span class="o">+</span> <span class="n">peny</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;localt&#39;</span><span class="p">:</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>            
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>            <span class="c1"># glocal on time</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>            <span class="c1">#w = weights.reshape(self.input_dims + [-1])**2</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,tw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localt_pen</span><span class="p">)</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">rpen</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;trd&#39;</span><span class="p">:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="c1"># penalty on time</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>            <span class="c1">#w = weights.reshape(self.input_dims + [-1])**2</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,tw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trd_pen</span><span class="p">)</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">rpen</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>        
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>        <span class="k">return</span> <span class="n">rpen</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>    <span class="c1"># END LocalityReg.compute_reg_penalty</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>    <span class="k">def</span> <span class="nf">build_reg_mats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocalx&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;localx&#39;</span><span class="p">:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;localx_pen&#39;</span><span class="p">,((</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">same_dims</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">same_dims</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;localy_pen&#39;</span><span class="p">,((</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocalt&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;localt&#39;</span><span class="p">:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;localt_pen&#39;</span><span class="p">,((</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;trd&#39;</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;trd_pen&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="k">class</span> <span class="nc">DiagonalReg</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Regularization module for diagonal penalties&quot;&quot;&quot;</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_t&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_t0&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_x&#39;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid Diagonal Regularization type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>        <span class="c1"># the &quot;input_dims&quot; are ordered differently for matrix implementations,</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="c1"># so this is a temporary fix to be able to use old functions</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="n">input_dims</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="n">reg_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_reg_mats</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>    
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute regularization loss&quot;&quot;&quot;</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">:</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#[C, NX, NY, num_lags, num_filters]</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="c1">#[C, NX, NY, num_lags, num_filters]</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>        <span class="c1"># Collapse weights across non-spatial dimensions</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;center&#39;</span><span class="p">:</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>            <span class="n">wcollapse</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">wcollapse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regcost</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;edge_t&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_t0&#39;</span><span class="p">]:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>            <span class="n">wcollapse</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">wcollapse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regcost</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;edge_x&#39;</span><span class="p">:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>            <span class="n">wcollapse</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">wcollapse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regcost_x</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                <span class="n">wcollapse</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                <span class="n">rpen</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">wcollapse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regcost_y</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="k">return</span> <span class="n">rpen</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>    
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>    <span class="k">def</span> <span class="nf">build_reg_mats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">):</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>    
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="n">NX</span><span class="p">,</span> <span class="n">NY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;center&#39;</span><span class="p">:</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>            <span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">NX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>            <span class="n">px</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NX</span><span class="p">)</span><span class="o">-</span><span class="n">center_x</span><span class="p">)</span><span class="o">/</span><span class="n">center_x</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>            <span class="k">if</span> <span class="n">NY</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># then 1-d space</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>                <span class="n">rmat</span> <span class="o">=</span> <span class="n">px</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>                <span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">NY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>                <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NY</span><span class="p">)</span><span class="o">-</span><span class="n">center_y</span><span class="p">)</span><span class="o">/</span><span class="n">center_y</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>                <span class="c1"># Make a matrix and then reshape</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">px</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="n">NY</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NX</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">@</span> <span class="n">py</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat</span><span class="p">))</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;edge_t&#39;</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>            <span class="n">rmat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>            <span class="n">rmat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat</span><span class="p">))</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;edge_t0&#39;</span><span class="p">:</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="n">rmat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat</span><span class="p">))</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;edge_x&#39;</span><span class="p">:</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>            <span class="n">rmat_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="n">rmat_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>            <span class="n">rmat_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost_x&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat_x</span><span class="p">))</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>            <span class="n">rmat_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>            <span class="n">rmat_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>            <span class="n">rmat_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost_y&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat_y</span><span class="p">))</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="k">class</span> <span class="nc">InlineReg</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Regularization module for inline penalties&quot;&quot;&quot;</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="s1">&#39;norm2&#39;</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="s1">&#39;orth&#39;</span><span class="p">,</span> <span class="s1">&#39;bi_t&#39;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid Inline Regularization type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a><span class="w">        </span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate regularization penalty for various reg types&quot;&quot;&quot;</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;l1&#39;</span><span class="p">:</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;l2&#39;</span><span class="p">:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>        
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;norm2&#39;</span><span class="p">:</span>  <span class="c1"># [custom] convex (I think) soft-normalization regularization</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;norm&#39;</span><span class="p">:</span>  <span class="c1"># [custom] convex (I think) soft-normalization regularization</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>  <span class="c1"># [custom] soft positive regularization</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="o">-</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span>  <span class="c1"># [custom] soft negative regularization</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;orth&#39;</span><span class="p">:</span>  <span class="c1"># [custom] orthogonal regularization</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">w</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;bi_t&#39;</span><span class="p">:</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>            <span class="n">n</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>        <span class="k">return</span> <span class="n">reg_pen</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a><span class="k">class</span> <span class="nc">ConvReg</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Regularization module for convolutional penalties&quot;&quot;&quot;</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Reg_module class&quot;&quot;&quot;</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;d2x&#39;</span><span class="p">,</span> <span class="s1">&#39;d2t&#39;</span><span class="p">,</span> <span class="s1">&#39;d2xt&#39;</span><span class="p">]</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid ConvReg type&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>        <span class="n">reg_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_laplacian</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;rmat&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">reg_mat</span><span class="p">))</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">BC</span> <span class="o">=</span> <span class="n">bc_val</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>    
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;I&#39;m separating the code for more complicated regularization penalties in the simplest possible way here, but</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">        this can be done more (or less) elaborately in the future. The challenge here is that the dimension of the weight</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a><span class="sd">        vector (1-D, 2-D, 3-D) determines what sort of Laplacian matrix, and convolution, to do</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">        Note that all convolutions are implicitly &#39;valid&#39; so no boundary conditions&quot;&quot;&quot;</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>        <span class="n">num_filters</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>        <span class="n">weight_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="n">num_filters</span><span class="p">]</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">weight_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weight_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">weight_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>            
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weight_dims</span><span class="p">)</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>        <span class="c1"># puts in [C, W, H, T, num_filters]: to reorder depending on reg type</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>        <span class="c1"># default reg_dims</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2t&#39;</span><span class="p">:</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># needs temporal dimension last so only convolved</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>            <span class="c1">#reg_dims = [weight_dims[3]]</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2xt&#39;</span><span class="p">:</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FL&#39;</span><span class="p">)</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># weights correspding to lag are up front</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> 
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>            <span class="c1"># Reg-dims will depend on whether space is one- or two-dimensional</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>            <span class="c1">#if weight_dims[2] &gt; 1:</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>            <span class="c1">#    reg_dims = [weight_dims[1], weight_dims[2], weight_dims[3]]</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>            <span class="c1">#else:</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>            <span class="c1">#    reg_dims = [weight_dims[1], weight_dims[3]]</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># then d2x</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># rotate temporal dimensions next to filter dims</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>            <span class="c1">#reg_dims = [weight_dims[1], weight_dims[2]]</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="c1"># Apply boundary conditions dependent on default values (that can be set by hand):</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>            <span class="c1"># prepare for 1-d convolve</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span> 
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>                <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="p">),</span>  <span class="c1"># [batch_dim, all non-conv dims, conv_dim]</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BC</span> <span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#/ weight_dims[-1]</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span> 
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>                <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="p">),</span> 
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BC</span> <span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#/ weight_dims[-1]</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>            
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv3d</span><span class="p">(</span> 
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>                <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span><span class="p">),</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BC</span> <span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#/ weight_dims[-1]</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>        
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>        <span class="c1"># average over all dimensions except the filter dimension</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="n">rpen</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_filters</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="n">rpen</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>        <span class="k">return</span> <span class="n">rpen</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>    
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>    <span class="k">def</span> <span class="nf">_make_laplacian</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span> <span class="p">):</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;This will make the Laplacian of the right dimensionality depending on d2xt, d2t, d2x&quot;&quot;&quot;</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>        <span class="c1"># Determine relevant reg_dims for Laplacian</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2t&#39;</span><span class="p">:</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2x&#39;</span><span class="p">:</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># d2xt</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>        <span class="c1"># Determine number of dimensions for laplacian matrix (and convolution)</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>        <span class="n">dim_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">1</span>  <span class="c1"># filter dimension will be ignored</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2t&#39;</span><span class="p">:</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>            <span class="n">dim_mask</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># zeros out spatial dimensions</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2x&#39;</span><span class="p">:</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>            <span class="n">dim_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># zeros out temporal dimensions</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim_mask</span><span class="p">)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>        
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>        <span class="c1"># note all the extra brackets are so the first two dims [out_chan, in_chan] are 1,1</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>            
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>            <span class="c1">#rmat = np.array([[[[0,-1,0],[-1, 4, -1], [0,-1,0]]]])</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>            <span class="c1"># Isotropic form of discrete Laplacian operator (https://en.wikipedia.org/wiki/Discrete_Laplace_operator)</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[[</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.25</span><span class="p">],[</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.25</span><span class="p">]]]])</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>            <span class="c1">#rmat = np.array(</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>            <span class="c1">#    [[[[[0, 0, 0],[0, -1, 0], [0, 0, 0]],</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>            <span class="c1">#    [[0, -1, 0],[-1, 6, -1], [0, -1, 0]],</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>            <span class="c1">#    [[0, 0, 0],[0, -1, 0], [0, 0, 0]]]]])</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>            <span class="c1"># Isotropic form:</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">26</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>                <span class="p">[[[[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>                <span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">88</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>                <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]]]])</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Warning: </span><span class="si">%s</span><span class="s2"> regularization does not have the necessary filter dimensions.&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="p">)</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>        <span class="k">return</span> <span class="n">rmat</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>        
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a><span class="k">class</span> <span class="nc">Tikhanov</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Regularization module for Tikhanov regularization&quot;&quot;&quot;</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Tikhanov class&quot;&quot;&quot;</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="n">bc_val</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>        
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;glocal&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;max_filt&#39;</span><span class="p">,</span> <span class="s1">&#39;max_space&#39;</span><span class="p">]</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid Tikhanov regularization type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>        
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>        <span class="c1"># the &quot;input_dims&quot; are ordered differently for matrix implementations,</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>        <span class="c1"># so this is a temporary fix to be able to use old functions</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>            <span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="c1"># non-spatial</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>            <span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="c1"># spatial </span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>        <span class="c1"># Make appropriate reg_matrix as buffer (non-fit parameter)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>        <span class="n">reg_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_reg_mats</span><span class="p">(</span> <span class="n">reg_type</span> <span class="p">)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;rmat&#39;</span><span class="p">,</span> <span class="n">reg_tensor</span><span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>    
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate regularization penalty for Tikhanov reg types&quot;&quot;&quot;</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>        <span class="n">w2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>        <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">w2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>        <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">reg_pen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># sum later (replaced call to torch.trace)</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>        <span class="k">return</span> <span class="n">reg_pen</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>    <span class="k">def</span> <span class="nf">_build_reg_mats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">):</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build regularization matrices in default tf Graph</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a><span class="sd">        Args:</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a><span class="sd">            reg_type (str): see `_allowed_reg_types` for options</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>        <span class="kn">import</span> <span class="nn">NDNT.utils.create_reg_matrices</span> <span class="k">as</span> <span class="nn">get_rmats</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;max_filt&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;max_space&#39;</span><span class="p">):</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>            <span class="n">reg_mat</span> <span class="o">=</span> <span class="n">get_rmats</span><span class="o">.</span><span class="n">create_maxpenalty_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">)</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>            <span class="n">reg_mat</span> <span class="o">=</span> <span class="n">get_rmats</span><span class="o">.</span><span class="n">create_localpenalty_matrix</span><span class="p">(</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">separable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocal&#39;</span><span class="p">:</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>            <span class="n">reg_mat</span> <span class="o">=</span> <span class="n">get_rmats</span><span class="o">.</span><span class="n">create_localpenalty_matrix</span><span class="p">(</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">separable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spatial_global</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>            <span class="n">reg_mat</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>        <span class="k">if</span> <span class="n">reg_mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">reg_mat</span><span class="p">)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>    <span class="c1"># END Tikhanov.build_reg_mats</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a><span class="k">class</span> <span class="nc">TikhanovC</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Regularization module for Tikhanov-collapse regularization -- where all but one</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a><span class="sd">    dimension is marginalized over first&quot;&quot;&quot;</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Tikhanov class&quot;&quot;&quot;</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="n">bc_val</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>        
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gmax_t&#39;</span><span class="p">,</span> <span class="s1">&#39;gmax_space&#39;</span><span class="p">,</span> <span class="s1">&#39;gmax_filter&#39;</span><span class="p">]</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid Tikhanov-C regularization type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>        
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>        <span class="c1"># the &quot;input_dims&quot; are ordered differently for matrix implementations,</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>        <span class="c1"># so this is a temporary fix to be able to use old functions</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collapse_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;gmax_t&#39;</span><span class="p">:</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;gmax_filter&#39;</span><span class="p">:</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collapse_dims</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span><span class="p">)</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>        <span class="c1"># Make appropriate reg_matrix as buffer (non-fit parameter)</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>        <span class="n">reg_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_reg_mats</span><span class="p">(</span> <span class="n">reg_type</span> <span class="p">)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;rmat&#39;</span><span class="p">,</span> <span class="n">reg_tensor</span><span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>    
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate regularization penalty for Tikhanov reg types&quot;&quot;&quot;</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>        <span class="c1">#w2 = torch.square(weights)  # assuming positive constraints here -- no squaring needed</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>                <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="c1"># [C, W*H, T, NF]</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>                <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collapse_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>                <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collapse_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>        <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>        <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">reg_pen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># sum later (replaced call to torch.trace)</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>        <span class="k">return</span> <span class="n">reg_pen</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>    <span class="k">def</span> <span class="nf">_build_reg_mats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">):</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build regularization matrices in default tf Graph</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a><span class="sd">        Args:</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a><span class="sd">            reg_type (str): see `_allowed_reg_types` for options</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>        <span class="c1">#import NDNT.utils.create_reg_matrices as get_rmats</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span><span class="p">]</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>        <span class="n">reg_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">L</span><span class="p">,</span><span class="n">L</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">reg_mat</span><span class="p">)</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>    <span class="c1"># END TikhanovC.build_reg_mats</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a><span class="k">class</span> <span class="nc">ActivityReg</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Regularization to penalize activity separably for each dimension</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a><span class="sd">    Note that the penalty needs to be computed elsewhere and just stored here&quot;&quot;&quot;</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>    
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_dims</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for LocalityReg class&quot;&quot;&quot;</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;activity&#39;</span><span class="p">]</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid Locality Reg type&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acitivity_penalty</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>    <span class="c1"># END ActivityReg.__init__</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>    <span class="k">def</span> <span class="nf">compute_activity_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acts</span> <span class="p">):</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes activity penalty from activations -- called in layer forward&quot;&quot;&quot;</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>        <span class="c1"># Can put conditionals if there is more than one reg module</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">activity_penalty</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">acts</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute regularization penalty for locality&quot;&quot;&quot;</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activity_penalty</span>  <span class="c1"># this is precomputed</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>    <span class="c1"># END ActivityReg.__init__</span>
</span></pre></div>


            </section>
                <section id="Regularization">
                            <input id="Regularization-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Regularization</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="Regularization-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Regularization"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Regularization-10"><a href="#Regularization-10"><span class="linenos"> 10</span></a><span class="k">class</span> <span class="nc">Regularization</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="Regularization-11"><a href="#Regularization-11"><span class="linenos"> 11</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Regularization-12"><a href="#Regularization-12"><span class="linenos"> 12</span></a><span class="sd">    Class for handling layer-wise regularization. </span>
</span><span id="Regularization-13"><a href="#Regularization-13"><span class="linenos"> 13</span></a><span class="sd">    </span>
</span><span id="Regularization-14"><a href="#Regularization-14"><span class="linenos"> 14</span></a><span class="sd">    This class stores all info for regularization, </span>
</span><span id="Regularization-15"><a href="#Regularization-15"><span class="linenos"> 15</span></a><span class="sd">    and sets up regularization modules for training, </span>
</span><span id="Regularization-16"><a href="#Regularization-16"><span class="linenos"> 16</span></a><span class="sd">    and returns reg_penalty from layer when passed in weights.</span>
</span><span id="Regularization-17"><a href="#Regularization-17"><span class="linenos"> 17</span></a><span class="sd">    </span>
</span><span id="Regularization-18"><a href="#Regularization-18"><span class="linenos"> 18</span></a><span class="sd">    Attributes:</span>
</span><span id="Regularization-19"><a href="#Regularization-19"><span class="linenos"> 19</span></a><span class="sd">        vals (dict): values for different types of regularization stored as</span>
</span><span id="Regularization-20"><a href="#Regularization-20"><span class="linenos"> 20</span></a><span class="sd">            floats</span>
</span><span id="Regularization-21"><a href="#Regularization-21"><span class="linenos"> 21</span></a><span class="sd">        vals_ph (dict): placeholders for different types of regularization to</span>
</span><span id="Regularization-22"><a href="#Regularization-22"><span class="linenos"> 22</span></a><span class="sd">            simplify the tf Graph when experimenting with different reg vals</span>
</span><span id="Regularization-23"><a href="#Regularization-23"><span class="linenos"> 23</span></a><span class="sd">        vals_var (dict): values for different types of regularization stored as</span>
</span><span id="Regularization-24"><a href="#Regularization-24"><span class="linenos"> 24</span></a><span class="sd">            (un-trainable) tf.Variables</span>
</span><span id="Regularization-25"><a href="#Regularization-25"><span class="linenos"> 25</span></a><span class="sd">        mats (dict): matrices for different types of regularization stored as</span>
</span><span id="Regularization-26"><a href="#Regularization-26"><span class="linenos"> 26</span></a><span class="sd">            tf constants</span>
</span><span id="Regularization-27"><a href="#Regularization-27"><span class="linenos"> 27</span></a><span class="sd">        penalties (dict): tf ops for evaluating different regularization </span>
</span><span id="Regularization-28"><a href="#Regularization-28"><span class="linenos"> 28</span></a><span class="sd">            penalties</span>
</span><span id="Regularization-29"><a href="#Regularization-29"><span class="linenos"> 29</span></a><span class="sd">        input_dims (list): dimensions of layer input size; for constructing reg </span>
</span><span id="Regularization-30"><a href="#Regularization-30"><span class="linenos"> 30</span></a><span class="sd">            matrices</span>
</span><span id="Regularization-31"><a href="#Regularization-31"><span class="linenos"> 31</span></a><span class="sd">        num_outputs (int): dimension of layer output size; for generating </span>
</span><span id="Regularization-32"><a href="#Regularization-32"><span class="linenos"> 32</span></a><span class="sd">            target weights in norm2</span>
</span><span id="Regularization-33"><a href="#Regularization-33"><span class="linenos"> 33</span></a>
</span><span id="Regularization-34"><a href="#Regularization-34"><span class="linenos"> 34</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Regularization-35"><a href="#Regularization-35"><span class="linenos"> 35</span></a>
</span><span id="Regularization-36"><a href="#Regularization-36"><span class="linenos"> 36</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="Regularization-37"><a href="#Regularization-37"><span class="linenos"> 37</span></a>                 <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Regularization-38"><a href="#Regularization-38"><span class="linenos"> 38</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Regularization class. This stores all info for regularization, and </span>
</span><span id="Regularization-39"><a href="#Regularization-39"><span class="linenos"> 39</span></a><span class="sd">        sets up regularization modules for training, and returns reg_penalty from layer when passed in weights</span>
</span><span id="Regularization-40"><a href="#Regularization-40"><span class="linenos"> 40</span></a><span class="sd">        </span>
</span><span id="Regularization-41"><a href="#Regularization-41"><span class="linenos"> 41</span></a><span class="sd">        Parameters:</span>
</span><span id="Regularization-42"><a href="#Regularization-42"><span class="linenos"> 42</span></a><span class="sd">        - input_dims (list of ints): dimension of input size (for building reg mats)</span>
</span><span id="Regularization-43"><a href="#Regularization-43"><span class="linenos"> 43</span></a><span class="sd">        - vals (dict, optional): key-value pairs specifying value for each type of regularization </span>
</span><span id="Regularization-44"><a href="#Regularization-44"><span class="linenos"> 44</span></a><span class="sd">        - Note: to pass in boundary_condition information, use a dict in vals with the values corresponding to</span>
</span><span id="Regularization-45"><a href="#Regularization-45"><span class="linenos"> 45</span></a><span class="sd">            particular regularization, e,g., &#39;BCs&#39;:{&#39;d2t&#39;:1, &#39;d2x&#39;:0} (1=on, 0=off)</span>
</span><span id="Regularization-46"><a href="#Regularization-46"><span class="linenos"> 46</span></a><span class="sd">            </span>
</span><span id="Regularization-47"><a href="#Regularization-47"><span class="linenos"> 47</span></a><span class="sd">        Raises:</span>
</span><span id="Regularization-48"><a href="#Regularization-48"><span class="linenos"> 48</span></a><span class="sd">        - TypeError: If `input_dims` is not specified</span>
</span><span id="Regularization-49"><a href="#Regularization-49"><span class="linenos"> 49</span></a><span class="sd">        - TypeError: If `num_outputs` is not specified</span>
</span><span id="Regularization-50"><a href="#Regularization-50"><span class="linenos"> 50</span></a><span class="sd">        </span>
</span><span id="Regularization-51"><a href="#Regularization-51"><span class="linenos"> 51</span></a><span class="sd">        Notes:</span>
</span><span id="Regularization-52"><a href="#Regularization-52"><span class="linenos"> 52</span></a><span class="sd">        - I&#39;m using my old regularization matrices, which is made for the following 3-dimensional </span>
</span><span id="Regularization-53"><a href="#Regularization-53"><span class="linenos"> 53</span></a><span class="sd">        weights with dimensions ordered in [NX, NY, num_lags]. Currently, filter_dims is 4-d: </span>
</span><span id="Regularization-54"><a href="#Regularization-54"><span class="linenos"> 54</span></a><span class="sd">        [num_filters, NX, NY, num_lags] so this will need to rearrage so num_filters gets folded into last </span>
</span><span id="Regularization-55"><a href="#Regularization-55"><span class="linenos"> 55</span></a><span class="sd">        dimension so that it will work with d2t regularization, if reshape is necessary]</span>
</span><span id="Regularization-56"><a href="#Regularization-56"><span class="linenos"> 56</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Regularization-57"><a href="#Regularization-57"><span class="linenos"> 57</span></a>
</span><span id="Regularization-58"><a href="#Regularization-58"><span class="linenos"> 58</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">Regularization</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Regularization-59"><a href="#Regularization-59"><span class="linenos"> 59</span></a>
</span><span id="Regularization-60"><a href="#Regularization-60"><span class="linenos"> 60</span></a>        <span class="c1"># check input</span>
</span><span id="Regularization-61"><a href="#Regularization-61"><span class="linenos"> 61</span></a>        <span class="k">assert</span> <span class="n">filter_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must specify `input_dims`&quot;</span>
</span><span id="Regularization-62"><a href="#Regularization-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="n">filter_dims</span>
</span><span id="Regularization-63"><a href="#Regularization-63"><span class="linenos"> 63</span></a>
</span><span id="Regularization-64"><a href="#Regularization-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vals</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Regularization-65"><a href="#Regularization-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span> 
</span><span id="Regularization-66"><a href="#Regularization-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span>
</span><span id="Regularization-67"><a href="#Regularization-67"><span class="linenos"> 67</span></a>
</span><span id="Regularization-68"><a href="#Regularization-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Regularization-69"><a href="#Regularization-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="Regularization-70"><a href="#Regularization-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">=</span> <span class="n">num_outputs</span>
</span><span id="Regularization-71"><a href="#Regularization-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="o">=</span><span class="n">pos_constraint</span>
</span><span id="Regularization-72"><a href="#Regularization-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Regularization-73"><a href="#Regularization-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">activity_regmodule</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Regularization-74"><a href="#Regularization-74"><span class="linenos"> 74</span></a>
</span><span id="Regularization-75"><a href="#Regularization-75"><span class="linenos"> 75</span></a>        <span class="c1"># read user input</span>
</span><span id="Regularization-76"><a href="#Regularization-76"><span class="linenos"> 76</span></a>        <span class="k">if</span> <span class="n">vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Regularization-77"><a href="#Regularization-77"><span class="linenos"> 77</span></a>            <span class="k">for</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Regularization-78"><a href="#Regularization-78"><span class="linenos"> 78</span></a>                <span class="k">if</span> <span class="n">reg_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Regularization-79"><a href="#Regularization-79"><span class="linenos"> 79</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_reg_val</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">)</span>
</span><span id="Regularization-80"><a href="#Regularization-80"><span class="linenos"> 80</span></a>    <span class="c1"># END Regularization.__init__</span>
</span><span id="Regularization-81"><a href="#Regularization-81"><span class="linenos"> 81</span></a>
</span><span id="Regularization-82"><a href="#Regularization-82"><span class="linenos"> 82</span></a>    <span class="k">def</span> <span class="nf">set_reg_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Regularization-83"><a href="#Regularization-83"><span class="linenos"> 83</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set regularization value in self.vals dict </span>
</span><span id="Regularization-84"><a href="#Regularization-84"><span class="linenos"> 84</span></a><span class="sd">        </span>
</span><span id="Regularization-85"><a href="#Regularization-85"><span class="linenos"> 85</span></a><span class="sd">        Args:</span>
</span><span id="Regularization-86"><a href="#Regularization-86"><span class="linenos"> 86</span></a><span class="sd">            reg_type (str): see `_allowed_reg_types` for options</span>
</span><span id="Regularization-87"><a href="#Regularization-87"><span class="linenos"> 87</span></a><span class="sd">            reg_val (float): value of regularization parameter</span>
</span><span id="Regularization-88"><a href="#Regularization-88"><span class="linenos"> 88</span></a><span class="sd">            </span>
</span><span id="Regularization-89"><a href="#Regularization-89"><span class="linenos"> 89</span></a><span class="sd">        Returns:</span>
</span><span id="Regularization-90"><a href="#Regularization-90"><span class="linenos"> 90</span></a><span class="sd">            bool: True if `reg_type` has not been previously set</span>
</span><span id="Regularization-91"><a href="#Regularization-91"><span class="linenos"> 91</span></a><span class="sd">            </span>
</span><span id="Regularization-92"><a href="#Regularization-92"><span class="linenos"> 92</span></a><span class="sd">        Note: can also pass in a dictionary with boundary condition information addressed by reg_type</span>
</span><span id="Regularization-93"><a href="#Regularization-93"><span class="linenos"> 93</span></a><span class="sd">        Raises:</span>
</span><span id="Regularization-94"><a href="#Regularization-94"><span class="linenos"> 94</span></a><span class="sd">            ValueError: If `reg_type` is not a valid regularization type</span>
</span><span id="Regularization-95"><a href="#Regularization-95"><span class="linenos"> 95</span></a><span class="sd">            ValueError: If `reg_val` is less than 0.0            </span>
</span><span id="Regularization-96"><a href="#Regularization-96"><span class="linenos"> 96</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Regularization-97"><a href="#Regularization-97"><span class="linenos"> 97</span></a>
</span><span id="Regularization-98"><a href="#Regularization-98"><span class="linenos"> 98</span></a>        <span class="c1"># check inputs</span>
</span><span id="Regularization-99"><a href="#Regularization-99"><span class="linenos"> 99</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reg_class</span><span class="p">():</span>
</span><span id="Regularization-100"><a href="#Regularization-100"><span class="linenos">100</span></a>            <span class="k">if</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bc&#39;</span><span class="p">,</span> <span class="s1">&#39;bcs&#39;</span><span class="p">,</span> <span class="s1">&#39;BC&#39;</span><span class="p">,</span> <span class="s1">&#39;BCs&#39;</span><span class="p">]:</span>
</span><span id="Regularization-101"><a href="#Regularization-101"><span class="linenos">101</span></a>                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s2">&quot;Regularization: boundary conditions must be a dictionary.&quot;</span>
</span><span id="Regularization-102"><a href="#Regularization-102"><span class="linenos">102</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">reg_val</span><span class="p">)</span>  <span class="c1"># set potential boundary conditions</span>
</span><span id="Regularization-103"><a href="#Regularization-103"><span class="linenos">103</span></a>                <span class="k">return</span>
</span><span id="Regularization-104"><a href="#Regularization-104"><span class="linenos">104</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Regularization-105"><a href="#Regularization-105"><span class="linenos">105</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regularization: </span><span class="si">%s</span><span class="s2"> not recognized as a valid regularization type&quot;</span> <span class="o">%</span> <span class="n">reg_type</span><span class="p">)</span>
</span><span id="Regularization-106"><a href="#Regularization-106"><span class="linenos">106</span></a>                <span class="c1"># skip this regularization type</span>
</span><span id="Regularization-107"><a href="#Regularization-107"><span class="linenos">107</span></a>                <span class="k">return</span>
</span><span id="Regularization-108"><a href="#Regularization-108"><span class="linenos">108</span></a>
</span><span id="Regularization-109"><a href="#Regularization-109"><span class="linenos">109</span></a>        <span class="k">if</span> <span class="n">reg_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># then eliminate reg_type</span>
</span><span id="Regularization-110"><a href="#Regularization-110"><span class="linenos">110</span></a>            <span class="k">if</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">:</span>
</span><span id="Regularization-111"><a href="#Regularization-111"><span class="linenos">111</span></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span>
</span><span id="Regularization-112"><a href="#Regularization-112"><span class="linenos">112</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># add or modify reg_val</span>
</span><span id="Regularization-113"><a href="#Regularization-113"><span class="linenos">113</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">reg_val</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
</span><span id="Regularization-114"><a href="#Regularization-114"><span class="linenos">114</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`reg_val` must be greater than or equal to zero&#39;</span><span class="p">)</span>
</span><span id="Regularization-115"><a href="#Regularization-115"><span class="linenos">115</span></a>
</span><span id="Regularization-116"><a href="#Regularization-116"><span class="linenos">116</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span><span class="p">:</span>
</span><span id="Regularization-117"><a href="#Regularization-117"><span class="linenos">117</span></a>                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;UNITREG initialization problems&quot;</span>
</span><span id="Regularization-118"><a href="#Regularization-118"><span class="linenos">118</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="Regularization-119"><a href="#Regularization-119"><span class="linenos">119</span></a>                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_val</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">,</span> <span class="s2">&quot;UNITREG: unmatched size list of reg values&quot;</span>
</span><span id="Regularization-120"><a href="#Regularization-120"><span class="linenos">120</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">reg_val</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Regularization-121"><a href="#Regularization-121"><span class="linenos">121</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Regularization-122"><a href="#Regularization-122"><span class="linenos">122</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">*</span><span class="n">reg_val</span>
</span><span id="Regularization-123"><a href="#Regularization-123"><span class="linenos">123</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Normal reg val setting</span>
</span><span id="Regularization-124"><a href="#Regularization-124"><span class="linenos">124</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_val</span>
</span><span id="Regularization-125"><a href="#Regularization-125"><span class="linenos">125</span></a>    <span class="c1"># END Regularization.set_reg_val</span>
</span><span id="Regularization-126"><a href="#Regularization-126"><span class="linenos">126</span></a>
</span><span id="Regularization-127"><a href="#Regularization-127"><span class="linenos">127</span></a>    <span class="k">def</span> <span class="nf">unit_reg_convert</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">unit_reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="Regularization-128"><a href="#Regularization-128"><span class="linenos">128</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Can convert reg object to turn on or off unit_reg (default turns it on&quot;&quot;&quot;</span>
</span><span id="Regularization-129"><a href="#Regularization-129"><span class="linenos">129</span></a>
</span><span id="Regularization-130"><a href="#Regularization-130"><span class="linenos">130</span></a>        <span class="k">if</span> <span class="n">unit_reg</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span><span class="p">:</span>
</span><span id="Regularization-131"><a href="#Regularization-131"><span class="linenos">131</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UNITREG: No conversion necessary&quot;</span><span class="p">)</span>
</span><span id="Regularization-132"><a href="#Regularization-132"><span class="linenos">132</span></a>            <span class="k">return</span>
</span><span id="Regularization-133"><a href="#Regularization-133"><span class="linenos">133</span></a>        <span class="k">if</span> <span class="n">unit_reg</span> <span class="ow">and</span> <span class="p">(</span><span class="n">num_outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Regularization-134"><a href="#Regularization-134"><span class="linenos">134</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;UNITREG: must set num_ouputs&quot;</span>
</span><span id="Regularization-135"><a href="#Regularization-135"><span class="linenos">135</span></a>
</span><span id="Regularization-136"><a href="#Regularization-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span> <span class="o">=</span> <span class="n">unit_reg</span> 
</span><span id="Regularization-137"><a href="#Regularization-137"><span class="linenos">137</span></a>
</span><span id="Regularization-138"><a href="#Regularization-138"><span class="linenos">138</span></a>        <span class="k">for</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Regularization-139"><a href="#Regularization-139"><span class="linenos">139</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">unit_reg</span><span class="p">:</span>  <span class="c1"># turn off unit reg -- convert from list to single number via mean</span>
</span><span id="Regularization-140"><a href="#Regularization-140"><span class="linenos">140</span></a>                <span class="n">new_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> 
</span><span id="Regularization-141"><a href="#Regularization-141"><span class="linenos">141</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Regularization-142"><a href="#Regularization-142"><span class="linenos">142</span></a>                <span class="n">new_val</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="Regularization-143"><a href="#Regularization-143"><span class="linenos">143</span></a>            
</span><span id="Regularization-144"><a href="#Regularization-144"><span class="linenos">144</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_reg_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">new_val</span><span class="p">)</span>
</span><span id="Regularization-145"><a href="#Regularization-145"><span class="linenos">145</span></a>    <span class="c1"># END Regularization.unit_reg_convert</span>
</span><span id="Regularization-146"><a href="#Regularization-146"><span class="linenos">146</span></a>
</span><span id="Regularization-147"><a href="#Regularization-147"><span class="linenos">147</span></a>    <span class="k">def</span> <span class="nf">build_reg_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Regularization-148"><a href="#Regularization-148"><span class="linenos">148</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepares regularization modules in train based on current regularization values&quot;&quot;&quot;</span>
</span><span id="Regularization-149"><a href="#Regularization-149"><span class="linenos">149</span></a>        
</span><span id="Regularization-150"><a href="#Regularization-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>  <span class="c1"># this clears old modules (better way?)</span>
</span><span id="Regularization-151"><a href="#Regularization-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Regularization-152"><a href="#Regularization-152"><span class="linenos">152</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span><span id="Regularization-153"><a href="#Regularization-153"><span class="linenos">153</span></a>            
</span><span id="Regularization-154"><a href="#Regularization-154"><span class="linenos">154</span></a>        <span class="k">for</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Regularization-155"><a href="#Regularization-155"><span class="linenos">155</span></a>            <span class="c1"># check for boundary conditions</span>
</span><span id="Regularization-156"><a href="#Regularization-156"><span class="linenos">156</span></a>            <span class="n">BC</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># default padding for boundary conditions</span>
</span><span id="Regularization-157"><a href="#Regularization-157"><span class="linenos">157</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Regularization-158"><a href="#Regularization-158"><span class="linenos">158</span></a>                <span class="k">if</span> <span class="n">reg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span><span class="p">:</span>
</span><span id="Regularization-159"><a href="#Regularization-159"><span class="linenos">159</span></a>                    <span class="n">BC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span>
</span><span id="Regularization-160"><a href="#Regularization-160"><span class="linenos">160</span></a>                    <span class="c1">#print(&#39;  Setting boundary conditions for&#39;, reg, &#39;=&#39;, BC)</span>
</span><span id="Regularization-161"><a href="#Regularization-161"><span class="linenos">161</span></a>
</span><span id="Regularization-162"><a href="#Regularization-162"><span class="linenos">162</span></a>            <span class="n">reg_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reg_class</span><span class="p">(</span><span class="n">reg</span><span class="p">)(</span>
</span><span id="Regularization-163"><a href="#Regularization-163"><span class="linenos">163</span></a>                <span class="n">reg_type</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> 
</span><span id="Regularization-164"><a href="#Regularization-164"><span class="linenos">164</span></a>                <span class="n">input_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">,</span>
</span><span id="Regularization-165"><a href="#Regularization-165"><span class="linenos">165</span></a>                <span class="n">folded_lags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">,</span> <span class="n">unit_reg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="n">BC</span><span class="p">)</span>
</span><span id="Regularization-166"><a href="#Regularization-166"><span class="linenos">166</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_obj</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
</span><span id="Regularization-167"><a href="#Regularization-167"><span class="linenos">167</span></a>
</span><span id="Regularization-168"><a href="#Regularization-168"><span class="linenos">168</span></a>            <span class="k">if</span> <span class="n">reg</span> <span class="o">==</span> <span class="s1">&#39;activity&#39;</span><span class="p">:</span>
</span><span id="Regularization-169"><a href="#Regularization-169"><span class="linenos">169</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">activity_regmodule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># hoping this acts as a pointer (otherwise use explicit indexing)</span>
</span><span id="Regularization-170"><a href="#Regularization-170"><span class="linenos">170</span></a>                <span class="c1"># note this currently will only handle one activity reg type at once, otherwise make list </span>
</span><span id="Regularization-171"><a href="#Regularization-171"><span class="linenos">171</span></a>    <span class="c1"># END Regularization.build_reg_modules</span>
</span><span id="Regularization-172"><a href="#Regularization-172"><span class="linenos">172</span></a>
</span><span id="Regularization-173"><a href="#Regularization-173"><span class="linenos">173</span></a>    <span class="k">def</span> <span class="nf">compute_reg_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="Regularization-174"><a href="#Regularization-174"><span class="linenos">174</span></a>        <span class="c1"># I don&#39;t think this flag is yet used anywhere -- weights are passed in normalized, if relevant</span>
</span><span id="Regularization-175"><a href="#Regularization-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span> 
</span><span id="Regularization-176"><a href="#Regularization-176"><span class="linenos">176</span></a>            <span class="n">weights</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Regularization-177"><a href="#Regularization-177"><span class="linenos">177</span></a>
</span><span id="Regularization-178"><a href="#Regularization-178"><span class="linenos">178</span></a>        <span class="n">rloss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Regularization-179"><a href="#Regularization-179"><span class="linenos">179</span></a>        <span class="k">for</span> <span class="n">regmod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span><span class="p">:</span>
</span><span id="Regularization-180"><a href="#Regularization-180"><span class="linenos">180</span></a>            <span class="n">rloss</span> <span class="o">+=</span> <span class="n">regmod</span><span class="p">(</span> <span class="n">weights</span> <span class="p">)</span>
</span><span id="Regularization-181"><a href="#Regularization-181"><span class="linenos">181</span></a>
</span><span id="Regularization-182"><a href="#Regularization-182"><span class="linenos">182</span></a>        <span class="k">return</span> <span class="n">rloss</span>
</span><span id="Regularization-183"><a href="#Regularization-183"><span class="linenos">183</span></a>    <span class="c1"># END Regularization.define_reg_loss</span>
</span><span id="Regularization-184"><a href="#Regularization-184"><span class="linenos">184</span></a>
</span><span id="Regularization-185"><a href="#Regularization-185"><span class="linenos">185</span></a>    <span class="k">def</span> <span class="nf">compute_activity_regularization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_output</span><span class="p">):</span>
</span><span id="Regularization-186"><a href="#Regularization-186"><span class="linenos">186</span></a>        <span class="c1"># first put wrapper so wont throw bug with older model</span>
</span><span id="Regularization-187"><a href="#Regularization-187"><span class="linenos">187</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activity_regmodule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Regularization-188"><a href="#Regularization-188"><span class="linenos">188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">activity_regmodule</span><span class="o">.</span><span class="n">compute_activity_penalty</span><span class="p">(</span><span class="n">layer_output</span><span class="p">)</span>
</span><span id="Regularization-189"><a href="#Regularization-189"><span class="linenos">189</span></a>
</span><span id="Regularization-190"><a href="#Regularization-190"><span class="linenos">190</span></a>    <span class="k">def</span> <span class="nf">reg_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Regularization-191"><a href="#Regularization-191"><span class="linenos">191</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy regularization to new structure&quot;&quot;&quot;</span>
</span><span id="Regularization-192"><a href="#Regularization-192"><span class="linenos">192</span></a>
</span><span id="Regularization-193"><a href="#Regularization-193"><span class="linenos">193</span></a>        <span class="n">reg_target</span> <span class="o">=</span> <span class="n">Regularization</span><span class="p">(</span><span class="n">input_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">)</span>
</span><span id="Regularization-194"><a href="#Regularization-194"><span class="linenos">194</span></a>        <span class="n">reg_target</span><span class="o">.</span><span class="n">vals</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
</span><span id="Regularization-195"><a href="#Regularization-195"><span class="linenos">195</span></a>
</span><span id="Regularization-196"><a href="#Regularization-196"><span class="linenos">196</span></a>        <span class="k">return</span> <span class="n">reg_target</span>
</span><span id="Regularization-197"><a href="#Regularization-197"><span class="linenos">197</span></a>
</span><span id="Regularization-198"><a href="#Regularization-198"><span class="linenos">198</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Regularization-199"><a href="#Regularization-199"><span class="linenos">199</span></a>    <span class="k">def</span> <span class="nf">get_reg_class</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Regularization-200"><a href="#Regularization-200"><span class="linenos">200</span></a>
</span><span id="Regularization-201"><a href="#Regularization-201"><span class="linenos">201</span></a>        <span class="n">reg_index</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;d2xt&#39;</span><span class="p">:</span> <span class="n">ConvReg</span><span class="p">,</span>
</span><span id="Regularization-202"><a href="#Regularization-202"><span class="linenos">202</span></a>                     <span class="s1">&#39;d2x&#39;</span><span class="p">:</span> <span class="n">ConvReg</span><span class="p">,</span>
</span><span id="Regularization-203"><a href="#Regularization-203"><span class="linenos">203</span></a>                     <span class="s1">&#39;d2t&#39;</span><span class="p">:</span> <span class="n">ConvReg</span><span class="p">,</span>
</span><span id="Regularization-204"><a href="#Regularization-204"><span class="linenos">204</span></a>                     <span class="s1">&#39;l1&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization-205"><a href="#Regularization-205"><span class="linenos">205</span></a>                     <span class="s1">&#39;l2&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization-206"><a href="#Regularization-206"><span class="linenos">206</span></a>                     <span class="s1">&#39;norm2&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span> <span class="c1"># weight regularization</span>
</span><span id="Regularization-207"><a href="#Regularization-207"><span class="linenos">207</span></a>                     <span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization-208"><a href="#Regularization-208"><span class="linenos">208</span></a>                     <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization-209"><a href="#Regularization-209"><span class="linenos">209</span></a>                     <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization-210"><a href="#Regularization-210"><span class="linenos">210</span></a>                     <span class="s1">&#39;orth&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization-211"><a href="#Regularization-211"><span class="linenos">211</span></a>                     <span class="s1">&#39;bi_t&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization-212"><a href="#Regularization-212"><span class="linenos">212</span></a>                     <span class="s1">&#39;glocalx&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="Regularization-213"><a href="#Regularization-213"><span class="linenos">213</span></a>                     <span class="s1">&#39;glocalt&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="Regularization-214"><a href="#Regularization-214"><span class="linenos">214</span></a>                     <span class="s1">&#39;localx&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="Regularization-215"><a href="#Regularization-215"><span class="linenos">215</span></a>                     <span class="s1">&#39;localt&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="Regularization-216"><a href="#Regularization-216"><span class="linenos">216</span></a>                     <span class="s1">&#39;trd&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="Regularization-217"><a href="#Regularization-217"><span class="linenos">217</span></a>                     <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="Regularization-218"><a href="#Regularization-218"><span class="linenos">218</span></a>                     <span class="s1">&#39;glocal&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="Regularization-219"><a href="#Regularization-219"><span class="linenos">219</span></a>                     <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="Regularization-220"><a href="#Regularization-220"><span class="linenos">220</span></a>                     <span class="s1">&#39;max_filt&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="Regularization-221"><a href="#Regularization-221"><span class="linenos">221</span></a>                     <span class="s1">&#39;max_space&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="Regularization-222"><a href="#Regularization-222"><span class="linenos">222</span></a>                     <span class="s1">&#39;gmax_t&#39;</span><span class="p">:</span> <span class="n">TikhanovC</span><span class="p">,</span>
</span><span id="Regularization-223"><a href="#Regularization-223"><span class="linenos">223</span></a>                     <span class="s1">&#39;gmax_space&#39;</span><span class="p">:</span> <span class="n">TikhanovC</span><span class="p">,</span>
</span><span id="Regularization-224"><a href="#Regularization-224"><span class="linenos">224</span></a>                     <span class="s1">&#39;gmax_filter&#39;</span><span class="p">:</span> <span class="n">TikhanovC</span><span class="p">,</span>
</span><span id="Regularization-225"><a href="#Regularization-225"><span class="linenos">225</span></a>                     <span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="n">DiagonalReg</span><span class="p">,</span>
</span><span id="Regularization-226"><a href="#Regularization-226"><span class="linenos">226</span></a>                     <span class="s1">&#39;edge_t&#39;</span><span class="p">:</span> <span class="n">DiagonalReg</span><span class="p">,</span>
</span><span id="Regularization-227"><a href="#Regularization-227"><span class="linenos">227</span></a>                     <span class="s1">&#39;edge_t0&#39;</span><span class="p">:</span> <span class="n">DiagonalReg</span><span class="p">,</span>
</span><span id="Regularization-228"><a href="#Regularization-228"><span class="linenos">228</span></a>                     <span class="s1">&#39;edge_x&#39;</span><span class="p">:</span> <span class="n">DiagonalReg</span><span class="p">,</span>
</span><span id="Regularization-229"><a href="#Regularization-229"><span class="linenos">229</span></a>                     <span class="s1">&#39;activity&#39;</span><span class="p">:</span> <span class="n">ActivityReg</span><span class="p">}</span>
</span><span id="Regularization-230"><a href="#Regularization-230"><span class="linenos">230</span></a>        
</span><span id="Regularization-231"><a href="#Regularization-231"><span class="linenos">231</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Regularization-232"><a href="#Regularization-232"><span class="linenos">232</span></a>            <span class="n">ret</span> <span class="o">=</span> <span class="n">reg_index</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="Regularization-233"><a href="#Regularization-233"><span class="linenos">233</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Regularization-234"><a href="#Regularization-234"><span class="linenos">234</span></a>            <span class="n">ret</span> <span class="o">=</span> <span class="n">reg_index</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span>
</span><span id="Regularization-235"><a href="#Regularization-235"><span class="linenos">235</span></a>
</span><span id="Regularization-236"><a href="#Regularization-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span><span id="Regularization-237"><a href="#Regularization-237"><span class="linenos">237</span></a>    <span class="c1"># END Regularization.reg_copy</span>
</span></pre></div>


            <div class="docstring"><p>Class for handling layer-wise regularization. </p>

<p>This class stores all info for regularization, 
and sets up regularization modules for training, 
and returns reg_penalty from layer when passed in weights.</p>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>vals (dict):</strong>  values for different types of regularization stored as
floats</li>
<li><strong>vals_ph (dict):</strong>  placeholders for different types of regularization to
simplify the tf Graph when experimenting with different reg vals</li>
<li><strong>vals_var (dict):</strong>  values for different types of regularization stored as
(un-trainable) tf.Variables</li>
<li><strong>mats (dict):</strong>  matrices for different types of regularization stored as
tf constants</li>
<li><strong>penalties (dict):</strong>  tf ops for evaluating different regularization 
penalties</li>
<li><strong>input_dims (list):</strong>  dimensions of layer input size; for constructing reg 
matrices</li>
<li><strong>num_outputs (int):</strong>  dimension of layer output size; for generating 
target weights in norm2</li>
</ul>
</div>


                            <div id="Regularization.__init__" class="classattr">
                                        <input id="Regularization.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Regularization</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">filter_dims</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">vals</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">num_outputs</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">normalize</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">pos_constraint</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="Regularization.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Regularization.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Regularization.__init__-36"><a href="#Regularization.__init__-36"><span class="linenos">36</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="Regularization.__init__-37"><a href="#Regularization.__init__-37"><span class="linenos">37</span></a>                 <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Regularization.__init__-38"><a href="#Regularization.__init__-38"><span class="linenos">38</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Regularization class. This stores all info for regularization, and </span>
</span><span id="Regularization.__init__-39"><a href="#Regularization.__init__-39"><span class="linenos">39</span></a><span class="sd">        sets up regularization modules for training, and returns reg_penalty from layer when passed in weights</span>
</span><span id="Regularization.__init__-40"><a href="#Regularization.__init__-40"><span class="linenos">40</span></a><span class="sd">        </span>
</span><span id="Regularization.__init__-41"><a href="#Regularization.__init__-41"><span class="linenos">41</span></a><span class="sd">        Parameters:</span>
</span><span id="Regularization.__init__-42"><a href="#Regularization.__init__-42"><span class="linenos">42</span></a><span class="sd">        - input_dims (list of ints): dimension of input size (for building reg mats)</span>
</span><span id="Regularization.__init__-43"><a href="#Regularization.__init__-43"><span class="linenos">43</span></a><span class="sd">        - vals (dict, optional): key-value pairs specifying value for each type of regularization </span>
</span><span id="Regularization.__init__-44"><a href="#Regularization.__init__-44"><span class="linenos">44</span></a><span class="sd">        - Note: to pass in boundary_condition information, use a dict in vals with the values corresponding to</span>
</span><span id="Regularization.__init__-45"><a href="#Regularization.__init__-45"><span class="linenos">45</span></a><span class="sd">            particular regularization, e,g., &#39;BCs&#39;:{&#39;d2t&#39;:1, &#39;d2x&#39;:0} (1=on, 0=off)</span>
</span><span id="Regularization.__init__-46"><a href="#Regularization.__init__-46"><span class="linenos">46</span></a><span class="sd">            </span>
</span><span id="Regularization.__init__-47"><a href="#Regularization.__init__-47"><span class="linenos">47</span></a><span class="sd">        Raises:</span>
</span><span id="Regularization.__init__-48"><a href="#Regularization.__init__-48"><span class="linenos">48</span></a><span class="sd">        - TypeError: If `input_dims` is not specified</span>
</span><span id="Regularization.__init__-49"><a href="#Regularization.__init__-49"><span class="linenos">49</span></a><span class="sd">        - TypeError: If `num_outputs` is not specified</span>
</span><span id="Regularization.__init__-50"><a href="#Regularization.__init__-50"><span class="linenos">50</span></a><span class="sd">        </span>
</span><span id="Regularization.__init__-51"><a href="#Regularization.__init__-51"><span class="linenos">51</span></a><span class="sd">        Notes:</span>
</span><span id="Regularization.__init__-52"><a href="#Regularization.__init__-52"><span class="linenos">52</span></a><span class="sd">        - I&#39;m using my old regularization matrices, which is made for the following 3-dimensional </span>
</span><span id="Regularization.__init__-53"><a href="#Regularization.__init__-53"><span class="linenos">53</span></a><span class="sd">        weights with dimensions ordered in [NX, NY, num_lags]. Currently, filter_dims is 4-d: </span>
</span><span id="Regularization.__init__-54"><a href="#Regularization.__init__-54"><span class="linenos">54</span></a><span class="sd">        [num_filters, NX, NY, num_lags] so this will need to rearrage so num_filters gets folded into last </span>
</span><span id="Regularization.__init__-55"><a href="#Regularization.__init__-55"><span class="linenos">55</span></a><span class="sd">        dimension so that it will work with d2t regularization, if reshape is necessary]</span>
</span><span id="Regularization.__init__-56"><a href="#Regularization.__init__-56"><span class="linenos">56</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Regularization.__init__-57"><a href="#Regularization.__init__-57"><span class="linenos">57</span></a>
</span><span id="Regularization.__init__-58"><a href="#Regularization.__init__-58"><span class="linenos">58</span></a>        <span class="nb">super</span><span class="p">(</span><span class="n">Regularization</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Regularization.__init__-59"><a href="#Regularization.__init__-59"><span class="linenos">59</span></a>
</span><span id="Regularization.__init__-60"><a href="#Regularization.__init__-60"><span class="linenos">60</span></a>        <span class="c1"># check input</span>
</span><span id="Regularization.__init__-61"><a href="#Regularization.__init__-61"><span class="linenos">61</span></a>        <span class="k">assert</span> <span class="n">filter_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must specify `input_dims`&quot;</span>
</span><span id="Regularization.__init__-62"><a href="#Regularization.__init__-62"><span class="linenos">62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="n">filter_dims</span>
</span><span id="Regularization.__init__-63"><a href="#Regularization.__init__-63"><span class="linenos">63</span></a>
</span><span id="Regularization.__init__-64"><a href="#Regularization.__init__-64"><span class="linenos">64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vals</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Regularization.__init__-65"><a href="#Regularization.__init__-65"><span class="linenos">65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span> 
</span><span id="Regularization.__init__-66"><a href="#Regularization.__init__-66"><span class="linenos">66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span>
</span><span id="Regularization.__init__-67"><a href="#Regularization.__init__-67"><span class="linenos">67</span></a>
</span><span id="Regularization.__init__-68"><a href="#Regularization.__init__-68"><span class="linenos">68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Regularization.__init__-69"><a href="#Regularization.__init__-69"><span class="linenos">69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="Regularization.__init__-70"><a href="#Regularization.__init__-70"><span class="linenos">70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="o">=</span> <span class="n">num_outputs</span>
</span><span id="Regularization.__init__-71"><a href="#Regularization.__init__-71"><span class="linenos">71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="o">=</span><span class="n">pos_constraint</span>
</span><span id="Regularization.__init__-72"><a href="#Regularization.__init__-72"><span class="linenos">72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Regularization.__init__-73"><a href="#Regularization.__init__-73"><span class="linenos">73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">activity_regmodule</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Regularization.__init__-74"><a href="#Regularization.__init__-74"><span class="linenos">74</span></a>
</span><span id="Regularization.__init__-75"><a href="#Regularization.__init__-75"><span class="linenos">75</span></a>        <span class="c1"># read user input</span>
</span><span id="Regularization.__init__-76"><a href="#Regularization.__init__-76"><span class="linenos">76</span></a>        <span class="k">if</span> <span class="n">vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Regularization.__init__-77"><a href="#Regularization.__init__-77"><span class="linenos">77</span></a>            <span class="k">for</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Regularization.__init__-78"><a href="#Regularization.__init__-78"><span class="linenos">78</span></a>                <span class="k">if</span> <span class="n">reg_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Regularization.__init__-79"><a href="#Regularization.__init__-79"><span class="linenos">79</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_reg_val</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Constructor for Regularization class. This stores all info for regularization, and 
sets up regularization modules for training, and returns reg_penalty from layer when passed in weights</p>

<p>Parameters:</p>

<ul>
<li>input_dims (list of ints): dimension of input size (for building reg mats)</li>
<li>vals (dict, optional): key-value pairs specifying value for each type of regularization </li>
<li>Note: to pass in boundary_condition information, use a dict in vals with the values corresponding to
particular regularization, e,g., 'BCs':{'d2t':1, 'd2x':0} (1=on, 0=off)</li>
</ul>

<p>Raises:</p>

<ul>
<li>TypeError: If <code><a href="#Regularization.input_dims">input_dims</a></code> is not specified</li>
<li>TypeError: If <code><a href="#Regularization.num_outputs">num_outputs</a></code> is not specified</li>
</ul>

<p>Notes:</p>

<ul>
<li>I'm using my old regularization matrices, which is made for the following 3-dimensional 
weights with dimensions ordered in [NX, NY, num_lags]. Currently, filter_dims is 4-d: 
[num_filters, NX, NY, num_lags] so this will need to rearrage so num_filters gets folded into last 
dimension so that it will work with d2t regularization, if reshape is necessary]</li>
</ul>
</div>


                            </div>
                            <div id="Regularization.input_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">input_dims</span>

        
    </div>
    <a class="headerlink" href="#Regularization.input_dims"></a>
    
    

                            </div>
                            <div id="Regularization.vals" class="classattr">
                                <div class="attr variable">
            <span class="name">vals</span>

        
    </div>
    <a class="headerlink" href="#Regularization.vals"></a>
    
    

                            </div>
                            <div id="Regularization.reg_modules" class="classattr">
                                <div class="attr variable">
            <span class="name">reg_modules</span>

        
    </div>
    <a class="headerlink" href="#Regularization.reg_modules"></a>
    
    

                            </div>
                            <div id="Regularization.normalize" class="classattr">
                                <div class="attr variable">
            <span class="name">normalize</span>

        
    </div>
    <a class="headerlink" href="#Regularization.normalize"></a>
    
    

                            </div>
                            <div id="Regularization.unit_reg" class="classattr">
                                <div class="attr variable">
            <span class="name">unit_reg</span>

        
    </div>
    <a class="headerlink" href="#Regularization.unit_reg"></a>
    
    

                            </div>
                            <div id="Regularization.folded_lags" class="classattr">
                                <div class="attr variable">
            <span class="name">folded_lags</span>

        
    </div>
    <a class="headerlink" href="#Regularization.folded_lags"></a>
    
    

                            </div>
                            <div id="Regularization.num_outputs" class="classattr">
                                <div class="attr variable">
            <span class="name">num_outputs</span>

        
    </div>
    <a class="headerlink" href="#Regularization.num_outputs"></a>
    
    

                            </div>
                            <div id="Regularization.pos_constraint" class="classattr">
                                <div class="attr variable">
            <span class="name">pos_constraint</span>

        
    </div>
    <a class="headerlink" href="#Regularization.pos_constraint"></a>
    
    

                            </div>
                            <div id="Regularization.boundary_conditions" class="classattr">
                                <div class="attr variable">
            <span class="name">boundary_conditions</span>

        
    </div>
    <a class="headerlink" href="#Regularization.boundary_conditions"></a>
    
    

                            </div>
                            <div id="Regularization.activity_regmodule" class="classattr">
                                <div class="attr variable">
            <span class="name">activity_regmodule</span>

        
    </div>
    <a class="headerlink" href="#Regularization.activity_regmodule"></a>
    
    

                            </div>
                            <div id="Regularization.set_reg_val" class="classattr">
                                        <input id="Regularization.set_reg_val-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_reg_val</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">reg_type</span>, </span><span class="param"><span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Regularization.set_reg_val-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Regularization.set_reg_val"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Regularization.set_reg_val-82"><a href="#Regularization.set_reg_val-82"><span class="linenos"> 82</span></a>    <span class="k">def</span> <span class="nf">set_reg_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Regularization.set_reg_val-83"><a href="#Regularization.set_reg_val-83"><span class="linenos"> 83</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set regularization value in self.vals dict </span>
</span><span id="Regularization.set_reg_val-84"><a href="#Regularization.set_reg_val-84"><span class="linenos"> 84</span></a><span class="sd">        </span>
</span><span id="Regularization.set_reg_val-85"><a href="#Regularization.set_reg_val-85"><span class="linenos"> 85</span></a><span class="sd">        Args:</span>
</span><span id="Regularization.set_reg_val-86"><a href="#Regularization.set_reg_val-86"><span class="linenos"> 86</span></a><span class="sd">            reg_type (str): see `_allowed_reg_types` for options</span>
</span><span id="Regularization.set_reg_val-87"><a href="#Regularization.set_reg_val-87"><span class="linenos"> 87</span></a><span class="sd">            reg_val (float): value of regularization parameter</span>
</span><span id="Regularization.set_reg_val-88"><a href="#Regularization.set_reg_val-88"><span class="linenos"> 88</span></a><span class="sd">            </span>
</span><span id="Regularization.set_reg_val-89"><a href="#Regularization.set_reg_val-89"><span class="linenos"> 89</span></a><span class="sd">        Returns:</span>
</span><span id="Regularization.set_reg_val-90"><a href="#Regularization.set_reg_val-90"><span class="linenos"> 90</span></a><span class="sd">            bool: True if `reg_type` has not been previously set</span>
</span><span id="Regularization.set_reg_val-91"><a href="#Regularization.set_reg_val-91"><span class="linenos"> 91</span></a><span class="sd">            </span>
</span><span id="Regularization.set_reg_val-92"><a href="#Regularization.set_reg_val-92"><span class="linenos"> 92</span></a><span class="sd">        Note: can also pass in a dictionary with boundary condition information addressed by reg_type</span>
</span><span id="Regularization.set_reg_val-93"><a href="#Regularization.set_reg_val-93"><span class="linenos"> 93</span></a><span class="sd">        Raises:</span>
</span><span id="Regularization.set_reg_val-94"><a href="#Regularization.set_reg_val-94"><span class="linenos"> 94</span></a><span class="sd">            ValueError: If `reg_type` is not a valid regularization type</span>
</span><span id="Regularization.set_reg_val-95"><a href="#Regularization.set_reg_val-95"><span class="linenos"> 95</span></a><span class="sd">            ValueError: If `reg_val` is less than 0.0            </span>
</span><span id="Regularization.set_reg_val-96"><a href="#Regularization.set_reg_val-96"><span class="linenos"> 96</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Regularization.set_reg_val-97"><a href="#Regularization.set_reg_val-97"><span class="linenos"> 97</span></a>
</span><span id="Regularization.set_reg_val-98"><a href="#Regularization.set_reg_val-98"><span class="linenos"> 98</span></a>        <span class="c1"># check inputs</span>
</span><span id="Regularization.set_reg_val-99"><a href="#Regularization.set_reg_val-99"><span class="linenos"> 99</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reg_class</span><span class="p">():</span>
</span><span id="Regularization.set_reg_val-100"><a href="#Regularization.set_reg_val-100"><span class="linenos">100</span></a>            <span class="k">if</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bc&#39;</span><span class="p">,</span> <span class="s1">&#39;bcs&#39;</span><span class="p">,</span> <span class="s1">&#39;BC&#39;</span><span class="p">,</span> <span class="s1">&#39;BCs&#39;</span><span class="p">]:</span>
</span><span id="Regularization.set_reg_val-101"><a href="#Regularization.set_reg_val-101"><span class="linenos">101</span></a>                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s2">&quot;Regularization: boundary conditions must be a dictionary.&quot;</span>
</span><span id="Regularization.set_reg_val-102"><a href="#Regularization.set_reg_val-102"><span class="linenos">102</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">reg_val</span><span class="p">)</span>  <span class="c1"># set potential boundary conditions</span>
</span><span id="Regularization.set_reg_val-103"><a href="#Regularization.set_reg_val-103"><span class="linenos">103</span></a>                <span class="k">return</span>
</span><span id="Regularization.set_reg_val-104"><a href="#Regularization.set_reg_val-104"><span class="linenos">104</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Regularization.set_reg_val-105"><a href="#Regularization.set_reg_val-105"><span class="linenos">105</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regularization: </span><span class="si">%s</span><span class="s2"> not recognized as a valid regularization type&quot;</span> <span class="o">%</span> <span class="n">reg_type</span><span class="p">)</span>
</span><span id="Regularization.set_reg_val-106"><a href="#Regularization.set_reg_val-106"><span class="linenos">106</span></a>                <span class="c1"># skip this regularization type</span>
</span><span id="Regularization.set_reg_val-107"><a href="#Regularization.set_reg_val-107"><span class="linenos">107</span></a>                <span class="k">return</span>
</span><span id="Regularization.set_reg_val-108"><a href="#Regularization.set_reg_val-108"><span class="linenos">108</span></a>
</span><span id="Regularization.set_reg_val-109"><a href="#Regularization.set_reg_val-109"><span class="linenos">109</span></a>        <span class="k">if</span> <span class="n">reg_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># then eliminate reg_type</span>
</span><span id="Regularization.set_reg_val-110"><a href="#Regularization.set_reg_val-110"><span class="linenos">110</span></a>            <span class="k">if</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">:</span>
</span><span id="Regularization.set_reg_val-111"><a href="#Regularization.set_reg_val-111"><span class="linenos">111</span></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span>
</span><span id="Regularization.set_reg_val-112"><a href="#Regularization.set_reg_val-112"><span class="linenos">112</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># add or modify reg_val</span>
</span><span id="Regularization.set_reg_val-113"><a href="#Regularization.set_reg_val-113"><span class="linenos">113</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">reg_val</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
</span><span id="Regularization.set_reg_val-114"><a href="#Regularization.set_reg_val-114"><span class="linenos">114</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`reg_val` must be greater than or equal to zero&#39;</span><span class="p">)</span>
</span><span id="Regularization.set_reg_val-115"><a href="#Regularization.set_reg_val-115"><span class="linenos">115</span></a>
</span><span id="Regularization.set_reg_val-116"><a href="#Regularization.set_reg_val-116"><span class="linenos">116</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span><span class="p">:</span>
</span><span id="Regularization.set_reg_val-117"><a href="#Regularization.set_reg_val-117"><span class="linenos">117</span></a>                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;UNITREG initialization problems&quot;</span>
</span><span id="Regularization.set_reg_val-118"><a href="#Regularization.set_reg_val-118"><span class="linenos">118</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="Regularization.set_reg_val-119"><a href="#Regularization.set_reg_val-119"><span class="linenos">119</span></a>                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_val</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">,</span> <span class="s2">&quot;UNITREG: unmatched size list of reg values&quot;</span>
</span><span id="Regularization.set_reg_val-120"><a href="#Regularization.set_reg_val-120"><span class="linenos">120</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">reg_val</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="Regularization.set_reg_val-121"><a href="#Regularization.set_reg_val-121"><span class="linenos">121</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Regularization.set_reg_val-122"><a href="#Regularization.set_reg_val-122"><span class="linenos">122</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">*</span><span class="n">reg_val</span>
</span><span id="Regularization.set_reg_val-123"><a href="#Regularization.set_reg_val-123"><span class="linenos">123</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Normal reg val setting</span>
</span><span id="Regularization.set_reg_val-124"><a href="#Regularization.set_reg_val-124"><span class="linenos">124</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_val</span>
</span></pre></div>


            <div class="docstring"><p>Set regularization value in self.vals dict </p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>reg_type (str):</strong>  see <code>_allowed_reg_types</code> for options</li>
<li><strong>reg_val (float):</strong>  value of regularization parameter</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>bool: True if <code>reg_type</code> has not been previously set</p>
</blockquote>

<p>Note: can also pass in a dictionary with boundary condition information addressed by reg_type</p>

<h6 id="raises">Raises:</h6>

<ul>
<li><strong>ValueError:</strong>  If <code>reg_type</code> is not a valid regularization type</li>
<li><strong>ValueError:</strong>  If <code>reg_val</code> is less than 0.0</li>
</ul>
</div>


                            </div>
                            <div id="Regularization.unit_reg_convert" class="classattr">
                                        <input id="Regularization.unit_reg_convert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unit_reg_convert</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">unit_reg</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">num_outputs</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Regularization.unit_reg_convert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Regularization.unit_reg_convert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Regularization.unit_reg_convert-127"><a href="#Regularization.unit_reg_convert-127"><span class="linenos">127</span></a>    <span class="k">def</span> <span class="nf">unit_reg_convert</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">unit_reg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
</span><span id="Regularization.unit_reg_convert-128"><a href="#Regularization.unit_reg_convert-128"><span class="linenos">128</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Can convert reg object to turn on or off unit_reg (default turns it on&quot;&quot;&quot;</span>
</span><span id="Regularization.unit_reg_convert-129"><a href="#Regularization.unit_reg_convert-129"><span class="linenos">129</span></a>
</span><span id="Regularization.unit_reg_convert-130"><a href="#Regularization.unit_reg_convert-130"><span class="linenos">130</span></a>        <span class="k">if</span> <span class="n">unit_reg</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span><span class="p">:</span>
</span><span id="Regularization.unit_reg_convert-131"><a href="#Regularization.unit_reg_convert-131"><span class="linenos">131</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UNITREG: No conversion necessary&quot;</span><span class="p">)</span>
</span><span id="Regularization.unit_reg_convert-132"><a href="#Regularization.unit_reg_convert-132"><span class="linenos">132</span></a>            <span class="k">return</span>
</span><span id="Regularization.unit_reg_convert-133"><a href="#Regularization.unit_reg_convert-133"><span class="linenos">133</span></a>        <span class="k">if</span> <span class="n">unit_reg</span> <span class="ow">and</span> <span class="p">(</span><span class="n">num_outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Regularization.unit_reg_convert-134"><a href="#Regularization.unit_reg_convert-134"><span class="linenos">134</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;UNITREG: must set num_ouputs&quot;</span>
</span><span id="Regularization.unit_reg_convert-135"><a href="#Regularization.unit_reg_convert-135"><span class="linenos">135</span></a>
</span><span id="Regularization.unit_reg_convert-136"><a href="#Regularization.unit_reg_convert-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span> <span class="o">=</span> <span class="n">unit_reg</span> 
</span><span id="Regularization.unit_reg_convert-137"><a href="#Regularization.unit_reg_convert-137"><span class="linenos">137</span></a>
</span><span id="Regularization.unit_reg_convert-138"><a href="#Regularization.unit_reg_convert-138"><span class="linenos">138</span></a>        <span class="k">for</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Regularization.unit_reg_convert-139"><a href="#Regularization.unit_reg_convert-139"><span class="linenos">139</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">unit_reg</span><span class="p">:</span>  <span class="c1"># turn off unit reg -- convert from list to single number via mean</span>
</span><span id="Regularization.unit_reg_convert-140"><a href="#Regularization.unit_reg_convert-140"><span class="linenos">140</span></a>                <span class="n">new_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> 
</span><span id="Regularization.unit_reg_convert-141"><a href="#Regularization.unit_reg_convert-141"><span class="linenos">141</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Regularization.unit_reg_convert-142"><a href="#Regularization.unit_reg_convert-142"><span class="linenos">142</span></a>                <span class="n">new_val</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="Regularization.unit_reg_convert-143"><a href="#Regularization.unit_reg_convert-143"><span class="linenos">143</span></a>            
</span><span id="Regularization.unit_reg_convert-144"><a href="#Regularization.unit_reg_convert-144"><span class="linenos">144</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_reg_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">new_val</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Can convert reg object to turn on or off unit_reg (default turns it on</p>
</div>


                            </div>
                            <div id="Regularization.build_reg_modules" class="classattr">
                                        <input id="Regularization.build_reg_modules-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_reg_modules</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">device</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Regularization.build_reg_modules-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Regularization.build_reg_modules"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Regularization.build_reg_modules-147"><a href="#Regularization.build_reg_modules-147"><span class="linenos">147</span></a>    <span class="k">def</span> <span class="nf">build_reg_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Regularization.build_reg_modules-148"><a href="#Regularization.build_reg_modules-148"><span class="linenos">148</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepares regularization modules in train based on current regularization values&quot;&quot;&quot;</span>
</span><span id="Regularization.build_reg_modules-149"><a href="#Regularization.build_reg_modules-149"><span class="linenos">149</span></a>        
</span><span id="Regularization.build_reg_modules-150"><a href="#Regularization.build_reg_modules-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>  <span class="c1"># this clears old modules (better way?)</span>
</span><span id="Regularization.build_reg_modules-151"><a href="#Regularization.build_reg_modules-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Regularization.build_reg_modules-152"><a href="#Regularization.build_reg_modules-152"><span class="linenos">152</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span><span id="Regularization.build_reg_modules-153"><a href="#Regularization.build_reg_modules-153"><span class="linenos">153</span></a>            
</span><span id="Regularization.build_reg_modules-154"><a href="#Regularization.build_reg_modules-154"><span class="linenos">154</span></a>        <span class="k">for</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Regularization.build_reg_modules-155"><a href="#Regularization.build_reg_modules-155"><span class="linenos">155</span></a>            <span class="c1"># check for boundary conditions</span>
</span><span id="Regularization.build_reg_modules-156"><a href="#Regularization.build_reg_modules-156"><span class="linenos">156</span></a>            <span class="n">BC</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># default padding for boundary conditions</span>
</span><span id="Regularization.build_reg_modules-157"><a href="#Regularization.build_reg_modules-157"><span class="linenos">157</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Regularization.build_reg_modules-158"><a href="#Regularization.build_reg_modules-158"><span class="linenos">158</span></a>                <span class="k">if</span> <span class="n">reg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span><span class="p">:</span>
</span><span id="Regularization.build_reg_modules-159"><a href="#Regularization.build_reg_modules-159"><span class="linenos">159</span></a>                    <span class="n">BC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span>
</span><span id="Regularization.build_reg_modules-160"><a href="#Regularization.build_reg_modules-160"><span class="linenos">160</span></a>                    <span class="c1">#print(&#39;  Setting boundary conditions for&#39;, reg, &#39;=&#39;, BC)</span>
</span><span id="Regularization.build_reg_modules-161"><a href="#Regularization.build_reg_modules-161"><span class="linenos">161</span></a>
</span><span id="Regularization.build_reg_modules-162"><a href="#Regularization.build_reg_modules-162"><span class="linenos">162</span></a>            <span class="n">reg_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reg_class</span><span class="p">(</span><span class="n">reg</span><span class="p">)(</span>
</span><span id="Regularization.build_reg_modules-163"><a href="#Regularization.build_reg_modules-163"><span class="linenos">163</span></a>                <span class="n">reg_type</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> 
</span><span id="Regularization.build_reg_modules-164"><a href="#Regularization.build_reg_modules-164"><span class="linenos">164</span></a>                <span class="n">input_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">pos_constraint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">,</span>
</span><span id="Regularization.build_reg_modules-165"><a href="#Regularization.build_reg_modules-165"><span class="linenos">165</span></a>                <span class="n">folded_lags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">,</span> <span class="n">unit_reg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="n">BC</span><span class="p">)</span>
</span><span id="Regularization.build_reg_modules-166"><a href="#Regularization.build_reg_modules-166"><span class="linenos">166</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_obj</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
</span><span id="Regularization.build_reg_modules-167"><a href="#Regularization.build_reg_modules-167"><span class="linenos">167</span></a>
</span><span id="Regularization.build_reg_modules-168"><a href="#Regularization.build_reg_modules-168"><span class="linenos">168</span></a>            <span class="k">if</span> <span class="n">reg</span> <span class="o">==</span> <span class="s1">&#39;activity&#39;</span><span class="p">:</span>
</span><span id="Regularization.build_reg_modules-169"><a href="#Regularization.build_reg_modules-169"><span class="linenos">169</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">activity_regmodule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># hoping this acts as a pointer (otherwise use explicit indexing)</span>
</span><span id="Regularization.build_reg_modules-170"><a href="#Regularization.build_reg_modules-170"><span class="linenos">170</span></a>                <span class="c1"># note this currently will only handle one activity reg type at once, otherwise make list </span>
</span></pre></div>


            <div class="docstring"><p>Prepares regularization modules in train based on current regularization values</p>
</div>


                            </div>
                            <div id="Regularization.compute_reg_loss" class="classattr">
                                        <input id="Regularization.compute_reg_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_reg_loss</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">weights</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Regularization.compute_reg_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Regularization.compute_reg_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Regularization.compute_reg_loss-173"><a href="#Regularization.compute_reg_loss-173"><span class="linenos">173</span></a>    <span class="k">def</span> <span class="nf">compute_reg_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="Regularization.compute_reg_loss-174"><a href="#Regularization.compute_reg_loss-174"><span class="linenos">174</span></a>        <span class="c1"># I don&#39;t think this flag is yet used anywhere -- weights are passed in normalized, if relevant</span>
</span><span id="Regularization.compute_reg_loss-175"><a href="#Regularization.compute_reg_loss-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span> 
</span><span id="Regularization.compute_reg_loss-176"><a href="#Regularization.compute_reg_loss-176"><span class="linenos">176</span></a>            <span class="n">weights</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Regularization.compute_reg_loss-177"><a href="#Regularization.compute_reg_loss-177"><span class="linenos">177</span></a>
</span><span id="Regularization.compute_reg_loss-178"><a href="#Regularization.compute_reg_loss-178"><span class="linenos">178</span></a>        <span class="n">rloss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Regularization.compute_reg_loss-179"><a href="#Regularization.compute_reg_loss-179"><span class="linenos">179</span></a>        <span class="k">for</span> <span class="n">regmod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_modules</span><span class="p">:</span>
</span><span id="Regularization.compute_reg_loss-180"><a href="#Regularization.compute_reg_loss-180"><span class="linenos">180</span></a>            <span class="n">rloss</span> <span class="o">+=</span> <span class="n">regmod</span><span class="p">(</span> <span class="n">weights</span> <span class="p">)</span>
</span><span id="Regularization.compute_reg_loss-181"><a href="#Regularization.compute_reg_loss-181"><span class="linenos">181</span></a>
</span><span id="Regularization.compute_reg_loss-182"><a href="#Regularization.compute_reg_loss-182"><span class="linenos">182</span></a>        <span class="k">return</span> <span class="n">rloss</span>
</span></pre></div>


    

                            </div>
                            <div id="Regularization.compute_activity_regularization" class="classattr">
                                        <input id="Regularization.compute_activity_regularization-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_activity_regularization</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">layer_output</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Regularization.compute_activity_regularization-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Regularization.compute_activity_regularization"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Regularization.compute_activity_regularization-185"><a href="#Regularization.compute_activity_regularization-185"><span class="linenos">185</span></a>    <span class="k">def</span> <span class="nf">compute_activity_regularization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_output</span><span class="p">):</span>
</span><span id="Regularization.compute_activity_regularization-186"><a href="#Regularization.compute_activity_regularization-186"><span class="linenos">186</span></a>        <span class="c1"># first put wrapper so wont throw bug with older model</span>
</span><span id="Regularization.compute_activity_regularization-187"><a href="#Regularization.compute_activity_regularization-187"><span class="linenos">187</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activity_regmodule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Regularization.compute_activity_regularization-188"><a href="#Regularization.compute_activity_regularization-188"><span class="linenos">188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">activity_regmodule</span><span class="o">.</span><span class="n">compute_activity_penalty</span><span class="p">(</span><span class="n">layer_output</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Regularization.reg_copy" class="classattr">
                                        <input id="Regularization.reg_copy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reg_copy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Regularization.reg_copy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Regularization.reg_copy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Regularization.reg_copy-190"><a href="#Regularization.reg_copy-190"><span class="linenos">190</span></a>    <span class="k">def</span> <span class="nf">reg_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Regularization.reg_copy-191"><a href="#Regularization.reg_copy-191"><span class="linenos">191</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy regularization to new structure&quot;&quot;&quot;</span>
</span><span id="Regularization.reg_copy-192"><a href="#Regularization.reg_copy-192"><span class="linenos">192</span></a>
</span><span id="Regularization.reg_copy-193"><a href="#Regularization.reg_copy-193"><span class="linenos">193</span></a>        <span class="n">reg_target</span> <span class="o">=</span> <span class="n">Regularization</span><span class="p">(</span><span class="n">input_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">)</span>
</span><span id="Regularization.reg_copy-194"><a href="#Regularization.reg_copy-194"><span class="linenos">194</span></a>        <span class="n">reg_target</span><span class="o">.</span><span class="n">vals</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
</span><span id="Regularization.reg_copy-195"><a href="#Regularization.reg_copy-195"><span class="linenos">195</span></a>
</span><span id="Regularization.reg_copy-196"><a href="#Regularization.reg_copy-196"><span class="linenos">196</span></a>        <span class="k">return</span> <span class="n">reg_target</span>
</span></pre></div>


            <div class="docstring"><p>Copy regularization to new structure</p>
</div>


                            </div>
                            <div id="Regularization.get_reg_class" class="classattr">
                                        <input id="Regularization.get_reg_class-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">get_reg_class</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Regularization.get_reg_class-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Regularization.get_reg_class"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Regularization.get_reg_class-198"><a href="#Regularization.get_reg_class-198"><span class="linenos">198</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Regularization.get_reg_class-199"><a href="#Regularization.get_reg_class-199"><span class="linenos">199</span></a>    <span class="k">def</span> <span class="nf">get_reg_class</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Regularization.get_reg_class-200"><a href="#Regularization.get_reg_class-200"><span class="linenos">200</span></a>
</span><span id="Regularization.get_reg_class-201"><a href="#Regularization.get_reg_class-201"><span class="linenos">201</span></a>        <span class="n">reg_index</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;d2xt&#39;</span><span class="p">:</span> <span class="n">ConvReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-202"><a href="#Regularization.get_reg_class-202"><span class="linenos">202</span></a>                     <span class="s1">&#39;d2x&#39;</span><span class="p">:</span> <span class="n">ConvReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-203"><a href="#Regularization.get_reg_class-203"><span class="linenos">203</span></a>                     <span class="s1">&#39;d2t&#39;</span><span class="p">:</span> <span class="n">ConvReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-204"><a href="#Regularization.get_reg_class-204"><span class="linenos">204</span></a>                     <span class="s1">&#39;l1&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-205"><a href="#Regularization.get_reg_class-205"><span class="linenos">205</span></a>                     <span class="s1">&#39;l2&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-206"><a href="#Regularization.get_reg_class-206"><span class="linenos">206</span></a>                     <span class="s1">&#39;norm2&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span> <span class="c1"># weight regularization</span>
</span><span id="Regularization.get_reg_class-207"><a href="#Regularization.get_reg_class-207"><span class="linenos">207</span></a>                     <span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-208"><a href="#Regularization.get_reg_class-208"><span class="linenos">208</span></a>                     <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-209"><a href="#Regularization.get_reg_class-209"><span class="linenos">209</span></a>                     <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-210"><a href="#Regularization.get_reg_class-210"><span class="linenos">210</span></a>                     <span class="s1">&#39;orth&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-211"><a href="#Regularization.get_reg_class-211"><span class="linenos">211</span></a>                     <span class="s1">&#39;bi_t&#39;</span><span class="p">:</span> <span class="n">InlineReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-212"><a href="#Regularization.get_reg_class-212"><span class="linenos">212</span></a>                     <span class="s1">&#39;glocalx&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-213"><a href="#Regularization.get_reg_class-213"><span class="linenos">213</span></a>                     <span class="s1">&#39;glocalt&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-214"><a href="#Regularization.get_reg_class-214"><span class="linenos">214</span></a>                     <span class="s1">&#39;localx&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-215"><a href="#Regularization.get_reg_class-215"><span class="linenos">215</span></a>                     <span class="s1">&#39;localt&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-216"><a href="#Regularization.get_reg_class-216"><span class="linenos">216</span></a>                     <span class="s1">&#39;trd&#39;</span><span class="p">:</span> <span class="n">LocalityReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-217"><a href="#Regularization.get_reg_class-217"><span class="linenos">217</span></a>                     <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-218"><a href="#Regularization.get_reg_class-218"><span class="linenos">218</span></a>                     <span class="s1">&#39;glocal&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-219"><a href="#Regularization.get_reg_class-219"><span class="linenos">219</span></a>                     <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-220"><a href="#Regularization.get_reg_class-220"><span class="linenos">220</span></a>                     <span class="s1">&#39;max_filt&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-221"><a href="#Regularization.get_reg_class-221"><span class="linenos">221</span></a>                     <span class="s1">&#39;max_space&#39;</span><span class="p">:</span> <span class="n">Tikhanov</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-222"><a href="#Regularization.get_reg_class-222"><span class="linenos">222</span></a>                     <span class="s1">&#39;gmax_t&#39;</span><span class="p">:</span> <span class="n">TikhanovC</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-223"><a href="#Regularization.get_reg_class-223"><span class="linenos">223</span></a>                     <span class="s1">&#39;gmax_space&#39;</span><span class="p">:</span> <span class="n">TikhanovC</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-224"><a href="#Regularization.get_reg_class-224"><span class="linenos">224</span></a>                     <span class="s1">&#39;gmax_filter&#39;</span><span class="p">:</span> <span class="n">TikhanovC</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-225"><a href="#Regularization.get_reg_class-225"><span class="linenos">225</span></a>                     <span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="n">DiagonalReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-226"><a href="#Regularization.get_reg_class-226"><span class="linenos">226</span></a>                     <span class="s1">&#39;edge_t&#39;</span><span class="p">:</span> <span class="n">DiagonalReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-227"><a href="#Regularization.get_reg_class-227"><span class="linenos">227</span></a>                     <span class="s1">&#39;edge_t0&#39;</span><span class="p">:</span> <span class="n">DiagonalReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-228"><a href="#Regularization.get_reg_class-228"><span class="linenos">228</span></a>                     <span class="s1">&#39;edge_x&#39;</span><span class="p">:</span> <span class="n">DiagonalReg</span><span class="p">,</span>
</span><span id="Regularization.get_reg_class-229"><a href="#Regularization.get_reg_class-229"><span class="linenos">229</span></a>                     <span class="s1">&#39;activity&#39;</span><span class="p">:</span> <span class="n">ActivityReg</span><span class="p">}</span>
</span><span id="Regularization.get_reg_class-230"><a href="#Regularization.get_reg_class-230"><span class="linenos">230</span></a>        
</span><span id="Regularization.get_reg_class-231"><a href="#Regularization.get_reg_class-231"><span class="linenos">231</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Regularization.get_reg_class-232"><a href="#Regularization.get_reg_class-232"><span class="linenos">232</span></a>            <span class="n">ret</span> <span class="o">=</span> <span class="n">reg_index</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="Regularization.get_reg_class-233"><a href="#Regularization.get_reg_class-233"><span class="linenos">233</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Regularization.get_reg_class-234"><a href="#Regularization.get_reg_class-234"><span class="linenos">234</span></a>            <span class="n">ret</span> <span class="o">=</span> <span class="n">reg_index</span><span class="p">[</span><span class="n">reg_type</span><span class="p">]</span>
</span><span id="Regularization.get_reg_class-235"><a href="#Regularization.get_reg_class-235"><span class="linenos">235</span></a>
</span><span id="Regularization.get_reg_class-236"><a href="#Regularization.get_reg_class-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">ret</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="Regularization.dump_patches" class="variable">dump_patches</dd>
                <dd id="Regularization.training" class="variable">training</dd>
                <dd id="Regularization.call_super_init" class="variable">call_super_init</dd>
                <dd id="Regularization.forward" class="function">forward</dd>
                <dd id="Regularization.register_buffer" class="function">register_buffer</dd>
                <dd id="Regularization.register_parameter" class="function">register_parameter</dd>
                <dd id="Regularization.add_module" class="function">add_module</dd>
                <dd id="Regularization.register_module" class="function">register_module</dd>
                <dd id="Regularization.get_submodule" class="function">get_submodule</dd>
                <dd id="Regularization.get_parameter" class="function">get_parameter</dd>
                <dd id="Regularization.get_buffer" class="function">get_buffer</dd>
                <dd id="Regularization.get_extra_state" class="function">get_extra_state</dd>
                <dd id="Regularization.set_extra_state" class="function">set_extra_state</dd>
                <dd id="Regularization.apply" class="function">apply</dd>
                <dd id="Regularization.cuda" class="function">cuda</dd>
                <dd id="Regularization.ipu" class="function">ipu</dd>
                <dd id="Regularization.xpu" class="function">xpu</dd>
                <dd id="Regularization.cpu" class="function">cpu</dd>
                <dd id="Regularization.type" class="function">type</dd>
                <dd id="Regularization.float" class="function">float</dd>
                <dd id="Regularization.double" class="function">double</dd>
                <dd id="Regularization.half" class="function">half</dd>
                <dd id="Regularization.bfloat16" class="function">bfloat16</dd>
                <dd id="Regularization.to_empty" class="function">to_empty</dd>
                <dd id="Regularization.to" class="function">to</dd>
                <dd id="Regularization.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="Regularization.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="Regularization.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="Regularization.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="Regularization.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="Regularization.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="Regularization.state_dict" class="function">state_dict</dd>
                <dd id="Regularization.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="Regularization.load_state_dict" class="function">load_state_dict</dd>
                <dd id="Regularization.parameters" class="function">parameters</dd>
                <dd id="Regularization.named_parameters" class="function">named_parameters</dd>
                <dd id="Regularization.buffers" class="function">buffers</dd>
                <dd id="Regularization.named_buffers" class="function">named_buffers</dd>
                <dd id="Regularization.children" class="function">children</dd>
                <dd id="Regularization.named_children" class="function">named_children</dd>
                <dd id="Regularization.modules" class="function">modules</dd>
                <dd id="Regularization.named_modules" class="function">named_modules</dd>
                <dd id="Regularization.train" class="function">train</dd>
                <dd id="Regularization.eval" class="function">eval</dd>
                <dd id="Regularization.requires_grad_" class="function">requires_grad_</dd>
                <dd id="Regularization.zero_grad" class="function">zero_grad</dd>
                <dd id="Regularization.share_memory" class="function">share_memory</dd>
                <dd id="Regularization.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="RegModule">
                            <input id="RegModule-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">RegModule</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="RegModule-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RegModule"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RegModule-239"><a href="#RegModule-239"><span class="linenos">239</span></a><span class="k">class</span> <span class="nc">RegModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span> 
</span><span id="RegModule-240"><a href="#RegModule-240"><span class="linenos">240</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Base class for regularization modules &quot;&quot;&quot;</span>
</span><span id="RegModule-241"><a href="#RegModule-241"><span class="linenos">241</span></a>
</span><span id="RegModule-242"><a href="#RegModule-242"><span class="linenos">242</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="RegModule-243"><a href="#RegModule-243"><span class="linenos">243</span></a>                 <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_dims</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">unit_reg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="RegModule-244"><a href="#RegModule-244"><span class="linenos">244</span></a>                 <span class="n">pos_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="RegModule-245"><a href="#RegModule-245"><span class="linenos">245</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Reg_module class&quot;&quot;&quot;</span>
</span><span id="RegModule-246"><a href="#RegModule-246"><span class="linenos">246</span></a>
</span><span id="RegModule-247"><a href="#RegModule-247"><span class="linenos">247</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Need reg_type.&#39;</span>
</span><span id="RegModule-248"><a href="#RegModule-248"><span class="linenos">248</span></a>        <span class="k">assert</span> <span class="n">reg_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Need reg_val&#39;</span>
</span><span id="RegModule-249"><a href="#RegModule-249"><span class="linenos">249</span></a>        <span class="k">assert</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Need input dims&#39;</span>
</span><span id="RegModule-250"><a href="#RegModule-250"><span class="linenos">250</span></a>
</span><span id="RegModule-251"><a href="#RegModule-251"><span class="linenos">251</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="RegModule-252"><a href="#RegModule-252"><span class="linenos">252</span></a>
</span><span id="RegModule-253"><a href="#RegModule-253"><span class="linenos">253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">=</span> <span class="n">reg_type</span>
</span><span id="RegModule-254"><a href="#RegModule-254"><span class="linenos">254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span> <span class="o">=</span> <span class="n">unit_reg</span>
</span><span id="RegModule-255"><a href="#RegModule-255"><span class="linenos">255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">reg_val</span><span class="p">))</span>
</span><span id="RegModule-256"><a href="#RegModule-256"><span class="linenos">256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="n">input_dims</span>
</span><span id="RegModule-257"><a href="#RegModule-257"><span class="linenos">257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">=</span> <span class="n">num_dims</span> <span class="c1"># this is the relevant number of dimensions for some filters -- will be set within functions</span>
</span><span id="RegModule-258"><a href="#RegModule-258"><span class="linenos">258</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="RegModule-259"><a href="#RegModule-259"><span class="linenos">259</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span> <span class="o">=</span> <span class="n">pos_constraint</span>
</span><span id="RegModule-260"><a href="#RegModule-260"><span class="linenos">260</span></a>
</span><span id="RegModule-261"><a href="#RegModule-261"><span class="linenos">261</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="RegModule-262"><a href="#RegModule-262"><span class="linenos">262</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reg_penalty</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span><span id="RegModule-263"><a href="#RegModule-263"><span class="linenos">263</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">*</span> <span class="n">rpen</span>
</span><span id="RegModule-264"><a href="#RegModule-264"><span class="linenos">264</span></a>        
</span><span id="RegModule-265"><a href="#RegModule-265"><span class="linenos">265</span></a>        <span class="k">return</span> <span class="n">rpen</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Base class for regularization modules</p>
</div>


                            <div id="RegModule.__init__" class="classattr">
                                        <input id="RegModule.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">RegModule</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">num_dims</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">unit_reg</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">pos_constraint</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="RegModule.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RegModule.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RegModule.__init__-242"><a href="#RegModule.__init__-242"><span class="linenos">242</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
</span><span id="RegModule.__init__-243"><a href="#RegModule.__init__-243"><span class="linenos">243</span></a>                 <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_dims</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">unit_reg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">folded_lags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="RegModule.__init__-244"><a href="#RegModule.__init__-244"><span class="linenos">244</span></a>                 <span class="n">pos_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="RegModule.__init__-245"><a href="#RegModule.__init__-245"><span class="linenos">245</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Reg_module class&quot;&quot;&quot;</span>
</span><span id="RegModule.__init__-246"><a href="#RegModule.__init__-246"><span class="linenos">246</span></a>
</span><span id="RegModule.__init__-247"><a href="#RegModule.__init__-247"><span class="linenos">247</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Need reg_type.&#39;</span>
</span><span id="RegModule.__init__-248"><a href="#RegModule.__init__-248"><span class="linenos">248</span></a>        <span class="k">assert</span> <span class="n">reg_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Need reg_val&#39;</span>
</span><span id="RegModule.__init__-249"><a href="#RegModule.__init__-249"><span class="linenos">249</span></a>        <span class="k">assert</span> <span class="n">input_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Need input dims&#39;</span>
</span><span id="RegModule.__init__-250"><a href="#RegModule.__init__-250"><span class="linenos">250</span></a>
</span><span id="RegModule.__init__-251"><a href="#RegModule.__init__-251"><span class="linenos">251</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="RegModule.__init__-252"><a href="#RegModule.__init__-252"><span class="linenos">252</span></a>
</span><span id="RegModule.__init__-253"><a href="#RegModule.__init__-253"><span class="linenos">253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">=</span> <span class="n">reg_type</span>
</span><span id="RegModule.__init__-254"><a href="#RegModule.__init__-254"><span class="linenos">254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unit_reg</span> <span class="o">=</span> <span class="n">unit_reg</span>
</span><span id="RegModule.__init__-255"><a href="#RegModule.__init__-255"><span class="linenos">255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">reg_val</span><span class="p">))</span>
</span><span id="RegModule.__init__-256"><a href="#RegModule.__init__-256"><span class="linenos">256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="n">input_dims</span>
</span><span id="RegModule.__init__-257"><a href="#RegModule.__init__-257"><span class="linenos">257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">=</span> <span class="n">num_dims</span> <span class="c1"># this is the relevant number of dimensions for some filters -- will be set within functions</span>
</span><span id="RegModule.__init__-258"><a href="#RegModule.__init__-258"><span class="linenos">258</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span> <span class="o">=</span> <span class="n">folded_lags</span>
</span><span id="RegModule.__init__-259"><a href="#RegModule.__init__-259"><span class="linenos">259</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span> <span class="o">=</span> <span class="n">pos_constraint</span>
</span></pre></div>


            <div class="docstring"><p>Constructor for Reg_module class</p>
</div>


                            </div>
                            <div id="RegModule.reg_type" class="classattr">
                                <div class="attr variable">
            <span class="name">reg_type</span>

        
    </div>
    <a class="headerlink" href="#RegModule.reg_type"></a>
    
    

                            </div>
                            <div id="RegModule.unit_reg" class="classattr">
                                <div class="attr variable">
            <span class="name">unit_reg</span>

        
    </div>
    <a class="headerlink" href="#RegModule.unit_reg"></a>
    
    

                            </div>
                            <div id="RegModule.input_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">input_dims</span>

        
    </div>
    <a class="headerlink" href="#RegModule.input_dims"></a>
    
    

                            </div>
                            <div id="RegModule.num_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">num_dims</span>

        
    </div>
    <a class="headerlink" href="#RegModule.num_dims"></a>
    
    

                            </div>
                            <div id="RegModule.folded_lags" class="classattr">
                                <div class="attr variable">
            <span class="name">folded_lags</span>

        
    </div>
    <a class="headerlink" href="#RegModule.folded_lags"></a>
    
    

                            </div>
                            <div id="RegModule.pos_constraint" class="classattr">
                                <div class="attr variable">
            <span class="name">pos_constraint</span>

        
    </div>
    <a class="headerlink" href="#RegModule.pos_constraint"></a>
    
    

                            </div>
                            <div id="RegModule.forward" class="classattr">
                                        <input id="RegModule.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">weights</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="RegModule.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RegModule.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RegModule.forward-261"><a href="#RegModule.forward-261"><span class="linenos">261</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="RegModule.forward-262"><a href="#RegModule.forward-262"><span class="linenos">262</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reg_penalty</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span><span id="RegModule.forward-263"><a href="#RegModule.forward-263"><span class="linenos">263</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">*</span> <span class="n">rpen</span>
</span><span id="RegModule.forward-264"><a href="#RegModule.forward-264"><span class="linenos">264</span></a>        
</span><span id="RegModule.forward-265"><a href="#RegModule.forward-265"><span class="linenos">265</span></a>        <span class="k">return</span> <span class="n">rpen</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Defines the computation performed at every call.</p>

<p>Should be overridden by all subclasses.</p>

<div class="pdoc-alert pdoc-alert-note">

<p>Although the recipe for forward pass needs to be defined within
this function, one should call the <code>Module</code> instance afterwards
instead of this since the former takes care of running the
registered hooks while the latter silently ignores them.</p>

</div>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="RegModule.dump_patches" class="variable">dump_patches</dd>
                <dd id="RegModule.training" class="variable">training</dd>
                <dd id="RegModule.call_super_init" class="variable">call_super_init</dd>
                <dd id="RegModule.register_buffer" class="function">register_buffer</dd>
                <dd id="RegModule.register_parameter" class="function">register_parameter</dd>
                <dd id="RegModule.add_module" class="function">add_module</dd>
                <dd id="RegModule.register_module" class="function">register_module</dd>
                <dd id="RegModule.get_submodule" class="function">get_submodule</dd>
                <dd id="RegModule.get_parameter" class="function">get_parameter</dd>
                <dd id="RegModule.get_buffer" class="function">get_buffer</dd>
                <dd id="RegModule.get_extra_state" class="function">get_extra_state</dd>
                <dd id="RegModule.set_extra_state" class="function">set_extra_state</dd>
                <dd id="RegModule.apply" class="function">apply</dd>
                <dd id="RegModule.cuda" class="function">cuda</dd>
                <dd id="RegModule.ipu" class="function">ipu</dd>
                <dd id="RegModule.xpu" class="function">xpu</dd>
                <dd id="RegModule.cpu" class="function">cpu</dd>
                <dd id="RegModule.type" class="function">type</dd>
                <dd id="RegModule.float" class="function">float</dd>
                <dd id="RegModule.double" class="function">double</dd>
                <dd id="RegModule.half" class="function">half</dd>
                <dd id="RegModule.bfloat16" class="function">bfloat16</dd>
                <dd id="RegModule.to_empty" class="function">to_empty</dd>
                <dd id="RegModule.to" class="function">to</dd>
                <dd id="RegModule.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="RegModule.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="RegModule.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="RegModule.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="RegModule.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="RegModule.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="RegModule.state_dict" class="function">state_dict</dd>
                <dd id="RegModule.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="RegModule.load_state_dict" class="function">load_state_dict</dd>
                <dd id="RegModule.parameters" class="function">parameters</dd>
                <dd id="RegModule.named_parameters" class="function">named_parameters</dd>
                <dd id="RegModule.buffers" class="function">buffers</dd>
                <dd id="RegModule.named_buffers" class="function">named_buffers</dd>
                <dd id="RegModule.children" class="function">children</dd>
                <dd id="RegModule.named_children" class="function">named_children</dd>
                <dd id="RegModule.modules" class="function">modules</dd>
                <dd id="RegModule.named_modules" class="function">named_modules</dd>
                <dd id="RegModule.train" class="function">train</dd>
                <dd id="RegModule.eval" class="function">eval</dd>
                <dd id="RegModule.requires_grad_" class="function">requires_grad_</dd>
                <dd id="RegModule.zero_grad" class="function">zero_grad</dd>
                <dd id="RegModule.share_memory" class="function">share_memory</dd>
                <dd id="RegModule.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="LocalityReg">
                            <input id="LocalityReg-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LocalityReg</span><wbr>(<span class="base"><a href="#RegModule">RegModule</a></span>):

                <label class="view-source-button" for="LocalityReg-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LocalityReg"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LocalityReg-267"><a href="#LocalityReg-267"><span class="linenos">267</span></a><span class="k">class</span> <span class="nc">LocalityReg</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="LocalityReg-268"><a href="#LocalityReg-268"><span class="linenos">268</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Regularization to penalize locality separably for each dimension&quot;&quot;&quot;</span>
</span><span id="LocalityReg-269"><a href="#LocalityReg-269"><span class="linenos">269</span></a>    
</span><span id="LocalityReg-270"><a href="#LocalityReg-270"><span class="linenos">270</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_dims</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="LocalityReg-271"><a href="#LocalityReg-271"><span class="linenos">271</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for LocalityReg class&quot;&quot;&quot;</span>
</span><span id="LocalityReg-272"><a href="#LocalityReg-272"><span class="linenos">272</span></a>
</span><span id="LocalityReg-273"><a href="#LocalityReg-273"><span class="linenos">273</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;localx&#39;</span><span class="p">,</span> <span class="s1">&#39;localt&#39;</span><span class="p">,</span> <span class="s1">&#39;glocalx&#39;</span><span class="p">,</span> <span class="s1">&#39;glocalt&#39;</span><span class="p">,</span> <span class="s1">&#39;trd&#39;</span><span class="p">]</span>
</span><span id="LocalityReg-274"><a href="#LocalityReg-274"><span class="linenos">274</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid Locality Reg type&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="LocalityReg-275"><a href="#LocalityReg-275"><span class="linenos">275</span></a>
</span><span id="LocalityReg-276"><a href="#LocalityReg-276"><span class="linenos">276</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="LocalityReg-277"><a href="#LocalityReg-277"><span class="linenos">277</span></a>
</span><span id="LocalityReg-278"><a href="#LocalityReg-278"><span class="linenos">278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">build_reg_mats</span><span class="p">()</span>
</span><span id="LocalityReg-279"><a href="#LocalityReg-279"><span class="linenos">279</span></a>        <span class="c1"># normalized weights mean w ~ 1/sqrt(N), so \sum w^2 = 1. but w^4 =&gt; 1/N^2 so multiply by N</span>
</span><span id="LocalityReg-280"><a href="#LocalityReg-280"><span class="linenos">280</span></a>        <span class="c1">#self.multiplier = np.prod(input_dims)</span>
</span><span id="LocalityReg-281"><a href="#LocalityReg-281"><span class="linenos">281</span></a>
</span><span id="LocalityReg-282"><a href="#LocalityReg-282"><span class="linenos">282</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="LocalityReg-283"><a href="#LocalityReg-283"><span class="linenos">283</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute regularization penalty for locality&quot;&quot;&quot;</span>
</span><span id="LocalityReg-284"><a href="#LocalityReg-284"><span class="linenos">284</span></a>
</span><span id="LocalityReg-285"><a href="#LocalityReg-285"><span class="linenos">285</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LocalityReg-286"><a href="#LocalityReg-286"><span class="linenos">286</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">:</span>
</span><span id="LocalityReg-287"><a href="#LocalityReg-287"><span class="linenos">287</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#[C, NX, NY, num_lags, num_filters]</span>
</span><span id="LocalityReg-288"><a href="#LocalityReg-288"><span class="linenos">288</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LocalityReg-289"><a href="#LocalityReg-289"><span class="linenos">289</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="c1">#[C, NX, NY, num_lags, num_filters]</span>
</span><span id="LocalityReg-290"><a href="#LocalityReg-290"><span class="linenos">290</span></a>
</span><span id="LocalityReg-291"><a href="#LocalityReg-291"><span class="linenos">291</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocalx&#39;</span><span class="p">:</span>
</span><span id="LocalityReg-292"><a href="#LocalityReg-292"><span class="linenos">292</span></a>            
</span><span id="LocalityReg-293"><a href="#LocalityReg-293"><span class="linenos">293</span></a>            <span class="c1"># glocal                </span>
</span><span id="LocalityReg-294"><a href="#LocalityReg-294"><span class="linenos">294</span></a>            <span class="n">wx</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># sum over y and t (note this works for singular dim y too, i.e., 1d)</span>
</span><span id="LocalityReg-295"><a href="#LocalityReg-295"><span class="linenos">295</span></a>
</span><span id="LocalityReg-296"><a href="#LocalityReg-296"><span class="linenos">296</span></a>            <span class="n">penx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xn,xw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">wx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localx_pen</span><span class="p">)</span>
</span><span id="LocalityReg-297"><a href="#LocalityReg-297"><span class="linenos">297</span></a>            <span class="n">penx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xn,xn-&gt;n&#39;</span><span class="p">,</span> <span class="n">penx</span><span class="p">,</span> <span class="n">wx</span><span class="p">)</span>
</span><span id="LocalityReg-298"><a href="#LocalityReg-298"><span class="linenos">298</span></a>
</span><span id="LocalityReg-299"><a href="#LocalityReg-299"><span class="linenos">299</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LocalityReg-300"><a href="#LocalityReg-300"><span class="linenos">300</span></a>                <span class="n">rpen</span> <span class="o">=</span> <span class="n">penx</span>
</span><span id="LocalityReg-301"><a href="#LocalityReg-301"><span class="linenos">301</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LocalityReg-302"><a href="#LocalityReg-302"><span class="linenos">302</span></a>                <span class="n">wy</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># sum over x and t</span>
</span><span id="LocalityReg-303"><a href="#LocalityReg-303"><span class="linenos">303</span></a>        
</span><span id="LocalityReg-304"><a href="#LocalityReg-304"><span class="linenos">304</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">same_dims</span><span class="p">:</span>
</span><span id="LocalityReg-305"><a href="#LocalityReg-305"><span class="linenos">305</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,yw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localx_pen</span><span class="p">)</span>
</span><span id="LocalityReg-306"><a href="#LocalityReg-306"><span class="linenos">306</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,yn-&gt;n&#39;</span><span class="p">,</span> <span class="n">peny</span><span class="p">,</span> <span class="n">wy</span><span class="p">)</span>
</span><span id="LocalityReg-307"><a href="#LocalityReg-307"><span class="linenos">307</span></a>                <span class="k">else</span><span class="p">:</span>    
</span><span id="LocalityReg-308"><a href="#LocalityReg-308"><span class="linenos">308</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,yw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localy_pen</span><span class="p">)</span>
</span><span id="LocalityReg-309"><a href="#LocalityReg-309"><span class="linenos">309</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,yn-&gt;n&#39;</span><span class="p">,</span> <span class="n">peny</span><span class="p">,</span> <span class="n">wy</span><span class="p">)</span>
</span><span id="LocalityReg-310"><a href="#LocalityReg-310"><span class="linenos">310</span></a>
</span><span id="LocalityReg-311"><a href="#LocalityReg-311"><span class="linenos">311</span></a>                <span class="n">rpen</span> <span class="o">=</span> <span class="n">penx</span> <span class="o">+</span> <span class="n">peny</span>
</span><span id="LocalityReg-312"><a href="#LocalityReg-312"><span class="linenos">312</span></a>
</span><span id="LocalityReg-313"><a href="#LocalityReg-313"><span class="linenos">313</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocalt&#39;</span><span class="p">:</span>
</span><span id="LocalityReg-314"><a href="#LocalityReg-314"><span class="linenos">314</span></a>            
</span><span id="LocalityReg-315"><a href="#LocalityReg-315"><span class="linenos">315</span></a>            <span class="c1"># glocal on time</span>
</span><span id="LocalityReg-316"><a href="#LocalityReg-316"><span class="linenos">316</span></a>            <span class="c1">#w = weights.reshape(self.input_dims + [-1])**2</span>
</span><span id="LocalityReg-317"><a href="#LocalityReg-317"><span class="linenos">317</span></a>            <span class="n">wt</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</span><span id="LocalityReg-318"><a href="#LocalityReg-318"><span class="linenos">318</span></a>
</span><span id="LocalityReg-319"><a href="#LocalityReg-319"><span class="linenos">319</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tn,tw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">wt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localt_pen</span><span class="p">)</span>
</span><span id="LocalityReg-320"><a href="#LocalityReg-320"><span class="linenos">320</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tn,tn-&gt;n&#39;</span><span class="p">,</span> <span class="n">rpen</span><span class="p">,</span> <span class="n">wt</span><span class="p">)</span>
</span><span id="LocalityReg-321"><a href="#LocalityReg-321"><span class="linenos">321</span></a>        
</span><span id="LocalityReg-322"><a href="#LocalityReg-322"><span class="linenos">322</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;localx&#39;</span><span class="p">:</span>
</span><span id="LocalityReg-323"><a href="#LocalityReg-323"><span class="linenos">323</span></a>            
</span><span id="LocalityReg-324"><a href="#LocalityReg-324"><span class="linenos">324</span></a>            <span class="c1"># glocal</span>
</span><span id="LocalityReg-325"><a href="#LocalityReg-325"><span class="linenos">325</span></a>            <span class="c1">#w = weights.reshape(self.input_dims + [-1])**2 #[C, NX, NY, num_lags, num_filters]</span>
</span><span id="LocalityReg-326"><a href="#LocalityReg-326"><span class="linenos">326</span></a>
</span><span id="LocalityReg-327"><a href="#LocalityReg-327"><span class="linenos">327</span></a>            <span class="n">penx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,xw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localx_pen</span><span class="p">)</span>
</span><span id="LocalityReg-328"><a href="#LocalityReg-328"><span class="linenos">328</span></a>            <span class="n">penx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">penx</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="LocalityReg-329"><a href="#LocalityReg-329"><span class="linenos">329</span></a>
</span><span id="LocalityReg-330"><a href="#LocalityReg-330"><span class="linenos">330</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LocalityReg-331"><a href="#LocalityReg-331"><span class="linenos">331</span></a>                <span class="n">rpen</span> <span class="o">=</span> <span class="n">penx</span>
</span><span id="LocalityReg-332"><a href="#LocalityReg-332"><span class="linenos">332</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LocalityReg-333"><a href="#LocalityReg-333"><span class="linenos">333</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">same_dims</span><span class="p">:</span>
</span><span id="LocalityReg-334"><a href="#LocalityReg-334"><span class="linenos">334</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,yw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localx_pen</span><span class="p">)</span>
</span><span id="LocalityReg-335"><a href="#LocalityReg-335"><span class="linenos">335</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">peny</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="LocalityReg-336"><a href="#LocalityReg-336"><span class="linenos">336</span></a>                <span class="k">else</span><span class="p">:</span>    
</span><span id="LocalityReg-337"><a href="#LocalityReg-337"><span class="linenos">337</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,yw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localy_pen</span><span class="p">)</span>
</span><span id="LocalityReg-338"><a href="#LocalityReg-338"><span class="linenos">338</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">peny</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="LocalityReg-339"><a href="#LocalityReg-339"><span class="linenos">339</span></a>
</span><span id="LocalityReg-340"><a href="#LocalityReg-340"><span class="linenos">340</span></a>                <span class="n">rpen</span> <span class="o">=</span> <span class="n">penx</span> <span class="o">+</span> <span class="n">peny</span>
</span><span id="LocalityReg-341"><a href="#LocalityReg-341"><span class="linenos">341</span></a>        
</span><span id="LocalityReg-342"><a href="#LocalityReg-342"><span class="linenos">342</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;localt&#39;</span><span class="p">:</span>
</span><span id="LocalityReg-343"><a href="#LocalityReg-343"><span class="linenos">343</span></a>            
</span><span id="LocalityReg-344"><a href="#LocalityReg-344"><span class="linenos">344</span></a>            <span class="c1"># glocal on time</span>
</span><span id="LocalityReg-345"><a href="#LocalityReg-345"><span class="linenos">345</span></a>            <span class="c1">#w = weights.reshape(self.input_dims + [-1])**2</span>
</span><span id="LocalityReg-346"><a href="#LocalityReg-346"><span class="linenos">346</span></a>
</span><span id="LocalityReg-347"><a href="#LocalityReg-347"><span class="linenos">347</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,tw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localt_pen</span><span class="p">)</span>
</span><span id="LocalityReg-348"><a href="#LocalityReg-348"><span class="linenos">348</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">rpen</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="LocalityReg-349"><a href="#LocalityReg-349"><span class="linenos">349</span></a>        
</span><span id="LocalityReg-350"><a href="#LocalityReg-350"><span class="linenos">350</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;trd&#39;</span><span class="p">:</span>
</span><span id="LocalityReg-351"><a href="#LocalityReg-351"><span class="linenos">351</span></a>            
</span><span id="LocalityReg-352"><a href="#LocalityReg-352"><span class="linenos">352</span></a>            <span class="c1"># penalty on time</span>
</span><span id="LocalityReg-353"><a href="#LocalityReg-353"><span class="linenos">353</span></a>            <span class="c1">#w = weights.reshape(self.input_dims + [-1])**2</span>
</span><span id="LocalityReg-354"><a href="#LocalityReg-354"><span class="linenos">354</span></a>
</span><span id="LocalityReg-355"><a href="#LocalityReg-355"><span class="linenos">355</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,tw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trd_pen</span><span class="p">)</span>
</span><span id="LocalityReg-356"><a href="#LocalityReg-356"><span class="linenos">356</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">rpen</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="LocalityReg-357"><a href="#LocalityReg-357"><span class="linenos">357</span></a>        
</span><span id="LocalityReg-358"><a href="#LocalityReg-358"><span class="linenos">358</span></a>        <span class="k">return</span> <span class="n">rpen</span>
</span><span id="LocalityReg-359"><a href="#LocalityReg-359"><span class="linenos">359</span></a>    <span class="c1"># END LocalityReg.compute_reg_penalty</span>
</span><span id="LocalityReg-360"><a href="#LocalityReg-360"><span class="linenos">360</span></a>
</span><span id="LocalityReg-361"><a href="#LocalityReg-361"><span class="linenos">361</span></a>    <span class="k">def</span> <span class="nf">build_reg_mats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LocalityReg-362"><a href="#LocalityReg-362"><span class="linenos">362</span></a>        
</span><span id="LocalityReg-363"><a href="#LocalityReg-363"><span class="linenos">363</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocalx&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;localx&#39;</span><span class="p">:</span>
</span><span id="LocalityReg-364"><a href="#LocalityReg-364"><span class="linenos">364</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;localx_pen&#39;</span><span class="p">,((</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="LocalityReg-365"><a href="#LocalityReg-365"><span class="linenos">365</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
</span><span id="LocalityReg-366"><a href="#LocalityReg-366"><span class="linenos">366</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">same_dims</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LocalityReg-367"><a href="#LocalityReg-367"><span class="linenos">367</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LocalityReg-368"><a href="#LocalityReg-368"><span class="linenos">368</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">same_dims</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LocalityReg-369"><a href="#LocalityReg-369"><span class="linenos">369</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;localy_pen&#39;</span><span class="p">,((</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="LocalityReg-370"><a href="#LocalityReg-370"><span class="linenos">370</span></a>
</span><span id="LocalityReg-371"><a href="#LocalityReg-371"><span class="linenos">371</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocalt&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;localt&#39;</span><span class="p">:</span>
</span><span id="LocalityReg-372"><a href="#LocalityReg-372"><span class="linenos">372</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;localt_pen&#39;</span><span class="p">,((</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="LocalityReg-373"><a href="#LocalityReg-373"><span class="linenos">373</span></a>        
</span><span id="LocalityReg-374"><a href="#LocalityReg-374"><span class="linenos">374</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;trd&#39;</span><span class="p">:</span>
</span><span id="LocalityReg-375"><a href="#LocalityReg-375"><span class="linenos">375</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;trd_pen&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Regularization to penalize locality separably for each dimension</p>
</div>


                            <div id="LocalityReg.__init__" class="classattr">
                                        <input id="LocalityReg.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LocalityReg</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">num_dims</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="LocalityReg.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LocalityReg.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LocalityReg.__init__-270"><a href="#LocalityReg.__init__-270"><span class="linenos">270</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_dims</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="LocalityReg.__init__-271"><a href="#LocalityReg.__init__-271"><span class="linenos">271</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for LocalityReg class&quot;&quot;&quot;</span>
</span><span id="LocalityReg.__init__-272"><a href="#LocalityReg.__init__-272"><span class="linenos">272</span></a>
</span><span id="LocalityReg.__init__-273"><a href="#LocalityReg.__init__-273"><span class="linenos">273</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;localx&#39;</span><span class="p">,</span> <span class="s1">&#39;localt&#39;</span><span class="p">,</span> <span class="s1">&#39;glocalx&#39;</span><span class="p">,</span> <span class="s1">&#39;glocalt&#39;</span><span class="p">,</span> <span class="s1">&#39;trd&#39;</span><span class="p">]</span>
</span><span id="LocalityReg.__init__-274"><a href="#LocalityReg.__init__-274"><span class="linenos">274</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid Locality Reg type&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="LocalityReg.__init__-275"><a href="#LocalityReg.__init__-275"><span class="linenos">275</span></a>
</span><span id="LocalityReg.__init__-276"><a href="#LocalityReg.__init__-276"><span class="linenos">276</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="LocalityReg.__init__-277"><a href="#LocalityReg.__init__-277"><span class="linenos">277</span></a>
</span><span id="LocalityReg.__init__-278"><a href="#LocalityReg.__init__-278"><span class="linenos">278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">build_reg_mats</span><span class="p">()</span>
</span><span id="LocalityReg.__init__-279"><a href="#LocalityReg.__init__-279"><span class="linenos">279</span></a>        <span class="c1"># normalized weights mean w ~ 1/sqrt(N), so \sum w^2 = 1. but w^4 =&gt; 1/N^2 so multiply by N</span>
</span><span id="LocalityReg.__init__-280"><a href="#LocalityReg.__init__-280"><span class="linenos">280</span></a>        <span class="c1">#self.multiplier = np.prod(input_dims)</span>
</span></pre></div>


            <div class="docstring"><p>Constructor for LocalityReg class</p>
</div>


                            </div>
                            <div id="LocalityReg.compute_reg_penalty" class="classattr">
                                        <input id="LocalityReg.compute_reg_penalty-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_reg_penalty</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">weights</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LocalityReg.compute_reg_penalty-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LocalityReg.compute_reg_penalty"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LocalityReg.compute_reg_penalty-282"><a href="#LocalityReg.compute_reg_penalty-282"><span class="linenos">282</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="LocalityReg.compute_reg_penalty-283"><a href="#LocalityReg.compute_reg_penalty-283"><span class="linenos">283</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute regularization penalty for locality&quot;&quot;&quot;</span>
</span><span id="LocalityReg.compute_reg_penalty-284"><a href="#LocalityReg.compute_reg_penalty-284"><span class="linenos">284</span></a>
</span><span id="LocalityReg.compute_reg_penalty-285"><a href="#LocalityReg.compute_reg_penalty-285"><span class="linenos">285</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LocalityReg.compute_reg_penalty-286"><a href="#LocalityReg.compute_reg_penalty-286"><span class="linenos">286</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-287"><a href="#LocalityReg.compute_reg_penalty-287"><span class="linenos">287</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#[C, NX, NY, num_lags, num_filters]</span>
</span><span id="LocalityReg.compute_reg_penalty-288"><a href="#LocalityReg.compute_reg_penalty-288"><span class="linenos">288</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-289"><a href="#LocalityReg.compute_reg_penalty-289"><span class="linenos">289</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="c1">#[C, NX, NY, num_lags, num_filters]</span>
</span><span id="LocalityReg.compute_reg_penalty-290"><a href="#LocalityReg.compute_reg_penalty-290"><span class="linenos">290</span></a>
</span><span id="LocalityReg.compute_reg_penalty-291"><a href="#LocalityReg.compute_reg_penalty-291"><span class="linenos">291</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocalx&#39;</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-292"><a href="#LocalityReg.compute_reg_penalty-292"><span class="linenos">292</span></a>            
</span><span id="LocalityReg.compute_reg_penalty-293"><a href="#LocalityReg.compute_reg_penalty-293"><span class="linenos">293</span></a>            <span class="c1"># glocal                </span>
</span><span id="LocalityReg.compute_reg_penalty-294"><a href="#LocalityReg.compute_reg_penalty-294"><span class="linenos">294</span></a>            <span class="n">wx</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># sum over y and t (note this works for singular dim y too, i.e., 1d)</span>
</span><span id="LocalityReg.compute_reg_penalty-295"><a href="#LocalityReg.compute_reg_penalty-295"><span class="linenos">295</span></a>
</span><span id="LocalityReg.compute_reg_penalty-296"><a href="#LocalityReg.compute_reg_penalty-296"><span class="linenos">296</span></a>            <span class="n">penx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xn,xw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">wx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localx_pen</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-297"><a href="#LocalityReg.compute_reg_penalty-297"><span class="linenos">297</span></a>            <span class="n">penx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xn,xn-&gt;n&#39;</span><span class="p">,</span> <span class="n">penx</span><span class="p">,</span> <span class="n">wx</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-298"><a href="#LocalityReg.compute_reg_penalty-298"><span class="linenos">298</span></a>
</span><span id="LocalityReg.compute_reg_penalty-299"><a href="#LocalityReg.compute_reg_penalty-299"><span class="linenos">299</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-300"><a href="#LocalityReg.compute_reg_penalty-300"><span class="linenos">300</span></a>                <span class="n">rpen</span> <span class="o">=</span> <span class="n">penx</span>
</span><span id="LocalityReg.compute_reg_penalty-301"><a href="#LocalityReg.compute_reg_penalty-301"><span class="linenos">301</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-302"><a href="#LocalityReg.compute_reg_penalty-302"><span class="linenos">302</span></a>                <span class="n">wy</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># sum over x and t</span>
</span><span id="LocalityReg.compute_reg_penalty-303"><a href="#LocalityReg.compute_reg_penalty-303"><span class="linenos">303</span></a>        
</span><span id="LocalityReg.compute_reg_penalty-304"><a href="#LocalityReg.compute_reg_penalty-304"><span class="linenos">304</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">same_dims</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-305"><a href="#LocalityReg.compute_reg_penalty-305"><span class="linenos">305</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,yw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localx_pen</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-306"><a href="#LocalityReg.compute_reg_penalty-306"><span class="linenos">306</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,yn-&gt;n&#39;</span><span class="p">,</span> <span class="n">peny</span><span class="p">,</span> <span class="n">wy</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-307"><a href="#LocalityReg.compute_reg_penalty-307"><span class="linenos">307</span></a>                <span class="k">else</span><span class="p">:</span>    
</span><span id="LocalityReg.compute_reg_penalty-308"><a href="#LocalityReg.compute_reg_penalty-308"><span class="linenos">308</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,yw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localy_pen</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-309"><a href="#LocalityReg.compute_reg_penalty-309"><span class="linenos">309</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,yn-&gt;n&#39;</span><span class="p">,</span> <span class="n">peny</span><span class="p">,</span> <span class="n">wy</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-310"><a href="#LocalityReg.compute_reg_penalty-310"><span class="linenos">310</span></a>
</span><span id="LocalityReg.compute_reg_penalty-311"><a href="#LocalityReg.compute_reg_penalty-311"><span class="linenos">311</span></a>                <span class="n">rpen</span> <span class="o">=</span> <span class="n">penx</span> <span class="o">+</span> <span class="n">peny</span>
</span><span id="LocalityReg.compute_reg_penalty-312"><a href="#LocalityReg.compute_reg_penalty-312"><span class="linenos">312</span></a>
</span><span id="LocalityReg.compute_reg_penalty-313"><a href="#LocalityReg.compute_reg_penalty-313"><span class="linenos">313</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocalt&#39;</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-314"><a href="#LocalityReg.compute_reg_penalty-314"><span class="linenos">314</span></a>            
</span><span id="LocalityReg.compute_reg_penalty-315"><a href="#LocalityReg.compute_reg_penalty-315"><span class="linenos">315</span></a>            <span class="c1"># glocal on time</span>
</span><span id="LocalityReg.compute_reg_penalty-316"><a href="#LocalityReg.compute_reg_penalty-316"><span class="linenos">316</span></a>            <span class="c1">#w = weights.reshape(self.input_dims + [-1])**2</span>
</span><span id="LocalityReg.compute_reg_penalty-317"><a href="#LocalityReg.compute_reg_penalty-317"><span class="linenos">317</span></a>            <span class="n">wt</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</span><span id="LocalityReg.compute_reg_penalty-318"><a href="#LocalityReg.compute_reg_penalty-318"><span class="linenos">318</span></a>
</span><span id="LocalityReg.compute_reg_penalty-319"><a href="#LocalityReg.compute_reg_penalty-319"><span class="linenos">319</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tn,tw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">wt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localt_pen</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-320"><a href="#LocalityReg.compute_reg_penalty-320"><span class="linenos">320</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tn,tn-&gt;n&#39;</span><span class="p">,</span> <span class="n">rpen</span><span class="p">,</span> <span class="n">wt</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-321"><a href="#LocalityReg.compute_reg_penalty-321"><span class="linenos">321</span></a>        
</span><span id="LocalityReg.compute_reg_penalty-322"><a href="#LocalityReg.compute_reg_penalty-322"><span class="linenos">322</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;localx&#39;</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-323"><a href="#LocalityReg.compute_reg_penalty-323"><span class="linenos">323</span></a>            
</span><span id="LocalityReg.compute_reg_penalty-324"><a href="#LocalityReg.compute_reg_penalty-324"><span class="linenos">324</span></a>            <span class="c1"># glocal</span>
</span><span id="LocalityReg.compute_reg_penalty-325"><a href="#LocalityReg.compute_reg_penalty-325"><span class="linenos">325</span></a>            <span class="c1">#w = weights.reshape(self.input_dims + [-1])**2 #[C, NX, NY, num_lags, num_filters]</span>
</span><span id="LocalityReg.compute_reg_penalty-326"><a href="#LocalityReg.compute_reg_penalty-326"><span class="linenos">326</span></a>
</span><span id="LocalityReg.compute_reg_penalty-327"><a href="#LocalityReg.compute_reg_penalty-327"><span class="linenos">327</span></a>            <span class="n">penx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,xw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localx_pen</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-328"><a href="#LocalityReg.compute_reg_penalty-328"><span class="linenos">328</span></a>            <span class="n">penx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;xn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">penx</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-329"><a href="#LocalityReg.compute_reg_penalty-329"><span class="linenos">329</span></a>
</span><span id="LocalityReg.compute_reg_penalty-330"><a href="#LocalityReg.compute_reg_penalty-330"><span class="linenos">330</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-331"><a href="#LocalityReg.compute_reg_penalty-331"><span class="linenos">331</span></a>                <span class="n">rpen</span> <span class="o">=</span> <span class="n">penx</span>
</span><span id="LocalityReg.compute_reg_penalty-332"><a href="#LocalityReg.compute_reg_penalty-332"><span class="linenos">332</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-333"><a href="#LocalityReg.compute_reg_penalty-333"><span class="linenos">333</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">same_dims</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-334"><a href="#LocalityReg.compute_reg_penalty-334"><span class="linenos">334</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,yw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localx_pen</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-335"><a href="#LocalityReg.compute_reg_penalty-335"><span class="linenos">335</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">peny</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-336"><a href="#LocalityReg.compute_reg_penalty-336"><span class="linenos">336</span></a>                <span class="k">else</span><span class="p">:</span>    
</span><span id="LocalityReg.compute_reg_penalty-337"><a href="#LocalityReg.compute_reg_penalty-337"><span class="linenos">337</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,yw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localy_pen</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-338"><a href="#LocalityReg.compute_reg_penalty-338"><span class="linenos">338</span></a>                    <span class="n">peny</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;yn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">peny</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-339"><a href="#LocalityReg.compute_reg_penalty-339"><span class="linenos">339</span></a>
</span><span id="LocalityReg.compute_reg_penalty-340"><a href="#LocalityReg.compute_reg_penalty-340"><span class="linenos">340</span></a>                <span class="n">rpen</span> <span class="o">=</span> <span class="n">penx</span> <span class="o">+</span> <span class="n">peny</span>
</span><span id="LocalityReg.compute_reg_penalty-341"><a href="#LocalityReg.compute_reg_penalty-341"><span class="linenos">341</span></a>        
</span><span id="LocalityReg.compute_reg_penalty-342"><a href="#LocalityReg.compute_reg_penalty-342"><span class="linenos">342</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;localt&#39;</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-343"><a href="#LocalityReg.compute_reg_penalty-343"><span class="linenos">343</span></a>            
</span><span id="LocalityReg.compute_reg_penalty-344"><a href="#LocalityReg.compute_reg_penalty-344"><span class="linenos">344</span></a>            <span class="c1"># glocal on time</span>
</span><span id="LocalityReg.compute_reg_penalty-345"><a href="#LocalityReg.compute_reg_penalty-345"><span class="linenos">345</span></a>            <span class="c1">#w = weights.reshape(self.input_dims + [-1])**2</span>
</span><span id="LocalityReg.compute_reg_penalty-346"><a href="#LocalityReg.compute_reg_penalty-346"><span class="linenos">346</span></a>
</span><span id="LocalityReg.compute_reg_penalty-347"><a href="#LocalityReg.compute_reg_penalty-347"><span class="linenos">347</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,tw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localt_pen</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-348"><a href="#LocalityReg.compute_reg_penalty-348"><span class="linenos">348</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">rpen</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-349"><a href="#LocalityReg.compute_reg_penalty-349"><span class="linenos">349</span></a>        
</span><span id="LocalityReg.compute_reg_penalty-350"><a href="#LocalityReg.compute_reg_penalty-350"><span class="linenos">350</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;trd&#39;</span><span class="p">:</span>
</span><span id="LocalityReg.compute_reg_penalty-351"><a href="#LocalityReg.compute_reg_penalty-351"><span class="linenos">351</span></a>            
</span><span id="LocalityReg.compute_reg_penalty-352"><a href="#LocalityReg.compute_reg_penalty-352"><span class="linenos">352</span></a>            <span class="c1"># penalty on time</span>
</span><span id="LocalityReg.compute_reg_penalty-353"><a href="#LocalityReg.compute_reg_penalty-353"><span class="linenos">353</span></a>            <span class="c1">#w = weights.reshape(self.input_dims + [-1])**2</span>
</span><span id="LocalityReg.compute_reg_penalty-354"><a href="#LocalityReg.compute_reg_penalty-354"><span class="linenos">354</span></a>
</span><span id="LocalityReg.compute_reg_penalty-355"><a href="#LocalityReg.compute_reg_penalty-355"><span class="linenos">355</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cxytn,tw-&gt;wn&#39;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trd_pen</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-356"><a href="#LocalityReg.compute_reg_penalty-356"><span class="linenos">356</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tn,cxytn-&gt;n&#39;</span><span class="p">,</span> <span class="n">rpen</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</span><span id="LocalityReg.compute_reg_penalty-357"><a href="#LocalityReg.compute_reg_penalty-357"><span class="linenos">357</span></a>        
</span><span id="LocalityReg.compute_reg_penalty-358"><a href="#LocalityReg.compute_reg_penalty-358"><span class="linenos">358</span></a>        <span class="k">return</span> <span class="n">rpen</span>
</span></pre></div>


            <div class="docstring"><p>Compute regularization penalty for locality</p>
</div>


                            </div>
                            <div id="LocalityReg.build_reg_mats" class="classattr">
                                        <input id="LocalityReg.build_reg_mats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_reg_mats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LocalityReg.build_reg_mats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LocalityReg.build_reg_mats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LocalityReg.build_reg_mats-361"><a href="#LocalityReg.build_reg_mats-361"><span class="linenos">361</span></a>    <span class="k">def</span> <span class="nf">build_reg_mats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LocalityReg.build_reg_mats-362"><a href="#LocalityReg.build_reg_mats-362"><span class="linenos">362</span></a>        
</span><span id="LocalityReg.build_reg_mats-363"><a href="#LocalityReg.build_reg_mats-363"><span class="linenos">363</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocalx&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;localx&#39;</span><span class="p">:</span>
</span><span id="LocalityReg.build_reg_mats-364"><a href="#LocalityReg.build_reg_mats-364"><span class="linenos">364</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;localx_pen&#39;</span><span class="p">,((</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="LocalityReg.build_reg_mats-365"><a href="#LocalityReg.build_reg_mats-365"><span class="linenos">365</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
</span><span id="LocalityReg.build_reg_mats-366"><a href="#LocalityReg.build_reg_mats-366"><span class="linenos">366</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">same_dims</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LocalityReg.build_reg_mats-367"><a href="#LocalityReg.build_reg_mats-367"><span class="linenos">367</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LocalityReg.build_reg_mats-368"><a href="#LocalityReg.build_reg_mats-368"><span class="linenos">368</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">same_dims</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LocalityReg.build_reg_mats-369"><a href="#LocalityReg.build_reg_mats-369"><span class="linenos">369</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;localy_pen&#39;</span><span class="p">,((</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="LocalityReg.build_reg_mats-370"><a href="#LocalityReg.build_reg_mats-370"><span class="linenos">370</span></a>
</span><span id="LocalityReg.build_reg_mats-371"><a href="#LocalityReg.build_reg_mats-371"><span class="linenos">371</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocalt&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;localt&#39;</span><span class="p">:</span>
</span><span id="LocalityReg.build_reg_mats-372"><a href="#LocalityReg.build_reg_mats-372"><span class="linenos">372</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;localt_pen&#39;</span><span class="p">,((</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="LocalityReg.build_reg_mats-373"><a href="#LocalityReg.build_reg_mats-373"><span class="linenos">373</span></a>        
</span><span id="LocalityReg.build_reg_mats-374"><a href="#LocalityReg.build_reg_mats-374"><span class="linenos">374</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;trd&#39;</span><span class="p">:</span>
</span><span id="LocalityReg.build_reg_mats-375"><a href="#LocalityReg.build_reg_mats-375"><span class="linenos">375</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;trd_pen&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#RegModule">RegModule</a></dt>
                                <dd id="LocalityReg.reg_type" class="variable"><a href="#RegModule.reg_type">reg_type</a></dd>
                <dd id="LocalityReg.unit_reg" class="variable"><a href="#RegModule.unit_reg">unit_reg</a></dd>
                <dd id="LocalityReg.input_dims" class="variable"><a href="#RegModule.input_dims">input_dims</a></dd>
                <dd id="LocalityReg.num_dims" class="variable"><a href="#RegModule.num_dims">num_dims</a></dd>
                <dd id="LocalityReg.folded_lags" class="variable"><a href="#RegModule.folded_lags">folded_lags</a></dd>
                <dd id="LocalityReg.pos_constraint" class="variable"><a href="#RegModule.pos_constraint">pos_constraint</a></dd>
                <dd id="LocalityReg.forward" class="function"><a href="#RegModule.forward">forward</a></dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="LocalityReg.dump_patches" class="variable">dump_patches</dd>
                <dd id="LocalityReg.training" class="variable">training</dd>
                <dd id="LocalityReg.call_super_init" class="variable">call_super_init</dd>
                <dd id="LocalityReg.register_buffer" class="function">register_buffer</dd>
                <dd id="LocalityReg.register_parameter" class="function">register_parameter</dd>
                <dd id="LocalityReg.add_module" class="function">add_module</dd>
                <dd id="LocalityReg.register_module" class="function">register_module</dd>
                <dd id="LocalityReg.get_submodule" class="function">get_submodule</dd>
                <dd id="LocalityReg.get_parameter" class="function">get_parameter</dd>
                <dd id="LocalityReg.get_buffer" class="function">get_buffer</dd>
                <dd id="LocalityReg.get_extra_state" class="function">get_extra_state</dd>
                <dd id="LocalityReg.set_extra_state" class="function">set_extra_state</dd>
                <dd id="LocalityReg.apply" class="function">apply</dd>
                <dd id="LocalityReg.cuda" class="function">cuda</dd>
                <dd id="LocalityReg.ipu" class="function">ipu</dd>
                <dd id="LocalityReg.xpu" class="function">xpu</dd>
                <dd id="LocalityReg.cpu" class="function">cpu</dd>
                <dd id="LocalityReg.type" class="function">type</dd>
                <dd id="LocalityReg.float" class="function">float</dd>
                <dd id="LocalityReg.double" class="function">double</dd>
                <dd id="LocalityReg.half" class="function">half</dd>
                <dd id="LocalityReg.bfloat16" class="function">bfloat16</dd>
                <dd id="LocalityReg.to_empty" class="function">to_empty</dd>
                <dd id="LocalityReg.to" class="function">to</dd>
                <dd id="LocalityReg.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="LocalityReg.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="LocalityReg.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="LocalityReg.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="LocalityReg.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="LocalityReg.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="LocalityReg.state_dict" class="function">state_dict</dd>
                <dd id="LocalityReg.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="LocalityReg.load_state_dict" class="function">load_state_dict</dd>
                <dd id="LocalityReg.parameters" class="function">parameters</dd>
                <dd id="LocalityReg.named_parameters" class="function">named_parameters</dd>
                <dd id="LocalityReg.buffers" class="function">buffers</dd>
                <dd id="LocalityReg.named_buffers" class="function">named_buffers</dd>
                <dd id="LocalityReg.children" class="function">children</dd>
                <dd id="LocalityReg.named_children" class="function">named_children</dd>
                <dd id="LocalityReg.modules" class="function">modules</dd>
                <dd id="LocalityReg.named_modules" class="function">named_modules</dd>
                <dd id="LocalityReg.train" class="function">train</dd>
                <dd id="LocalityReg.eval" class="function">eval</dd>
                <dd id="LocalityReg.requires_grad_" class="function">requires_grad_</dd>
                <dd id="LocalityReg.zero_grad" class="function">zero_grad</dd>
                <dd id="LocalityReg.share_memory" class="function">share_memory</dd>
                <dd id="LocalityReg.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="DiagonalReg">
                            <input id="DiagonalReg-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DiagonalReg</span><wbr>(<span class="base"><a href="#RegModule">RegModule</a></span>):

                <label class="view-source-button" for="DiagonalReg-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DiagonalReg"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DiagonalReg-377"><a href="#DiagonalReg-377"><span class="linenos">377</span></a><span class="k">class</span> <span class="nc">DiagonalReg</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="DiagonalReg-378"><a href="#DiagonalReg-378"><span class="linenos">378</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Regularization module for diagonal penalties&quot;&quot;&quot;</span>
</span><span id="DiagonalReg-379"><a href="#DiagonalReg-379"><span class="linenos">379</span></a>
</span><span id="DiagonalReg-380"><a href="#DiagonalReg-380"><span class="linenos">380</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="DiagonalReg-381"><a href="#DiagonalReg-381"><span class="linenos">381</span></a>
</span><span id="DiagonalReg-382"><a href="#DiagonalReg-382"><span class="linenos">382</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_t&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_t0&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_x&#39;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid Diagonal Regularization type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="DiagonalReg-383"><a href="#DiagonalReg-383"><span class="linenos">383</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="DiagonalReg-384"><a href="#DiagonalReg-384"><span class="linenos">384</span></a>
</span><span id="DiagonalReg-385"><a href="#DiagonalReg-385"><span class="linenos">385</span></a>        <span class="c1"># the &quot;input_dims&quot; are ordered differently for matrix implementations,</span>
</span><span id="DiagonalReg-386"><a href="#DiagonalReg-386"><span class="linenos">386</span></a>        <span class="c1"># so this is a temporary fix to be able to use old functions</span>
</span><span id="DiagonalReg-387"><a href="#DiagonalReg-387"><span class="linenos">387</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="n">input_dims</span>
</span><span id="DiagonalReg-388"><a href="#DiagonalReg-388"><span class="linenos">388</span></a>
</span><span id="DiagonalReg-389"><a href="#DiagonalReg-389"><span class="linenos">389</span></a>        <span class="n">reg_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_reg_mats</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="DiagonalReg-390"><a href="#DiagonalReg-390"><span class="linenos">390</span></a>    
</span><span id="DiagonalReg-391"><a href="#DiagonalReg-391"><span class="linenos">391</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="DiagonalReg-392"><a href="#DiagonalReg-392"><span class="linenos">392</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute regularization loss&quot;&quot;&quot;</span>
</span><span id="DiagonalReg-393"><a href="#DiagonalReg-393"><span class="linenos">393</span></a>
</span><span id="DiagonalReg-394"><a href="#DiagonalReg-394"><span class="linenos">394</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">:</span>
</span><span id="DiagonalReg-395"><a href="#DiagonalReg-395"><span class="linenos">395</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#[C, NX, NY, num_lags, num_filters]</span>
</span><span id="DiagonalReg-396"><a href="#DiagonalReg-396"><span class="linenos">396</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DiagonalReg-397"><a href="#DiagonalReg-397"><span class="linenos">397</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="c1">#[C, NX, NY, num_lags, num_filters]</span>
</span><span id="DiagonalReg-398"><a href="#DiagonalReg-398"><span class="linenos">398</span></a>
</span><span id="DiagonalReg-399"><a href="#DiagonalReg-399"><span class="linenos">399</span></a>        <span class="c1"># Collapse weights across non-spatial dimensions</span>
</span><span id="DiagonalReg-400"><a href="#DiagonalReg-400"><span class="linenos">400</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;center&#39;</span><span class="p">:</span>
</span><span id="DiagonalReg-401"><a href="#DiagonalReg-401"><span class="linenos">401</span></a>            <span class="n">wcollapse</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="DiagonalReg-402"><a href="#DiagonalReg-402"><span class="linenos">402</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">wcollapse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regcost</span><span class="p">)</span> <span class="p">)</span>
</span><span id="DiagonalReg-403"><a href="#DiagonalReg-403"><span class="linenos">403</span></a>
</span><span id="DiagonalReg-404"><a href="#DiagonalReg-404"><span class="linenos">404</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;edge_t&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_t0&#39;</span><span class="p">]:</span>
</span><span id="DiagonalReg-405"><a href="#DiagonalReg-405"><span class="linenos">405</span></a>            <span class="n">wcollapse</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="DiagonalReg-406"><a href="#DiagonalReg-406"><span class="linenos">406</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">wcollapse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regcost</span><span class="p">)</span> <span class="p">)</span>
</span><span id="DiagonalReg-407"><a href="#DiagonalReg-407"><span class="linenos">407</span></a>
</span><span id="DiagonalReg-408"><a href="#DiagonalReg-408"><span class="linenos">408</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;edge_x&#39;</span><span class="p">:</span>
</span><span id="DiagonalReg-409"><a href="#DiagonalReg-409"><span class="linenos">409</span></a>            <span class="n">wcollapse</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="DiagonalReg-410"><a href="#DiagonalReg-410"><span class="linenos">410</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">wcollapse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regcost_x</span><span class="p">)</span> <span class="p">)</span>
</span><span id="DiagonalReg-411"><a href="#DiagonalReg-411"><span class="linenos">411</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="DiagonalReg-412"><a href="#DiagonalReg-412"><span class="linenos">412</span></a>                <span class="n">wcollapse</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="DiagonalReg-413"><a href="#DiagonalReg-413"><span class="linenos">413</span></a>                <span class="n">rpen</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">wcollapse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regcost_y</span><span class="p">)</span> <span class="p">)</span>
</span><span id="DiagonalReg-414"><a href="#DiagonalReg-414"><span class="linenos">414</span></a>
</span><span id="DiagonalReg-415"><a href="#DiagonalReg-415"><span class="linenos">415</span></a>        <span class="k">return</span> <span class="n">rpen</span>
</span><span id="DiagonalReg-416"><a href="#DiagonalReg-416"><span class="linenos">416</span></a>    
</span><span id="DiagonalReg-417"><a href="#DiagonalReg-417"><span class="linenos">417</span></a>    <span class="k">def</span> <span class="nf">build_reg_mats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">):</span>
</span><span id="DiagonalReg-418"><a href="#DiagonalReg-418"><span class="linenos">418</span></a>    
</span><span id="DiagonalReg-419"><a href="#DiagonalReg-419"><span class="linenos">419</span></a>        <span class="n">NX</span><span class="p">,</span> <span class="n">NY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="DiagonalReg-420"><a href="#DiagonalReg-420"><span class="linenos">420</span></a>
</span><span id="DiagonalReg-421"><a href="#DiagonalReg-421"><span class="linenos">421</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;center&#39;</span><span class="p">:</span>
</span><span id="DiagonalReg-422"><a href="#DiagonalReg-422"><span class="linenos">422</span></a>
</span><span id="DiagonalReg-423"><a href="#DiagonalReg-423"><span class="linenos">423</span></a>            <span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">NX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="DiagonalReg-424"><a href="#DiagonalReg-424"><span class="linenos">424</span></a>            <span class="n">px</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NX</span><span class="p">)</span><span class="o">-</span><span class="n">center_x</span><span class="p">)</span><span class="o">/</span><span class="n">center_x</span>
</span><span id="DiagonalReg-425"><a href="#DiagonalReg-425"><span class="linenos">425</span></a>
</span><span id="DiagonalReg-426"><a href="#DiagonalReg-426"><span class="linenos">426</span></a>            <span class="k">if</span> <span class="n">NY</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># then 1-d space</span>
</span><span id="DiagonalReg-427"><a href="#DiagonalReg-427"><span class="linenos">427</span></a>                <span class="n">rmat</span> <span class="o">=</span> <span class="n">px</span><span class="o">**</span><span class="mi">2</span>
</span><span id="DiagonalReg-428"><a href="#DiagonalReg-428"><span class="linenos">428</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DiagonalReg-429"><a href="#DiagonalReg-429"><span class="linenos">429</span></a>                <span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">NY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="DiagonalReg-430"><a href="#DiagonalReg-430"><span class="linenos">430</span></a>                <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NY</span><span class="p">)</span><span class="o">-</span><span class="n">center_y</span><span class="p">)</span><span class="o">/</span><span class="n">center_y</span>
</span><span id="DiagonalReg-431"><a href="#DiagonalReg-431"><span class="linenos">431</span></a>
</span><span id="DiagonalReg-432"><a href="#DiagonalReg-432"><span class="linenos">432</span></a>                <span class="c1"># Make a matrix and then reshape</span>
</span><span id="DiagonalReg-433"><a href="#DiagonalReg-433"><span class="linenos">433</span></a>                <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">px</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="n">NY</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NX</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">@</span> <span class="n">py</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="DiagonalReg-434"><a href="#DiagonalReg-434"><span class="linenos">434</span></a>
</span><span id="DiagonalReg-435"><a href="#DiagonalReg-435"><span class="linenos">435</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat</span><span class="p">))</span>
</span><span id="DiagonalReg-436"><a href="#DiagonalReg-436"><span class="linenos">436</span></a>
</span><span id="DiagonalReg-437"><a href="#DiagonalReg-437"><span class="linenos">437</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;edge_t&#39;</span><span class="p">:</span>
</span><span id="DiagonalReg-438"><a href="#DiagonalReg-438"><span class="linenos">438</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="DiagonalReg-439"><a href="#DiagonalReg-439"><span class="linenos">439</span></a>            <span class="n">rmat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg-440"><a href="#DiagonalReg-440"><span class="linenos">440</span></a>            <span class="n">rmat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg-441"><a href="#DiagonalReg-441"><span class="linenos">441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat</span><span class="p">))</span>
</span><span id="DiagonalReg-442"><a href="#DiagonalReg-442"><span class="linenos">442</span></a>
</span><span id="DiagonalReg-443"><a href="#DiagonalReg-443"><span class="linenos">443</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;edge_t0&#39;</span><span class="p">:</span>
</span><span id="DiagonalReg-444"><a href="#DiagonalReg-444"><span class="linenos">444</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="DiagonalReg-445"><a href="#DiagonalReg-445"><span class="linenos">445</span></a>            <span class="n">rmat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg-446"><a href="#DiagonalReg-446"><span class="linenos">446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat</span><span class="p">))</span>
</span><span id="DiagonalReg-447"><a href="#DiagonalReg-447"><span class="linenos">447</span></a>
</span><span id="DiagonalReg-448"><a href="#DiagonalReg-448"><span class="linenos">448</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;edge_x&#39;</span><span class="p">:</span>
</span><span id="DiagonalReg-449"><a href="#DiagonalReg-449"><span class="linenos">449</span></a>            <span class="n">rmat_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="DiagonalReg-450"><a href="#DiagonalReg-450"><span class="linenos">450</span></a>            <span class="n">rmat_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg-451"><a href="#DiagonalReg-451"><span class="linenos">451</span></a>            <span class="n">rmat_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg-452"><a href="#DiagonalReg-452"><span class="linenos">452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost_x&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat_x</span><span class="p">))</span>
</span><span id="DiagonalReg-453"><a href="#DiagonalReg-453"><span class="linenos">453</span></a>            <span class="n">rmat_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="DiagonalReg-454"><a href="#DiagonalReg-454"><span class="linenos">454</span></a>            <span class="n">rmat_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg-455"><a href="#DiagonalReg-455"><span class="linenos">455</span></a>            <span class="n">rmat_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg-456"><a href="#DiagonalReg-456"><span class="linenos">456</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost_y&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat_y</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Regularization module for diagonal penalties</p>
</div>


                            <div id="DiagonalReg.__init__" class="classattr">
                                        <input id="DiagonalReg.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DiagonalReg</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="DiagonalReg.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DiagonalReg.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DiagonalReg.__init__-380"><a href="#DiagonalReg.__init__-380"><span class="linenos">380</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="DiagonalReg.__init__-381"><a href="#DiagonalReg.__init__-381"><span class="linenos">381</span></a>
</span><span id="DiagonalReg.__init__-382"><a href="#DiagonalReg.__init__-382"><span class="linenos">382</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_t&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_t0&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_x&#39;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid Diagonal Regularization type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="DiagonalReg.__init__-383"><a href="#DiagonalReg.__init__-383"><span class="linenos">383</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="DiagonalReg.__init__-384"><a href="#DiagonalReg.__init__-384"><span class="linenos">384</span></a>
</span><span id="DiagonalReg.__init__-385"><a href="#DiagonalReg.__init__-385"><span class="linenos">385</span></a>        <span class="c1"># the &quot;input_dims&quot; are ordered differently for matrix implementations,</span>
</span><span id="DiagonalReg.__init__-386"><a href="#DiagonalReg.__init__-386"><span class="linenos">386</span></a>        <span class="c1"># so this is a temporary fix to be able to use old functions</span>
</span><span id="DiagonalReg.__init__-387"><a href="#DiagonalReg.__init__-387"><span class="linenos">387</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="n">input_dims</span>
</span><span id="DiagonalReg.__init__-388"><a href="#DiagonalReg.__init__-388"><span class="linenos">388</span></a>
</span><span id="DiagonalReg.__init__-389"><a href="#DiagonalReg.__init__-389"><span class="linenos">389</span></a>        <span class="n">reg_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_reg_mats</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Constructor for Reg_module class</p>
</div>


                            </div>
                            <div id="DiagonalReg.input_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">input_dims</span>

        
    </div>
    <a class="headerlink" href="#DiagonalReg.input_dims"></a>
    
    

                            </div>
                            <div id="DiagonalReg.compute_reg_penalty" class="classattr">
                                        <input id="DiagonalReg.compute_reg_penalty-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_reg_penalty</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">weights</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DiagonalReg.compute_reg_penalty-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DiagonalReg.compute_reg_penalty"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DiagonalReg.compute_reg_penalty-391"><a href="#DiagonalReg.compute_reg_penalty-391"><span class="linenos">391</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="DiagonalReg.compute_reg_penalty-392"><a href="#DiagonalReg.compute_reg_penalty-392"><span class="linenos">392</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute regularization loss&quot;&quot;&quot;</span>
</span><span id="DiagonalReg.compute_reg_penalty-393"><a href="#DiagonalReg.compute_reg_penalty-393"><span class="linenos">393</span></a>
</span><span id="DiagonalReg.compute_reg_penalty-394"><a href="#DiagonalReg.compute_reg_penalty-394"><span class="linenos">394</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_constraint</span><span class="p">:</span>
</span><span id="DiagonalReg.compute_reg_penalty-395"><a href="#DiagonalReg.compute_reg_penalty-395"><span class="linenos">395</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#[C, NX, NY, num_lags, num_filters]</span>
</span><span id="DiagonalReg.compute_reg_penalty-396"><a href="#DiagonalReg.compute_reg_penalty-396"><span class="linenos">396</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DiagonalReg.compute_reg_penalty-397"><a href="#DiagonalReg.compute_reg_penalty-397"><span class="linenos">397</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="c1">#[C, NX, NY, num_lags, num_filters]</span>
</span><span id="DiagonalReg.compute_reg_penalty-398"><a href="#DiagonalReg.compute_reg_penalty-398"><span class="linenos">398</span></a>
</span><span id="DiagonalReg.compute_reg_penalty-399"><a href="#DiagonalReg.compute_reg_penalty-399"><span class="linenos">399</span></a>        <span class="c1"># Collapse weights across non-spatial dimensions</span>
</span><span id="DiagonalReg.compute_reg_penalty-400"><a href="#DiagonalReg.compute_reg_penalty-400"><span class="linenos">400</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;center&#39;</span><span class="p">:</span>
</span><span id="DiagonalReg.compute_reg_penalty-401"><a href="#DiagonalReg.compute_reg_penalty-401"><span class="linenos">401</span></a>            <span class="n">wcollapse</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="DiagonalReg.compute_reg_penalty-402"><a href="#DiagonalReg.compute_reg_penalty-402"><span class="linenos">402</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">wcollapse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regcost</span><span class="p">)</span> <span class="p">)</span>
</span><span id="DiagonalReg.compute_reg_penalty-403"><a href="#DiagonalReg.compute_reg_penalty-403"><span class="linenos">403</span></a>
</span><span id="DiagonalReg.compute_reg_penalty-404"><a href="#DiagonalReg.compute_reg_penalty-404"><span class="linenos">404</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;edge_t&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_t0&#39;</span><span class="p">]:</span>
</span><span id="DiagonalReg.compute_reg_penalty-405"><a href="#DiagonalReg.compute_reg_penalty-405"><span class="linenos">405</span></a>            <span class="n">wcollapse</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="DiagonalReg.compute_reg_penalty-406"><a href="#DiagonalReg.compute_reg_penalty-406"><span class="linenos">406</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">wcollapse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regcost</span><span class="p">)</span> <span class="p">)</span>
</span><span id="DiagonalReg.compute_reg_penalty-407"><a href="#DiagonalReg.compute_reg_penalty-407"><span class="linenos">407</span></a>
</span><span id="DiagonalReg.compute_reg_penalty-408"><a href="#DiagonalReg.compute_reg_penalty-408"><span class="linenos">408</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;edge_x&#39;</span><span class="p">:</span>
</span><span id="DiagonalReg.compute_reg_penalty-409"><a href="#DiagonalReg.compute_reg_penalty-409"><span class="linenos">409</span></a>            <span class="n">wcollapse</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="DiagonalReg.compute_reg_penalty-410"><a href="#DiagonalReg.compute_reg_penalty-410"><span class="linenos">410</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">wcollapse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regcost_x</span><span class="p">)</span> <span class="p">)</span>
</span><span id="DiagonalReg.compute_reg_penalty-411"><a href="#DiagonalReg.compute_reg_penalty-411"><span class="linenos">411</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="DiagonalReg.compute_reg_penalty-412"><a href="#DiagonalReg.compute_reg_penalty-412"><span class="linenos">412</span></a>                <span class="n">wcollapse</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="DiagonalReg.compute_reg_penalty-413"><a href="#DiagonalReg.compute_reg_penalty-413"><span class="linenos">413</span></a>                <span class="n">rpen</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">wcollapse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regcost_y</span><span class="p">)</span> <span class="p">)</span>
</span><span id="DiagonalReg.compute_reg_penalty-414"><a href="#DiagonalReg.compute_reg_penalty-414"><span class="linenos">414</span></a>
</span><span id="DiagonalReg.compute_reg_penalty-415"><a href="#DiagonalReg.compute_reg_penalty-415"><span class="linenos">415</span></a>        <span class="k">return</span> <span class="n">rpen</span>
</span></pre></div>


            <div class="docstring"><p>Compute regularization loss</p>
</div>


                            </div>
                            <div id="DiagonalReg.build_reg_mats" class="classattr">
                                        <input id="DiagonalReg.build_reg_mats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_reg_mats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">reg_type</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DiagonalReg.build_reg_mats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DiagonalReg.build_reg_mats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DiagonalReg.build_reg_mats-417"><a href="#DiagonalReg.build_reg_mats-417"><span class="linenos">417</span></a>    <span class="k">def</span> <span class="nf">build_reg_mats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">):</span>
</span><span id="DiagonalReg.build_reg_mats-418"><a href="#DiagonalReg.build_reg_mats-418"><span class="linenos">418</span></a>    
</span><span id="DiagonalReg.build_reg_mats-419"><a href="#DiagonalReg.build_reg_mats-419"><span class="linenos">419</span></a>        <span class="n">NX</span><span class="p">,</span> <span class="n">NY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="DiagonalReg.build_reg_mats-420"><a href="#DiagonalReg.build_reg_mats-420"><span class="linenos">420</span></a>
</span><span id="DiagonalReg.build_reg_mats-421"><a href="#DiagonalReg.build_reg_mats-421"><span class="linenos">421</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;center&#39;</span><span class="p">:</span>
</span><span id="DiagonalReg.build_reg_mats-422"><a href="#DiagonalReg.build_reg_mats-422"><span class="linenos">422</span></a>
</span><span id="DiagonalReg.build_reg_mats-423"><a href="#DiagonalReg.build_reg_mats-423"><span class="linenos">423</span></a>            <span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">NX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="DiagonalReg.build_reg_mats-424"><a href="#DiagonalReg.build_reg_mats-424"><span class="linenos">424</span></a>            <span class="n">px</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NX</span><span class="p">)</span><span class="o">-</span><span class="n">center_x</span><span class="p">)</span><span class="o">/</span><span class="n">center_x</span>
</span><span id="DiagonalReg.build_reg_mats-425"><a href="#DiagonalReg.build_reg_mats-425"><span class="linenos">425</span></a>
</span><span id="DiagonalReg.build_reg_mats-426"><a href="#DiagonalReg.build_reg_mats-426"><span class="linenos">426</span></a>            <span class="k">if</span> <span class="n">NY</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># then 1-d space</span>
</span><span id="DiagonalReg.build_reg_mats-427"><a href="#DiagonalReg.build_reg_mats-427"><span class="linenos">427</span></a>                <span class="n">rmat</span> <span class="o">=</span> <span class="n">px</span><span class="o">**</span><span class="mi">2</span>
</span><span id="DiagonalReg.build_reg_mats-428"><a href="#DiagonalReg.build_reg_mats-428"><span class="linenos">428</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DiagonalReg.build_reg_mats-429"><a href="#DiagonalReg.build_reg_mats-429"><span class="linenos">429</span></a>                <span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">NY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="DiagonalReg.build_reg_mats-430"><a href="#DiagonalReg.build_reg_mats-430"><span class="linenos">430</span></a>                <span class="n">py</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">NY</span><span class="p">)</span><span class="o">-</span><span class="n">center_y</span><span class="p">)</span><span class="o">/</span><span class="n">center_y</span>
</span><span id="DiagonalReg.build_reg_mats-431"><a href="#DiagonalReg.build_reg_mats-431"><span class="linenos">431</span></a>
</span><span id="DiagonalReg.build_reg_mats-432"><a href="#DiagonalReg.build_reg_mats-432"><span class="linenos">432</span></a>                <span class="c1"># Make a matrix and then reshape</span>
</span><span id="DiagonalReg.build_reg_mats-433"><a href="#DiagonalReg.build_reg_mats-433"><span class="linenos">433</span></a>                <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">px</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="n">NY</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NX</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">@</span> <span class="n">py</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="DiagonalReg.build_reg_mats-434"><a href="#DiagonalReg.build_reg_mats-434"><span class="linenos">434</span></a>
</span><span id="DiagonalReg.build_reg_mats-435"><a href="#DiagonalReg.build_reg_mats-435"><span class="linenos">435</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat</span><span class="p">))</span>
</span><span id="DiagonalReg.build_reg_mats-436"><a href="#DiagonalReg.build_reg_mats-436"><span class="linenos">436</span></a>
</span><span id="DiagonalReg.build_reg_mats-437"><a href="#DiagonalReg.build_reg_mats-437"><span class="linenos">437</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;edge_t&#39;</span><span class="p">:</span>
</span><span id="DiagonalReg.build_reg_mats-438"><a href="#DiagonalReg.build_reg_mats-438"><span class="linenos">438</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="DiagonalReg.build_reg_mats-439"><a href="#DiagonalReg.build_reg_mats-439"><span class="linenos">439</span></a>            <span class="n">rmat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg.build_reg_mats-440"><a href="#DiagonalReg.build_reg_mats-440"><span class="linenos">440</span></a>            <span class="n">rmat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg.build_reg_mats-441"><a href="#DiagonalReg.build_reg_mats-441"><span class="linenos">441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat</span><span class="p">))</span>
</span><span id="DiagonalReg.build_reg_mats-442"><a href="#DiagonalReg.build_reg_mats-442"><span class="linenos">442</span></a>
</span><span id="DiagonalReg.build_reg_mats-443"><a href="#DiagonalReg.build_reg_mats-443"><span class="linenos">443</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;edge_t0&#39;</span><span class="p">:</span>
</span><span id="DiagonalReg.build_reg_mats-444"><a href="#DiagonalReg.build_reg_mats-444"><span class="linenos">444</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="DiagonalReg.build_reg_mats-445"><a href="#DiagonalReg.build_reg_mats-445"><span class="linenos">445</span></a>            <span class="n">rmat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg.build_reg_mats-446"><a href="#DiagonalReg.build_reg_mats-446"><span class="linenos">446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat</span><span class="p">))</span>
</span><span id="DiagonalReg.build_reg_mats-447"><a href="#DiagonalReg.build_reg_mats-447"><span class="linenos">447</span></a>
</span><span id="DiagonalReg.build_reg_mats-448"><a href="#DiagonalReg.build_reg_mats-448"><span class="linenos">448</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;edge_x&#39;</span><span class="p">:</span>
</span><span id="DiagonalReg.build_reg_mats-449"><a href="#DiagonalReg.build_reg_mats-449"><span class="linenos">449</span></a>            <span class="n">rmat_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="DiagonalReg.build_reg_mats-450"><a href="#DiagonalReg.build_reg_mats-450"><span class="linenos">450</span></a>            <span class="n">rmat_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg.build_reg_mats-451"><a href="#DiagonalReg.build_reg_mats-451"><span class="linenos">451</span></a>            <span class="n">rmat_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg.build_reg_mats-452"><a href="#DiagonalReg.build_reg_mats-452"><span class="linenos">452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost_x&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat_x</span><span class="p">))</span>
</span><span id="DiagonalReg.build_reg_mats-453"><a href="#DiagonalReg.build_reg_mats-453"><span class="linenos">453</span></a>            <span class="n">rmat_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="DiagonalReg.build_reg_mats-454"><a href="#DiagonalReg.build_reg_mats-454"><span class="linenos">454</span></a>            <span class="n">rmat_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg.build_reg_mats-455"><a href="#DiagonalReg.build_reg_mats-455"><span class="linenos">455</span></a>            <span class="n">rmat_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DiagonalReg.build_reg_mats-456"><a href="#DiagonalReg.build_reg_mats-456"><span class="linenos">456</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;regcost_y&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">rmat_y</span><span class="p">))</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#RegModule">RegModule</a></dt>
                                <dd id="DiagonalReg.reg_type" class="variable"><a href="#RegModule.reg_type">reg_type</a></dd>
                <dd id="DiagonalReg.unit_reg" class="variable"><a href="#RegModule.unit_reg">unit_reg</a></dd>
                <dd id="DiagonalReg.num_dims" class="variable"><a href="#RegModule.num_dims">num_dims</a></dd>
                <dd id="DiagonalReg.folded_lags" class="variable"><a href="#RegModule.folded_lags">folded_lags</a></dd>
                <dd id="DiagonalReg.pos_constraint" class="variable"><a href="#RegModule.pos_constraint">pos_constraint</a></dd>
                <dd id="DiagonalReg.forward" class="function"><a href="#RegModule.forward">forward</a></dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="DiagonalReg.dump_patches" class="variable">dump_patches</dd>
                <dd id="DiagonalReg.training" class="variable">training</dd>
                <dd id="DiagonalReg.call_super_init" class="variable">call_super_init</dd>
                <dd id="DiagonalReg.register_buffer" class="function">register_buffer</dd>
                <dd id="DiagonalReg.register_parameter" class="function">register_parameter</dd>
                <dd id="DiagonalReg.add_module" class="function">add_module</dd>
                <dd id="DiagonalReg.register_module" class="function">register_module</dd>
                <dd id="DiagonalReg.get_submodule" class="function">get_submodule</dd>
                <dd id="DiagonalReg.get_parameter" class="function">get_parameter</dd>
                <dd id="DiagonalReg.get_buffer" class="function">get_buffer</dd>
                <dd id="DiagonalReg.get_extra_state" class="function">get_extra_state</dd>
                <dd id="DiagonalReg.set_extra_state" class="function">set_extra_state</dd>
                <dd id="DiagonalReg.apply" class="function">apply</dd>
                <dd id="DiagonalReg.cuda" class="function">cuda</dd>
                <dd id="DiagonalReg.ipu" class="function">ipu</dd>
                <dd id="DiagonalReg.xpu" class="function">xpu</dd>
                <dd id="DiagonalReg.cpu" class="function">cpu</dd>
                <dd id="DiagonalReg.type" class="function">type</dd>
                <dd id="DiagonalReg.float" class="function">float</dd>
                <dd id="DiagonalReg.double" class="function">double</dd>
                <dd id="DiagonalReg.half" class="function">half</dd>
                <dd id="DiagonalReg.bfloat16" class="function">bfloat16</dd>
                <dd id="DiagonalReg.to_empty" class="function">to_empty</dd>
                <dd id="DiagonalReg.to" class="function">to</dd>
                <dd id="DiagonalReg.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="DiagonalReg.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="DiagonalReg.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="DiagonalReg.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="DiagonalReg.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="DiagonalReg.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="DiagonalReg.state_dict" class="function">state_dict</dd>
                <dd id="DiagonalReg.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="DiagonalReg.load_state_dict" class="function">load_state_dict</dd>
                <dd id="DiagonalReg.parameters" class="function">parameters</dd>
                <dd id="DiagonalReg.named_parameters" class="function">named_parameters</dd>
                <dd id="DiagonalReg.buffers" class="function">buffers</dd>
                <dd id="DiagonalReg.named_buffers" class="function">named_buffers</dd>
                <dd id="DiagonalReg.children" class="function">children</dd>
                <dd id="DiagonalReg.named_children" class="function">named_children</dd>
                <dd id="DiagonalReg.modules" class="function">modules</dd>
                <dd id="DiagonalReg.named_modules" class="function">named_modules</dd>
                <dd id="DiagonalReg.train" class="function">train</dd>
                <dd id="DiagonalReg.eval" class="function">eval</dd>
                <dd id="DiagonalReg.requires_grad_" class="function">requires_grad_</dd>
                <dd id="DiagonalReg.zero_grad" class="function">zero_grad</dd>
                <dd id="DiagonalReg.share_memory" class="function">share_memory</dd>
                <dd id="DiagonalReg.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="InlineReg">
                            <input id="InlineReg-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">InlineReg</span><wbr>(<span class="base"><a href="#RegModule">RegModule</a></span>):

                <label class="view-source-button" for="InlineReg-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InlineReg"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InlineReg-459"><a href="#InlineReg-459"><span class="linenos">459</span></a><span class="k">class</span> <span class="nc">InlineReg</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="InlineReg-460"><a href="#InlineReg-460"><span class="linenos">460</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Regularization module for inline penalties&quot;&quot;&quot;</span>
</span><span id="InlineReg-461"><a href="#InlineReg-461"><span class="linenos">461</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="InlineReg-462"><a href="#InlineReg-462"><span class="linenos">462</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="s1">&#39;norm2&#39;</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="s1">&#39;orth&#39;</span><span class="p">,</span> <span class="s1">&#39;bi_t&#39;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid Inline Regularization type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="InlineReg-463"><a href="#InlineReg-463"><span class="linenos">463</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="InlineReg-464"><a href="#InlineReg-464"><span class="linenos">464</span></a>
</span><span id="InlineReg-465"><a href="#InlineReg-465"><span class="linenos">465</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="InlineReg-466"><a href="#InlineReg-466"><span class="linenos">466</span></a><span class="w">        </span>
</span><span id="InlineReg-467"><a href="#InlineReg-467"><span class="linenos">467</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate regularization penalty for various reg types&quot;&quot;&quot;</span>
</span><span id="InlineReg-468"><a href="#InlineReg-468"><span class="linenos">468</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;l1&#39;</span><span class="p">:</span>
</span><span id="InlineReg-469"><a href="#InlineReg-469"><span class="linenos">469</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="InlineReg-470"><a href="#InlineReg-470"><span class="linenos">470</span></a>
</span><span id="InlineReg-471"><a href="#InlineReg-471"><span class="linenos">471</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;l2&#39;</span><span class="p">:</span>
</span><span id="InlineReg-472"><a href="#InlineReg-472"><span class="linenos">472</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="InlineReg-473"><a href="#InlineReg-473"><span class="linenos">473</span></a>        
</span><span id="InlineReg-474"><a href="#InlineReg-474"><span class="linenos">474</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;norm2&#39;</span><span class="p">:</span>  <span class="c1"># [custom] convex (I think) soft-normalization regularization</span>
</span><span id="InlineReg-475"><a href="#InlineReg-475"><span class="linenos">475</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="InlineReg-476"><a href="#InlineReg-476"><span class="linenos">476</span></a>        
</span><span id="InlineReg-477"><a href="#InlineReg-477"><span class="linenos">477</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;norm&#39;</span><span class="p">:</span>  <span class="c1"># [custom] convex (I think) soft-normalization regularization</span>
</span><span id="InlineReg-478"><a href="#InlineReg-478"><span class="linenos">478</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="InlineReg-479"><a href="#InlineReg-479"><span class="linenos">479</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>  <span class="c1"># [custom] soft positive regularization</span>
</span><span id="InlineReg-480"><a href="#InlineReg-480"><span class="linenos">480</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="o">-</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="InlineReg-481"><a href="#InlineReg-481"><span class="linenos">481</span></a>
</span><span id="InlineReg-482"><a href="#InlineReg-482"><span class="linenos">482</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span>  <span class="c1"># [custom] soft negative regularization</span>
</span><span id="InlineReg-483"><a href="#InlineReg-483"><span class="linenos">483</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="InlineReg-484"><a href="#InlineReg-484"><span class="linenos">484</span></a>
</span><span id="InlineReg-485"><a href="#InlineReg-485"><span class="linenos">485</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;orth&#39;</span><span class="p">:</span>  <span class="c1"># [custom] orthogonal regularization</span>
</span><span id="InlineReg-486"><a href="#InlineReg-486"><span class="linenos">486</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</span><span id="InlineReg-487"><a href="#InlineReg-487"><span class="linenos">487</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">w</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
</span><span id="InlineReg-488"><a href="#InlineReg-488"><span class="linenos">488</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;bi_t&#39;</span><span class="p">:</span>
</span><span id="InlineReg-489"><a href="#InlineReg-489"><span class="linenos">489</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="InlineReg-490"><a href="#InlineReg-490"><span class="linenos">490</span></a>            <span class="n">n</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="InlineReg-491"><a href="#InlineReg-491"><span class="linenos">491</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</span><span id="InlineReg-492"><a href="#InlineReg-492"><span class="linenos">492</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="InlineReg-493"><a href="#InlineReg-493"><span class="linenos">493</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="InlineReg-494"><a href="#InlineReg-494"><span class="linenos">494</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="InlineReg-495"><a href="#InlineReg-495"><span class="linenos">495</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="InlineReg-496"><a href="#InlineReg-496"><span class="linenos">496</span></a>
</span><span id="InlineReg-497"><a href="#InlineReg-497"><span class="linenos">497</span></a>        <span class="k">return</span> <span class="n">reg_pen</span>
</span></pre></div>


            <div class="docstring"><p>Regularization module for inline penalties</p>
</div>


                            <div id="InlineReg.__init__" class="classattr">
                                        <input id="InlineReg.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">InlineReg</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="InlineReg.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InlineReg.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InlineReg.__init__-461"><a href="#InlineReg.__init__-461"><span class="linenos">461</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="InlineReg.__init__-462"><a href="#InlineReg.__init__-462"><span class="linenos">462</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="s1">&#39;norm2&#39;</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="s1">&#39;orth&#39;</span><span class="p">,</span> <span class="s1">&#39;bi_t&#39;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid Inline Regularization type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="InlineReg.__init__-463"><a href="#InlineReg.__init__-463"><span class="linenos">463</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Constructor for Reg_module class</p>
</div>


                            </div>
                            <div id="InlineReg.compute_reg_penalty" class="classattr">
                                        <input id="InlineReg.compute_reg_penalty-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_reg_penalty</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">weights</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="InlineReg.compute_reg_penalty-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InlineReg.compute_reg_penalty"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InlineReg.compute_reg_penalty-465"><a href="#InlineReg.compute_reg_penalty-465"><span class="linenos">465</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="InlineReg.compute_reg_penalty-466"><a href="#InlineReg.compute_reg_penalty-466"><span class="linenos">466</span></a><span class="w">        </span>
</span><span id="InlineReg.compute_reg_penalty-467"><a href="#InlineReg.compute_reg_penalty-467"><span class="linenos">467</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate regularization penalty for various reg types&quot;&quot;&quot;</span>
</span><span id="InlineReg.compute_reg_penalty-468"><a href="#InlineReg.compute_reg_penalty-468"><span class="linenos">468</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;l1&#39;</span><span class="p">:</span>
</span><span id="InlineReg.compute_reg_penalty-469"><a href="#InlineReg.compute_reg_penalty-469"><span class="linenos">469</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="InlineReg.compute_reg_penalty-470"><a href="#InlineReg.compute_reg_penalty-470"><span class="linenos">470</span></a>
</span><span id="InlineReg.compute_reg_penalty-471"><a href="#InlineReg.compute_reg_penalty-471"><span class="linenos">471</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;l2&#39;</span><span class="p">:</span>
</span><span id="InlineReg.compute_reg_penalty-472"><a href="#InlineReg.compute_reg_penalty-472"><span class="linenos">472</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="InlineReg.compute_reg_penalty-473"><a href="#InlineReg.compute_reg_penalty-473"><span class="linenos">473</span></a>        
</span><span id="InlineReg.compute_reg_penalty-474"><a href="#InlineReg.compute_reg_penalty-474"><span class="linenos">474</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;norm2&#39;</span><span class="p">:</span>  <span class="c1"># [custom] convex (I think) soft-normalization regularization</span>
</span><span id="InlineReg.compute_reg_penalty-475"><a href="#InlineReg.compute_reg_penalty-475"><span class="linenos">475</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="InlineReg.compute_reg_penalty-476"><a href="#InlineReg.compute_reg_penalty-476"><span class="linenos">476</span></a>        
</span><span id="InlineReg.compute_reg_penalty-477"><a href="#InlineReg.compute_reg_penalty-477"><span class="linenos">477</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;norm&#39;</span><span class="p">:</span>  <span class="c1"># [custom] convex (I think) soft-normalization regularization</span>
</span><span id="InlineReg.compute_reg_penalty-478"><a href="#InlineReg.compute_reg_penalty-478"><span class="linenos">478</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="InlineReg.compute_reg_penalty-479"><a href="#InlineReg.compute_reg_penalty-479"><span class="linenos">479</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>  <span class="c1"># [custom] soft positive regularization</span>
</span><span id="InlineReg.compute_reg_penalty-480"><a href="#InlineReg.compute_reg_penalty-480"><span class="linenos">480</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="o">-</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="InlineReg.compute_reg_penalty-481"><a href="#InlineReg.compute_reg_penalty-481"><span class="linenos">481</span></a>
</span><span id="InlineReg.compute_reg_penalty-482"><a href="#InlineReg.compute_reg_penalty-482"><span class="linenos">482</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span>  <span class="c1"># [custom] soft negative regularization</span>
</span><span id="InlineReg.compute_reg_penalty-483"><a href="#InlineReg.compute_reg_penalty-483"><span class="linenos">483</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="InlineReg.compute_reg_penalty-484"><a href="#InlineReg.compute_reg_penalty-484"><span class="linenos">484</span></a>
</span><span id="InlineReg.compute_reg_penalty-485"><a href="#InlineReg.compute_reg_penalty-485"><span class="linenos">485</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;orth&#39;</span><span class="p">:</span>  <span class="c1"># [custom] orthogonal regularization</span>
</span><span id="InlineReg.compute_reg_penalty-486"><a href="#InlineReg.compute_reg_penalty-486"><span class="linenos">486</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</span><span id="InlineReg.compute_reg_penalty-487"><a href="#InlineReg.compute_reg_penalty-487"><span class="linenos">487</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">w</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
</span><span id="InlineReg.compute_reg_penalty-488"><a href="#InlineReg.compute_reg_penalty-488"><span class="linenos">488</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;bi_t&#39;</span><span class="p">:</span>
</span><span id="InlineReg.compute_reg_penalty-489"><a href="#InlineReg.compute_reg_penalty-489"><span class="linenos">489</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="InlineReg.compute_reg_penalty-490"><a href="#InlineReg.compute_reg_penalty-490"><span class="linenos">490</span></a>            <span class="n">n</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="InlineReg.compute_reg_penalty-491"><a href="#InlineReg.compute_reg_penalty-491"><span class="linenos">491</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</span><span id="InlineReg.compute_reg_penalty-492"><a href="#InlineReg.compute_reg_penalty-492"><span class="linenos">492</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="InlineReg.compute_reg_penalty-493"><a href="#InlineReg.compute_reg_penalty-493"><span class="linenos">493</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="InlineReg.compute_reg_penalty-494"><a href="#InlineReg.compute_reg_penalty-494"><span class="linenos">494</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="InlineReg.compute_reg_penalty-495"><a href="#InlineReg.compute_reg_penalty-495"><span class="linenos">495</span></a>            <span class="n">reg_pen</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="InlineReg.compute_reg_penalty-496"><a href="#InlineReg.compute_reg_penalty-496"><span class="linenos">496</span></a>
</span><span id="InlineReg.compute_reg_penalty-497"><a href="#InlineReg.compute_reg_penalty-497"><span class="linenos">497</span></a>        <span class="k">return</span> <span class="n">reg_pen</span>
</span></pre></div>


            <div class="docstring"><p>Calculate regularization penalty for various reg types</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#RegModule">RegModule</a></dt>
                                <dd id="InlineReg.reg_type" class="variable"><a href="#RegModule.reg_type">reg_type</a></dd>
                <dd id="InlineReg.unit_reg" class="variable"><a href="#RegModule.unit_reg">unit_reg</a></dd>
                <dd id="InlineReg.input_dims" class="variable"><a href="#RegModule.input_dims">input_dims</a></dd>
                <dd id="InlineReg.num_dims" class="variable"><a href="#RegModule.num_dims">num_dims</a></dd>
                <dd id="InlineReg.folded_lags" class="variable"><a href="#RegModule.folded_lags">folded_lags</a></dd>
                <dd id="InlineReg.pos_constraint" class="variable"><a href="#RegModule.pos_constraint">pos_constraint</a></dd>
                <dd id="InlineReg.forward" class="function"><a href="#RegModule.forward">forward</a></dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="InlineReg.dump_patches" class="variable">dump_patches</dd>
                <dd id="InlineReg.training" class="variable">training</dd>
                <dd id="InlineReg.call_super_init" class="variable">call_super_init</dd>
                <dd id="InlineReg.register_buffer" class="function">register_buffer</dd>
                <dd id="InlineReg.register_parameter" class="function">register_parameter</dd>
                <dd id="InlineReg.add_module" class="function">add_module</dd>
                <dd id="InlineReg.register_module" class="function">register_module</dd>
                <dd id="InlineReg.get_submodule" class="function">get_submodule</dd>
                <dd id="InlineReg.get_parameter" class="function">get_parameter</dd>
                <dd id="InlineReg.get_buffer" class="function">get_buffer</dd>
                <dd id="InlineReg.get_extra_state" class="function">get_extra_state</dd>
                <dd id="InlineReg.set_extra_state" class="function">set_extra_state</dd>
                <dd id="InlineReg.apply" class="function">apply</dd>
                <dd id="InlineReg.cuda" class="function">cuda</dd>
                <dd id="InlineReg.ipu" class="function">ipu</dd>
                <dd id="InlineReg.xpu" class="function">xpu</dd>
                <dd id="InlineReg.cpu" class="function">cpu</dd>
                <dd id="InlineReg.type" class="function">type</dd>
                <dd id="InlineReg.float" class="function">float</dd>
                <dd id="InlineReg.double" class="function">double</dd>
                <dd id="InlineReg.half" class="function">half</dd>
                <dd id="InlineReg.bfloat16" class="function">bfloat16</dd>
                <dd id="InlineReg.to_empty" class="function">to_empty</dd>
                <dd id="InlineReg.to" class="function">to</dd>
                <dd id="InlineReg.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="InlineReg.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="InlineReg.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="InlineReg.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="InlineReg.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="InlineReg.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="InlineReg.state_dict" class="function">state_dict</dd>
                <dd id="InlineReg.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="InlineReg.load_state_dict" class="function">load_state_dict</dd>
                <dd id="InlineReg.parameters" class="function">parameters</dd>
                <dd id="InlineReg.named_parameters" class="function">named_parameters</dd>
                <dd id="InlineReg.buffers" class="function">buffers</dd>
                <dd id="InlineReg.named_buffers" class="function">named_buffers</dd>
                <dd id="InlineReg.children" class="function">children</dd>
                <dd id="InlineReg.named_children" class="function">named_children</dd>
                <dd id="InlineReg.modules" class="function">modules</dd>
                <dd id="InlineReg.named_modules" class="function">named_modules</dd>
                <dd id="InlineReg.train" class="function">train</dd>
                <dd id="InlineReg.eval" class="function">eval</dd>
                <dd id="InlineReg.requires_grad_" class="function">requires_grad_</dd>
                <dd id="InlineReg.zero_grad" class="function">zero_grad</dd>
                <dd id="InlineReg.share_memory" class="function">share_memory</dd>
                <dd id="InlineReg.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ConvReg">
                            <input id="ConvReg-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ConvReg</span><wbr>(<span class="base"><a href="#RegModule">RegModule</a></span>):

                <label class="view-source-button" for="ConvReg-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConvReg"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConvReg-499"><a href="#ConvReg-499"><span class="linenos">499</span></a><span class="k">class</span> <span class="nc">ConvReg</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="ConvReg-500"><a href="#ConvReg-500"><span class="linenos">500</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Regularization module for convolutional penalties&quot;&quot;&quot;</span>
</span><span id="ConvReg-501"><a href="#ConvReg-501"><span class="linenos">501</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ConvReg-502"><a href="#ConvReg-502"><span class="linenos">502</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Reg_module class&quot;&quot;&quot;</span>
</span><span id="ConvReg-503"><a href="#ConvReg-503"><span class="linenos">503</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;d2x&#39;</span><span class="p">,</span> <span class="s1">&#39;d2t&#39;</span><span class="p">,</span> <span class="s1">&#39;d2xt&#39;</span><span class="p">]</span>
</span><span id="ConvReg-504"><a href="#ConvReg-504"><span class="linenos">504</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid ConvReg type&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="ConvReg-505"><a href="#ConvReg-505"><span class="linenos">505</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ConvReg-506"><a href="#ConvReg-506"><span class="linenos">506</span></a>
</span><span id="ConvReg-507"><a href="#ConvReg-507"><span class="linenos">507</span></a>        <span class="n">reg_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_laplacian</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="ConvReg-508"><a href="#ConvReg-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;rmat&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">reg_mat</span><span class="p">))</span>
</span><span id="ConvReg-509"><a href="#ConvReg-509"><span class="linenos">509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">BC</span> <span class="o">=</span> <span class="n">bc_val</span>
</span><span id="ConvReg-510"><a href="#ConvReg-510"><span class="linenos">510</span></a>    
</span><span id="ConvReg-511"><a href="#ConvReg-511"><span class="linenos">511</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="ConvReg-512"><a href="#ConvReg-512"><span class="linenos">512</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;I&#39;m separating the code for more complicated regularization penalties in the simplest possible way here, but</span>
</span><span id="ConvReg-513"><a href="#ConvReg-513"><span class="linenos">513</span></a><span class="sd">        this can be done more (or less) elaborately in the future. The challenge here is that the dimension of the weight</span>
</span><span id="ConvReg-514"><a href="#ConvReg-514"><span class="linenos">514</span></a><span class="sd">        vector (1-D, 2-D, 3-D) determines what sort of Laplacian matrix, and convolution, to do</span>
</span><span id="ConvReg-515"><a href="#ConvReg-515"><span class="linenos">515</span></a><span class="sd">        Note that all convolutions are implicitly &#39;valid&#39; so no boundary conditions&quot;&quot;&quot;</span>
</span><span id="ConvReg-516"><a href="#ConvReg-516"><span class="linenos">516</span></a>        <span class="n">num_filters</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ConvReg-517"><a href="#ConvReg-517"><span class="linenos">517</span></a>        <span class="n">weight_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="n">num_filters</span><span class="p">]</span>
</span><span id="ConvReg-518"><a href="#ConvReg-518"><span class="linenos">518</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="ConvReg-519"><a href="#ConvReg-519"><span class="linenos">519</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">weight_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weight_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">weight_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>            
</span><span id="ConvReg-520"><a href="#ConvReg-520"><span class="linenos">520</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ConvReg-521"><a href="#ConvReg-521"><span class="linenos">521</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weight_dims</span><span class="p">)</span>
</span><span id="ConvReg-522"><a href="#ConvReg-522"><span class="linenos">522</span></a>        <span class="c1"># puts in [C, W, H, T, num_filters]: to reorder depending on reg type</span>
</span><span id="ConvReg-523"><a href="#ConvReg-523"><span class="linenos">523</span></a>        <span class="c1"># default reg_dims</span>
</span><span id="ConvReg-524"><a href="#ConvReg-524"><span class="linenos">524</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2t&#39;</span><span class="p">:</span>
</span><span id="ConvReg-525"><a href="#ConvReg-525"><span class="linenos">525</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># needs temporal dimension last so only convolved</span>
</span><span id="ConvReg-526"><a href="#ConvReg-526"><span class="linenos">526</span></a>            <span class="c1">#reg_dims = [weight_dims[3]]</span>
</span><span id="ConvReg-527"><a href="#ConvReg-527"><span class="linenos">527</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2xt&#39;</span><span class="p">:</span>
</span><span id="ConvReg-528"><a href="#ConvReg-528"><span class="linenos">528</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="ConvReg-529"><a href="#ConvReg-529"><span class="linenos">529</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FL&#39;</span><span class="p">)</span>
</span><span id="ConvReg-530"><a href="#ConvReg-530"><span class="linenos">530</span></a>                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># weights correspding to lag are up front</span>
</span><span id="ConvReg-531"><a href="#ConvReg-531"><span class="linenos">531</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ConvReg-532"><a href="#ConvReg-532"><span class="linenos">532</span></a>                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> 
</span><span id="ConvReg-533"><a href="#ConvReg-533"><span class="linenos">533</span></a>            <span class="c1"># Reg-dims will depend on whether space is one- or two-dimensional</span>
</span><span id="ConvReg-534"><a href="#ConvReg-534"><span class="linenos">534</span></a>            <span class="c1">#if weight_dims[2] &gt; 1:</span>
</span><span id="ConvReg-535"><a href="#ConvReg-535"><span class="linenos">535</span></a>            <span class="c1">#    reg_dims = [weight_dims[1], weight_dims[2], weight_dims[3]]</span>
</span><span id="ConvReg-536"><a href="#ConvReg-536"><span class="linenos">536</span></a>            <span class="c1">#else:</span>
</span><span id="ConvReg-537"><a href="#ConvReg-537"><span class="linenos">537</span></a>            <span class="c1">#    reg_dims = [weight_dims[1], weight_dims[3]]</span>
</span><span id="ConvReg-538"><a href="#ConvReg-538"><span class="linenos">538</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># then d2x</span>
</span><span id="ConvReg-539"><a href="#ConvReg-539"><span class="linenos">539</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># rotate temporal dimensions next to filter dims</span>
</span><span id="ConvReg-540"><a href="#ConvReg-540"><span class="linenos">540</span></a>            <span class="c1">#reg_dims = [weight_dims[1], weight_dims[2]]</span>
</span><span id="ConvReg-541"><a href="#ConvReg-541"><span class="linenos">541</span></a>
</span><span id="ConvReg-542"><a href="#ConvReg-542"><span class="linenos">542</span></a>        <span class="c1"># Apply boundary conditions dependent on default values (that can be set by hand):</span>
</span><span id="ConvReg-543"><a href="#ConvReg-543"><span class="linenos">543</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ConvReg-544"><a href="#ConvReg-544"><span class="linenos">544</span></a>            <span class="c1"># prepare for 1-d convolve</span>
</span><span id="ConvReg-545"><a href="#ConvReg-545"><span class="linenos">545</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span> 
</span><span id="ConvReg-546"><a href="#ConvReg-546"><span class="linenos">546</span></a>                <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="p">),</span>  <span class="c1"># [batch_dim, all non-conv dims, conv_dim]</span>
</span><span id="ConvReg-547"><a href="#ConvReg-547"><span class="linenos">547</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BC</span> <span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#/ weight_dims[-1]</span>
</span><span id="ConvReg-548"><a href="#ConvReg-548"><span class="linenos">548</span></a>
</span><span id="ConvReg-549"><a href="#ConvReg-549"><span class="linenos">549</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ConvReg-550"><a href="#ConvReg-550"><span class="linenos">550</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span> 
</span><span id="ConvReg-551"><a href="#ConvReg-551"><span class="linenos">551</span></a>                <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="p">),</span> 
</span><span id="ConvReg-552"><a href="#ConvReg-552"><span class="linenos">552</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BC</span> <span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#/ weight_dims[-1]</span>
</span><span id="ConvReg-553"><a href="#ConvReg-553"><span class="linenos">553</span></a>            
</span><span id="ConvReg-554"><a href="#ConvReg-554"><span class="linenos">554</span></a>
</span><span id="ConvReg-555"><a href="#ConvReg-555"><span class="linenos">555</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="ConvReg-556"><a href="#ConvReg-556"><span class="linenos">556</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv3d</span><span class="p">(</span> 
</span><span id="ConvReg-557"><a href="#ConvReg-557"><span class="linenos">557</span></a>                <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span><span class="p">),</span>
</span><span id="ConvReg-558"><a href="#ConvReg-558"><span class="linenos">558</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BC</span> <span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#/ weight_dims[-1]</span>
</span><span id="ConvReg-559"><a href="#ConvReg-559"><span class="linenos">559</span></a>        
</span><span id="ConvReg-560"><a href="#ConvReg-560"><span class="linenos">560</span></a>        <span class="c1"># average over all dimensions except the filter dimension</span>
</span><span id="ConvReg-561"><a href="#ConvReg-561"><span class="linenos">561</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="n">rpen</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_filters</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ConvReg-562"><a href="#ConvReg-562"><span class="linenos">562</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="n">rpen</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ConvReg-563"><a href="#ConvReg-563"><span class="linenos">563</span></a>
</span><span id="ConvReg-564"><a href="#ConvReg-564"><span class="linenos">564</span></a>        <span class="k">return</span> <span class="n">rpen</span>
</span><span id="ConvReg-565"><a href="#ConvReg-565"><span class="linenos">565</span></a>    
</span><span id="ConvReg-566"><a href="#ConvReg-566"><span class="linenos">566</span></a>    <span class="k">def</span> <span class="nf">_make_laplacian</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span> <span class="p">):</span>
</span><span id="ConvReg-567"><a href="#ConvReg-567"><span class="linenos">567</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;This will make the Laplacian of the right dimensionality depending on d2xt, d2t, d2x&quot;&quot;&quot;</span>
</span><span id="ConvReg-568"><a href="#ConvReg-568"><span class="linenos">568</span></a>
</span><span id="ConvReg-569"><a href="#ConvReg-569"><span class="linenos">569</span></a>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="ConvReg-570"><a href="#ConvReg-570"><span class="linenos">570</span></a>
</span><span id="ConvReg-571"><a href="#ConvReg-571"><span class="linenos">571</span></a>        <span class="c1"># Determine relevant reg_dims for Laplacian</span>
</span><span id="ConvReg-572"><a href="#ConvReg-572"><span class="linenos">572</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2t&#39;</span><span class="p">:</span>
</span><span id="ConvReg-573"><a href="#ConvReg-573"><span class="linenos">573</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="ConvReg-574"><a href="#ConvReg-574"><span class="linenos">574</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2x&#39;</span><span class="p">:</span>
</span><span id="ConvReg-575"><a href="#ConvReg-575"><span class="linenos">575</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</span><span id="ConvReg-576"><a href="#ConvReg-576"><span class="linenos">576</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># d2xt</span>
</span><span id="ConvReg-577"><a href="#ConvReg-577"><span class="linenos">577</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ConvReg-578"><a href="#ConvReg-578"><span class="linenos">578</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="ConvReg-579"><a href="#ConvReg-579"><span class="linenos">579</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ConvReg-580"><a href="#ConvReg-580"><span class="linenos">580</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="ConvReg-581"><a href="#ConvReg-581"><span class="linenos">581</span></a>
</span><span id="ConvReg-582"><a href="#ConvReg-582"><span class="linenos">582</span></a>        <span class="c1"># Determine number of dimensions for laplacian matrix (and convolution)</span>
</span><span id="ConvReg-583"><a href="#ConvReg-583"><span class="linenos">583</span></a>        <span class="n">dim_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">1</span>  <span class="c1"># filter dimension will be ignored</span>
</span><span id="ConvReg-584"><a href="#ConvReg-584"><span class="linenos">584</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2t&#39;</span><span class="p">:</span>
</span><span id="ConvReg-585"><a href="#ConvReg-585"><span class="linenos">585</span></a>            <span class="n">dim_mask</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># zeros out spatial dimensions</span>
</span><span id="ConvReg-586"><a href="#ConvReg-586"><span class="linenos">586</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2x&#39;</span><span class="p">:</span>
</span><span id="ConvReg-587"><a href="#ConvReg-587"><span class="linenos">587</span></a>            <span class="n">dim_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># zeros out temporal dimensions</span>
</span><span id="ConvReg-588"><a href="#ConvReg-588"><span class="linenos">588</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim_mask</span><span class="p">)</span>
</span><span id="ConvReg-589"><a href="#ConvReg-589"><span class="linenos">589</span></a>        
</span><span id="ConvReg-590"><a href="#ConvReg-590"><span class="linenos">590</span></a>        <span class="c1"># note all the extra brackets are so the first two dims [out_chan, in_chan] are 1,1</span>
</span><span id="ConvReg-591"><a href="#ConvReg-591"><span class="linenos">591</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ConvReg-592"><a href="#ConvReg-592"><span class="linenos">592</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>
</span><span id="ConvReg-593"><a href="#ConvReg-593"><span class="linenos">593</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>            
</span><span id="ConvReg-594"><a href="#ConvReg-594"><span class="linenos">594</span></a>            <span class="c1">#rmat = np.array([[[[0,-1,0],[-1, 4, -1], [0,-1,0]]]])</span>
</span><span id="ConvReg-595"><a href="#ConvReg-595"><span class="linenos">595</span></a>            <span class="c1"># Isotropic form of discrete Laplacian operator (https://en.wikipedia.org/wiki/Discrete_Laplace_operator)</span>
</span><span id="ConvReg-596"><a href="#ConvReg-596"><span class="linenos">596</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[[</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.25</span><span class="p">],[</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.25</span><span class="p">]]]])</span>
</span><span id="ConvReg-597"><a href="#ConvReg-597"><span class="linenos">597</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="ConvReg-598"><a href="#ConvReg-598"><span class="linenos">598</span></a>            <span class="c1">#rmat = np.array(</span>
</span><span id="ConvReg-599"><a href="#ConvReg-599"><span class="linenos">599</span></a>            <span class="c1">#    [[[[[0, 0, 0],[0, -1, 0], [0, 0, 0]],</span>
</span><span id="ConvReg-600"><a href="#ConvReg-600"><span class="linenos">600</span></a>            <span class="c1">#    [[0, -1, 0],[-1, 6, -1], [0, -1, 0]],</span>
</span><span id="ConvReg-601"><a href="#ConvReg-601"><span class="linenos">601</span></a>            <span class="c1">#    [[0, 0, 0],[0, -1, 0], [0, 0, 0]]]]])</span>
</span><span id="ConvReg-602"><a href="#ConvReg-602"><span class="linenos">602</span></a>            <span class="c1"># Isotropic form:</span>
</span><span id="ConvReg-603"><a href="#ConvReg-603"><span class="linenos">603</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">26</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="ConvReg-604"><a href="#ConvReg-604"><span class="linenos">604</span></a>                <span class="p">[[[[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span>
</span><span id="ConvReg-605"><a href="#ConvReg-605"><span class="linenos">605</span></a>                <span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">],[</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">88</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
</span><span id="ConvReg-606"><a href="#ConvReg-606"><span class="linenos">606</span></a>                <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]]]])</span>
</span><span id="ConvReg-607"><a href="#ConvReg-607"><span class="linenos">607</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ConvReg-608"><a href="#ConvReg-608"><span class="linenos">608</span></a>            <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ConvReg-609"><a href="#ConvReg-609"><span class="linenos">609</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Warning: </span><span class="si">%s</span><span class="s2"> regularization does not have the necessary filter dimensions.&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="p">)</span>
</span><span id="ConvReg-610"><a href="#ConvReg-610"><span class="linenos">610</span></a>        <span class="k">return</span> <span class="n">rmat</span>
</span></pre></div>


            <div class="docstring"><p>Regularization module for convolutional penalties</p>
</div>


                            <div id="ConvReg.__init__" class="classattr">
                                        <input id="ConvReg.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ConvReg</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">bc_val</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="ConvReg.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConvReg.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConvReg.__init__-501"><a href="#ConvReg.__init__-501"><span class="linenos">501</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ConvReg.__init__-502"><a href="#ConvReg.__init__-502"><span class="linenos">502</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Reg_module class&quot;&quot;&quot;</span>
</span><span id="ConvReg.__init__-503"><a href="#ConvReg.__init__-503"><span class="linenos">503</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;d2x&#39;</span><span class="p">,</span> <span class="s1">&#39;d2t&#39;</span><span class="p">,</span> <span class="s1">&#39;d2xt&#39;</span><span class="p">]</span>
</span><span id="ConvReg.__init__-504"><a href="#ConvReg.__init__-504"><span class="linenos">504</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid ConvReg type&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="ConvReg.__init__-505"><a href="#ConvReg.__init__-505"><span class="linenos">505</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ConvReg.__init__-506"><a href="#ConvReg.__init__-506"><span class="linenos">506</span></a>
</span><span id="ConvReg.__init__-507"><a href="#ConvReg.__init__-507"><span class="linenos">507</span></a>        <span class="n">reg_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_laplacian</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="ConvReg.__init__-508"><a href="#ConvReg.__init__-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;rmat&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">reg_mat</span><span class="p">))</span>
</span><span id="ConvReg.__init__-509"><a href="#ConvReg.__init__-509"><span class="linenos">509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">BC</span> <span class="o">=</span> <span class="n">bc_val</span>
</span></pre></div>


            <div class="docstring"><p>Constructor for Reg_module class</p>
</div>


                            </div>
                            <div id="ConvReg.BC" class="classattr">
                                <div class="attr variable">
            <span class="name">BC</span>

        
    </div>
    <a class="headerlink" href="#ConvReg.BC"></a>
    
    

                            </div>
                            <div id="ConvReg.compute_reg_penalty" class="classattr">
                                        <input id="ConvReg.compute_reg_penalty-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_reg_penalty</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">weights</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ConvReg.compute_reg_penalty-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConvReg.compute_reg_penalty"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConvReg.compute_reg_penalty-511"><a href="#ConvReg.compute_reg_penalty-511"><span class="linenos">511</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="ConvReg.compute_reg_penalty-512"><a href="#ConvReg.compute_reg_penalty-512"><span class="linenos">512</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;I&#39;m separating the code for more complicated regularization penalties in the simplest possible way here, but</span>
</span><span id="ConvReg.compute_reg_penalty-513"><a href="#ConvReg.compute_reg_penalty-513"><span class="linenos">513</span></a><span class="sd">        this can be done more (or less) elaborately in the future. The challenge here is that the dimension of the weight</span>
</span><span id="ConvReg.compute_reg_penalty-514"><a href="#ConvReg.compute_reg_penalty-514"><span class="linenos">514</span></a><span class="sd">        vector (1-D, 2-D, 3-D) determines what sort of Laplacian matrix, and convolution, to do</span>
</span><span id="ConvReg.compute_reg_penalty-515"><a href="#ConvReg.compute_reg_penalty-515"><span class="linenos">515</span></a><span class="sd">        Note that all convolutions are implicitly &#39;valid&#39; so no boundary conditions&quot;&quot;&quot;</span>
</span><span id="ConvReg.compute_reg_penalty-516"><a href="#ConvReg.compute_reg_penalty-516"><span class="linenos">516</span></a>        <span class="n">num_filters</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ConvReg.compute_reg_penalty-517"><a href="#ConvReg.compute_reg_penalty-517"><span class="linenos">517</span></a>        <span class="n">weight_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="n">num_filters</span><span class="p">]</span>
</span><span id="ConvReg.compute_reg_penalty-518"><a href="#ConvReg.compute_reg_penalty-518"><span class="linenos">518</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="ConvReg.compute_reg_penalty-519"><a href="#ConvReg.compute_reg_penalty-519"><span class="linenos">519</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">weight_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weight_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">weight_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>            
</span><span id="ConvReg.compute_reg_penalty-520"><a href="#ConvReg.compute_reg_penalty-520"><span class="linenos">520</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ConvReg.compute_reg_penalty-521"><a href="#ConvReg.compute_reg_penalty-521"><span class="linenos">521</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weight_dims</span><span class="p">)</span>
</span><span id="ConvReg.compute_reg_penalty-522"><a href="#ConvReg.compute_reg_penalty-522"><span class="linenos">522</span></a>        <span class="c1"># puts in [C, W, H, T, num_filters]: to reorder depending on reg type</span>
</span><span id="ConvReg.compute_reg_penalty-523"><a href="#ConvReg.compute_reg_penalty-523"><span class="linenos">523</span></a>        <span class="c1"># default reg_dims</span>
</span><span id="ConvReg.compute_reg_penalty-524"><a href="#ConvReg.compute_reg_penalty-524"><span class="linenos">524</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2t&#39;</span><span class="p">:</span>
</span><span id="ConvReg.compute_reg_penalty-525"><a href="#ConvReg.compute_reg_penalty-525"><span class="linenos">525</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># needs temporal dimension last so only convolved</span>
</span><span id="ConvReg.compute_reg_penalty-526"><a href="#ConvReg.compute_reg_penalty-526"><span class="linenos">526</span></a>            <span class="c1">#reg_dims = [weight_dims[3]]</span>
</span><span id="ConvReg.compute_reg_penalty-527"><a href="#ConvReg.compute_reg_penalty-527"><span class="linenos">527</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;d2xt&#39;</span><span class="p">:</span>
</span><span id="ConvReg.compute_reg_penalty-528"><a href="#ConvReg.compute_reg_penalty-528"><span class="linenos">528</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_lags</span><span class="p">:</span>
</span><span id="ConvReg.compute_reg_penalty-529"><a href="#ConvReg.compute_reg_penalty-529"><span class="linenos">529</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FL&#39;</span><span class="p">)</span>
</span><span id="ConvReg.compute_reg_penalty-530"><a href="#ConvReg.compute_reg_penalty-530"><span class="linenos">530</span></a>                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># weights correspding to lag are up front</span>
</span><span id="ConvReg.compute_reg_penalty-531"><a href="#ConvReg.compute_reg_penalty-531"><span class="linenos">531</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ConvReg.compute_reg_penalty-532"><a href="#ConvReg.compute_reg_penalty-532"><span class="linenos">532</span></a>                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> 
</span><span id="ConvReg.compute_reg_penalty-533"><a href="#ConvReg.compute_reg_penalty-533"><span class="linenos">533</span></a>            <span class="c1"># Reg-dims will depend on whether space is one- or two-dimensional</span>
</span><span id="ConvReg.compute_reg_penalty-534"><a href="#ConvReg.compute_reg_penalty-534"><span class="linenos">534</span></a>            <span class="c1">#if weight_dims[2] &gt; 1:</span>
</span><span id="ConvReg.compute_reg_penalty-535"><a href="#ConvReg.compute_reg_penalty-535"><span class="linenos">535</span></a>            <span class="c1">#    reg_dims = [weight_dims[1], weight_dims[2], weight_dims[3]]</span>
</span><span id="ConvReg.compute_reg_penalty-536"><a href="#ConvReg.compute_reg_penalty-536"><span class="linenos">536</span></a>            <span class="c1">#else:</span>
</span><span id="ConvReg.compute_reg_penalty-537"><a href="#ConvReg.compute_reg_penalty-537"><span class="linenos">537</span></a>            <span class="c1">#    reg_dims = [weight_dims[1], weight_dims[3]]</span>
</span><span id="ConvReg.compute_reg_penalty-538"><a href="#ConvReg.compute_reg_penalty-538"><span class="linenos">538</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># then d2x</span>
</span><span id="ConvReg.compute_reg_penalty-539"><a href="#ConvReg.compute_reg_penalty-539"><span class="linenos">539</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># rotate temporal dimensions next to filter dims</span>
</span><span id="ConvReg.compute_reg_penalty-540"><a href="#ConvReg.compute_reg_penalty-540"><span class="linenos">540</span></a>            <span class="c1">#reg_dims = [weight_dims[1], weight_dims[2]]</span>
</span><span id="ConvReg.compute_reg_penalty-541"><a href="#ConvReg.compute_reg_penalty-541"><span class="linenos">541</span></a>
</span><span id="ConvReg.compute_reg_penalty-542"><a href="#ConvReg.compute_reg_penalty-542"><span class="linenos">542</span></a>        <span class="c1"># Apply boundary conditions dependent on default values (that can be set by hand):</span>
</span><span id="ConvReg.compute_reg_penalty-543"><a href="#ConvReg.compute_reg_penalty-543"><span class="linenos">543</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ConvReg.compute_reg_penalty-544"><a href="#ConvReg.compute_reg_penalty-544"><span class="linenos">544</span></a>            <span class="c1"># prepare for 1-d convolve</span>
</span><span id="ConvReg.compute_reg_penalty-545"><a href="#ConvReg.compute_reg_penalty-545"><span class="linenos">545</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span> 
</span><span id="ConvReg.compute_reg_penalty-546"><a href="#ConvReg.compute_reg_penalty-546"><span class="linenos">546</span></a>                <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="p">),</span>  <span class="c1"># [batch_dim, all non-conv dims, conv_dim]</span>
</span><span id="ConvReg.compute_reg_penalty-547"><a href="#ConvReg.compute_reg_penalty-547"><span class="linenos">547</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BC</span> <span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#/ weight_dims[-1]</span>
</span><span id="ConvReg.compute_reg_penalty-548"><a href="#ConvReg.compute_reg_penalty-548"><span class="linenos">548</span></a>
</span><span id="ConvReg.compute_reg_penalty-549"><a href="#ConvReg.compute_reg_penalty-549"><span class="linenos">549</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ConvReg.compute_reg_penalty-550"><a href="#ConvReg.compute_reg_penalty-550"><span class="linenos">550</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span> 
</span><span id="ConvReg.compute_reg_penalty-551"><a href="#ConvReg.compute_reg_penalty-551"><span class="linenos">551</span></a>                <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="p">),</span> 
</span><span id="ConvReg.compute_reg_penalty-552"><a href="#ConvReg.compute_reg_penalty-552"><span class="linenos">552</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BC</span> <span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#/ weight_dims[-1]</span>
</span><span id="ConvReg.compute_reg_penalty-553"><a href="#ConvReg.compute_reg_penalty-553"><span class="linenos">553</span></a>            
</span><span id="ConvReg.compute_reg_penalty-554"><a href="#ConvReg.compute_reg_penalty-554"><span class="linenos">554</span></a>
</span><span id="ConvReg.compute_reg_penalty-555"><a href="#ConvReg.compute_reg_penalty-555"><span class="linenos">555</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="ConvReg.compute_reg_penalty-556"><a href="#ConvReg.compute_reg_penalty-556"><span class="linenos">556</span></a>            <span class="n">rpen</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv3d</span><span class="p">(</span> 
</span><span id="ConvReg.compute_reg_penalty-557"><a href="#ConvReg.compute_reg_penalty-557"><span class="linenos">557</span></a>                <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_dims</span><span class="p">),</span>
</span><span id="ConvReg.compute_reg_penalty-558"><a href="#ConvReg.compute_reg_penalty-558"><span class="linenos">558</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BC</span> <span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#/ weight_dims[-1]</span>
</span><span id="ConvReg.compute_reg_penalty-559"><a href="#ConvReg.compute_reg_penalty-559"><span class="linenos">559</span></a>        
</span><span id="ConvReg.compute_reg_penalty-560"><a href="#ConvReg.compute_reg_penalty-560"><span class="linenos">560</span></a>        <span class="c1"># average over all dimensions except the filter dimension</span>
</span><span id="ConvReg.compute_reg_penalty-561"><a href="#ConvReg.compute_reg_penalty-561"><span class="linenos">561</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="n">rpen</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_filters</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ConvReg.compute_reg_penalty-562"><a href="#ConvReg.compute_reg_penalty-562"><span class="linenos">562</span></a>        <span class="n">rpen</span> <span class="o">=</span> <span class="n">rpen</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ConvReg.compute_reg_penalty-563"><a href="#ConvReg.compute_reg_penalty-563"><span class="linenos">563</span></a>
</span><span id="ConvReg.compute_reg_penalty-564"><a href="#ConvReg.compute_reg_penalty-564"><span class="linenos">564</span></a>        <span class="k">return</span> <span class="n">rpen</span>
</span></pre></div>


            <div class="docstring"><p>I'm separating the code for more complicated regularization penalties in the simplest possible way here, but
this can be done more (or less) elaborately in the future. The challenge here is that the dimension of the weight
vector (1-D, 2-D, 3-D) determines what sort of Laplacian matrix, and convolution, to do
Note that all convolutions are implicitly 'valid' so no boundary conditions</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#RegModule">RegModule</a></dt>
                                <dd id="ConvReg.reg_type" class="variable"><a href="#RegModule.reg_type">reg_type</a></dd>
                <dd id="ConvReg.unit_reg" class="variable"><a href="#RegModule.unit_reg">unit_reg</a></dd>
                <dd id="ConvReg.input_dims" class="variable"><a href="#RegModule.input_dims">input_dims</a></dd>
                <dd id="ConvReg.num_dims" class="variable"><a href="#RegModule.num_dims">num_dims</a></dd>
                <dd id="ConvReg.folded_lags" class="variable"><a href="#RegModule.folded_lags">folded_lags</a></dd>
                <dd id="ConvReg.pos_constraint" class="variable"><a href="#RegModule.pos_constraint">pos_constraint</a></dd>
                <dd id="ConvReg.forward" class="function"><a href="#RegModule.forward">forward</a></dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="ConvReg.dump_patches" class="variable">dump_patches</dd>
                <dd id="ConvReg.training" class="variable">training</dd>
                <dd id="ConvReg.call_super_init" class="variable">call_super_init</dd>
                <dd id="ConvReg.register_buffer" class="function">register_buffer</dd>
                <dd id="ConvReg.register_parameter" class="function">register_parameter</dd>
                <dd id="ConvReg.add_module" class="function">add_module</dd>
                <dd id="ConvReg.register_module" class="function">register_module</dd>
                <dd id="ConvReg.get_submodule" class="function">get_submodule</dd>
                <dd id="ConvReg.get_parameter" class="function">get_parameter</dd>
                <dd id="ConvReg.get_buffer" class="function">get_buffer</dd>
                <dd id="ConvReg.get_extra_state" class="function">get_extra_state</dd>
                <dd id="ConvReg.set_extra_state" class="function">set_extra_state</dd>
                <dd id="ConvReg.apply" class="function">apply</dd>
                <dd id="ConvReg.cuda" class="function">cuda</dd>
                <dd id="ConvReg.ipu" class="function">ipu</dd>
                <dd id="ConvReg.xpu" class="function">xpu</dd>
                <dd id="ConvReg.cpu" class="function">cpu</dd>
                <dd id="ConvReg.type" class="function">type</dd>
                <dd id="ConvReg.float" class="function">float</dd>
                <dd id="ConvReg.double" class="function">double</dd>
                <dd id="ConvReg.half" class="function">half</dd>
                <dd id="ConvReg.bfloat16" class="function">bfloat16</dd>
                <dd id="ConvReg.to_empty" class="function">to_empty</dd>
                <dd id="ConvReg.to" class="function">to</dd>
                <dd id="ConvReg.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="ConvReg.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="ConvReg.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="ConvReg.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="ConvReg.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="ConvReg.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="ConvReg.state_dict" class="function">state_dict</dd>
                <dd id="ConvReg.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="ConvReg.load_state_dict" class="function">load_state_dict</dd>
                <dd id="ConvReg.parameters" class="function">parameters</dd>
                <dd id="ConvReg.named_parameters" class="function">named_parameters</dd>
                <dd id="ConvReg.buffers" class="function">buffers</dd>
                <dd id="ConvReg.named_buffers" class="function">named_buffers</dd>
                <dd id="ConvReg.children" class="function">children</dd>
                <dd id="ConvReg.named_children" class="function">named_children</dd>
                <dd id="ConvReg.modules" class="function">modules</dd>
                <dd id="ConvReg.named_modules" class="function">named_modules</dd>
                <dd id="ConvReg.train" class="function">train</dd>
                <dd id="ConvReg.eval" class="function">eval</dd>
                <dd id="ConvReg.requires_grad_" class="function">requires_grad_</dd>
                <dd id="ConvReg.zero_grad" class="function">zero_grad</dd>
                <dd id="ConvReg.share_memory" class="function">share_memory</dd>
                <dd id="ConvReg.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Tikhanov">
                            <input id="Tikhanov-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Tikhanov</span><wbr>(<span class="base"><a href="#RegModule">RegModule</a></span>):

                <label class="view-source-button" for="Tikhanov-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tikhanov"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tikhanov-613"><a href="#Tikhanov-613"><span class="linenos">613</span></a><span class="k">class</span> <span class="nc">Tikhanov</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="Tikhanov-614"><a href="#Tikhanov-614"><span class="linenos">614</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Regularization module for Tikhanov regularization&quot;&quot;&quot;</span>
</span><span id="Tikhanov-615"><a href="#Tikhanov-615"><span class="linenos">615</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Tikhanov-616"><a href="#Tikhanov-616"><span class="linenos">616</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Tikhanov class&quot;&quot;&quot;</span>
</span><span id="Tikhanov-617"><a href="#Tikhanov-617"><span class="linenos">617</span></a>
</span><span id="Tikhanov-618"><a href="#Tikhanov-618"><span class="linenos">618</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="n">bc_val</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Tikhanov-619"><a href="#Tikhanov-619"><span class="linenos">619</span></a>        
</span><span id="Tikhanov-620"><a href="#Tikhanov-620"><span class="linenos">620</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;glocal&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;max_filt&#39;</span><span class="p">,</span> <span class="s1">&#39;max_space&#39;</span><span class="p">]</span>
</span><span id="Tikhanov-621"><a href="#Tikhanov-621"><span class="linenos">621</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid Tikhanov regularization type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="Tikhanov-622"><a href="#Tikhanov-622"><span class="linenos">622</span></a>        
</span><span id="Tikhanov-623"><a href="#Tikhanov-623"><span class="linenos">623</span></a>        <span class="c1"># the &quot;input_dims&quot; are ordered differently for matrix implementations,</span>
</span><span id="Tikhanov-624"><a href="#Tikhanov-624"><span class="linenos">624</span></a>        <span class="c1"># so this is a temporary fix to be able to use old functions</span>
</span><span id="Tikhanov-625"><a href="#Tikhanov-625"><span class="linenos">625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Tikhanov-626"><a href="#Tikhanov-626"><span class="linenos">626</span></a>            <span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="c1"># non-spatial</span>
</span><span id="Tikhanov-627"><a href="#Tikhanov-627"><span class="linenos">627</span></a>            <span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="c1"># spatial </span>
</span><span id="Tikhanov-628"><a href="#Tikhanov-628"><span class="linenos">628</span></a>
</span><span id="Tikhanov-629"><a href="#Tikhanov-629"><span class="linenos">629</span></a>        <span class="c1"># Make appropriate reg_matrix as buffer (non-fit parameter)</span>
</span><span id="Tikhanov-630"><a href="#Tikhanov-630"><span class="linenos">630</span></a>        <span class="n">reg_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_reg_mats</span><span class="p">(</span> <span class="n">reg_type</span> <span class="p">)</span>
</span><span id="Tikhanov-631"><a href="#Tikhanov-631"><span class="linenos">631</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;rmat&#39;</span><span class="p">,</span> <span class="n">reg_tensor</span><span class="p">)</span>
</span><span id="Tikhanov-632"><a href="#Tikhanov-632"><span class="linenos">632</span></a>    
</span><span id="Tikhanov-633"><a href="#Tikhanov-633"><span class="linenos">633</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="Tikhanov-634"><a href="#Tikhanov-634"><span class="linenos">634</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate regularization penalty for Tikhanov reg types&quot;&quot;&quot;</span>
</span><span id="Tikhanov-635"><a href="#Tikhanov-635"><span class="linenos">635</span></a>
</span><span id="Tikhanov-636"><a href="#Tikhanov-636"><span class="linenos">636</span></a>        <span class="n">w2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span><span id="Tikhanov-637"><a href="#Tikhanov-637"><span class="linenos">637</span></a>        <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">w2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="p">)</span>
</span><span id="Tikhanov-638"><a href="#Tikhanov-638"><span class="linenos">638</span></a>        <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">reg_pen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># sum later (replaced call to torch.trace)</span>
</span><span id="Tikhanov-639"><a href="#Tikhanov-639"><span class="linenos">639</span></a>
</span><span id="Tikhanov-640"><a href="#Tikhanov-640"><span class="linenos">640</span></a>        <span class="k">return</span> <span class="n">reg_pen</span>
</span><span id="Tikhanov-641"><a href="#Tikhanov-641"><span class="linenos">641</span></a>
</span><span id="Tikhanov-642"><a href="#Tikhanov-642"><span class="linenos">642</span></a>    <span class="k">def</span> <span class="nf">_build_reg_mats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">):</span>
</span><span id="Tikhanov-643"><a href="#Tikhanov-643"><span class="linenos">643</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build regularization matrices in default tf Graph</span>
</span><span id="Tikhanov-644"><a href="#Tikhanov-644"><span class="linenos">644</span></a>
</span><span id="Tikhanov-645"><a href="#Tikhanov-645"><span class="linenos">645</span></a><span class="sd">        Args:</span>
</span><span id="Tikhanov-646"><a href="#Tikhanov-646"><span class="linenos">646</span></a><span class="sd">            reg_type (str): see `_allowed_reg_types` for options</span>
</span><span id="Tikhanov-647"><a href="#Tikhanov-647"><span class="linenos">647</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tikhanov-648"><a href="#Tikhanov-648"><span class="linenos">648</span></a>        <span class="kn">import</span> <span class="nn">NDNT.utils.create_reg_matrices</span> <span class="k">as</span> <span class="nn">get_rmats</span>
</span><span id="Tikhanov-649"><a href="#Tikhanov-649"><span class="linenos">649</span></a>
</span><span id="Tikhanov-650"><a href="#Tikhanov-650"><span class="linenos">650</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;max_filt&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;max_space&#39;</span><span class="p">):</span>
</span><span id="Tikhanov-651"><a href="#Tikhanov-651"><span class="linenos">651</span></a>            <span class="n">reg_mat</span> <span class="o">=</span> <span class="n">get_rmats</span><span class="o">.</span><span class="n">create_maxpenalty_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">)</span>
</span><span id="Tikhanov-652"><a href="#Tikhanov-652"><span class="linenos">652</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
</span><span id="Tikhanov-653"><a href="#Tikhanov-653"><span class="linenos">653</span></a>            <span class="n">reg_mat</span> <span class="o">=</span> <span class="n">get_rmats</span><span class="o">.</span><span class="n">create_localpenalty_matrix</span><span class="p">(</span>
</span><span id="Tikhanov-654"><a href="#Tikhanov-654"><span class="linenos">654</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">separable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Tikhanov-655"><a href="#Tikhanov-655"><span class="linenos">655</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;glocal&#39;</span><span class="p">:</span>
</span><span id="Tikhanov-656"><a href="#Tikhanov-656"><span class="linenos">656</span></a>            <span class="n">reg_mat</span> <span class="o">=</span> <span class="n">get_rmats</span><span class="o">.</span><span class="n">create_localpenalty_matrix</span><span class="p">(</span>
</span><span id="Tikhanov-657"><a href="#Tikhanov-657"><span class="linenos">657</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">separable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spatial_global</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Tikhanov-658"><a href="#Tikhanov-658"><span class="linenos">658</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Tikhanov-659"><a href="#Tikhanov-659"><span class="linenos">659</span></a>            <span class="n">reg_mat</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Tikhanov-660"><a href="#Tikhanov-660"><span class="linenos">660</span></a>
</span><span id="Tikhanov-661"><a href="#Tikhanov-661"><span class="linenos">661</span></a>        <span class="k">if</span> <span class="n">reg_mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Tikhanov-662"><a href="#Tikhanov-662"><span class="linenos">662</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="Tikhanov-663"><a href="#Tikhanov-663"><span class="linenos">663</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Tikhanov-664"><a href="#Tikhanov-664"><span class="linenos">664</span></a>            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">reg_mat</span><span class="p">)</span>
</span><span id="Tikhanov-665"><a href="#Tikhanov-665"><span class="linenos">665</span></a>    <span class="c1"># END Tikhanov.build_reg_mats</span>
</span></pre></div>


            <div class="docstring"><p>Regularization module for Tikhanov regularization</p>
</div>


                            <div id="Tikhanov.__init__" class="classattr">
                                        <input id="Tikhanov.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Tikhanov</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">bc_val</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="Tikhanov.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tikhanov.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tikhanov.__init__-615"><a href="#Tikhanov.__init__-615"><span class="linenos">615</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Tikhanov.__init__-616"><a href="#Tikhanov.__init__-616"><span class="linenos">616</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Tikhanov class&quot;&quot;&quot;</span>
</span><span id="Tikhanov.__init__-617"><a href="#Tikhanov.__init__-617"><span class="linenos">617</span></a>
</span><span id="Tikhanov.__init__-618"><a href="#Tikhanov.__init__-618"><span class="linenos">618</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="n">bc_val</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Tikhanov.__init__-619"><a href="#Tikhanov.__init__-619"><span class="linenos">619</span></a>        
</span><span id="Tikhanov.__init__-620"><a href="#Tikhanov.__init__-620"><span class="linenos">620</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;glocal&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;max_filt&#39;</span><span class="p">,</span> <span class="s1">&#39;max_space&#39;</span><span class="p">]</span>
</span><span id="Tikhanov.__init__-621"><a href="#Tikhanov.__init__-621"><span class="linenos">621</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid Tikhanov regularization type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="Tikhanov.__init__-622"><a href="#Tikhanov.__init__-622"><span class="linenos">622</span></a>        
</span><span id="Tikhanov.__init__-623"><a href="#Tikhanov.__init__-623"><span class="linenos">623</span></a>        <span class="c1"># the &quot;input_dims&quot; are ordered differently for matrix implementations,</span>
</span><span id="Tikhanov.__init__-624"><a href="#Tikhanov.__init__-624"><span class="linenos">624</span></a>        <span class="c1"># so this is a temporary fix to be able to use old functions</span>
</span><span id="Tikhanov.__init__-625"><a href="#Tikhanov.__init__-625"><span class="linenos">625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Tikhanov.__init__-626"><a href="#Tikhanov.__init__-626"><span class="linenos">626</span></a>            <span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="c1"># non-spatial</span>
</span><span id="Tikhanov.__init__-627"><a href="#Tikhanov.__init__-627"><span class="linenos">627</span></a>            <span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="c1"># spatial </span>
</span><span id="Tikhanov.__init__-628"><a href="#Tikhanov.__init__-628"><span class="linenos">628</span></a>
</span><span id="Tikhanov.__init__-629"><a href="#Tikhanov.__init__-629"><span class="linenos">629</span></a>        <span class="c1"># Make appropriate reg_matrix as buffer (non-fit parameter)</span>
</span><span id="Tikhanov.__init__-630"><a href="#Tikhanov.__init__-630"><span class="linenos">630</span></a>        <span class="n">reg_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_reg_mats</span><span class="p">(</span> <span class="n">reg_type</span> <span class="p">)</span>
</span><span id="Tikhanov.__init__-631"><a href="#Tikhanov.__init__-631"><span class="linenos">631</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;rmat&#39;</span><span class="p">,</span> <span class="n">reg_tensor</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Constructor for Tikhanov class</p>
</div>


                            </div>
                            <div id="Tikhanov.input_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">input_dims</span>

        
    </div>
    <a class="headerlink" href="#Tikhanov.input_dims"></a>
    
    

                            </div>
                            <div id="Tikhanov.compute_reg_penalty" class="classattr">
                                        <input id="Tikhanov.compute_reg_penalty-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_reg_penalty</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">weights</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Tikhanov.compute_reg_penalty-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tikhanov.compute_reg_penalty"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tikhanov.compute_reg_penalty-633"><a href="#Tikhanov.compute_reg_penalty-633"><span class="linenos">633</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="Tikhanov.compute_reg_penalty-634"><a href="#Tikhanov.compute_reg_penalty-634"><span class="linenos">634</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate regularization penalty for Tikhanov reg types&quot;&quot;&quot;</span>
</span><span id="Tikhanov.compute_reg_penalty-635"><a href="#Tikhanov.compute_reg_penalty-635"><span class="linenos">635</span></a>
</span><span id="Tikhanov.compute_reg_penalty-636"><a href="#Tikhanov.compute_reg_penalty-636"><span class="linenos">636</span></a>        <span class="n">w2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span><span id="Tikhanov.compute_reg_penalty-637"><a href="#Tikhanov.compute_reg_penalty-637"><span class="linenos">637</span></a>        <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">w2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="p">)</span>
</span><span id="Tikhanov.compute_reg_penalty-638"><a href="#Tikhanov.compute_reg_penalty-638"><span class="linenos">638</span></a>        <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">reg_pen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># sum later (replaced call to torch.trace)</span>
</span><span id="Tikhanov.compute_reg_penalty-639"><a href="#Tikhanov.compute_reg_penalty-639"><span class="linenos">639</span></a>
</span><span id="Tikhanov.compute_reg_penalty-640"><a href="#Tikhanov.compute_reg_penalty-640"><span class="linenos">640</span></a>        <span class="k">return</span> <span class="n">reg_pen</span>
</span></pre></div>


            <div class="docstring"><p>Calculate regularization penalty for Tikhanov reg types</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#RegModule">RegModule</a></dt>
                                <dd id="Tikhanov.reg_type" class="variable"><a href="#RegModule.reg_type">reg_type</a></dd>
                <dd id="Tikhanov.unit_reg" class="variable"><a href="#RegModule.unit_reg">unit_reg</a></dd>
                <dd id="Tikhanov.num_dims" class="variable"><a href="#RegModule.num_dims">num_dims</a></dd>
                <dd id="Tikhanov.folded_lags" class="variable"><a href="#RegModule.folded_lags">folded_lags</a></dd>
                <dd id="Tikhanov.pos_constraint" class="variable"><a href="#RegModule.pos_constraint">pos_constraint</a></dd>
                <dd id="Tikhanov.forward" class="function"><a href="#RegModule.forward">forward</a></dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="Tikhanov.dump_patches" class="variable">dump_patches</dd>
                <dd id="Tikhanov.training" class="variable">training</dd>
                <dd id="Tikhanov.call_super_init" class="variable">call_super_init</dd>
                <dd id="Tikhanov.register_buffer" class="function">register_buffer</dd>
                <dd id="Tikhanov.register_parameter" class="function">register_parameter</dd>
                <dd id="Tikhanov.add_module" class="function">add_module</dd>
                <dd id="Tikhanov.register_module" class="function">register_module</dd>
                <dd id="Tikhanov.get_submodule" class="function">get_submodule</dd>
                <dd id="Tikhanov.get_parameter" class="function">get_parameter</dd>
                <dd id="Tikhanov.get_buffer" class="function">get_buffer</dd>
                <dd id="Tikhanov.get_extra_state" class="function">get_extra_state</dd>
                <dd id="Tikhanov.set_extra_state" class="function">set_extra_state</dd>
                <dd id="Tikhanov.apply" class="function">apply</dd>
                <dd id="Tikhanov.cuda" class="function">cuda</dd>
                <dd id="Tikhanov.ipu" class="function">ipu</dd>
                <dd id="Tikhanov.xpu" class="function">xpu</dd>
                <dd id="Tikhanov.cpu" class="function">cpu</dd>
                <dd id="Tikhanov.type" class="function">type</dd>
                <dd id="Tikhanov.float" class="function">float</dd>
                <dd id="Tikhanov.double" class="function">double</dd>
                <dd id="Tikhanov.half" class="function">half</dd>
                <dd id="Tikhanov.bfloat16" class="function">bfloat16</dd>
                <dd id="Tikhanov.to_empty" class="function">to_empty</dd>
                <dd id="Tikhanov.to" class="function">to</dd>
                <dd id="Tikhanov.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="Tikhanov.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="Tikhanov.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="Tikhanov.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="Tikhanov.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="Tikhanov.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="Tikhanov.state_dict" class="function">state_dict</dd>
                <dd id="Tikhanov.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="Tikhanov.load_state_dict" class="function">load_state_dict</dd>
                <dd id="Tikhanov.parameters" class="function">parameters</dd>
                <dd id="Tikhanov.named_parameters" class="function">named_parameters</dd>
                <dd id="Tikhanov.buffers" class="function">buffers</dd>
                <dd id="Tikhanov.named_buffers" class="function">named_buffers</dd>
                <dd id="Tikhanov.children" class="function">children</dd>
                <dd id="Tikhanov.named_children" class="function">named_children</dd>
                <dd id="Tikhanov.modules" class="function">modules</dd>
                <dd id="Tikhanov.named_modules" class="function">named_modules</dd>
                <dd id="Tikhanov.train" class="function">train</dd>
                <dd id="Tikhanov.eval" class="function">eval</dd>
                <dd id="Tikhanov.requires_grad_" class="function">requires_grad_</dd>
                <dd id="Tikhanov.zero_grad" class="function">zero_grad</dd>
                <dd id="Tikhanov.share_memory" class="function">share_memory</dd>
                <dd id="Tikhanov.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="TikhanovC">
                            <input id="TikhanovC-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TikhanovC</span><wbr>(<span class="base"><a href="#RegModule">RegModule</a></span>):

                <label class="view-source-button" for="TikhanovC-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TikhanovC"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TikhanovC-668"><a href="#TikhanovC-668"><span class="linenos">668</span></a><span class="k">class</span> <span class="nc">TikhanovC</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="TikhanovC-669"><a href="#TikhanovC-669"><span class="linenos">669</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Regularization module for Tikhanov-collapse regularization -- where all but one</span>
</span><span id="TikhanovC-670"><a href="#TikhanovC-670"><span class="linenos">670</span></a><span class="sd">    dimension is marginalized over first&quot;&quot;&quot;</span>
</span><span id="TikhanovC-671"><a href="#TikhanovC-671"><span class="linenos">671</span></a>
</span><span id="TikhanovC-672"><a href="#TikhanovC-672"><span class="linenos">672</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="TikhanovC-673"><a href="#TikhanovC-673"><span class="linenos">673</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Tikhanov class&quot;&quot;&quot;</span>
</span><span id="TikhanovC-674"><a href="#TikhanovC-674"><span class="linenos">674</span></a>
</span><span id="TikhanovC-675"><a href="#TikhanovC-675"><span class="linenos">675</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="n">bc_val</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="TikhanovC-676"><a href="#TikhanovC-676"><span class="linenos">676</span></a>        
</span><span id="TikhanovC-677"><a href="#TikhanovC-677"><span class="linenos">677</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gmax_t&#39;</span><span class="p">,</span> <span class="s1">&#39;gmax_space&#39;</span><span class="p">,</span> <span class="s1">&#39;gmax_filter&#39;</span><span class="p">]</span>
</span><span id="TikhanovC-678"><a href="#TikhanovC-678"><span class="linenos">678</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid Tikhanov-C regularization type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="TikhanovC-679"><a href="#TikhanovC-679"><span class="linenos">679</span></a>        
</span><span id="TikhanovC-680"><a href="#TikhanovC-680"><span class="linenos">680</span></a>        <span class="c1"># the &quot;input_dims&quot; are ordered differently for matrix implementations,</span>
</span><span id="TikhanovC-681"><a href="#TikhanovC-681"><span class="linenos">681</span></a>        <span class="c1"># so this is a temporary fix to be able to use old functions</span>
</span><span id="TikhanovC-682"><a href="#TikhanovC-682"><span class="linenos">682</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="TikhanovC-683"><a href="#TikhanovC-683"><span class="linenos">683</span></a>
</span><span id="TikhanovC-684"><a href="#TikhanovC-684"><span class="linenos">684</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collapse_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="TikhanovC-685"><a href="#TikhanovC-685"><span class="linenos">685</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;gmax_t&#39;</span><span class="p">:</span>
</span><span id="TikhanovC-686"><a href="#TikhanovC-686"><span class="linenos">686</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="TikhanovC-687"><a href="#TikhanovC-687"><span class="linenos">687</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;gmax_filter&#39;</span><span class="p">:</span>
</span><span id="TikhanovC-688"><a href="#TikhanovC-688"><span class="linenos">688</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TikhanovC-689"><a href="#TikhanovC-689"><span class="linenos">689</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TikhanovC-690"><a href="#TikhanovC-690"><span class="linenos">690</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="TikhanovC-691"><a href="#TikhanovC-691"><span class="linenos">691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collapse_dims</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span><span class="p">)</span>
</span><span id="TikhanovC-692"><a href="#TikhanovC-692"><span class="linenos">692</span></a>
</span><span id="TikhanovC-693"><a href="#TikhanovC-693"><span class="linenos">693</span></a>        <span class="c1"># Make appropriate reg_matrix as buffer (non-fit parameter)</span>
</span><span id="TikhanovC-694"><a href="#TikhanovC-694"><span class="linenos">694</span></a>        <span class="n">reg_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_reg_mats</span><span class="p">(</span> <span class="n">reg_type</span> <span class="p">)</span>
</span><span id="TikhanovC-695"><a href="#TikhanovC-695"><span class="linenos">695</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;rmat&#39;</span><span class="p">,</span> <span class="n">reg_tensor</span><span class="p">)</span>
</span><span id="TikhanovC-696"><a href="#TikhanovC-696"><span class="linenos">696</span></a>    
</span><span id="TikhanovC-697"><a href="#TikhanovC-697"><span class="linenos">697</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="TikhanovC-698"><a href="#TikhanovC-698"><span class="linenos">698</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate regularization penalty for Tikhanov reg types&quot;&quot;&quot;</span>
</span><span id="TikhanovC-699"><a href="#TikhanovC-699"><span class="linenos">699</span></a>
</span><span id="TikhanovC-700"><a href="#TikhanovC-700"><span class="linenos">700</span></a>        <span class="c1">#w2 = torch.square(weights)  # assuming positive constraints here -- no squaring needed</span>
</span><span id="TikhanovC-701"><a href="#TikhanovC-701"><span class="linenos">701</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
</span><span id="TikhanovC-702"><a href="#TikhanovC-702"><span class="linenos">702</span></a>                <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="c1"># [C, W*H, T, NF]</span>
</span><span id="TikhanovC-703"><a href="#TikhanovC-703"><span class="linenos">703</span></a>                <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collapse_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
</span><span id="TikhanovC-704"><a href="#TikhanovC-704"><span class="linenos">704</span></a>                <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collapse_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="TikhanovC-705"><a href="#TikhanovC-705"><span class="linenos">705</span></a>
</span><span id="TikhanovC-706"><a href="#TikhanovC-706"><span class="linenos">706</span></a>        <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="p">)</span>
</span><span id="TikhanovC-707"><a href="#TikhanovC-707"><span class="linenos">707</span></a>        <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">reg_pen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># sum later (replaced call to torch.trace)</span>
</span><span id="TikhanovC-708"><a href="#TikhanovC-708"><span class="linenos">708</span></a>
</span><span id="TikhanovC-709"><a href="#TikhanovC-709"><span class="linenos">709</span></a>        <span class="k">return</span> <span class="n">reg_pen</span>
</span><span id="TikhanovC-710"><a href="#TikhanovC-710"><span class="linenos">710</span></a>
</span><span id="TikhanovC-711"><a href="#TikhanovC-711"><span class="linenos">711</span></a>    <span class="k">def</span> <span class="nf">_build_reg_mats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">):</span>
</span><span id="TikhanovC-712"><a href="#TikhanovC-712"><span class="linenos">712</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build regularization matrices in default tf Graph</span>
</span><span id="TikhanovC-713"><a href="#TikhanovC-713"><span class="linenos">713</span></a>
</span><span id="TikhanovC-714"><a href="#TikhanovC-714"><span class="linenos">714</span></a><span class="sd">        Args:</span>
</span><span id="TikhanovC-715"><a href="#TikhanovC-715"><span class="linenos">715</span></a><span class="sd">            reg_type (str): see `_allowed_reg_types` for options</span>
</span><span id="TikhanovC-716"><a href="#TikhanovC-716"><span class="linenos">716</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TikhanovC-717"><a href="#TikhanovC-717"><span class="linenos">717</span></a>        <span class="c1">#import NDNT.utils.create_reg_matrices as get_rmats</span>
</span><span id="TikhanovC-718"><a href="#TikhanovC-718"><span class="linenos">718</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span><span class="p">]</span>
</span><span id="TikhanovC-719"><a href="#TikhanovC-719"><span class="linenos">719</span></a>        <span class="n">reg_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">L</span><span class="p">,</span><span class="n">L</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
</span><span id="TikhanovC-720"><a href="#TikhanovC-720"><span class="linenos">720</span></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">reg_mat</span><span class="p">)</span>
</span><span id="TikhanovC-721"><a href="#TikhanovC-721"><span class="linenos">721</span></a>    <span class="c1"># END TikhanovC.build_reg_mats</span>
</span></pre></div>


            <div class="docstring"><p>Regularization module for Tikhanov-collapse regularization -- where all but one
dimension is marginalized over first</p>
</div>


                            <div id="TikhanovC.__init__" class="classattr">
                                        <input id="TikhanovC.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TikhanovC</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">bc_val</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="TikhanovC.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TikhanovC.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TikhanovC.__init__-672"><a href="#TikhanovC.__init__-672"><span class="linenos">672</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="TikhanovC.__init__-673"><a href="#TikhanovC.__init__-673"><span class="linenos">673</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for Tikhanov class&quot;&quot;&quot;</span>
</span><span id="TikhanovC.__init__-674"><a href="#TikhanovC.__init__-674"><span class="linenos">674</span></a>
</span><span id="TikhanovC.__init__-675"><a href="#TikhanovC.__init__-675"><span class="linenos">675</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">input_dims</span><span class="p">,</span> <span class="n">bc_val</span><span class="o">=</span><span class="n">bc_val</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="TikhanovC.__init__-676"><a href="#TikhanovC.__init__-676"><span class="linenos">676</span></a>        
</span><span id="TikhanovC.__init__-677"><a href="#TikhanovC.__init__-677"><span class="linenos">677</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gmax_t&#39;</span><span class="p">,</span> <span class="s1">&#39;gmax_space&#39;</span><span class="p">,</span> <span class="s1">&#39;gmax_filter&#39;</span><span class="p">]</span>
</span><span id="TikhanovC.__init__-678"><a href="#TikhanovC.__init__-678"><span class="linenos">678</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a valid Tikhanov-C regularization type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="TikhanovC.__init__-679"><a href="#TikhanovC.__init__-679"><span class="linenos">679</span></a>        
</span><span id="TikhanovC.__init__-680"><a href="#TikhanovC.__init__-680"><span class="linenos">680</span></a>        <span class="c1"># the &quot;input_dims&quot; are ordered differently for matrix implementations,</span>
</span><span id="TikhanovC.__init__-681"><a href="#TikhanovC.__init__-681"><span class="linenos">681</span></a>        <span class="c1"># so this is a temporary fix to be able to use old functions</span>
</span><span id="TikhanovC.__init__-682"><a href="#TikhanovC.__init__-682"><span class="linenos">682</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">input_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">input_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="TikhanovC.__init__-683"><a href="#TikhanovC.__init__-683"><span class="linenos">683</span></a>
</span><span id="TikhanovC.__init__-684"><a href="#TikhanovC.__init__-684"><span class="linenos">684</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collapse_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="TikhanovC.__init__-685"><a href="#TikhanovC.__init__-685"><span class="linenos">685</span></a>        <span class="k">if</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;gmax_t&#39;</span><span class="p">:</span>
</span><span id="TikhanovC.__init__-686"><a href="#TikhanovC.__init__-686"><span class="linenos">686</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="TikhanovC.__init__-687"><a href="#TikhanovC.__init__-687"><span class="linenos">687</span></a>        <span class="k">elif</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s1">&#39;gmax_filter&#39;</span><span class="p">:</span>
</span><span id="TikhanovC.__init__-688"><a href="#TikhanovC.__init__-688"><span class="linenos">688</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TikhanovC.__init__-689"><a href="#TikhanovC.__init__-689"><span class="linenos">689</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TikhanovC.__init__-690"><a href="#TikhanovC.__init__-690"><span class="linenos">690</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="TikhanovC.__init__-691"><a href="#TikhanovC.__init__-691"><span class="linenos">691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collapse_dims</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_dim</span><span class="p">)</span>
</span><span id="TikhanovC.__init__-692"><a href="#TikhanovC.__init__-692"><span class="linenos">692</span></a>
</span><span id="TikhanovC.__init__-693"><a href="#TikhanovC.__init__-693"><span class="linenos">693</span></a>        <span class="c1"># Make appropriate reg_matrix as buffer (non-fit parameter)</span>
</span><span id="TikhanovC.__init__-694"><a href="#TikhanovC.__init__-694"><span class="linenos">694</span></a>        <span class="n">reg_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_reg_mats</span><span class="p">(</span> <span class="n">reg_type</span> <span class="p">)</span>
</span><span id="TikhanovC.__init__-695"><a href="#TikhanovC.__init__-695"><span class="linenos">695</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span> <span class="s1">&#39;rmat&#39;</span><span class="p">,</span> <span class="n">reg_tensor</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Constructor for Tikhanov class</p>
</div>


                            </div>
                            <div id="TikhanovC.input_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">input_dims</span>

        
    </div>
    <a class="headerlink" href="#TikhanovC.input_dims"></a>
    
    

                            </div>
                            <div id="TikhanovC.collapse_dims" class="classattr">
                                <div class="attr variable">
            <span class="name">collapse_dims</span>

        
    </div>
    <a class="headerlink" href="#TikhanovC.collapse_dims"></a>
    
    

                            </div>
                            <div id="TikhanovC.compute_reg_penalty" class="classattr">
                                        <input id="TikhanovC.compute_reg_penalty-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_reg_penalty</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">weights</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TikhanovC.compute_reg_penalty-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TikhanovC.compute_reg_penalty"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TikhanovC.compute_reg_penalty-697"><a href="#TikhanovC.compute_reg_penalty-697"><span class="linenos">697</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="TikhanovC.compute_reg_penalty-698"><a href="#TikhanovC.compute_reg_penalty-698"><span class="linenos">698</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate regularization penalty for Tikhanov reg types&quot;&quot;&quot;</span>
</span><span id="TikhanovC.compute_reg_penalty-699"><a href="#TikhanovC.compute_reg_penalty-699"><span class="linenos">699</span></a>
</span><span id="TikhanovC.compute_reg_penalty-700"><a href="#TikhanovC.compute_reg_penalty-700"><span class="linenos">700</span></a>        <span class="c1">#w2 = torch.square(weights)  # assuming positive constraints here -- no squaring needed</span>
</span><span id="TikhanovC.compute_reg_penalty-701"><a href="#TikhanovC.compute_reg_penalty-701"><span class="linenos">701</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
</span><span id="TikhanovC.compute_reg_penalty-702"><a href="#TikhanovC.compute_reg_penalty-702"><span class="linenos">702</span></a>                <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dims</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="c1"># [C, W*H, T, NF]</span>
</span><span id="TikhanovC.compute_reg_penalty-703"><a href="#TikhanovC.compute_reg_penalty-703"><span class="linenos">703</span></a>                <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collapse_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
</span><span id="TikhanovC.compute_reg_penalty-704"><a href="#TikhanovC.compute_reg_penalty-704"><span class="linenos">704</span></a>                <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collapse_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="TikhanovC.compute_reg_penalty-705"><a href="#TikhanovC.compute_reg_penalty-705"><span class="linenos">705</span></a>
</span><span id="TikhanovC.compute_reg_penalty-706"><a href="#TikhanovC.compute_reg_penalty-706"><span class="linenos">706</span></a>        <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span> <span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmat</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="p">)</span>
</span><span id="TikhanovC.compute_reg_penalty-707"><a href="#TikhanovC.compute_reg_penalty-707"><span class="linenos">707</span></a>        <span class="n">reg_pen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">reg_pen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># sum later (replaced call to torch.trace)</span>
</span><span id="TikhanovC.compute_reg_penalty-708"><a href="#TikhanovC.compute_reg_penalty-708"><span class="linenos">708</span></a>
</span><span id="TikhanovC.compute_reg_penalty-709"><a href="#TikhanovC.compute_reg_penalty-709"><span class="linenos">709</span></a>        <span class="k">return</span> <span class="n">reg_pen</span>
</span></pre></div>


            <div class="docstring"><p>Calculate regularization penalty for Tikhanov reg types</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#RegModule">RegModule</a></dt>
                                <dd id="TikhanovC.reg_type" class="variable"><a href="#RegModule.reg_type">reg_type</a></dd>
                <dd id="TikhanovC.unit_reg" class="variable"><a href="#RegModule.unit_reg">unit_reg</a></dd>
                <dd id="TikhanovC.num_dims" class="variable"><a href="#RegModule.num_dims">num_dims</a></dd>
                <dd id="TikhanovC.folded_lags" class="variable"><a href="#RegModule.folded_lags">folded_lags</a></dd>
                <dd id="TikhanovC.pos_constraint" class="variable"><a href="#RegModule.pos_constraint">pos_constraint</a></dd>
                <dd id="TikhanovC.forward" class="function"><a href="#RegModule.forward">forward</a></dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="TikhanovC.dump_patches" class="variable">dump_patches</dd>
                <dd id="TikhanovC.training" class="variable">training</dd>
                <dd id="TikhanovC.call_super_init" class="variable">call_super_init</dd>
                <dd id="TikhanovC.register_buffer" class="function">register_buffer</dd>
                <dd id="TikhanovC.register_parameter" class="function">register_parameter</dd>
                <dd id="TikhanovC.add_module" class="function">add_module</dd>
                <dd id="TikhanovC.register_module" class="function">register_module</dd>
                <dd id="TikhanovC.get_submodule" class="function">get_submodule</dd>
                <dd id="TikhanovC.get_parameter" class="function">get_parameter</dd>
                <dd id="TikhanovC.get_buffer" class="function">get_buffer</dd>
                <dd id="TikhanovC.get_extra_state" class="function">get_extra_state</dd>
                <dd id="TikhanovC.set_extra_state" class="function">set_extra_state</dd>
                <dd id="TikhanovC.apply" class="function">apply</dd>
                <dd id="TikhanovC.cuda" class="function">cuda</dd>
                <dd id="TikhanovC.ipu" class="function">ipu</dd>
                <dd id="TikhanovC.xpu" class="function">xpu</dd>
                <dd id="TikhanovC.cpu" class="function">cpu</dd>
                <dd id="TikhanovC.type" class="function">type</dd>
                <dd id="TikhanovC.float" class="function">float</dd>
                <dd id="TikhanovC.double" class="function">double</dd>
                <dd id="TikhanovC.half" class="function">half</dd>
                <dd id="TikhanovC.bfloat16" class="function">bfloat16</dd>
                <dd id="TikhanovC.to_empty" class="function">to_empty</dd>
                <dd id="TikhanovC.to" class="function">to</dd>
                <dd id="TikhanovC.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="TikhanovC.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="TikhanovC.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="TikhanovC.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="TikhanovC.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="TikhanovC.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="TikhanovC.state_dict" class="function">state_dict</dd>
                <dd id="TikhanovC.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="TikhanovC.load_state_dict" class="function">load_state_dict</dd>
                <dd id="TikhanovC.parameters" class="function">parameters</dd>
                <dd id="TikhanovC.named_parameters" class="function">named_parameters</dd>
                <dd id="TikhanovC.buffers" class="function">buffers</dd>
                <dd id="TikhanovC.named_buffers" class="function">named_buffers</dd>
                <dd id="TikhanovC.children" class="function">children</dd>
                <dd id="TikhanovC.named_children" class="function">named_children</dd>
                <dd id="TikhanovC.modules" class="function">modules</dd>
                <dd id="TikhanovC.named_modules" class="function">named_modules</dd>
                <dd id="TikhanovC.train" class="function">train</dd>
                <dd id="TikhanovC.eval" class="function">eval</dd>
                <dd id="TikhanovC.requires_grad_" class="function">requires_grad_</dd>
                <dd id="TikhanovC.zero_grad" class="function">zero_grad</dd>
                <dd id="TikhanovC.share_memory" class="function">share_memory</dd>
                <dd id="TikhanovC.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ActivityReg">
                            <input id="ActivityReg-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ActivityReg</span><wbr>(<span class="base"><a href="#RegModule">RegModule</a></span>):

                <label class="view-source-button" for="ActivityReg-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ActivityReg"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ActivityReg-724"><a href="#ActivityReg-724"><span class="linenos">724</span></a><span class="k">class</span> <span class="nc">ActivityReg</span><span class="p">(</span><span class="n">RegModule</span><span class="p">):</span>
</span><span id="ActivityReg-725"><a href="#ActivityReg-725"><span class="linenos">725</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Regularization to penalize activity separably for each dimension</span>
</span><span id="ActivityReg-726"><a href="#ActivityReg-726"><span class="linenos">726</span></a><span class="sd">    Note that the penalty needs to be computed elsewhere and just stored here&quot;&quot;&quot;</span>
</span><span id="ActivityReg-727"><a href="#ActivityReg-727"><span class="linenos">727</span></a>    
</span><span id="ActivityReg-728"><a href="#ActivityReg-728"><span class="linenos">728</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_dims</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ActivityReg-729"><a href="#ActivityReg-729"><span class="linenos">729</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for LocalityReg class&quot;&quot;&quot;</span>
</span><span id="ActivityReg-730"><a href="#ActivityReg-730"><span class="linenos">730</span></a>
</span><span id="ActivityReg-731"><a href="#ActivityReg-731"><span class="linenos">731</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;activity&#39;</span><span class="p">]</span>
</span><span id="ActivityReg-732"><a href="#ActivityReg-732"><span class="linenos">732</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid Locality Reg type&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="ActivityReg-733"><a href="#ActivityReg-733"><span class="linenos">733</span></a>
</span><span id="ActivityReg-734"><a href="#ActivityReg-734"><span class="linenos">734</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ActivityReg-735"><a href="#ActivityReg-735"><span class="linenos">735</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acitivity_penalty</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ActivityReg-736"><a href="#ActivityReg-736"><span class="linenos">736</span></a>    <span class="c1"># END ActivityReg.__init__</span>
</span><span id="ActivityReg-737"><a href="#ActivityReg-737"><span class="linenos">737</span></a>
</span><span id="ActivityReg-738"><a href="#ActivityReg-738"><span class="linenos">738</span></a>    <span class="k">def</span> <span class="nf">compute_activity_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acts</span> <span class="p">):</span>
</span><span id="ActivityReg-739"><a href="#ActivityReg-739"><span class="linenos">739</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes activity penalty from activations -- called in layer forward&quot;&quot;&quot;</span>
</span><span id="ActivityReg-740"><a href="#ActivityReg-740"><span class="linenos">740</span></a>        <span class="c1"># Can put conditionals if there is more than one reg module</span>
</span><span id="ActivityReg-741"><a href="#ActivityReg-741"><span class="linenos">741</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">activity_penalty</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">acts</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ActivityReg-742"><a href="#ActivityReg-742"><span class="linenos">742</span></a>
</span><span id="ActivityReg-743"><a href="#ActivityReg-743"><span class="linenos">743</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="ActivityReg-744"><a href="#ActivityReg-744"><span class="linenos">744</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute regularization penalty for locality&quot;&quot;&quot;</span>
</span><span id="ActivityReg-745"><a href="#ActivityReg-745"><span class="linenos">745</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activity_penalty</span>  <span class="c1"># this is precomputed</span>
</span><span id="ActivityReg-746"><a href="#ActivityReg-746"><span class="linenos">746</span></a>    <span class="c1"># END ActivityReg.__init__</span>
</span></pre></div>


            <div class="docstring"><p>Regularization to penalize activity separably for each dimension
Note that the penalty needs to be computed elsewhere and just stored here</p>
</div>


                            <div id="ActivityReg.__init__" class="classattr">
                                        <input id="ActivityReg.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ActivityReg</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">num_dims</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="ActivityReg.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ActivityReg.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ActivityReg.__init__-728"><a href="#ActivityReg.__init__-728"><span class="linenos">728</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_dims</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ActivityReg.__init__-729"><a href="#ActivityReg.__init__-729"><span class="linenos">729</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for LocalityReg class&quot;&quot;&quot;</span>
</span><span id="ActivityReg.__init__-730"><a href="#ActivityReg.__init__-730"><span class="linenos">730</span></a>
</span><span id="ActivityReg.__init__-731"><a href="#ActivityReg.__init__-731"><span class="linenos">731</span></a>        <span class="n">_valid_reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;activity&#39;</span><span class="p">]</span>
</span><span id="ActivityReg.__init__-732"><a href="#ActivityReg.__init__-732"><span class="linenos">732</span></a>        <span class="k">assert</span> <span class="n">reg_type</span> <span class="ow">in</span> <span class="n">_valid_reg_types</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid Locality Reg type&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_type</span><span class="p">)</span>
</span><span id="ActivityReg.__init__-733"><a href="#ActivityReg.__init__-733"><span class="linenos">733</span></a>
</span><span id="ActivityReg.__init__-734"><a href="#ActivityReg.__init__-734"><span class="linenos">734</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">,</span> <span class="n">input_dims</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ActivityReg.__init__-735"><a href="#ActivityReg.__init__-735"><span class="linenos">735</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">acitivity_penalty</span> <span class="o">=</span> <span class="mf">0.0</span>
</span></pre></div>


            <div class="docstring"><p>Constructor for LocalityReg class</p>
</div>


                            </div>
                            <div id="ActivityReg.acitivity_penalty" class="classattr">
                                <div class="attr variable">
            <span class="name">acitivity_penalty</span>

        
    </div>
    <a class="headerlink" href="#ActivityReg.acitivity_penalty"></a>
    
    

                            </div>
                            <div id="ActivityReg.compute_activity_penalty" class="classattr">
                                        <input id="ActivityReg.compute_activity_penalty-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_activity_penalty</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">acts</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ActivityReg.compute_activity_penalty-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ActivityReg.compute_activity_penalty"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ActivityReg.compute_activity_penalty-738"><a href="#ActivityReg.compute_activity_penalty-738"><span class="linenos">738</span></a>    <span class="k">def</span> <span class="nf">compute_activity_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acts</span> <span class="p">):</span>
</span><span id="ActivityReg.compute_activity_penalty-739"><a href="#ActivityReg.compute_activity_penalty-739"><span class="linenos">739</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes activity penalty from activations -- called in layer forward&quot;&quot;&quot;</span>
</span><span id="ActivityReg.compute_activity_penalty-740"><a href="#ActivityReg.compute_activity_penalty-740"><span class="linenos">740</span></a>        <span class="c1"># Can put conditionals if there is more than one reg module</span>
</span><span id="ActivityReg.compute_activity_penalty-741"><a href="#ActivityReg.compute_activity_penalty-741"><span class="linenos">741</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">activity_penalty</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">acts</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Computes activity penalty from activations -- called in layer forward</p>
</div>


                            </div>
                            <div id="ActivityReg.compute_reg_penalty" class="classattr">
                                        <input id="ActivityReg.compute_reg_penalty-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_reg_penalty</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">weights</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ActivityReg.compute_reg_penalty-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ActivityReg.compute_reg_penalty"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ActivityReg.compute_reg_penalty-743"><a href="#ActivityReg.compute_reg_penalty-743"><span class="linenos">743</span></a>    <span class="k">def</span> <span class="nf">compute_reg_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
</span><span id="ActivityReg.compute_reg_penalty-744"><a href="#ActivityReg.compute_reg_penalty-744"><span class="linenos">744</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute regularization penalty for locality&quot;&quot;&quot;</span>
</span><span id="ActivityReg.compute_reg_penalty-745"><a href="#ActivityReg.compute_reg_penalty-745"><span class="linenos">745</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activity_penalty</span>  <span class="c1"># this is precomputed</span>
</span></pre></div>


            <div class="docstring"><p>Compute regularization penalty for locality</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#RegModule">RegModule</a></dt>
                                <dd id="ActivityReg.reg_type" class="variable"><a href="#RegModule.reg_type">reg_type</a></dd>
                <dd id="ActivityReg.unit_reg" class="variable"><a href="#RegModule.unit_reg">unit_reg</a></dd>
                <dd id="ActivityReg.input_dims" class="variable"><a href="#RegModule.input_dims">input_dims</a></dd>
                <dd id="ActivityReg.num_dims" class="variable"><a href="#RegModule.num_dims">num_dims</a></dd>
                <dd id="ActivityReg.folded_lags" class="variable"><a href="#RegModule.folded_lags">folded_lags</a></dd>
                <dd id="ActivityReg.pos_constraint" class="variable"><a href="#RegModule.pos_constraint">pos_constraint</a></dd>
                <dd id="ActivityReg.forward" class="function"><a href="#RegModule.forward">forward</a></dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="ActivityReg.dump_patches" class="variable">dump_patches</dd>
                <dd id="ActivityReg.training" class="variable">training</dd>
                <dd id="ActivityReg.call_super_init" class="variable">call_super_init</dd>
                <dd id="ActivityReg.register_buffer" class="function">register_buffer</dd>
                <dd id="ActivityReg.register_parameter" class="function">register_parameter</dd>
                <dd id="ActivityReg.add_module" class="function">add_module</dd>
                <dd id="ActivityReg.register_module" class="function">register_module</dd>
                <dd id="ActivityReg.get_submodule" class="function">get_submodule</dd>
                <dd id="ActivityReg.get_parameter" class="function">get_parameter</dd>
                <dd id="ActivityReg.get_buffer" class="function">get_buffer</dd>
                <dd id="ActivityReg.get_extra_state" class="function">get_extra_state</dd>
                <dd id="ActivityReg.set_extra_state" class="function">set_extra_state</dd>
                <dd id="ActivityReg.apply" class="function">apply</dd>
                <dd id="ActivityReg.cuda" class="function">cuda</dd>
                <dd id="ActivityReg.ipu" class="function">ipu</dd>
                <dd id="ActivityReg.xpu" class="function">xpu</dd>
                <dd id="ActivityReg.cpu" class="function">cpu</dd>
                <dd id="ActivityReg.type" class="function">type</dd>
                <dd id="ActivityReg.float" class="function">float</dd>
                <dd id="ActivityReg.double" class="function">double</dd>
                <dd id="ActivityReg.half" class="function">half</dd>
                <dd id="ActivityReg.bfloat16" class="function">bfloat16</dd>
                <dd id="ActivityReg.to_empty" class="function">to_empty</dd>
                <dd id="ActivityReg.to" class="function">to</dd>
                <dd id="ActivityReg.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="ActivityReg.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="ActivityReg.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="ActivityReg.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="ActivityReg.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="ActivityReg.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="ActivityReg.state_dict" class="function">state_dict</dd>
                <dd id="ActivityReg.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="ActivityReg.load_state_dict" class="function">load_state_dict</dd>
                <dd id="ActivityReg.parameters" class="function">parameters</dd>
                <dd id="ActivityReg.named_parameters" class="function">named_parameters</dd>
                <dd id="ActivityReg.buffers" class="function">buffers</dd>
                <dd id="ActivityReg.named_buffers" class="function">named_buffers</dd>
                <dd id="ActivityReg.children" class="function">children</dd>
                <dd id="ActivityReg.named_children" class="function">named_children</dd>
                <dd id="ActivityReg.modules" class="function">modules</dd>
                <dd id="ActivityReg.named_modules" class="function">named_modules</dd>
                <dd id="ActivityReg.train" class="function">train</dd>
                <dd id="ActivityReg.eval" class="function">eval</dd>
                <dd id="ActivityReg.requires_grad_" class="function">requires_grad_</dd>
                <dd id="ActivityReg.zero_grad" class="function">zero_grad</dd>
                <dd id="ActivityReg.share_memory" class="function">share_memory</dd>
                <dd id="ActivityReg.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>